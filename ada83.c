#define _POSIX_C_SOURCE 200809L
#include<stdio.h>
#include<stdlib.h>
#include<string.h>
#include<ctype.h>
#include<stdint.h>
#include<stdbool.h>
#include<stdarg.h>
#include<setjmp.h>
#include<pthread.h>
#include<sys/stat.h>
#include<fcntl.h>
#include<unistd.h>
#include"err.h"
typedef struct{char*b,*p,*e;}A;typedef struct{const char*s;uint32_t n;}S;typedef struct{uint32_t l,c;const char*f;}L;
#define Z(x)((S){x,sizeof(x)-1})
#define N ((S){0,0})
static A M={0};static int E=0;
static void*al(size_t n){n=(n+7)&~7;if(!M.b||M.p+n>M.e){size_t z=1<<24;M.b=M.p=malloc(z);M.e=M.b+z;}void*r=M.p;M.p+=n;return memset(r,0,n);}
static void ar(){if(M.b)M.p=M.b;}
static S sd(S s){char*p=al(s.n+1);memcpy(p,s.s,s.n);return(S){p,s.n};}
static bool se(S a,S b){return a.n==b.n&&!memcmp(a.s,b.s,a.n);}
static bool si(S a,S b){if(a.n!=b.n)return 0;for(uint32_t i=0;i<a.n;i++)if(tolower(a.s[i])!=tolower(b.s[i]))return 0;return 1;}
static uint64_t sh(S s){uint64_t h=14695981039346656037ULL;for(uint32_t i=0;i<s.n;i++)h=(h^(uint8_t)tolower(s.s[i]))*1099511628211ULL;return h;}
static jmp_buf JB;static void die(L l,const char*f,...){static char m[999];va_list v;va_start(v,f);
vsnprintf(m,999,f,v);va_end(v);char*g=strstr(m,"got '"),*x=strstr(m,"exp '");
ERR((char*)l.f,l.l,l.c,g?g+5:"?",x?x+5:"?");E++;if(E>50)longjmp(JB,1);}
typedef enum{T_EOF=0,T_ERR,T_ID,T_INT,T_REAL,T_CHAR,T_STR,T_LP,T_RP,T_LB,T_RB,T_CM,T_DT,T_SC,T_CL,T_TK,T_AS,T_AR,T_DD,T_LL,T_GG,T_BX,T_BR,T_EQ,T_NE,T_LT,T_LE,T_GT,T_GE,T_PL,T_MN,T_ST,T_SL,T_AM,T_EX,T_AB,T_ABS,T_ACC,T_ACCS,T_ALITK,T_ALL,T_AND,T_ATHN,T_ARR,T_AT,T_BEG,T_BOD,T_CSE,T_CONST,T_DEC,T_DEL,T_DELTA,T_DIG,T_DO,T_ELSE,T_ELSIF,T_END,T_ENT,T_EXCP,T_EXIT,T_FOR,T_FUN,T_GEN,T_GOTO,T_IF,T_IN,T_IS,T_LIM,T_LOOP,T_MOD,T_NEW,T_NOT,T_NULL,T_OF,T_OR,T_OREL,T_OTH,T_OUT,T_PKG,T_PGM,T_PRV,T_PROC,T_RAS,T_RNG,T_REC,T_REM,T_REN,T_RET,T_REV,T_SEL,T_SEP,T_SUB,T_TSK,T_TER,T_THEN,T_TYP,T_USE,T_WHN,T_WHI,T_WITH,T_XOR,T_CNT}Tk;
static const char*TN[T_CNT]={[T_EOF]="eof",[T_ID]="id",[T_INT]="int",[T_REAL]="real",[T_CHAR]="char",[T_STR]="str",[T_LP]="(",[T_RP]=")",[T_LB]="[",[T_RB]="]",[T_CM]=",",[T_DT]=".",[T_SC]=";",[T_CL]=":",[T_TK]="'",[T_AS]=":=",[T_AR]="=>",[T_DD]="..",[T_LL]="<<",[T_GG]=">>",[T_BX]="<>",[T_BR]="|",[T_EQ]="=",[T_NE]="/=",[T_LT]="<",[T_LE]="<=",[T_GT]=">",[T_GE]=">=",[T_PL]="+",[T_MN]="-",[T_ST]="*",[T_SL]="/",[T_AM]="&",[T_EX]="**",[T_AB]="ABORT",[T_ABS]="ABS",[T_ACC]="ACCEPT",[T_ACCS]="ACCESS",[T_ALITK]="ALIASED",[T_ALL]="ALL",[T_AND]="AND",[T_ATHN]="AND THEN",[T_ARR]="ARRAY",[T_AT]="AT",[T_BEG]="BEGIN",[T_BOD]="BODY",[T_CSE]="CASE",[T_CONST]="CONSTANT",[T_DEC]="DECLARE",[T_DEL]="DELAY",[T_DELTA]="DELTA",[T_DIG]="DIGITS",[T_DO]="DO",[T_ELSE]="ELSE",[T_ELSIF]="ELSIF",[T_END]="END",[T_ENT]="ENTRY",[T_EXCP]="EXCEPTION",[T_EXIT]="EXIT",[T_FOR]="FOR",[T_FUN]="FUNCTION",[T_GEN]="GENERIC",[T_GOTO]="GOTO",[T_IF]="IF",[T_IN]="IN",[T_IS]="IS",[T_LIM]="LIMITED",[T_LOOP]="LOOP",[T_MOD]="MOD",[T_NEW]="NEW",[T_NOT]="NOT",[T_NULL]="NULL",[T_OF]="OF",[T_OR]="OR",[T_OREL]="OR ELSE",[T_OTH]="OTHERS",[T_OUT]="OUT",[T_PKG]="PACKAGE",[T_PGM]="PRAGMA",[T_PRV]="PRIVATE",[T_PROC]="PROCEDURE",[T_RAS]="RAISE",[T_RNG]="RANGE",[T_REC]="RECORD",[T_REM]="REM",[T_REN]="RENAMES",[T_RET]="RETURN",[T_REV]="REVERSE",[T_SEL]="SELECT",[T_SEP]="SEPARATE",[T_SUB]="SUBTYPE",[T_TSK]="TASK",[T_TER]="TERMINATE",[T_THEN]="THEN",[T_TYP]="TYPE",[T_USE]="USE",[T_WHN]="WHEN",[T_WHI]="WHILE",[T_WITH]="WITH",[T_XOR]="XOR"};
typedef struct{Tk t;L l;S lit;int64_t iv;double fv;}Tn;typedef struct{const char*s,*c,*e;uint32_t ln,cl;const char*f;}Lx;
static struct{S k;Tk t;}KW[]={{Z("abort"),T_AB},{Z("abs"),T_ABS},{Z("accept"),T_ACC},{Z("access"),T_ACCS},{Z("all"),T_ALL},{Z("and"),T_AND},{Z("array"),T_ARR},{Z("at"),T_AT},{Z("begin"),T_BEG},{Z("body"),T_BOD},{Z("case"),T_CSE},{Z("constant"),T_CONST},{Z("declare"),T_DEC},{Z("delay"),T_DEL},{Z("delta"),T_DELTA},{Z("digits"),T_DIG},{Z("do"),T_DO},{Z("else"),T_ELSE},{Z("elsif"),T_ELSIF},{Z("end"),T_END},{Z("entry"),T_ENT},{Z("exception"),T_EXCP},{Z("exit"),T_EXIT},{Z("for"),T_FOR},{Z("function"),T_FUN},{Z("generic"),T_GEN},{Z("goto"),T_GOTO},{Z("if"),T_IF},{Z("in"),T_IN},{Z("is"),T_IS},{Z("limited"),T_LIM},{Z("loop"),T_LOOP},{Z("mod"),T_MOD},{Z("new"),T_NEW},{Z("not"),T_NOT},{Z("null"),T_NULL},{Z("of"),T_OF},{Z("or"),T_OR},{Z("others"),T_OTH},{Z("out"),T_OUT},{Z("package"),T_PKG},{Z("pragma"),T_PGM},{Z("private"),T_PRV},{Z("procedure"),T_PROC},{Z("raise"),T_RAS},{Z("range"),T_RNG},{Z("record"),T_REC},{Z("rem"),T_REM},{Z("renames"),T_REN},{Z("return"),T_RET},{Z("reverse"),T_REV},{Z("select"),T_SEL},{Z("separate"),T_SEP},{Z("subtype"),T_SUB},{Z("task"),T_TSK},{Z("terminate"),T_TER},{Z("then"),T_THEN},{Z("type"),T_TYP},{Z("use"),T_USE},{Z("when"),T_WHN},{Z("while"),T_WHI},{Z("with"),T_WITH},{Z("xor"),T_XOR},{N,T_EOF}};
static Tk kl(S s){for(int i=0;KW[i].k.s;i++)if(si(s,KW[i].k))return KW[i].t;return T_ID;}
static Lx ln(const char*s,size_t z,const char*f){return(Lx){s,s,s+z,1,1,f};}
static char pk(Lx*l){return l->c<l->e?*l->c:0;}
static char p2(Lx*l){return l->c+1<l->e?l->c[1]:0;}
static char p3(Lx*l){return l->c+2<l->e?l->c[2]:0;}
static char av(Lx*l){if(l->c>=l->e)return 0;char c=*l->c++;if(c=='\n'){l->ln++;l->cl=1;}else l->cl++;return c;}
static void sw(Lx*l){for(;;){while(l->c<l->e&&(*l->c==' '||*l->c=='\t'||*l->c=='\n'||*l->c=='\r'))av(l);if(l->c+1<l->e&&l->c[0]=='-'&&l->c[1]=='-'){while(l->c<l->e&&*l->c!='\n')av(l);}else break;}}
static Tn mt(Tk t,L lc,S lt){return(Tn){t,lc,lt,0,0.0};}
static Tn si_(Lx*l){L lc={l->ln,l->cl,l->f};const char*s=l->c;while(isalnum(pk(l))||pk(l)=='_')av(l);S lt={s,l->c-s};return mt(kl(lt),lc,lt);}
static Tn sn(Lx*l){L lc={l->ln,l->cl,l->f};const char*s=l->c;int b=10;bool ir=false;while(isdigit(pk(l))||pk(l)=='_')av(l);if(pk(l)=='#'){av(l);b=strtol(s,0,10);s=l->c;while(isxdigit(pk(l))||pk(l)=='_')av(l);if(pk(l)=='.'){ir=true;av(l);while(isxdigit(pk(l))||pk(l)=='_')av(l);}if(pk(l)=='#')av(l);if(tolower(pk(l))=='e'){ir=true;av(l);if(pk(l)=='+'||pk(l)=='-')av(l);while(isdigit(pk(l))||pk(l)=='_')av(l);}}else{if(pk(l)=='.'){if(p2(l)!='.'&&!isalpha(p2(l))){ir=true;av(l);while(isdigit(pk(l))||pk(l)=='_')av(l);}}if(tolower(pk(l))=='e'){ir=true;av(l);if(pk(l)=='+'||pk(l)=='-')av(l);while(isdigit(pk(l))||pk(l)=='_')av(l);}}S lt={s,l->c-s};Tn tk=mt(ir?T_REAL:T_INT,lc,lt);char*tp=al(lt.n+1);int j=0;for(uint32_t i=0;i<lt.n;i++)if(lt.s[i]!='_'&&lt.s[i]!='#')tp[j++]=lt.s[i];tp[j]=0;if(ir)tk.fv=strtod(tp,0);else tk.iv=strtoll(tp,0,b);return tk;}
static Tn sc(Lx*l){L lc={l->ln,l->cl,l->f};av(l);if(pk(l)==0)return mt(T_ERR,lc,Z("uc"));char c=pk(l);av(l);if(pk(l)!='\'')return mt(T_ERR,lc,Z("uc"));av(l);Tn tk=mt(T_CHAR,lc,(S){&c,1});tk.iv=c;return tk;}
static Tn ss(Lx*l){L lc={l->ln,l->cl,l->f};av(l);const char*s=l->c;char*b=al(256),*p=b;int n=0;while(pk(l)){if(pk(l)=='"'){if(p2(l)=='"'){av(l);av(l);if(n<255)*p++='"';n++;}else break;}else{if(n<255)*p++=pk(l);n++;av(l);}}if(pk(l)=='"')av(l);else return mt(T_ERR,lc,Z("us"));*p=0;S lt={b,n};return mt(T_STR,lc,lt);}
static Tn lnx(Lx*l){sw(l);L lc={l->ln,l->cl,l->f};char c=pk(l);if(!c)return mt(T_EOF,lc,N);if(isalpha(c))return si_(l);if(isdigit(c))return sn(l);if(c=='\''){if(p2(l)&&p3(l)=='\'')return sc(l);av(l);return mt(T_TK,lc,Z("'"));}if(c=='"')return ss(l);av(l);switch(c){case'(':return mt(T_LP,lc,Z("("));case')':return mt(T_RP,lc,Z(")"));case'[':return mt(T_LB,lc,Z("["));case']':return mt(T_RB,lc,Z("]"));case',':return mt(T_CM,lc,Z(","));case';':return mt(T_SC,lc,Z(";"));case'&':return mt(T_AM,lc,Z("&"));case'|':return mt(T_BR,lc,Z("|"));case'+':return mt(T_PL,lc,Z("+"));case'-':return mt(T_MN,lc,Z("-"));case'/':if(pk(l)=='='){av(l);return mt(T_NE,lc,Z("/="));}return mt(T_SL,lc,Z("/"));case'*':if(pk(l)=='*'){av(l);return mt(T_EX,lc,Z("**"));}return mt(T_ST,lc,Z("*"));case'=':if(pk(l)=='>'){av(l);return mt(T_AR,lc,Z("=>"));}return mt(T_EQ,lc,Z("="));case':':if(pk(l)=='='){av(l);return mt(T_AS,lc,Z(":="));}return mt(T_CL,lc,Z(":"));case'.':if(pk(l)=='.'){av(l);return mt(T_DD,lc,Z(".."));}return mt(T_DT,lc,Z("."));case'<':if(pk(l)=='='){av(l);return mt(T_LE,lc,Z("<="));}if(pk(l)=='<'){av(l);return mt(T_LL,lc,Z("<<"));}if(pk(l)=='>'){av(l);return mt(T_BX,lc,Z("<>"));}return mt(T_LT,lc,Z("<"));case'>':if(pk(l)=='='){av(l);return mt(T_GE,lc,Z(">="));}if(pk(l)=='>'){av(l);return mt(T_GG,lc,Z(">>"));}return mt(T_GT,lc,Z(">"));}return mt(T_ERR,lc,Z("ux"));}
typedef enum{N_ERR=0,N_ID,N_INT,N_REAL,N_CHAR,N_STR,N_NULL,N_AG,N_BIN,N_UN,N_AT,N_QL,N_CL,N_IX,N_SL,N_SEL,N_ALC,N_TI,N_TE,N_TF,N_TX,N_TA,N_TR,N_TAC,N_TP,N_ST,N_RN,N_CN,N_CM,N_VR,N_VP,N_DS,N_PM,N_PS,N_FS,N_PB,N_FB,N_PD,N_FD,N_PKS,N_PKB,N_PKD,N_OD,N_ND,N_TD,N_SD,N_ED,N_RE,N_AS,N_IF,N_CS,N_LP,N_BL,N_EX,N_RT,N_GT,N_RS,N_NS,N_CLT,N_EC,N_DL,N_AB,N_CD,N_ACC,N_SLS,N_SA,N_TKS,N_TKB,N_TKD,N_ENT,N_EI,N_HD,N_CH,N_ASC,N_WH,N_EL,N_WI,N_US,N_PG,N_RP,N_GD,N_GI,N_GF,N_CU,N_CX,N_LST,N_DRF,N_CVT,N_CHK,N_RRC,N_ERC,N_LNC,N_ADC,N_ALC2,N_DRV,N_LBL,N_OPID,N_GTP,N_GVL,N_GSP,N_GEN,N_GINST,N_TRM,N_CNT}Nk;
typedef struct Ty Ty;typedef struct No No;typedef struct Sy Sy;typedef struct RC RC;typedef struct LU LU;typedef struct GT GT;typedef struct{No**d;uint32_t n,c;}NV;typedef struct{Sy**d;uint32_t n,c;}SV;typedef struct{RC**d;uint32_t n,c;}RV;typedef struct{LU**d;uint32_t n,c;}LV;typedef struct{GT**d;uint32_t n,c;}GV;typedef struct{FILE**d;uint32_t n,c;}FV;typedef struct{S*d;uint32_t n,c;}SLV;
static void nv(NV*v,No*n){if(v->n>=v->c){v->c=v->c?v->c*2:8;v->d=realloc(v->d,v->c*sizeof(No*));}v->d[v->n++]=n;}
static void sv(SV*v,Sy*s){if(v->n>=v->c){v->c=v->c?v->c*2:8;v->d=realloc(v->d,v->c*sizeof(Sy*));}v->d[v->n++]=s;}
static void rv(RV*v,RC*r){if(v->n>=v->c){v->c=v->c?v->c*2:8;v->d=realloc(v->d,v->c*sizeof(RC*));}v->d[v->n++]=r;}
static void lv(LV*v,LU*l){if(v->n>=v->c){v->c=v->c?v->c*2:8;v->d=realloc(v->d,v->c*sizeof(LU*));}v->d[v->n++]=l;}
static void gv(GV*v,GT*g){if(v->n>=v->c){v->c=v->c?v->c*2:8;v->d=realloc(v->d,v->c*sizeof(GT*));}v->d[v->n++]=g;}
static void fv(FV*v,FILE*f){if(v->n>=v->c){v->c=v->c?v->c*2:8;v->d=realloc(v->d,v->c*sizeof(FILE*));}v->d[v->n++]=f;}
static void slv(SLV*v,S s){if(v->n>=v->c){v->c=v->c?v->c*2:8;v->d=realloc(v->d,v->c*sizeof(S));}v->d[v->n++]=s;}
struct No{Nk k;L l;Ty*ty;Sy*sy;union{S s;int64_t i;double f;struct{Tk op;No*l,*r;}bn;struct{Tk op;No*x;}un;struct{No*p;S at;NV ar;}at;struct{No*nm,*ag;}ql;struct{No*fn;NV ar;}cl;struct{No*p;NV ix;}ix;struct{No*p;No*lo,*hi;}sl;struct{No*p;S se;}se;struct{No*st;No*in;}alc;struct{No*lo,*hi;}rn;struct{No*rn;NV cs;}cn;struct{S nm;No*ty;No*in;bool al;uint32_t of,bt;No*dc;No*dsc;}cm;struct{NV ch;NV cmm;}vr;struct{No*ds;NV vrr;uint32_t sz;}vp;struct{S nm;No*ty;No*df;uint8_t md;}pm;struct{S nm;NV pmm;No*rt;S op;}sp;struct{No*sp;NV dc;NV st;NV hdd;int el;Sy*pr;NV lk;}bd;struct{S nm;NV dc;NV pr;int el;}ps;struct{S nm;NV dc;NV st;NV hddd;int el;}pb;struct{NV id;No*ty;No*in;bool co;}od;struct{S nm;No*df;No*ds;bool nw;bool drv;No*prt;NV dsc;}td;struct{S nm;No*in;No*cn;No*rn;}sd;struct{NV id;}ed;struct{S nm;No*rn;}re;struct{No*tg;No*vl;}as;struct{No*cd;NV th;NV ei;NV el;}if_;struct{No*ex;NV al;}cs;struct{S lb;No*it;bool rv;NV st;NV lk;}lp;struct{S lb;NV dc;NV st;NV hd;}bk;struct{S lb;No*cd;}ex;struct{No*vl;}rt;struct{S lb;}go;struct{No*ec;}rs;struct{No*nm;NV arr;}ct;struct{S nm;NV ixx;NV pmx;NV stx;NV hdx;No*gd;}acc;struct{NV al;NV el;}ss;struct{uint8_t kn;No*gd;NV sts;}sa;struct{S nm;NV en;bool it;}ts;struct{S nm;NV dc;NV st;NV hdz;}tb;struct{S nm;NV ixy;NV pmy;No*gd;}ent;struct{NV ec;NV stz;}hnd;struct{NV it;}ch;struct{NV ch;No*vl;}asc;struct{NV it;}lst;struct{NV wt;NV us;}cx;struct{S nm;}wt;struct{No*nm;}us;struct{S nm;NV ar;}pg;struct{No*cx;No*un;}cu;struct{No*x;}drf;struct{No*ty,*ex;}cvt;struct{No*ex;S ec;}chk;struct{No*bs;NV ops;}drv;struct{NV fp;NV dc;No*un;}gen;struct{S gn;NV ap;}gi;NV ag;};};
struct RC{uint8_t k;Ty*ty;union{struct{S nm;uint32_t po;}er;struct{S nm;uint64_t ad;}ad;struct{S nm;NV cp;}rr;};};
struct LU{uint8_t k;S nm;S pth;No*sp;No*bd;LV wth;LV elb;uint64_t ts;bool cmpl;};
struct GT{S nm;NV fp;NV dc;No*un;};
static No*nd(Nk k,L l){No*n=al(sizeof(No));n->k=k;n->l=l;return n;}
static RC*rc(uint8_t k,Ty*t){RC*r=al(sizeof(RC));r->k=k;r->ty=t;return r;}
static LU*lu(uint8_t k,S nm,S pth){LU*l=al(sizeof(LU));l->k=k;l->nm=nm;l->pth=pth;return l;}
static GT*gt(S nm){GT*g=al(sizeof(GT));g->nm=nm;return g;}
#define ND(k,l)nd(N_##k,l)
typedef struct{Lx lx;Tn cr,pk;int er;SLV lb;}Ps;
static void pn(Ps*p){p->cr=p->pk;p->pk=lnx(&p->lx);if(p->cr.t==T_AND&&p->pk.t==T_THEN){p->cr.t=T_ATHN;p->pk=lnx(&p->lx);}if(p->cr.t==T_OR&&p->pk.t==T_ELSE){p->cr.t=T_OREL;p->pk=lnx(&p->lx);}}
static bool pa(Ps*p,Tk t){return p->cr.t==t;}
static bool pm(Ps*p,Tk t){if(pa(p,t)){pn(p);return 1;}return 0;}
static void pe(Ps*p,Tk t){if(!pm(p,t))die(p->cr.l,"exp '%s' got '%s'",TN[t],TN[p->cr.t]);}
static L pl(Ps*p){return p->cr.l;}
static S pi(Ps*p){S s=p->cr.lit;pe(p,T_ID);return s;}
static S pat(Ps*p){S s;if(pa(p,T_ID))s=pi(p);else if(pa(p,T_RNG)){s=Z("RANGE");pn(p);}else if(pa(p,T_ACCS)){s=Z("ACCESS");pn(p);}else if(pa(p,T_DIG)){s=Z("DIGITS");pn(p);}else if(pa(p,T_DELTA)){s=Z("DELTA");pn(p);}else if(pa(p,T_MOD)){s=Z("MOD");pn(p);}else if(pa(p,T_REM)){s=Z("REM");pn(p);}else if(pa(p,T_ABS)){s=Z("ABS");pn(p);}else if(pa(p,T_NOT)){s=Z("NOT");pn(p);}else if(pa(p,T_AND)){s=Z("AND");pn(p);}else if(pa(p,T_OR)){s=Z("OR");pn(p);}else if(pa(p,T_XOR)){s=Z("XOR");pn(p);}else if(pa(p,T_PL)){s=Z("+");pn(p);}else if(pa(p,T_MN)){s=Z("-");pn(p);}else if(pa(p,T_ST)){s=Z("*");pn(p);}else if(pa(p,T_SL)){s=Z("/");pn(p);}else if(pa(p,T_EQ)){s=Z("=");pn(p);}else if(pa(p,T_NE)){s=Z("/=");pn(p);}else if(pa(p,T_LT)){s=Z("<");pn(p);}else if(pa(p,T_LE)){s=Z("<=");pn(p);}else if(pa(p,T_GT)){s=Z(">");pn(p);}else if(pa(p,T_GE)){s=Z(">=");pn(p);}else if(pa(p,T_AM)){s=Z("&");pn(p);}else if(pa(p,T_EX)){s=Z("**");pn(p);}else die(pl(p),"exp attr");return s;}
static No*pnm(Ps*p);static No*pex(Ps*p);static No*ppr(Ps*p);static No*prn(Ps*p);static NV pst(Ps*p);static NV pdc(Ps*p);static NV phd(Ps*p);static No*ps(Ps*p);static No*pgf(Ps*p);
static No*ppr(Ps*p){L lc=pl(p);if(pm(p,T_LP)){NV v={0};do{NV ch={0};No*e=pex(p);nv(&ch,e);while(pm(p,T_BR))nv(&ch,pex(p));if(pa(p,T_AR)){pn(p);No*vl=pex(p);for(uint32_t i=0;i<ch.n;i++){No*a=ND(ASC,lc);nv(&a->asc.ch,ch.d[i]);a->asc.vl=vl;nv(&v,a);}}else{if(ch.n==1)nv(&v,ch.d[0]);else die(lc,"exp '=>'");}}while(pm(p,T_CM));pe(p,T_RP);if(v.n==1&&v.d[0]->k!=N_ASC)return v.d[0];No*n=ND(AG,lc);n->ag=v;return n;}if(pm(p,T_NEW)){No*n=ND(ALC,lc);n->alc.st=pnm(p);if(pm(p,T_TK)){pe(p,T_LP);n->alc.in=pex(p);pe(p,T_RP);}return n;}if(pm(p,T_NULL))return ND(NULL,lc);if(pm(p,T_OTH)){No*n=ND(ID,lc);n->s=Z("others");return n;}if(pa(p,T_INT)){No*n=ND(INT,lc);n->i=p->cr.iv;pn(p);return n;}if(pa(p,T_REAL)){No*n=ND(REAL,lc);n->f=p->cr.fv;pn(p);return n;}if(pa(p,T_CHAR)){No*n=ND(CHAR,lc);n->i=p->cr.iv;pn(p);return n;}if(pa(p,T_STR)){No*n=ND(STR,lc);n->s=sd(p->cr.lit);pn(p);return n;}if(pa(p,T_ID))return pnm(p);if(pm(p,T_NOT)){No*n=ND(UN,lc);n->un.op=T_NOT;n->un.x=ppr(p);return n;}if(pm(p,T_ABS)){No*n=ND(UN,lc);n->un.op=T_ABS;n->un.x=ppr(p);return n;}if(pm(p,T_ALL)){No*n=ND(DRF,lc);n->drf.x=ppr(p);return n;}die(lc,"exp expr");}
static No*pnm(Ps*p){L lc=pl(p);No*n=ND(ID,lc);n->s=pi(p);for(;;){if(pm(p,T_DT)){if(pm(p,T_ALL)){No*m=ND(DRF,lc);m->drf.x=n;n=m;}else{No*m=ND(SEL,lc);m->se.p=n;if(pa(p,T_STR)){m->se.se=p->cr.lit;pn(p);}else m->se.se=pi(p);n=m;}}else if(pm(p,T_TK)){if(pa(p,T_LP)){pn(p);No*m=ND(QL,lc);m->ql.nm=n;NV v={0};do{NV ch={0};No*e=pex(p);nv(&ch,e);while(pm(p,T_BR))nv(&ch,pex(p));if(pa(p,T_AR)){pn(p);No*vl=pex(p);for(uint32_t i=0;i<ch.n;i++){No*a=ND(ASC,lc);nv(&a->asc.ch,ch.d[i]);a->asc.vl=vl;nv(&v,a);}}else{if(ch.n==1)nv(&v,ch.d[0]);else die(lc,"exp '=>'");}}while(pm(p,T_CM));pe(p,T_RP);if(v.n==1&&v.d[0]->k!=N_ASC)m->ql.ag=v.d[0];else{No*ag=ND(AG,lc);ag->ag=v;m->ql.ag=ag;}n=m;}else{S at=pat(p);No*m=ND(AT,lc);m->at.p=n;m->at.at=at;if(pm(p,T_LP)){do nv(&m->at.ar,pex(p));while(pm(p,T_CM));pe(p,T_RP);}n=m;}}else if(pa(p,T_LP)){pn(p);if(pa(p,T_RP)){pe(p,T_RP);No*m=ND(CL,lc);m->cl.fn=n;n=m;}else{NV v={0};do{NV ch={0};No*e=pex(p);nv(&ch,e);while(pm(p,T_BR))nv(&ch,pex(p));if(pa(p,T_AR)){pn(p);No*vl=pex(p);for(uint32_t i=0;i<ch.n;i++){No*a=ND(ASC,lc);nv(&a->asc.ch,ch.d[i]);a->asc.vl=vl;nv(&v,a);}}else{if(ch.n==1)nv(&v,ch.d[0]);else die(lc,"exp '=>'");}}while(pm(p,T_CM));pe(p,T_RP);if(pa(p,T_DD)){pn(p);No*hi=pex(p);if(v.n==1&&v.d[0]->k!=N_ASC){No*m=ND(SL,lc);m->sl.p=n;m->sl.lo=v.d[0];m->sl.hi=hi;n=m;}else{No*m=ND(CL,lc);m->cl.fn=n;m->cl.ar=v;n=m;}}else{No*m=ND(CL,lc);m->cl.fn=n;m->cl.ar=v;n=m;}}}else break;}return n;}
static No*ppw(Ps*p){No*n=ppr(p);if(pm(p,T_EX)){L lc=pl(p);No*m=ND(BIN,lc);m->bn.op=T_EX;m->bn.l=n;m->bn.r=ppw(p);return m;}return n;}
static No*pt(Ps*p){No*n=ppw(p);while(pa(p,T_ST)||pa(p,T_SL)||pa(p,T_MOD)||pa(p,T_REM)){Tk op=p->cr.t;pn(p);L lc=pl(p);No*m=ND(BIN,lc);m->bn.op=op;m->bn.l=n;m->bn.r=ppw(p);n=m;}return n;}
static No*psm(Ps*p){L lc=pl(p);Tk un=0;if(pm(p,T_MN))un=T_MN;else if(pm(p,T_PL))un=T_PL;No*n=pt(p);if(un){No*m=ND(UN,lc);m->un.op=un;m->un.x=n;n=m;}while(pa(p,T_PL)||pa(p,T_MN)||pa(p,T_AM)){Tk op=p->cr.t;pn(p);lc=pl(p);No*m=ND(BIN,lc);m->bn.op=op;m->bn.l=n;m->bn.r=pt(p);n=m;}return n;}
static No*prl(Ps*p){No*n=psm(p);if(pm(p,T_DD)){L lc=pl(p);No*m=ND(RN,lc);m->rn.lo=n;m->rn.hi=psm(p);return m;}if(pa(p,T_EQ)||pa(p,T_NE)||pa(p,T_LT)||pa(p,T_LE)||pa(p,T_GT)||pa(p,T_GE)||pa(p,T_IN)||pa(p,T_NOT)){Tk op=p->cr.t;pn(p);if(op==T_NOT)pe(p,T_IN);L lc=pl(p);No*m=ND(BIN,lc);m->bn.op=op;m->bn.l=n;if(op==T_IN||op==T_NOT)m->bn.r=prn(p);else m->bn.r=psm(p);return m;}return n;}
static No*pan(Ps*p){No*n=prl(p);while(pa(p,T_AND)||pa(p,T_ATHN)){Tk op=p->cr.t;pn(p);L lc=pl(p);No*m=ND(BIN,lc);m->bn.op=op;m->bn.l=n;m->bn.r=prl(p);n=m;}return n;}
static No*por(Ps*p){No*n=pan(p);while(pa(p,T_OR)||pa(p,T_OREL)||pa(p,T_XOR)){Tk op=p->cr.t;pn(p);L lc=pl(p);No*m=ND(BIN,lc);m->bn.op=op;m->bn.l=n;m->bn.r=pan(p);n=m;}return n;}
static No*pex(Ps*p){return por(p);}
static No*prn(Ps*p){L lc=pl(p);if(pm(p,T_BX)){No*n=ND(RN,lc);n->rn.lo=0;n->rn.hi=0;return n;}No*lo=psm(p);if(pm(p,T_DD)){No*m=ND(RN,lc);m->rn.lo=lo;m->rn.hi=psm(p);return m;}return lo;}
static No*psi(Ps*p){No*n=pnm(p);if(pm(p,T_DELTA)){psm(p);}if(pm(p,T_RNG)){L lc=pl(p);No*c=ND(CN,lc);c->cn.rn=prn(p);No*m=ND(ST,lc);m->sd.in=n;m->sd.cn=c;return m;}if(pa(p,T_LP)){pn(p);L lc=pl(p);No*c=ND(CN,lc);do nv(&c->cn.cs,prn(p));while(pm(p,T_CM));pe(p,T_RP);No*m=ND(ST,lc);m->sd.in=n;m->sd.cn=c;return m;}return n;}
static NV ppm(Ps*p){NV v={0};if(!pm(p,T_LP))return v;do{L lc=pl(p);NV id={0};do{S nm=pi(p);No*i=ND(ID,lc);i->s=nm;nv(&id,i);}while(pm(p,T_CM));pe(p,T_CL);uint8_t md=0;if(pm(p,T_IN))md|=1;if(pm(p,T_OUT))md|=2;if(!md)md=1;No*ty=pnm(p);No*df=0;if(pm(p,T_AS))df=pex(p);for(uint32_t i=0;i<id.n;i++){No*n=ND(PM,lc);n->pm.nm=id.d[i]->s;n->pm.ty=ty;n->pm.df=df;n->pm.md=md;nv(&v,n);}}while(pm(p,T_SC));pe(p,T_RP);return v;}
static No*pps_(Ps*p){L lc=pl(p);pe(p,T_PROC);No*n=ND(PS,lc);if(pa(p,T_STR)){n->sp.nm=p->cr.lit;pn(p);}else n->sp.nm=pi(p);n->sp.pmm=ppm(p);return n;}
static No*pfs(Ps*p){L lc=pl(p);pe(p,T_FUN);No*n=ND(FS,lc);if(pa(p,T_STR)){n->sp.nm=p->cr.lit;pn(p);}else n->sp.nm=pi(p);n->sp.pmm=ppm(p);pe(p,T_RET);n->sp.rt=pnm(p);return n;}
static No*ptd(Ps*p);
static NV pgfp(Ps*p){NV v={0};while(!pa(p,T_PROC)&&!pa(p,T_FUN)&&!pa(p,T_PKG)){if(pm(p,T_TYP)){L lc=pl(p);S nm=pi(p);bool isp=false;if(pm(p,T_IS)){if(pm(p,T_DIG)||pm(p,T_DELTA)||pm(p,T_RNG)){pe(p,T_BX);}else if(pm(p,T_LP)){pe(p,T_BX);pe(p,T_RP);isp=true;}else if(pa(p,T_ARR)||pa(p,T_REC)||pa(p,T_ACCS)||pa(p,T_PRV)){ptd(p);}else pex(p);}No*n=ND(GTP,lc);n->td.nm=nm;nv(&v,n);pe(p,T_SC);}else if(pm(p,T_WITH)){if(pa(p,T_PROC)){No*sp=pps_(p);sp->k=N_GSP;nv(&v,sp);}else if(pa(p,T_FUN)){No*sp=pfs(p);sp->k=N_GSP;nv(&v,sp);}else{L lc=pl(p);S nm=pi(p);pe(p,T_CL);uint8_t md=0;if(pm(p,T_IN))md|=1;if(pm(p,T_OUT))md|=2;if(!md)md=1;No*ty=pnm(p);pm(p,T_AS);if(!pa(p,T_SC))pex(p);No*n=ND(GVL,lc);n->od.id.n=1;No*id=ND(ID,lc);id->s=nm;n->od.id.d=realloc(0,sizeof(No*));n->od.id.d[0]=id;n->od.ty=ty;nv(&v,n);}pe(p,T_SC);}else{L lc=pl(p);S nm=pi(p);pe(p,T_CL);uint8_t md=0;if(pm(p,T_IN))md|=1;if(pm(p,T_OUT))md|=2;if(!md)md=1;No*ty=pnm(p);pm(p,T_AS);if(!pa(p,T_SC))pex(p);No*n=ND(GVL,lc);n->od.id.n=1;No*id=ND(ID,lc);id->s=nm;n->od.id.d=realloc(0,sizeof(No*));n->od.id.d[0]=id;n->od.ty=ty;nv(&v,n);pe(p,T_SC);}}return v;}
static No*pgf(Ps*p){L lc=pl(p);pe(p,T_GEN);No*n=ND(GEN,lc);n->gen.fp=pgfp(p);if(pa(p,T_PROC)){No*sp=pps_(p);pe(p,T_SC);n->gen.un=ND(PD,lc);n->gen.un->bd.sp=sp;return n;}if(pa(p,T_FUN)){No*sp=pfs(p);pe(p,T_SC);n->gen.un=ND(FD,lc);n->gen.un->bd.sp=sp;return n;}if(pm(p,T_PKG)){S nm=pi(p);pe(p,T_IS);n->gen.dc=pdc(p);pe(p,T_END);if(pa(p,T_ID))pn(p);pe(p,T_SC);No*pk=ND(PKS,lc);pk->ps.nm=nm;pk->ps.dc=n->gen.dc;n->gen.un=pk;return n;}return n;}
static No*pif(Ps*p){L lc=pl(p);pe(p,T_IF);No*n=ND(IF,lc);n->if_.cd=pex(p);pe(p,T_THEN);while(!pa(p,T_ELSIF)&&!pa(p,T_ELSE)&&!pa(p,T_END))nv(&n->if_.th,ps(p));while(pm(p,T_ELSIF)){No*e=ND(EL,lc);e->if_.cd=pex(p);pe(p,T_THEN);while(!pa(p,T_ELSIF)&&!pa(p,T_ELSE)&&!pa(p,T_END))nv(&e->if_.th,ps(p));nv(&n->if_.ei,e);}if(pm(p,T_ELSE))while(!pa(p,T_END))nv(&n->if_.el,ps(p));pe(p,T_END);pe(p,T_IF);pe(p,T_SC);return n;}
static No*pcs(Ps*p){L lc=pl(p);pe(p,T_CSE);No*n=ND(CS,lc);n->cs.ex=pex(p);pe(p,T_IS);while(pm(p,T_WHN)){No*a=ND(WH,lc);do nv(&a->ch.it,pex(p));while(pm(p,T_BR));pe(p,T_AR);while(!pa(p,T_WHN)&&!pa(p,T_END))nv(&a->hnd.stz,ps(p));nv(&n->cs.al,a);}pe(p,T_END);pe(p,T_CSE);pe(p,T_SC);return n;}
static No*plp(Ps*p,S lb){L lc=pl(p);No*n=ND(LP,lc);n->lp.lb=lb;if(pm(p,T_WHI))n->lp.it=pex(p);else if(pm(p,T_FOR)){S vr=pi(p);pe(p,T_IN);n->lp.rv=pm(p,T_REV);No*rng=prn(p);if(pm(p,T_RNG)){No*r=ND(RN,lc);r->rn.lo=psm(p);pe(p,T_DD);r->rn.hi=psm(p);rng=r;}No*it=ND(BIN,lc);it->bn.op=T_IN;it->bn.l=ND(ID,lc);it->bn.l->s=vr;it->bn.r=rng;n->lp.it=it;}pe(p,T_LOOP);while(!pa(p,T_END))nv(&n->lp.st,ps(p));pe(p,T_END);pe(p,T_LOOP);if(pa(p,T_ID))pn(p);pe(p,T_SC);return n;}
static No*pbk(Ps*p,S lb){L lc=pl(p);No*n=ND(BL,lc);n->bk.lb=lb;if(pm(p,T_DEC))n->bk.dc=pdc(p);pe(p,T_BEG);while(!pa(p,T_EXCP)&&!pa(p,T_END))nv(&n->bk.st,ps(p));if(pm(p,T_EXCP))n->bk.hd=phd(p);pe(p,T_END);if(pa(p,T_ID))pn(p);pe(p,T_SC);return n;}
static No*psl(Ps*p){L lc=pl(p);pe(p,T_SEL);No*n=ND(SA,lc);n->sa.kn=0;if(pm(p,T_DEL)){n->sa.kn=1;n->sa.gd=pex(p);pe(p,T_THEN);if(pm(p,T_AB))n->sa.kn=3;while(!pa(p,T_OR)&&!pa(p,T_ELSE)&&!pa(p,T_END))nv(&n->sa.sts,ps(p));}else if(pa(p,T_WHN)){while(pm(p,T_WHN)){No*g=ND(WH,lc);do nv(&g->ch.it,pex(p));while(pm(p,T_BR));pe(p,T_AR);if(pm(p,T_ACC)){g->k=N_ACC;g->acc.nm=pi(p);if(pa(p,T_LP)){if(p->pk.t==T_ID){Tn scr=p->cr,spk=p->pk;Lx slx=p->lx;pn(p);pn(p);if(p->cr.t==T_CM||p->cr.t==T_CL){p->cr=scr;p->pk=spk;p->lx=slx;g->acc.pmx=ppm(p);}else{p->cr=scr;p->pk=spk;p->lx=slx;pe(p,T_LP);do nv(&g->acc.ixx,pex(p));while(pm(p,T_CM));pe(p,T_RP);g->acc.pmx=ppm(p);}}else{pe(p,T_LP);do nv(&g->acc.ixx,pex(p));while(pm(p,T_CM));pe(p,T_RP);g->acc.pmx=ppm(p);}}else{g->acc.pmx=ppm(p);}if(pm(p,T_DO)){while(!pa(p,T_END)&&!pa(p,T_OR)&&!pa(p,T_ELSE))nv(&g->acc.stx,ps(p));pe(p,T_END);if(pa(p,T_ID))pn(p);}}else if(pm(p,T_TER)){g->k=N_TRM;}else if(pm(p,T_DEL)){g->k=N_DL;g->ex.cd=pex(p);pe(p,T_THEN);while(!pa(p,T_OR)&&!pa(p,T_ELSE)&&!pa(p,T_END))nv(&g->hnd.stz,ps(p));}nv(&n->sa.sts,g);}}else{do{No*g=ND(WH,lc);if(pm(p,T_ACC)){g->k=N_ACC;g->acc.nm=pi(p);if(pa(p,T_LP)){if(p->pk.t==T_ID){Tn scr=p->cr,spk=p->pk;Lx slx=p->lx;pn(p);pn(p);if(p->cr.t==T_CM||p->cr.t==T_CL){p->cr=scr;p->pk=spk;p->lx=slx;g->acc.pmx=ppm(p);}else{p->cr=scr;p->pk=spk;p->lx=slx;pe(p,T_LP);do nv(&g->acc.ixx,pex(p));while(pm(p,T_CM));pe(p,T_RP);g->acc.pmx=ppm(p);}}else{pe(p,T_LP);do nv(&g->acc.ixx,pex(p));while(pm(p,T_CM));pe(p,T_RP);g->acc.pmx=ppm(p);}}else{g->acc.pmx=ppm(p);}if(pm(p,T_DO)){while(!pa(p,T_END)&&!pa(p,T_OR)&&!pa(p,T_ELSE))nv(&g->acc.stx,ps(p));pe(p,T_END);if(pa(p,T_ID))pn(p);}pe(p,T_SC);}else if(pm(p,T_DEL)){g->k=N_DL;g->ex.cd=pex(p);pe(p,T_SC);}else if(pm(p,T_TER)){g->k=N_TRM;pe(p,T_SC);}nv(&n->sa.sts,g);}while(pm(p,T_OR));}if(pm(p,T_ELSE))while(!pa(p,T_END))nv(&n->ss.el,ps(p));pe(p,T_END);pe(p,T_SEL);pe(p,T_SC);return n;}
static No*ps(Ps*p){L lc=pl(p);S lb=N;if(pa(p,T_LL)){pn(p);lb=pi(p);pe(p,T_GG);slv(&p->lb,lb);}else if(pa(p,T_ID)&&p->pk.t==T_CL){lb=pi(p);pe(p,T_CL);slv(&p->lb,lb);}if(pa(p,T_IF))return pif(p);if(pa(p,T_CSE))return pcs(p);if(pa(p,T_SEL))return psl(p);if(pa(p,T_LOOP)||pa(p,T_WHI)||pa(p,T_FOR))return plp(p,lb);if(pa(p,T_DEC)||pa(p,T_BEG))return pbk(p,lb);if(pm(p,T_ACC)){No*n=ND(ACC,lc);n->acc.nm=pi(p);if(pa(p,T_LP)){if(p->pk.t==T_ID){Tn scr=p->cr,spk=p->pk;Lx slx=p->lx;pn(p);pn(p);if(p->cr.t==T_CM||p->cr.t==T_CL){p->cr=scr;p->pk=spk;p->lx=slx;n->acc.pmx=ppm(p);}else{p->cr=scr;p->pk=spk;p->lx=slx;pe(p,T_LP);do nv(&n->acc.ixx,pex(p));while(pm(p,T_CM));pe(p,T_RP);n->acc.pmx=ppm(p);}}else{pe(p,T_LP);do nv(&n->acc.ixx,pex(p));while(pm(p,T_CM));pe(p,T_RP);n->acc.pmx=ppm(p);}}else{n->acc.pmx=ppm(p);}if(pm(p,T_DO)){while(!pa(p,T_END))nv(&n->acc.stx,ps(p));pe(p,T_END);if(pa(p,T_ID))pn(p);}pe(p,T_SC);return n;}if(pm(p,T_DEL)){No*n=ND(DL,lc);n->ex.cd=pex(p);pe(p,T_SC);return n;}if(pm(p,T_AB)){No*n=ND(AB,lc);if(!pa(p,T_SC))n->rs.ec=pnm(p);pe(p,T_SC);return n;}if(pm(p,T_RET)){No*n=ND(RT,lc);if(!pa(p,T_SC))n->rt.vl=pex(p);pe(p,T_SC);return n;}if(pm(p,T_EXIT)){No*n=ND(EX,lc);if(pa(p,T_ID))n->ex.lb=pi(p);if(pm(p,T_WHN))n->ex.cd=pex(p);pe(p,T_SC);return n;}if(pm(p,T_GOTO)){No*n=ND(GT,lc);n->go.lb=pi(p);pe(p,T_SC);return n;}if(pm(p,T_RAS)){No*n=ND(RS,lc);if(!pa(p,T_SC))n->rs.ec=pnm(p);pe(p,T_SC);return n;}if(pm(p,T_NULL)){pe(p,T_SC);return ND(NS,lc);}if(pm(p,T_PGM)){No*n=ND(PG,lc);n->pg.nm=pi(p);if(pm(p,T_LP)){do nv(&n->pg.ar,pex(p));while(pm(p,T_CM));pe(p,T_RP);}pe(p,T_SC);return n;}No*e=pnm(p);if(pm(p,T_AS)){No*n=ND(AS,lc);if(e&&e->k==N_CL){No*fn=e->cl.fn;NV ar=e->cl.ar;e->k=N_IX;e->ix.p=fn;e->ix.ix=ar;}n->as.tg=e;n->as.vl=pex(p);pe(p,T_SC);return n;}No*n=ND(CLT,lc);if(e->k==N_IX){n->ct.nm=e->ix.p;n->ct.arr=e->ix.ix;}else if(e->k==N_CL){n->ct.nm=e->cl.fn;n->ct.arr=e->cl.ar;}else n->ct.nm=e;pe(p,T_SC);return n;}
static NV pst(Ps*p){NV v={0};while(!pa(p,T_END)&&!pa(p,T_EXCP)&&!pa(p,T_ELSIF)&&!pa(p,T_ELSE)&&!pa(p,T_WHN)&&!pa(p,T_OR))nv(&v,ps(p));return v;}
static NV phd(Ps*p){NV v={0};while(pm(p,T_WHN)){L lc=pl(p);No*h=ND(HD,lc);do{if(pm(p,T_OTH)){No*n=ND(ID,lc);n->s=Z("others");nv(&h->hnd.ec,n);}else nv(&h->hnd.ec,pnm(p));}while(pm(p,T_BR));pe(p,T_AR);while(!pa(p,T_WHN)&&!pa(p,T_END))nv(&h->hnd.stz,ps(p));nv(&v,h);}return v;}
static No*ptd(Ps*p){L lc=pl(p);if(pm(p,T_LP)){No*n=ND(TE,lc);do{if(pa(p,T_CHAR)){No*c=ND(CHAR,lc);c->i=p->cr.iv;pn(p);nv(&n->lst.it,c);}else{S nm=pi(p);No*i=ND(ID,lc);i->s=nm;nv(&n->lst.it,i);}}while(pm(p,T_CM));pe(p,T_RP);return n;}if(pm(p,T_RNG)){No*n=ND(TI,lc);if(pm(p,T_BX)){n->rn.lo=0;n->rn.hi=0;}else{n->rn.lo=psm(p);pe(p,T_DD);n->rn.hi=psm(p);}return n;}if(pm(p,T_MOD)){No*n=ND(TI,lc);n->un.op=T_MOD;n->un.x=pex(p);return n;}if(pm(p,T_DIG)){No*n=ND(TF,lc);if(pm(p,T_BX))n->un.x=0;else n->un.x=pex(p);if(pm(p,T_RNG)){n->rn.lo=psm(p);pe(p,T_DD);n->rn.hi=psm(p);}return n;}if(pm(p,T_DELTA)){No*n=ND(TX,lc);if(pm(p,T_BX)){n->rn.lo=0;n->rn.hi=0;n->bn.r=0;}else{n->rn.lo=pex(p);pe(p,T_RNG);n->rn.hi=psm(p);pe(p,T_DD);n->bn.r=psm(p);}return n;}if(pm(p,T_ARR)){pe(p,T_LP);No*n=ND(TA,lc);do{if(pa(p,T_ID)){No*ty=psi(p);if(pm(p,T_RNG)){No*cn=ND(ST,lc);cn->sd.in=ty;cn->sd.cn=ND(CN,lc);cn->sd.cn->cn.rn=prn(p);nv(&n->ix.ix,cn);}else if(pm(p,T_DD)){No*r=ND(RN,lc);r->rn.lo=ty;r->rn.hi=psm(p);nv(&n->ix.ix,r);}else nv(&n->ix.ix,ty);}else nv(&n->ix.ix,prn(p));}while(pm(p,T_CM));pe(p,T_RP);pe(p,T_OF);n->ix.p=psi(p);return n;}if(pm(p,T_REC)){No*n=ND(TR,lc);uint32_t of=0;NV dc={0};if(pm(p,T_LP)){do{S dn=pi(p);pe(p,T_CL);No*dt=pnm(p);No*dd=0;if(pm(p,T_AS))dd=pex(p);No*dp=ND(DS,lc);dp->pm.nm=dn;dp->pm.ty=dt;dp->pm.df=dd;nv(&dc,dp);}while(pm(p,T_SC));pe(p,T_RP);if(!pa(p,T_IS))pe(p,T_SC);}if(pm(p,T_IS)){pe(p,T_REC);}while(!pa(p,T_END)&&!pa(p,T_CSE)&&!pa(p,T_NULL)){NV id={0};do{S nm=pi(p);No*i=ND(ID,lc);i->s=nm;nv(&id,i);}while(pm(p,T_CM));pe(p,T_CL);No*ty=psi(p);No*in=0;if(pm(p,T_AS))in=pex(p);pe(p,T_SC);for(uint32_t i=0;i<id.n;i++){No*c=ND(CM,lc);c->cm.nm=id.d[i]->s;c->cm.ty=ty;c->cm.in=in;c->cm.of=of++;c->cm.dc=0;c->cm.dsc=0;if(dc.n>0){c->cm.dc=ND(LST,lc);c->cm.dc->lst.it=dc;}nv(&n->lst.it,c);}}if(pm(p,T_NULL)){pe(p,T_SC);}if(pm(p,T_CSE)){No*vp=ND(VP,lc);vp->vp.ds=pnm(p);pe(p,T_IS);while(pm(p,T_WHN)){No*v=ND(VR,lc);do{No*e=pex(p);if(pm(p,T_DD)){No*r=ND(RN,lc);r->rn.lo=e;r->rn.hi=pex(p);e=r;}nv(&v->vr.ch,e);}while(pm(p,T_BR));pe(p,T_AR);while(!pa(p,T_WHN)&&!pa(p,T_END)&&!pa(p,T_NULL)){NV id={0};do{S nm=pi(p);No*i=ND(ID,lc);i->s=nm;nv(&id,i);}while(pm(p,T_CM));pe(p,T_CL);No*ty=psi(p);No*in=0;if(pm(p,T_AS))in=pex(p);pe(p,T_SC);for(uint32_t i=0;i<id.n;i++){No*c=ND(CM,lc);c->cm.nm=id.d[i]->s;c->cm.ty=ty;c->cm.in=in;c->cm.of=of++;c->cm.dc=0;c->cm.dsc=0;if(dc.n>0){c->cm.dc=ND(LST,lc);c->cm.dc->lst.it=dc;}nv(&v->vr.cmm,c);}}nv(&vp->vp.vrr,v);}vp->vp.sz=of;if(pm(p,T_NULL)){pe(p,T_REC);}pe(p,T_END);pe(p,T_CSE);pe(p,T_SC);nv(&n->lst.it,vp);}pe(p,T_END);pe(p,T_REC);return n;}if(pm(p,T_ACCS)){No*n=ND(TAC,lc);n->un.x=psi(p);return n;}if(pm(p,T_PRV))return ND(TP,lc);if(pm(p,T_LIM)){pm(p,T_PRV);return ND(TP,lc);}return psi(p);}
static RC*prc(Ps*p){L lc=pl(p);if(pm(p,T_FOR)){pnm(p);pe(p,T_USE);if(pm(p,T_AT)){RC*r=rc(2,0);pex(p);pe(p,T_SC);return r;}if(pm(p,T_REC)){while(!pa(p,T_END)){pi(p);pe(p,T_AT);pex(p);pe(p,T_RNG);prn(p);pe(p,T_SC);}pe(p,T_END);pe(p,T_REC);pe(p,T_SC);return 0;}pex(p);pe(p,T_SC);return 0;}if(pm(p,T_PGM)){S nm=pi(p);if(si(nm,Z("ELABORATE"))||si(nm,Z("ELABORATE_ALL"))||si(nm,Z("PACK"))){pe(p,T_LP);do pi(p);while(pm(p,T_CM));pe(p,T_RP);}pe(p,T_SC);}return 0;}
static No*pdl(Ps*p){L lc=pl(p);if(pa(p,T_GEN))return pgf(p);if(pm(p,T_TYP)){S nm=pi(p);No*n=ND(TD,lc);n->td.nm=nm;if(pm(p,T_LP)){No*ds=ND(LST,lc);do{NV dn={0};do{S dnm=pi(p);No*di=ND(ID,lc);di->s=dnm;nv(&dn,di);}while(pm(p,T_CM));pe(p,T_CL);No*dt=pnm(p);No*dd=0;if(pm(p,T_AS))dd=pex(p);for(uint32_t i=0;i<dn.n;i++){No*dp=ND(DS,lc);dp->pm.nm=dn.d[i]->s;dp->pm.ty=dt;dp->pm.df=dd;nv(&ds->lst.it,dp);}}while(pm(p,T_SC));pe(p,T_RP);n->td.dsc=ds->lst.it;}if(pm(p,T_IS)){n->td.nw=pm(p,T_NEW);n->td.drv=n->td.nw;if(n->td.drv){n->td.prt=pnm(p);n->td.df=n->td.prt;if(pm(p,T_DIG)){pex(p);if(pm(p,T_RNG)){psm(p);pe(p,T_DD);psm(p);}}else if(pm(p,T_DELTA)){pex(p);pe(p,T_RNG);psm(p);pe(p,T_DD);psm(p);}else if(pm(p,T_RNG)){No*rn=ND(RN,lc);rn->rn.lo=psm(p);pe(p,T_DD);rn->rn.hi=psm(p);n->td.df=rn;}}else n->td.df=ptd(p);}pe(p,T_SC);return n;}if(pm(p,T_SUB)){S nm=pi(p);pe(p,T_IS);No*n=ND(SD,lc);n->sd.nm=nm;n->sd.in=psi(p);if(n->sd.in->k==N_ST)n->sd.rn=n->sd.in->sd.cn->cn.rn;pe(p,T_SC);return n;}if(pa(p,T_PROC)){No*sp=pps_(p);if(pm(p,T_REN)){pex(p);pe(p,T_SC);No*n=ND(PD,lc);n->bd.sp=sp;return n;}if(pm(p,T_IS)){if(pm(p,T_SEP)){pe(p,T_SC);No*n=ND(PD,lc);n->bd.sp=sp;return n;}if(pm(p,T_NEW)){S gn=pi(p);NV ap={0};if(pm(p,T_LP)){do nv(&ap,pex(p));while(pm(p,T_CM));pe(p,T_RP);}pe(p,T_SC);No*n=ND(GINST,lc);n->gi.gn=gn;n->gi.ap=ap;return n;}No*n=ND(PB,lc);n->bd.sp=sp;n->bd.dc=pdc(p);pe(p,T_BEG);n->bd.st=pst(p);if(pm(p,T_EXCP))n->bd.hdd=phd(p);pe(p,T_END);if(pa(p,T_ID)||pa(p,T_STR))pn(p);pe(p,T_SC);return n;}pe(p,T_SC);No*n=ND(PD,lc);n->bd.sp=sp;return n;}if(pm(p,T_FUN)){S nm;if(pa(p,T_STR)){nm=p->cr.lit;pn(p);}else nm=pi(p);if(pm(p,T_IS)&&pm(p,T_NEW)){S gn=pi(p);NV ap={0};if(pm(p,T_LP)){do nv(&ap,pex(p));while(pm(p,T_CM));pe(p,T_RP);}pe(p,T_SC);No*n=ND(GINST,lc);n->gi.gn=gn;n->gi.ap=ap;return n;}No*sp=ND(FS,lc);sp->sp.nm=nm;sp->sp.pmm=ppm(p);pe(p,T_RET);sp->sp.rt=pnm(p);if(pm(p,T_REN)){pex(p);pe(p,T_SC);No*n=ND(FD,lc);n->bd.sp=sp;return n;}if(pm(p,T_IS)){if(pm(p,T_SEP)){pe(p,T_SC);No*n=ND(FD,lc);n->bd.sp=sp;return n;}No*n=ND(FB,lc);n->bd.sp=sp;n->bd.dc=pdc(p);pe(p,T_BEG);n->bd.st=pst(p);if(pm(p,T_EXCP))n->bd.hdd=phd(p);pe(p,T_END);if(pa(p,T_ID)||pa(p,T_STR))pn(p);pe(p,T_SC);return n;}pe(p,T_SC);No*n=ND(FD,lc);n->bd.sp=sp;return n;}if(pm(p,T_PKG)){if(pm(p,T_BOD)){S nm=pi(p);pe(p,T_IS);No*n=ND(PKB,lc);n->pb.nm=nm;n->pb.dc=pdc(p);if(pm(p,T_BEG)){n->pb.st=pst(p);if(pm(p,T_EXCP))n->pb.hddd=phd(p);}pe(p,T_END);if(pa(p,T_ID))pn(p);pe(p,T_SC);return n;}S nm=pi(p);pe(p,T_IS);if(pm(p,T_NEW)){S gn=pi(p);NV ap={0};if(pm(p,T_LP)){do nv(&ap,pex(p));while(pm(p,T_CM));pe(p,T_RP);}pe(p,T_SC);No*n=ND(GINST,lc);n->gi.gn=gn;n->gi.ap=ap;return n;}No*n=ND(PKS,lc);n->ps.nm=nm;n->ps.dc=pdc(p);if(pm(p,T_PRV))n->ps.pr=pdc(p);pe(p,T_END);if(pa(p,T_ID))pn(p);pe(p,T_SC);return n;}if(pm(p,T_TSK)){if(pm(p,T_BOD)){S nm=pi(p);pe(p,T_IS);No*n=ND(TKB,lc);n->tb.nm=nm;n->tb.dc=pdc(p);pe(p,T_BEG);n->tb.st=pst(p);if(pm(p,T_EXCP))n->tb.hdz=phd(p);pe(p,T_END);if(pa(p,T_ID))pn(p);pe(p,T_SC);return n;}bool it=pm(p,T_TYP);S nm=pi(p);No*n=ND(TKS,lc);n->ts.nm=nm;n->ts.it=it;if(pm(p,T_IS)){while(!pa(p,T_END)){if(pm(p,T_ENT)){No*e=ND(ENT,lc);e->ent.nm=pi(p);if(pa(p,T_LP)){if(p->pk.t==T_ID){Tn scr=p->cr,spk=p->pk;Lx slx=p->lx;pn(p);pn(p);if(p->cr.t==T_CM||p->cr.t==T_CL){p->cr=scr;p->pk=spk;p->lx=slx;e->ent.pmy=ppm(p);}else{p->cr=scr;p->pk=spk;p->lx=slx;pe(p,T_LP);nv(&e->ent.ixy,pnm(p));pe(p,T_RP);e->ent.pmy=ppm(p);}}else{pe(p,T_LP);nv(&e->ent.ixy,pnm(p));pe(p,T_RP);e->ent.pmy=ppm(p);}}else{e->ent.pmy=ppm(p);}pe(p,T_SC);nv(&n->ts.en,e);}else if(pm(p,T_PGM)){pi(p);if(pm(p,T_LP)){do pex(p);while(pm(p,T_CM));pe(p,T_RP);}pe(p,T_SC);}}pe(p,T_END);if(pa(p,T_ID))pn(p);}pe(p,T_SC);return n;}if(pm(p,T_USE)){NV nms={0};do nv(&nms,pnm(p));while(pm(p,T_CM));pe(p,T_SC);if(nms.n==1){No*n=ND(US,lc);n->us.nm=nms.d[0];return n;}No*lst=ND(LST,lc);for(uint32_t i=0;i<nms.n;i++){No*u=ND(US,lc);u->us.nm=nms.d[i];nv(&lst->lst.it,u);}return lst;}if(pm(p,T_PGM)){No*n=ND(PG,lc);n->pg.nm=pi(p);if(pm(p,T_LP)){do nv(&n->pg.ar,pex(p));while(pm(p,T_CM));pe(p,T_RP);}pe(p,T_SC);return n;}{NV id={0};do{S nm=pi(p);No*i=ND(ID,lc);i->s=nm;nv(&id,i);}while(pm(p,T_CM));pe(p,T_CL);bool co=pm(p,T_CONST);if(pm(p,T_EXCP)){No*n=ND(ED,lc);n->ed.id=id;pe(p,T_SC);return n;}No*ty=0;if(!pa(p,T_AS)){if(pa(p,T_ARR)||pa(p,T_ACCS))ty=ptd(p);else ty=psi(p);}No*in=0;if(pm(p,T_REN))in=pex(p);else if(pm(p,T_AS))in=pex(p);pe(p,T_SC);No*n=ND(OD,lc);n->od.id=id;n->od.ty=ty;n->od.in=in;n->od.co=co;return n;}}
static NV pdc(Ps*p){NV v={0};while(!pa(p,T_BEG)&&!pa(p,T_END)&&!pa(p,T_PRV)&&!pa(p,T_EOF)&&!pa(p,T_ENT)){if(pa(p,T_FOR)){RC*r=prc(p);if(r){No*n=ND(RRC,pl(p));memcpy(&n->ag.d,&r,sizeof(RC*));nv(&v,n);}continue;}nv(&v,pdl(p));}return v;}
static No*pcx(Ps*p){L lc=pl(p);No*cx=ND(CX,lc);while(pa(p,T_WITH)||pa(p,T_USE)||pa(p,T_PGM)){if(pm(p,T_WITH)){do{No*w=ND(WI,lc);w->wt.nm=pi(p);nv(&cx->cx.wt,w);}while(pm(p,T_CM));pe(p,T_SC);}else if(pm(p,T_USE)){do{No*u=ND(US,lc);u->us.nm=pnm(p);nv(&cx->cx.us,u);}while(pm(p,T_CM));pe(p,T_SC);}else{No*pg=pdl(p);if(pg)nv(&cx->cx.us,pg);}}return cx;}
static No*pcu(Ps*p){L lc=pl(p);No*n=ND(CU,lc);n->cu.cx=pcx(p);if(pa(p,T_PROC)||pa(p,T_FUN)||pa(p,T_PKG)||pa(p,T_GEN))n->cu.un=pdl(p);return n;}
static Ps pnw(const char*s,size_t z,const char*f){Ps p={ln(s,z,f)};pn(&p);pn(&p);return p;}
typedef enum{TY_V=0,TY_I,TY_B,TY_C,TY_F,TY_E,TY_A,TY_R,TY_AC,TY_T,TY_S,TY_P,TY_UI,TY_UF,TY_D,TY_PT,TY_FT,TY_FX}Tk_;
struct Ty{Tk_ k;S nm;Ty*bs,*el,*prt;int64_t lo,hi;NV cm,dc;uint32_t sz,al;SV ev;RV rc;uint64_t ad;bool pk;NV ops;int64_t sm,lg;};
struct Sy{S nm;uint8_t k;Ty*ty;No*df;Sy*nx,*pv;int sc;int64_t vl;uint32_t of;NV ol;SV us;int el;GT*gt;Sy*pr;int lv;};
typedef struct{Sy*sy[4096];int sc;No*ds;No*pk;SV uv;int eo;LV lu;GV gt;jmp_buf*eb[16];int ed;S ce[16];FV io;int fn;SLV lb;int lv;}Sm;
static uint32_t syh(S s){return sh(s)&4095;}
static Sy*syn(S nm,uint8_t k,Ty*ty,No*df){Sy*s=al(sizeof(Sy));s->nm=nm;s->k=k;s->ty=ty;s->df=df;s->el=-1;s->lv=-1;return s;}
static Sy*sya(Sm*SM,Sy*s){uint32_t h=syh(s->nm);s->nx=SM->sy[h];s->sc=SM->sc;s->el=SM->eo++;s->lv=SM->lv;SM->sy[h]=s;return s;}
static Sy*syf(Sm*SM,S nm){for(Sy*s=SM->sy[syh(nm)];s;s=s->nx)if(si(s->nm,nm)&&s->sc<=SM->sc)return s;for(uint32_t i=0;i<SM->uv.n;i++)for(Sy*u=SM->uv.d[i];u;u=u->nx)if(si(u->nm,nm))return u;return 0;}
static void sfu(Sm*SM,Sy*s,S nm){for(Sy*p=s;p;p=p->nx)if(si(p->nm,nm)&&p->k==6&&p->df&&p->df->k==N_PKS){No*pk=p->df;for(uint32_t i=0;i<pk->ps.dc.n;i++){No*d=pk->ps.dc.d[i];if(d->sy)sv(&s->us,d->sy);}}}
static GT*gfnd(Sm*SM,S nm){for(uint32_t i=0;i<SM->gt.n;i++){GT*g=SM->gt.d[i];if(si(g->nm,nm))return g;}return 0;}
static int tysc(Ty*a,Ty*b,Ty*tx){if(!a||!b)return 0;if(a==b)return 1000;if(a->prt==b||b->prt==a)return 900;if(a->bs==b||b->bs==a)return 800;if((a->k==TY_I||a->k==TY_UI)&&(b->k==TY_I||b->k==TY_UI))return 700;if((a->k==TY_F||a->k==TY_UF)&&(b->k==TY_F||b->k==TY_UF))return 700;if(a->k==TY_AC&&b->k==TY_AC&&a->el&&b->el)return 500+tysc(a->el,b->el,0);if(tx&&a->el&&b==tx)return 400;return 0;}
static Sy*syfa(Sm*SM,S nm,int na,Ty*tx){SV cv={0};for(Sy*s=SM->sy[syh(nm)];s;s=s->nx)if(si(s->nm,nm)&&s->sc<=SM->sc)sv(&cv,s);for(uint32_t i=0;i<SM->uv.n;i++)for(Sy*u=SM->uv.d[i];u;u=u->nx)if(si(u->nm,nm))sv(&cv,u);if(cv.n==0)return 0;if(cv.n==1)return cv.d[0];Sy*br=0;int bs=-1;for(uint32_t i=0;i<cv.n;i++){Sy*c=cv.d[i];int sc=0;if((c->k==4||c->k==5)&&na>=0){if(c->ol.n>0){for(uint32_t j=0;j<c->ol.n;j++){No*b=c->ol.d[j];if(b->k==N_PB||b->k==N_FB){int np=b->bd.sp->sp.pmm.n;if(np==na){sc+=1000;if(tx&&c->ty&&c->ty->el){int ts=tysc(c->ty->el,tx,0);sc+=ts;}for(uint32_t k=0;k<b->bd.sp->sp.pmm.n&&k<(uint32_t)na;k++){No*p=b->bd.sp->sp.pmm.d[k];if(p->sy&&p->sy->ty&&tx){int ps=tysc(p->sy->ty,tx,0);sc+=ps;}}if(sc>bs){bs=sc;br=c;}}}}}else if(c->k==1){if(na==1){sc=500;if(tx){int ts=tysc(c->ty,tx,0);sc+=ts;}if(sc>bs){bs=sc;br=c;}}}}else if(c->k==1&&na<0){sc=100;if(sc>bs){bs=sc;br=c;}}}return br?br:cv.d[0];}
static Ty*tyn(Tk_ k,S nm){Ty*t=al(sizeof(Ty));t->k=k;t->nm=nm;t->sz=8;t->al=8;return t;}
static Ty*TY_INT,*TY_BOOL,*TY_CHAR,*TY_STR,*TY_FLT,*TY_UINT,*TY_UFLT,*TY_FILE;
static void smi(Sm*SM){memset(SM,0,sizeof(*SM));TY_INT=tyn(TY_I,Z("INTEGER"));TY_INT->lo=-2147483648LL;TY_INT->hi=2147483647LL;TY_BOOL=tyn(TY_B,Z("BOOLEAN"));TY_CHAR=tyn(TY_C,Z("CHARACTER"));TY_CHAR->sz=1;TY_STR=tyn(TY_A,Z("STRING"));TY_STR->el=TY_CHAR;TY_FLT=tyn(TY_F,Z("FLOAT"));TY_UINT=tyn(TY_UI,Z("universal_integer"));TY_UFLT=tyn(TY_UF,Z("universal_real"));TY_FILE=tyn(TY_FT,Z("FILE_TYPE"));sya(SM,syn(Z("INTEGER"),1,TY_INT,0));sya(SM,syn(Z("BOOLEAN"),1,TY_BOOL,0));Sy*st=sya(SM,syn(Z("TRUE"),2,TY_BOOL,0));st->vl=1;sv(&TY_BOOL->ev,st);Sy*sf=sya(SM,syn(Z("FALSE"),2,TY_BOOL,0));sf->vl=0;sv(&TY_BOOL->ev,sf);sya(SM,syn(Z("CHARACTER"),1,TY_CHAR,0));sya(SM,syn(Z("STRING"),1,TY_STR,0));sya(SM,syn(Z("FLOAT"),1,TY_FLT,0));sya(SM,syn(Z("FILE_TYPE"),1,TY_FILE,0));sya(SM,syn(Z("CONSTRAINT_ERROR"),3,0,0));sya(SM,syn(Z("PROGRAM_ERROR"),3,0,0));sya(SM,syn(Z("STORAGE_ERROR"),3,0,0));sya(SM,syn(Z("TASKING_ERROR"),3,0,0));fv(&SM->io,stdin);fv(&SM->io,stdout);fv(&SM->io,stderr);SM->fn=3;}
static void scp(Sm*SM){SM->sc++;}
static void sco(Sm*SM){for(int i=0;i<4096;i++){while(SM->sy[i]&&SM->sy[i]->sc==SM->sc)SM->sy[i]=SM->sy[i]->nx;}SM->sc--;}
static Ty*rst(Sm*SM,No*n);static void rex(Sm*SM,No*n,Ty*tx);static void rss(Sm*SM,No*n);static void rdl(Sm*SM,No*n);static void rrc_(Sm*SM,RC*r);static No*gcl(Sm*SM,No*n);
static Ty*tcc(Ty*t){if(!t)return TY_INT;if(t->k==TY_UI)return TY_INT;if(t->k==TY_UF)return TY_FLT;if(t->k==TY_D&&t->prt)return tcc(t->prt);return t;}
static bool tco(Ty*a,Ty*b){if(!a||!b)return false;if(a==b)return true;if(a->prt==b||b->prt==a)return true;if(a->bs==b||b->bs==a)return true;if((a->k==TY_I||a->k==TY_UI)&&(b->k==TY_I||b->k==TY_UI))return true;if((a->k==TY_F||a->k==TY_UF)&&(b->k==TY_F||b->k==TY_UF))return true;if(a->k==TY_AC&&b->k==TY_AC)return tco(a->el,b->el);if(a->k==TY_D)return tco(a->prt,b);if(b->k==TY_D)return tco(a,b->prt);return false;}
static Ty*rst(Sm*SM,No*n){if(!n)return TY_INT;if(n->k==N_ID){Sy*s=syf(SM,n->s);if(s&&s->ty)return s->ty;return TY_INT;}if(n->k==N_SEL){No*p=n->se.p;if(p->k==N_ID){Sy*ps=syf(SM,p->s);if(ps&&ps->k==6&&ps->df&&ps->df->k==N_PKS){No*pk=ps->df;for(uint32_t i=0;i<pk->ps.dc.n;i++){No*d=pk->ps.dc.d[i];if(d->k==N_TD&&si(d->td.nm,n->se.se))return rst(SM,d->td.df);if(d->sy&&si(d->sy->nm,n->se.se)&&d->sy->ty)return d->sy->ty;}}return rst(SM,p);}return TY_INT;}if(n->k==N_ST)return rst(SM,n->sd.in);if(n->k==N_TI||n->k==N_TE)return tyn(TY_I,N);if(n->k==N_TF)return tyn(TY_F,N);if(n->k==N_TA){Ty*t=tyn(TY_A,N);t->el=rst(SM,n->ix.p);if(n->ix.ix.n==1){No*r=n->ix.ix.d[0];if(r&&r->k==N_RN&&r->rn.lo&&r->rn.hi&&r->rn.lo->k==N_INT&&r->rn.hi->k==N_INT){t->lo=r->rn.lo->i;t->hi=r->rn.hi->i;}}return t;}if(n->k==N_TR||n->k==N_TP)return tyn(TY_R,N);if(n->k==N_TAC){Ty*t=tyn(TY_AC,N);t->el=rst(SM,n->un.x);return t;}if(n->k==N_RN){Ty*t=tyn(TY_I,N);if(n->rn.lo&&n->rn.lo->k==N_INT)t->lo=n->rn.lo->i;if(n->rn.hi&&n->rn.hi->k==N_INT)t->hi=n->rn.hi->i;return t;}return TY_INT;}
static Sy*scl(Sm*SM,char c,Ty*tx){if(tx&&tx->k==TY_E){for(uint32_t i=0;i<tx->ev.n;i++){Sy*e=tx->ev.d[i];if(e->nm.n==1&&tolower(e->nm.s[0])==tolower(c))return e;}}if(tx&&tx->k==TY_D&&tx->prt)return scl(SM,c,tx->prt);for(Sy*s=SM->sy[syh((S){&c,1})];s;s=s->nx)if(s->nm.n==1&&tolower(s->nm.s[0])==tolower(c)&&s->k==2&&s->ty&&(s->ty->k==TY_E||(s->ty->k==TY_D&&s->ty->prt&&s->ty->prt->k==TY_E)))return s;return 0;}
static No*chk(Sm*SM,No*n,L l){if(!n||!n->ty)return n;Ty*t=tcc(n->ty);if(t->k==TY_I&&(t->lo!=TY_INT->lo||t->hi!=TY_INT->hi)){No*c=ND(CHK,l);c->chk.ex=n;c->chk.ec=Z("CONSTRAINT_ERROR");c->ty=n->ty;return c;}return n;}
static void icv(Ty*t,No*n){if(!t||!n||n->k!=N_CL)return;for(uint32_t i=0;i<n->cl.ar.n;i++)rex(0,n->cl.ar.d[i],0);}
static void rex(Sm*SM,No*n,Ty*tx){if(!n)return;switch(n->k){case N_ID:{Sy*s=syf(SM,n->s);if(s){n->ty=s->ty;n->sy=s;}else{if(tx&&tx->k==TY_E){for(uint32_t i=0;i<tx->ev.n;i++){Sy*e=tx->ev.d[i];if(si(e->nm,n->s)){n->ty=tx;n->sy=e;return;}}}n->ty=TY_INT;}}break;case N_INT:n->ty=TY_UINT;break;case N_REAL:n->ty=TY_UFLT;break;case N_CHAR:{Sy*s=scl(SM,n->i,tx);if(s){n->ty=s->ty;n->sy=s;n->k=N_ID;n->s=s->nm;}else n->ty=TY_CHAR;}break;case N_STR:n->ty=TY_STR;break;case N_NULL:n->ty=tx&&tx->k==TY_AC?tx:TY_INT;break;case N_BIN:rex(SM,n->bn.l,tx);rex(SM,n->bn.r,tx);if(n->bn.op==T_ATHN||n->bn.op==T_OREL){n->ty=TY_BOOL;break;}if(n->bn.op==T_AND||n->bn.op==T_OR||n->bn.op==T_XOR){n->bn.l=chk(SM,n->bn.l,n->l);n->bn.r=chk(SM,n->bn.r,n->l);n->ty=TY_BOOL;break;}if(n->bn.op==T_IN){n->bn.l=chk(SM,n->bn.l,n->l);n->bn.r=chk(SM,n->bn.r,n->l);n->ty=TY_BOOL;break;}n->ty=tcc(n->bn.l->ty);if(n->bn.op>=T_EQ&&n->bn.op<=T_GE)n->ty=TY_BOOL;break;case N_UN:rex(SM,n->un.x,tx);n->ty=tcc(n->un.x->ty);if(n->un.op==T_NOT)n->ty=TY_BOOL;break;case N_IX:rex(SM,n->ix.p,0);for(uint32_t i=0;i<n->ix.ix.n;i++){rex(SM,n->ix.ix.d[i],0);n->ix.ix.d[i]=chk(SM,n->ix.ix.d[i],n->l);}if(n->ix.p->ty&&n->ix.p->ty->k==TY_A)n->ty=n->ix.p->ty->el;else n->ty=TY_INT;break;case N_SL:rex(SM,n->sl.p,0);rex(SM,n->sl.lo,0);rex(SM,n->sl.hi,0);if(n->sl.p->ty&&n->sl.p->ty->k==TY_A)n->ty=n->sl.p->ty;else n->ty=TY_INT;break;case N_SEL:{rex(SM,n->se.p,0);No*p=n->se.p;if(p->k==N_ID){Sy*ps=syf(SM,p->s);if(ps&&ps->k==6&&ps->df&&ps->df->k==N_PKS){No*pk=ps->df;for(uint32_t i=0;i<pk->ps.dc.n;i++){No*d=pk->ps.dc.d[i];if(d->sy&&si(d->sy->nm,n->se.se)){n->ty=d->sy->ty?d->sy->ty:TY_INT;n->sy=d->sy;return;}}}}if(p->ty){Ty*pt=tcc(p->ty);if(pt->k==TY_R){for(uint32_t i=0;i<pt->cm.n;i++){No*c=pt->cm.d[i];if(c->k==N_CM&&si(c->cm.nm,n->se.se)){n->ty=rst(SM,c->cm.ty);return;}}}}n->ty=TY_INT;}break;case N_AT:rex(SM,n->at.p,0);for(uint32_t i=0;i<n->at.ar.n;i++)rex(SM,n->at.ar.d[i],0);if(si(n->at.at,Z("LENGTH"))||si(n->at.at,Z("SIZE")))n->ty=TY_INT;else if(si(n->at.at,Z("FIRST"))||si(n->at.at,Z("LAST"))){Ty*pt=n->at.p->ty?tcc(n->at.p->ty):0;n->ty=pt&&pt->el?pt->el:TY_INT;}else if(si(n->at.at,Z("ADDRESS")))n->ty=TY_INT;else if(si(n->at.at,Z("COUNT")))n->ty=TY_INT;else if(si(n->at.at,Z("CALLABLE")))n->ty=TY_BOOL;else if(si(n->at.at,Z("TERMINATED")))n->ty=TY_BOOL;else if(si(n->at.at,Z("ACCESS")))n->ty=tyn(TY_AC,N);else n->ty=TY_INT;break;case N_QL:{Ty*qt=rst(SM,n->ql.nm);rex(SM,n->ql.ag,qt);n->ty=qt;if(n->ql.ag->ty&&qt){icv(qt,n->ql.ag);n->ql.ag->ty=qt;}}break;case N_CL:{rex(SM,n->cl.fn,0);for(uint32_t i=0;i<n->cl.ar.n;i++)rex(SM,n->cl.ar.d[i],0);Ty*ft=n->cl.fn?n->cl.fn->ty:0;if(ft&&ft->k==TY_A){No*fn=n->cl.fn;NV ar=n->cl.ar;n->k=N_IX;n->ix.p=fn;n->ix.ix=ar;rex(SM,n,tx);break;}if(n->cl.fn->k==N_ID){Sy*s=syfa(SM,n->cl.fn->s,n->cl.ar.n,tx);if(s){if(s->ty&&s->ty->k==TY_S&&s->ty->el){n->ty=s->ty->el;n->sy=s;}else if(s->k==1){No*cv=ND(CVT,n->l);cv->cvt.ty=n->cl.fn;cv->cvt.ex=n->cl.ar.n>0?n->cl.ar.d[0]:0;n->k=N_CVT;n->cvt=cv->cvt;n->ty=s->ty?s->ty:TY_INT;}else n->ty=TY_INT;}else n->ty=TY_INT;}else n->ty=TY_INT;}break;case N_AG:for(uint32_t i=0;i<n->ag.n;i++)rex(SM,n->ag.d[i],tx);n->ty=tx?tx:TY_INT;icv(tx,n);break;case N_ALC:n->ty=tyn(TY_AC,N);n->ty->el=rst(SM,n->alc.st);if(n->alc.in){Ty*et=n->ty->el?tcc(n->ty->el):0;if(et&&et->k==TY_R&&et->dc.n>0){for(uint32_t i=0;i<et->dc.n;i++){No*d=et->dc.d[i];if(d->k==N_DS&&d->pm.df){rex(SM,d->pm.df,rst(SM,d->pm.ty));}}}rex(SM,n->alc.in,n->ty->el);}break;case N_RN:rex(SM,n->rn.lo,tx);rex(SM,n->rn.hi,tx);n->rn.lo=chk(SM,n->rn.lo,n->l);n->rn.hi=chk(SM,n->rn.hi,n->l);n->ty=tcc(n->rn.lo->ty);break;case N_ASC:for(uint32_t i=0;i<n->asc.ch.n;i++)rex(SM,n->asc.ch.d[i],0);if(n->asc.vl)rex(SM,n->asc.vl,tx);break;case N_DRF:rex(SM,n->drf.x,0);if(n->drf.x->ty&&n->drf.x->ty->k==TY_AC)n->ty=n->drf.x->ty->el;else n->ty=TY_INT;break;case N_CVT:rex(SM,n->cvt.ex,0);n->ty=rst(SM,n->cvt.ty);break;case N_CHK:rex(SM,n->chk.ex,tx);n->ty=n->chk.ex->ty;break;default:break;}}
static void rss(Sm*SM,No*n){if(!n)return;switch(n->k){case N_AS:rex(SM,n->as.tg,0);rex(SM,n->as.vl,n->as.tg->ty);break;case N_IF:rex(SM,n->if_.cd,TY_BOOL);for(uint32_t i=0;i<n->if_.th.n;i++)rss(SM,n->if_.th.d[i]);for(uint32_t i=0;i<n->if_.ei.n;i++){No*e=n->if_.ei.d[i];rex(SM,e->if_.cd,TY_BOOL);for(uint32_t j=0;j<e->if_.th.n;j++)rss(SM,e->if_.th.d[j]);}for(uint32_t i=0;i<n->if_.el.n;i++)rss(SM,n->if_.el.d[i]);break;case N_CS:rex(SM,n->cs.ex,0);for(uint32_t i=0;i<n->cs.al.n;i++){No*a=n->cs.al.d[i];for(uint32_t j=0;j<a->ch.it.n;j++)rex(SM,a->ch.it.d[j],n->cs.ex->ty);for(uint32_t j=0;j<a->hnd.stz.n;j++)rss(SM,a->hnd.stz.d[j]);}break;case N_LP:scp(SM);if(n->lp.it){rex(SM,n->lp.it,TY_BOOL);if(n->lp.it->k==N_BIN&&n->lp.it->bn.op==T_IN){No*v=n->lp.it->bn.l;if(v->k==N_ID){Ty*rt=n->lp.it->bn.r->ty;sya(SM,syn(v->s,0,rt?rt:TY_INT,0));}}}for(uint32_t i=0;i<n->lp.st.n;i++)rss(SM,n->lp.st.d[i]);sco(SM);break;case N_BL:scp(SM);for(uint32_t i=0;i<n->bk.dc.n;i++)rdl(SM,n->bk.dc.d[i]);for(uint32_t i=0;i<n->bk.st.n;i++)rss(SM,n->bk.st.d[i]);for(uint32_t i=0;i<n->bk.hd.n;i++){No*h=n->bk.hd.d[i];for(uint32_t j=0;j<h->hnd.stz.n;j++)rss(SM,h->hnd.stz.d[j]);}sco(SM);break;case N_RT:if(n->rt.vl)rex(SM,n->rt.vl,0);break;case N_EX:if(n->ex.cd)rex(SM,n->ex.cd,TY_BOOL);break;case N_RS:if(n->rs.ec)rex(SM,n->rs.ec,0);break;case N_CLT:rex(SM,n->ct.nm,0);for(uint32_t i=0;i<n->ct.arr.n;i++)rex(SM,n->ct.arr.d[i],0);break;case N_ACC:for(uint32_t i=0;i<n->acc.pmx.n;i++){No*p=n->acc.pmx.d[i];rex(SM,p,0);}for(uint32_t i=0;i<n->acc.stx.n;i++)rss(SM,n->acc.stx.d[i]);break;case N_SA:if(n->sa.gd)rex(SM,n->sa.gd,0);for(uint32_t i=0;i<n->sa.sts.n;i++){No*s=n->sa.sts.d[i];if(s->k==N_ACC){for(uint32_t j=0;j<s->acc.pmx.n;j++)rex(SM,s->acc.pmx.d[j],0);for(uint32_t j=0;j<s->acc.stx.n;j++)rss(SM,s->acc.stx.d[j]);}else if(s->k==N_DL)rex(SM,s->ex.cd,0);}break;case N_DL:rex(SM,n->ex.cd,0);break;case N_AB:if(n->rs.ec)rex(SM,n->rs.ec,0);break;case N_US:if(n->us.nm->k==N_ID){Sy*s=syf(SM,n->us.nm->s);if(s)sfu(SM,s,n->us.nm->s);}break;default:break;}}
static void rrc_(Sm*SM,RC*r){if(!r)return;switch(r->k){case 1:{Sy*ts=syf(SM,r->er.nm);if(ts&&ts->ty){Ty*t=tcc(ts->ty);for(uint32_t i=0;i<r->rr.cp.n;i++){No*e=r->rr.cp.d[i];for(uint32_t j=0;j<t->ev.n;j++){Sy*ev=t->ev.d[j];if(si(ev->nm,e->s)){ev->vl=e->i;break;}}}}}break;case 2:{Sy*s=syf(SM,r->ad.nm);if(s&&s->ty){Ty*t=tcc(s->ty);t->ad=r->ad.ad;}}break;case 3:{Sy*s=syf(SM,r->rr.nm);if(s&&s->ty){Ty*t=tcc(s->ty);uint32_t bt=0;for(uint32_t i=0;i<r->rr.cp.n;i++){No*cp=r->rr.cp.d[i];for(uint32_t j=0;j<t->cm.n;j++){No*c=t->cm.d[j];if(c->k==N_CM&&si(c->cm.nm,cp->cm.nm)){c->cm.of=cp->cm.of;c->cm.bt=cp->cm.bt;bt+=cp->cm.bt;break;}}}t->sz=(bt+7)/8;t->pk=true;}}break;}}
static void ihop(Ty*dt,Ty*pt){if(!dt||!pt)return;for(uint32_t i=0;i<pt->ops.n;i++){No*op=pt->ops.d[i];if(op->k==N_FB||op->k==N_PB){No*nop=nd(op->k,op->l);nop->bd=op->bd;No*nsp=nd(N_FS,op->l);nsp->sp=op->bd.sp->sp;nsp->sp.nm=op->bd.sp->sp.nm;nsp->sp.pmm=op->bd.sp->sp.pmm;if(op->k==N_FB)nsp->sp.rt=op->bd.sp->sp.rt;nop->bd.sp=nsp;nop->bd.el=-1;nv(&dt->ops,nop);}}}
static No*ncp(No*n){if(!n)return 0;No*c=nd(n->k,n->l);*c=*n;if(n->k==N_BIN){c->bn.l=ncp(n->bn.l);c->bn.r=ncp(n->bn.r);}else if(n->k==N_UN){c->un.x=ncp(n->un.x);}else if(n->k==N_CL){c->cl.fn=ncp(n->cl.fn);for(uint32_t i=0;i<n->cl.ar.n;i++)c->cl.ar.d[i]=ncp(n->cl.ar.d[i]);}else if(n->k==N_AG){for(uint32_t i=0;i<n->ag.n;i++)c->ag.d[i]=ncp(n->ag.d[i]);}return c;}
static No*gsub(Sm*SM,No*n,NV*fp,NV*ap){if(!n)return n;No*r=ncp(n);switch(n->k){case N_ID:for(uint32_t i=0;i<fp->n;i++){No*f=fp->d[i];if((f->k==N_GTP||f->k==N_GVL)&&si(f->td.nm,n->s)){if(i<ap->n)return ncp(ap->d[i]);}}return r;case N_BIN:r->bn.l=gsub(SM,n->bn.l,fp,ap);r->bn.r=gsub(SM,n->bn.r,fp,ap);break;case N_UN:r->un.x=gsub(SM,n->un.x,fp,ap);break;case N_CL:r->cl.fn=gsub(SM,n->cl.fn,fp,ap);for(uint32_t i=0;i<n->cl.ar.n;i++)r->cl.ar.d[i]=gsub(SM,n->cl.ar.d[i],fp,ap);break;case N_PM:r->pm.ty=gsub(SM,n->pm.ty,fp,ap);break;case N_OD:r->od.ty=gsub(SM,n->od.ty,fp,ap);break;case N_TD:r->td.df=gsub(SM,n->td.df,fp,ap);break;case N_TA:for(uint32_t i=0;i<n->ix.ix.n;i++)r->ix.ix.d[i]=gsub(SM,n->ix.ix.d[i],fp,ap);r->ix.p=gsub(SM,n->ix.p,fp,ap);break;default:break;}return r;}
static No*gcl(Sm*SM,No*n){if(!n)return 0;if(n->k==N_GEN){GT*g=gfnd(SM,n->gen.un&&n->gen.un->bd.sp?n->gen.un->bd.sp->sp.nm:n->gen.un?((n->gen.un->k==N_PKS)?n->gen.un->ps.nm:N):N);if(!g){g=gt(n->gen.un&&n->gen.un->bd.sp?n->gen.un->bd.sp->sp.nm:n->gen.un?((n->gen.un->k==N_PKS)?n->gen.un->ps.nm:N):N);g->fp=n->gen.fp;g->dc=n->gen.dc;g->un=n->gen.un;gv(&SM->gt,g);Sy*gs=syn(g->nm,11,0,n);gs->gt=g;sya(SM,gs);}}else if(n->k==N_GINST){GT*g=gfnd(SM,n->gi.gn);if(g){No*inst=ncp(g->un);if(inst->k==N_PB||inst->k==N_FB||inst->k==N_PD||inst->k==N_FD){for(uint32_t i=0;i<inst->bd.sp->sp.pmm.n;i++){No*p=inst->bd.sp->sp.pmm.d[i];p->pm.ty=gsub(SM,p->pm.ty,&g->fp,&n->gi.ap);}if((inst->k==N_FB||inst->k==N_FD)&&inst->bd.sp->sp.rt)inst->bd.sp->sp.rt=gsub(SM,inst->bd.sp->sp.rt,&g->fp,&n->gi.ap);for(uint32_t i=0;i<g->dc.n;i++){No*d=ncp(g->dc.d[i]);if(d->k==N_TD)d->td.df=gsub(SM,d->td.df,&g->fp,&n->gi.ap);else if(d->k==N_OD)d->od.ty=gsub(SM,d->od.ty,&g->fp,&n->gi.ap);nv(&inst->bd.dc,d);}}else if(inst->k==N_PKS){for(uint32_t i=0;i<g->dc.n;i++){No*d=ncp(g->dc.d[i]);if(d->k==N_TD)d->td.df=gsub(SM,d->td.df,&g->fp,&n->gi.ap);else if(d->k==N_OD)d->od.ty=gsub(SM,d->od.ty,&g->fp,&n->gi.ap);nv(&inst->ps.dc,d);}}return inst;}}return 0;}
static void rdl(Sm*SM,No*n){if(!n)return;switch(n->k){case N_GINST:{No*inst=gcl(SM,n);if(inst)rdl(SM,inst);}break;case N_RRC:{RC*r=(RC*)n->ag.d;rrc_(SM,r);}break;case N_OD:{Ty*t=rst(SM,n->od.ty);for(uint32_t i=0;i<n->od.id.n;i++){No*id=n->od.id.d[i];Sy*s=sya(SM,syn(id->s,n->od.co?2:0,t,n));id->sy=s;s->pr=SM->pk?SM->pk->sy:0;}if(n->od.in)rex(SM,n->od.in,t);}break;case N_TD:{uint32_t of=0;Ty*t=0;if(n->td.drv&&n->td.prt){Ty*pt=rst(SM,n->td.prt);t=tyn(TY_D,n->td.nm);t->prt=pt;if(pt){t->k=pt->k==TY_D?pt->prt->k:pt->k;t->lo=pt->lo;t->hi=pt->hi;t->el=pt->el;t->cm=pt->cm;t->dc=pt->dc;t->sz=pt->sz;t->al=pt->al;t->ev=pt->ev;ihop(t,pt);}if(n->td.df&&n->td.df->k==N_RN){rex(SM,n->td.df->rn.lo,0);rex(SM,n->td.df->rn.hi,0);t->lo=n->td.df->rn.lo->i;t->hi=n->td.df->rn.hi->i;}}else t=n->td.df?rst(SM,n->td.df):tyn(TY_I,n->td.nm);if(!t->nm.s)t->nm=n->td.nm;if(n->td.dsc.n>0){for(uint32_t i=0;i<n->td.dsc.n;i++){No*d=n->td.dsc.d[i];if(d->k==N_DS){Sy*ds=sya(SM,syn(d->pm.nm,8,rst(SM,d->pm.ty),d));if(d->pm.df)rex(SM,d->pm.df,ds->ty);}}t->dc=n->td.dsc;}Sy*s=sya(SM,syn(n->td.nm,1,t,n));n->sy=s;if(n->td.df&&n->td.df->k==N_TE){t->k=TY_E;int vl=0;for(uint32_t i=0;i<n->td.df->lst.it.n;i++){No*it=n->td.df->lst.it.d[i];Sy*es=sya(SM,syn(it->k==N_CHAR?(S){&it->i,1}:it->s,2,t,n));es->vl=vl++;sv(&t->ev,es);}}if(n->td.df&&n->td.df->k==N_TR){of=0;for(uint32_t i=0;i<n->td.df->lst.it.n;i++){No*c=n->td.df->lst.it.d[i];if(c->k==N_CM){c->cm.of=of++;Ty*ct=rst(SM,c->cm.ty);if(ct)c->cm.ty->ty=ct;if(c->cm.dc){for(uint32_t j=0;j<c->cm.dc->lst.it.n;j++){No*dc=c->cm.dc->lst.it.d[j];if(dc->k==N_DS&&dc->pm.df)rex(SM,dc->pm.df,rst(SM,dc->pm.ty));}}if(c->cm.dsc){for(uint32_t j=0;j<c->cm.dsc->lst.it.n;j++){No*dc=c->cm.dsc->lst.it.d[j];if(dc->k==N_DS){Sy*ds=sya(SM,syn(dc->pm.nm,8,rst(SM,dc->pm.ty),dc));if(dc->pm.df)rex(SM,dc->pm.df,ds->ty);}}c->cm.dc=c->cm.dsc;}}else if(c->k==N_VP){for(uint32_t j=0;j<c->vp.vrr.n;j++){No*v=c->vp.vrr.d[j];for(uint32_t k=0;k<v->vr.cmm.n;k++){No*vc=v->vr.cmm.d[k];vc->cm.of=of++;Ty*vct=rst(SM,vc->cm.ty);if(vct)vc->cm.ty->ty=vct;if(vc->cm.dc){for(uint32_t m=0;m<vc->cm.dc->lst.it.n;m++){No*dc=vc->cm.dc->lst.it.d[m];if(dc->k==N_DS&&dc->pm.df)rex(SM,dc->pm.df,rst(SM,dc->pm.ty));}}if(vc->cm.dsc){for(uint32_t m=0;m<vc->cm.dsc->lst.it.n;m++){No*dc=vc->cm.dsc->lst.it.d[m];if(dc->k==N_DS){Sy*ds=sya(SM,syn(dc->pm.nm,8,rst(SM,dc->pm.ty),dc));if(dc->pm.df)rex(SM,dc->pm.df,ds->ty);}}vc->cm.dc=vc->cm.dsc;}}}}}}t->cm=n->td.df->lst.it;t->sz=of*8;}break;case N_SD:{Ty*b=rst(SM,n->sd.in);Ty*t=tyn(b?b->k:TY_I,n->sd.nm);if(b){t->bs=b;t->el=b->el;t->cm=b->cm;t->dc=b->dc;t->sz=b->sz;t->al=b->al;t->ad=b->ad;t->pk=b->pk;t->lo=b->lo;t->hi=b->hi;t->prt=b->prt?b->prt:b;}if(n->sd.rn){rex(SM,n->sd.rn->rn.lo,0);rex(SM,n->sd.rn->rn.hi,0);t->lo=n->sd.rn->rn.lo->i;t->hi=n->sd.rn->rn.hi->i;}sya(SM,syn(n->sd.nm,1,t,n));}break;case N_ED:for(uint32_t i=0;i<n->ed.id.n;i++){No*id=n->ed.id.d[i];sya(SM,syn(id->s,3,0,n));}break;case N_PD:case N_PB:{No*sp=n->bd.sp;Ty*ft=tyn(TY_S,sp->sp.nm);Sy*s=sya(SM,syn(sp->sp.nm,4,ft,n));nv(&s->ol,n);n->sy=s;n->bd.el=s->el;nv(&ft->ops,n);if(n->k==N_PB){SM->lv++;scp(SM);n->bd.pr=s;for(uint32_t i=0;i<sp->sp.pmm.n;i++){No*p=sp->sp.pmm.d[i];Ty*pt=rst(SM,p->pm.ty);Sy*ps=sya(SM,syn(p->pm.nm,0,pt,p));p->sy=ps;}for(uint32_t i=0;i<n->bd.dc.n;i++)rdl(SM,n->bd.dc.d[i]);for(uint32_t i=0;i<n->bd.st.n;i++)rss(SM,n->bd.st.d[i]);sco(SM);SM->lv--;}}break;case N_FB:{No*sp=n->bd.sp;Ty*rt=rst(SM,sp->sp.rt);Ty*ft=tyn(TY_S,sp->sp.nm);ft->el=rt;Sy*s=sya(SM,syn(sp->sp.nm,5,ft,n));nv(&s->ol,n);n->sy=s;n->bd.el=s->el;nv(&ft->ops,n);if(n->k==N_FB){SM->lv++;scp(SM);n->bd.pr=s;for(uint32_t i=0;i<sp->sp.pmm.n;i++){No*p=sp->sp.pmm.d[i];Ty*pt=rst(SM,p->pm.ty);Sy*ps=sya(SM,syn(p->pm.nm,0,pt,p));p->sy=ps;}for(uint32_t i=0;i<n->bd.dc.n;i++)rdl(SM,n->bd.dc.d[i]);for(uint32_t i=0;i<n->bd.st.n;i++)rss(SM,n->bd.st.d[i]);sco(SM);SM->lv--;}}break;case N_FD:{No*sp=n->bd.sp;Ty*rt=rst(SM,sp->sp.rt);Ty*ft=tyn(TY_S,sp->sp.nm);ft->el=rt;Sy*s=sya(SM,syn(sp->sp.nm,5,ft,n));nv(&s->ol,n);n->sy=s;n->bd.el=s->el;nv(&ft->ops,n);}break;case N_PKS:{Ty*t=tyn(TY_P,n->ps.nm);Sy*s=sya(SM,syn(n->ps.nm,6,t,n));n->sy=s;n->ps.el=s->el;SM->pk=n;scp(SM);for(uint32_t i=0;i<n->ps.dc.n;i++)rdl(SM,n->ps.dc.d[i]);for(uint32_t i=0;i<n->ps.pr.n;i++)rdl(SM,n->ps.pr.d[i]);sco(SM);SM->pk=0;}break;case N_PKB:{Sy*ps=syf(SM,n->pb.nm);if(ps){sv(&SM->uv,ps);n->pb.el=ps->el;}scp(SM);for(uint32_t i=0;i<n->pb.dc.n;i++)rdl(SM,n->pb.dc.d[i]);for(uint32_t i=0;i<n->pb.st.n;i++)rss(SM,n->pb.st.d[i]);sco(SM);}break;case N_TKS:{Ty*t=tyn(TY_T,n->ts.nm);t->cm=n->ts.en;sya(SM,syn(n->ts.nm,7,t,n));}break;case N_TKB:{scp(SM);for(uint32_t i=0;i<n->tb.dc.n;i++)rdl(SM,n->tb.dc.d[i]);for(uint32_t i=0;i<n->tb.st.n;i++)rss(SM,n->tb.st.d[i]);sco(SM);}break;case N_GEN:gcl(SM,n);break;case N_US:rss(SM,n);break;default:break;}}
static int elc(Sm*SM,SV*ev,No*n){if(!n)return 0;int mx=0;switch(n->k){case N_PKS:case N_PKB:case N_PD:case N_PB:case N_FD:case N_FB:{Sy*s=n->sy;if(s&&s->el<0)s->el=SM->eo;if(s){sv(ev,s);if(s->el>mx)mx=s->el;}}break;case N_OD:for(uint32_t i=0;i<n->od.id.n;i++){No*id=n->od.id.d[i];if(id->sy){sv(ev,id->sy);if(id->sy->el>mx)mx=id->sy->el;}}break;default:break;}return mx;}
static void smu(Sm*SM,No*n){if(n->k==N_CU){for(uint32_t i=0;i<n->cu.cx->cx.us.n;i++)rdl(SM,n->cu.cx->cx.us.d[i]);if(n->cu.un){SV eo={0};int mx=0;if(n->cu.un->k==N_PKS){for(uint32_t i=0;i<n->cu.un->ps.dc.n;i++){int e=elc(SM,&eo,n->cu.un->ps.dc.d[i]);if(e>mx)mx=e;}}else if(n->cu.un->k==N_PKB){for(uint32_t i=0;i<n->cu.un->pb.dc.n;i++){int e=elc(SM,&eo,n->cu.un->pb.dc.d[i]);if(e>mx)mx=e;}}for(uint32_t i=0;i<eo.n;i++){Sy*s=eo.d[i];if(s->k==6&&s->df&&s->df->k==N_PKS){No*pk=s->df;for(uint32_t j=0;j<pk->ps.dc.n;j++)rdl(SM,pk->ps.dc.d[j]);}}rdl(SM,n->cu.un);}}}
typedef enum{VK_I=0,VK_F=1,VK_P=2}Vk;typedef struct{int id;Vk k;}V;typedef struct TH TH;typedef struct TK TK;typedef struct PT PT;struct TH{S ec;jmp_buf jb;TH*nx;};struct TK{pthread_t th;int id;S nm;NV en;PT*pt;bool ac,tm;};struct PT{pthread_mutex_t mx;S nm;NV en;bool lk;};typedef struct{FILE*o;int tm,lb;Sm*sm;int ll[64];int ls;SV el;TH*eh;TK*tk[64];int tn;PT*pt[64];int pn;SLV lbs;}Gn;
static int nt(Gn*g){return g->tm++;}
static int nl(Gn*g){return g->lb++;}
static int flbl(Gn*g,S lb){for(uint32_t i=0;i<g->lbs.n;i++)if(si(g->lbs.d[i],lb))return i;return -1;}
static const char*vt(Vk k){return k==VK_I?"i64":k==VK_F?"double":"ptr";}
static Vk tk2v(Ty*t){if(!t)return VK_I;t=tcc(t);switch(t->k){case TY_F:case TY_UF:return VK_F;case TY_AC:case TY_FT:case TY_A:return VK_P;default:return VK_I;}}
static V gex(Gn*g,No*n);static void gss(Gn*g,No*n);static void gdl(Gn*g,No*n);
static V vcast(Gn*g,V v,Vk k){if(v.k==k)return v;V r={nt(g),k};if(v.k==VK_I&&k==VK_F)fprintf(g->o,"  %%t%d = sitofp i64 %%t%d to double\n",r.id,v.id);else if(v.k==VK_F&&k==VK_I)fprintf(g->o,"  %%t%d = fptosi double %%t%d to i64\n",r.id,v.id);else if(v.k==VK_P&&k==VK_I)fprintf(g->o,"  %%t%d = ptrtoint ptr %%t%d to i64\n",r.id,v.id);else if(v.k==VK_I&&k==VK_P)fprintf(g->o,"  %%t%d = inttoptr i64 %%t%d to ptr\n",r.id,v.id);else fprintf(g->o,"  %%t%d = bitcast %s %%t%d to %s\n",r.id,vt(v.k),v.id,vt(k));return r;}
static V vbool(Gn*g,V v){if(v.k!=VK_I)v=vcast(g,v,VK_I);int t=nt(g);V c={nt(g),VK_I};fprintf(g->o,"  %%t%d = icmp ne i64 %%t%d, 0\n",t,v.id);fprintf(g->o,"  %%t%d = zext i1 %%t%d to i64\n",c.id,t);return c;}
static V vcmpi(Gn*g,const char*op,V a,V b){a=vcast(g,a,VK_I);b=vcast(g,b,VK_I);int c=nt(g);V r={nt(g),VK_I};fprintf(g->o,"  %%t%d = icmp %s i64 %%t%d, %%t%d\n",c,op,a.id,b.id);fprintf(g->o,"  %%t%d = zext i1 %%t%d to i64\n",r.id,c);return r;}
static V vcmpf(Gn*g,const char*op,V a,V b){a=vcast(g,a,VK_F);b=vcast(g,b,VK_F);int c=nt(g);V r={nt(g),VK_I};fprintf(g->o,"  %%t%d = fcmp %s double %%t%d, %%t%d\n",c,op,a.id,b.id);fprintf(g->o,"  %%t%d = zext i1 %%t%d to i64\n",r.id,c);return r;}
static V vpowi(Gn*g,V a,V b){a=vcast(g,a,VK_I);b=vcast(g,b,VK_I);V r={nt(g),VK_I};fprintf(g->o,"  %%t%d = call i64 @__ada_powi(i64 %%t%d, i64 %%t%d)\n",r.id,a.id,b.id);return r;}
static V vpows(Gn*g,V a,V b){a=vcast(g,a,VK_F);b=vcast(g,b,VK_F);V r={nt(g),VK_F};fprintf(g->o,"  %%t%d = call double @pow(double %%t%d, double %%t%d)\n",r.id,a.id,b.id);return r;}
static V gag(Gn*g,No*n,Ty*ty){V r={nt(g),VK_P};Ty*t=ty?tcc(ty):0;if(!t||t->k!=TY_R||t->pk){int sz=n->ag.n?n->ag.n:1;int p=nt(g);fprintf(g->o,"  %%t%d = alloca [%d x i64]\n",p,sz);uint32_t ix=0;for(uint32_t i=0;i<n->ag.n;i++){No*el=n->ag.d[i];if(el->k==N_ASC){if(el->asc.ch.d[0]->k==N_ID&&si(el->asc.ch.d[0]->s,Z("others"))){for(;ix<(uint32_t)sz;ix++){V v=vcast(g,gex(g,el->asc.vl),VK_I);int ep=nt(g);fprintf(g->o,"  %%t%d = getelementptr [%d x i64], ptr %%t%d, i64 0, i64 %u\n",ep,sz,p,ix);fprintf(g->o,"  store i64 %%t%d, ptr %%t%d\n",v.id,ep);}}else{V v=vcast(g,gex(g,el->asc.vl),VK_I);for(uint32_t j=0;j<el->asc.ch.n;j++){V ci=vcast(g,gex(g,el->asc.ch.d[j]),VK_I);int ep=nt(g);fprintf(g->o,"  %%t%d = getelementptr [%d x i64], ptr %%t%d, i64 0, i64 %%t%d\n",ep,sz,p,ci.id);fprintf(g->o,"  store i64 %%t%d, ptr %%t%d\n",v.id,ep);}ix++;}}else{V v=vcast(g,gex(g,el),VK_I);int ep=nt(g);fprintf(g->o,"  %%t%d = getelementptr [%d x i64], ptr %%t%d, i64 0, i64 %u\n",ep,sz,p,ix);fprintf(g->o,"  store i64 %%t%d, ptr %%t%d\n",v.id,ep);ix++;}}fprintf(g->o,"  %%t%d = getelementptr [%d x i64], ptr %%t%d, i64 0, i64 0\n",r.id,sz,p);}else{uint32_t sz=t->sz/8;int p=nt(g);fprintf(g->o,"  %%t%d = alloca [%u x i64]\n",p,sz);uint32_t ix=0;for(uint32_t i=0;i<n->ag.n;i++){No*el=n->ag.d[i];if(el->k==N_ASC){for(uint32_t j=0;j<el->asc.ch.n;j++){No*ch=el->asc.ch.d[j];if(ch->k==N_ID){for(uint32_t k=0;k<t->cm.n;k++){No*c=t->cm.d[k];if(c->k==N_CM&&si(c->cm.nm,ch->s)){V v=vcast(g,gex(g,el->asc.vl),VK_I);int ep=nt(g);fprintf(g->o,"  %%t%d = getelementptr [%u x i64], ptr %%t%d, i64 0, i64 %u\n",ep,sz,p,c->cm.of);fprintf(g->o,"  store i64 %%t%d, ptr %%t%d\n",v.id,ep);break;}}}}ix++;}else{V v=vcast(g,gex(g,el),VK_I);int ep=nt(g);fprintf(g->o,"  %%t%d = getelementptr [%u x i64], ptr %%t%d, i64 0, i64 %u\n",ep,sz,p,ix);fprintf(g->o,"  store i64 %%t%d, ptr %%t%d\n",v.id,ep);ix++;}}fprintf(g->o,"  %%t%d = getelementptr [%u x i64], ptr %%t%d, i64 0, i64 0\n",r.id,sz,p);}return r;}
static No*sbody(Sy*s,int el){if(!s||s->ol.n==0)return 0;for(uint32_t i=0;i<s->ol.n;i++){No*b=s->ol.d[i];if((b->k==N_PB||b->k==N_FB)&&b->bd.el==el)return b;}return s->ol.d[0];}
static V gex(Gn*g,No*n){if(!n)return(V){0,VK_I};V r={nt(g),tk2v(n->ty)};switch(n->k){case N_INT:r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, %lld\n",r.id,(long long)n->i);break;case N_REAL:r.k=VK_F;fprintf(g->o,"  %%t%d = fadd double 0.0, %g\n",r.id,n->f);break;case N_CHAR:r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, %d\n",r.id,(int)n->i);break;case N_STR:r.k=VK_P;{int p=nt(g);fprintf(g->o,"  %%t%d = alloca [%u x i8]\n",p,n->s.n+1);fprintf(g->o,"  store [%u x i8] c\"",n->s.n+1);for(uint32_t i=0;i<n->s.n;i++){char c=n->s.s[i];if(c=='"')fprintf(g->o,"\\22");else if(c=='\\')fprintf(g->o,"\\5C");else if(c<32||c>126)fprintf(g->o,"\\%02X",(unsigned char)c);else fprintf(g->o,"%c",c);}fprintf(g->o,"\\00\", ptr %%t%d\n",p);fprintf(g->o,"  %%t%d = getelementptr [%u x i8], ptr %%t%d, i64 0, i64 0\n",r.id,n->s.n+1,p);}break;case N_NULL:r.k=VK_P;fprintf(g->o,"  %%t%d = inttoptr i64 0 to ptr\n",r.id);break;case N_ID:{Sy*s=n->sy?n->sy:syf(g->sm,n->s);if(s&&s->k==2){r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, %lld\n",r.id,(long long)s->vl);}else{Vk k=VK_I;if(s&&s->ty)k=tk2v(s->ty);r.k=k;if(s&&s->lv>=0&&s->lv<g->sm->lv)fprintf(g->o,"  %%t%d = load %s, ptr %%lnk.%d.%.*s\n",r.id,vt(k),s->lv,(int)n->s.n,n->s.s);else fprintf(g->o,"  %%t%d = load %s, ptr %%v.%.*s\n",r.id,vt(k),(int)n->s.n,n->s.s);}}break;case N_BIN:{Tk op=n->bn.op;if(op==T_ATHN||op==T_OREL){V lv=vbool(g,gex(g,n->bn.l));int c=nt(g);fprintf(g->o,"  %%t%d = icmp ne i64 %%t%d, 0\n",c,lv.id);int lt=nl(g),lf=nl(g),ld=nl(g);if(op==T_ATHN)fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",c,lt,lf);else fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",c,lf,lt);fprintf(g->o,"L%d:\n",lt);V rv=vbool(g,gex(g,n->bn.r));fprintf(g->o,"  br label %%L%d\n",ld);fprintf(g->o,"L%d:\n",lf);fprintf(g->o,"  br label %%L%d\n",ld);fprintf(g->o,"L%d:\n",ld);r.k=VK_I;fprintf(g->o,"  %%t%d = phi i64 [%s,%%L%d],[%%t%d,%%L%d]\n",r.id,op==T_ATHN?"0":"1",lf,rv.id,lt);break;}if(op==T_AND||op==T_OR||op==T_XOR){V a=vbool(g,gex(g,n->bn.l));V b=vbool(g,gex(g,n->bn.r));r.k=VK_I;if(op==T_AND)fprintf(g->o,"  %%t%d = and i64 %%t%d, %%t%d\n",r.id,a.id,b.id);else if(op==T_OR)fprintf(g->o,"  %%t%d = or i64 %%t%d, %%t%d\n",r.id,a.id,b.id);else fprintf(g->o,"  %%t%d = xor i64 %%t%d, %%t%d\n",r.id,a.id,b.id);break;}if(op==T_IN){V x=vcast(g,gex(g,n->bn.l),VK_I);No*rr=n->bn.r;if(rr&&rr->k==N_RN){V lo=vcast(g,gex(g,rr->rn.lo),VK_I),hi=vcast(g,gex(g,rr->rn.hi),VK_I);V ge=vcmpi(g,"sge",x,lo);V le=vcmpi(g,"sle",x,hi);V b1=vbool(g,ge),b2=vbool(g,le);int c1=nt(g);fprintf(g->o,"  %%t%d = icmp ne i64 %%t%d, 0\n",c1,b1.id);int c2=nt(g);fprintf(g->o,"  %%t%d = icmp ne i64 %%t%d, 0\n",c2,b2.id);int a1=nt(g);fprintf(g->o,"  %%t%d = and i1 %%t%d, %%t%d\n",a1,c1,c2);r.k=VK_I;fprintf(g->o,"  %%t%d = zext i1 %%t%d to i64\n",r.id,a1);}else{r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, 0\n",r.id);}break;}V a=gex(g,n->bn.l),b=gex(g,n->bn.r);if(op==T_EX){if(b.k==VK_F){int bc=nt(g);fprintf(g->o,"  %%t%d = fptosi double %%t%d to i64\n",bc,b.id);b.id=bc;b.k=VK_I;}V bi=vcast(g,b,VK_I);int cf=nt(g);fprintf(g->o,"  %%t%d = icmp slt i64 %%t%d, 0\n",cf,bi.id);int lt=nl(g),lf=nl(g);fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",cf,lt,lf);fprintf(g->o,"L%d:\n",lt);fprintf(g->o,"  call void @__ada_raise(ptr @.ex.CONSTRAINT_ERROR)\n  unreachable\nL%d:\n",lf);if(tk2v(n->ty)==VK_F){r=vpows(g,a,b);}else{r=vpowi(g,a,bi);}break;}if(op==T_PL||op==T_MN||op==T_ST||op==T_SL){if(a.k==VK_F||b.k==VK_F){a=vcast(g,a,VK_F);b=vcast(g,b,VK_F);r.k=VK_F;fprintf(g->o,"  %%t%d = %s double %%t%d, %%t%d\n",r.id,op==T_PL?"fadd":op==T_MN?"fsub":op==T_ST?"fmul":"fdiv",a.id,b.id);}else{a=vcast(g,a,VK_I);b=vcast(g,b,VK_I);r.k=VK_I;fprintf(g->o,"  %%t%d = %s i64 %%t%d, %%t%d\n",r.id,op==T_PL?"add":op==T_MN?"sub":op==T_ST?"mul":"sdiv",a.id,b.id);}break;}if(op==T_MOD||op==T_REM){a=vcast(g,a,VK_I);b=vcast(g,b,VK_I);r.k=VK_I;fprintf(g->o,"  %%t%d = srem i64 %%t%d, %%t%d\n",r.id,a.id,b.id);break;}if(op==T_EQ||op==T_NE||op==T_LT||op==T_LE||op==T_GT||op==T_GE){if(a.k==VK_F||b.k==VK_F){const char*cc=op==T_EQ?"oeq":op==T_NE?"one":op==T_LT?"olt":op==T_LE?"ole":op==T_GT?"ogt":"oge";r=vcmpf(g,cc,a,b);}else{const char*cc=op==T_EQ?"eq":op==T_NE?"ne":op==T_LT?"slt":op==T_LE?"sle":op==T_GT?"sgt":"sge";r=vcmpi(g,cc,a,b);}break;}r.k=VK_I;{V ai=vcast(g,a,VK_I),bi=vcast(g,b,VK_I);fprintf(g->o,"  %%t%d = add i64 %%t%d, %%t%d\n",r.id,ai.id,bi.id);}break;}break;case N_UN:{V x=gex(g,n->un.x);if(n->un.op==T_MN){if(x.k==VK_F){r.k=VK_F;fprintf(g->o,"  %%t%d = fsub double 0.0, %%t%d\n",r.id,x.id);}else{x=vcast(g,x,VK_I);r.k=VK_I;fprintf(g->o,"  %%t%d = sub i64 0, %%t%d\n",r.id,x.id);}break;}if(n->un.op==T_NOT){V b=vbool(g,x);r.k=VK_I;fprintf(g->o,"  %%t%d = xor i64 %%t%d, 1\n",r.id,b.id);break;}if(n->un.op==T_ABS){if(x.k==VK_F){V z=vcast(g,x,VK_F);int c=nt(g);fprintf(g->o,"  %%t%d = fcmp olt double %%t%d, 0.0\n",c,z.id);V ng={nt(g),VK_F};fprintf(g->o,"  %%t%d = fsub double 0.0, %%t%d\n",ng.id,z.id);r.k=VK_F;fprintf(g->o,"  %%t%d = select i1 %%t%d, double %%t%d, double %%t%d\n",r.id,c,ng.id,z.id);}else{V z=vcast(g,x,VK_I);int c=nt(g);fprintf(g->o,"  %%t%d = icmp slt i64 %%t%d, 0\n",c,z.id);V ng={nt(g),VK_I};fprintf(g->o,"  %%t%d = sub i64 0, %%t%d\n",ng.id,z.id);r.k=VK_I;fprintf(g->o,"  %%t%d = select i1 %%t%d, i64 %%t%d, i64 %%t%d\n",r.id,c,ng.id,z.id);}break;}r=vcast(g,x,r.k);break;}break;case N_IX:{V p=gex(g,n->ix.p);V i0=vcast(g,gex(g,n->ix.ix.d[0]),VK_I);int ep=nt(g);fprintf(g->o,"  %%t%d = getelementptr i64, ptr %%t%d, i64 %%t%d\n",ep,p.id,i0.id);r.k=VK_I;fprintf(g->o,"  %%t%d = load i64, ptr %%t%d\n",r.id,ep);}break;case N_SL:{V p=gex(g,n->sl.p);V lo=vcast(g,gex(g,n->sl.lo),VK_I);V hi=vcast(g,gex(g,n->sl.hi),VK_I);int ln=nt(g);fprintf(g->o,"  %%t%d = sub i64 %%t%d, %%t%d\n",ln,hi.id,lo.id);int sz=nt(g);fprintf(g->o,"  %%t%d = add i64 %%t%d, 1\n",sz,ln);int sl=nt(g);fprintf(g->o,"  %%t%d = mul i64 %%t%d, 8\n",sl,sz);int ap=nt(g);fprintf(g->o,"  %%t%d = alloca i8, i64 %%t%d\n",ap,sl);int sp=nt(g);fprintf(g->o,"  %%t%d = getelementptr i64, ptr %%t%d, i64 %%t%d\n",sp,p.id,lo.id);fprintf(g->o,"  call void @llvm.memcpy.p0.p0.i64(ptr %%t%d, ptr %%t%d, i64 %%t%d, i1 false)\n",ap,sp,sl);r.k=VK_P;fprintf(g->o,"  %%t%d = bitcast ptr %%t%d to ptr\n",r.id,ap);}break;case N_SEL:{Ty*pt=n->se.p->ty?tcc(n->se.p->ty):0;V p={nt(g),VK_P};if(n->se.p->k==N_ID){Sy*s=syf(g->sm,n->se.p->s);if(s&&s->lv>=0&&s->lv<g->sm->lv)fprintf(g->o,"  %%t%d = bitcast ptr %%lnk.%d.%.*s to ptr\n",p.id,s->lv,(int)n->se.p->s.n,n->se.p->s.s);else fprintf(g->o,"  %%t%d = bitcast ptr %%v.%.*s to ptr\n",p.id,(int)n->se.p->s.n,n->se.p->s.s);}else{p=gex(g,n->se.p);}if(pt&&pt->k==TY_R){if(pt->pk){for(uint32_t i=0;i<pt->cm.n;i++){No*c=pt->cm.d[i];if(c->k==N_CM&&si(c->cm.nm,n->se.se)){int bp=nt(g);fprintf(g->o,"  %%t%d = ptrtoint ptr %%t%d to i64\n",bp,p.id);int bo=nt(g);fprintf(g->o,"  %%t%d = add i64 %%t%d, %u\n",bo,bp,c->cm.of/8);int pp=nt(g);fprintf(g->o,"  %%t%d = inttoptr i64 %%t%d to ptr\n",pp,bo);int vp=nt(g);fprintf(g->o,"  %%t%d = load i64, ptr %%t%d\n",vp,pp);int sh=nt(g);fprintf(g->o,"  %%t%d = lshr i64 %%t%d, %u\n",sh,vp,c->cm.of%8);int ms=nt(g);uint64_t mk=(1ULL<<c->cm.bt)-1;r.k=VK_I;fprintf(g->o,"  %%t%d = and i64 %%t%d, %llu\n",r.id,sh,(unsigned long long)mk);break;}}}else{for(uint32_t i=0;i<pt->cm.n;i++){No*c=pt->cm.d[i];if(c->k==N_CM&&si(c->cm.nm,n->se.se)){int ep=nt(g);fprintf(g->o,"  %%t%d = getelementptr i64, ptr %%t%d, i64 %u\n",ep,p.id,c->cm.of);r.k=VK_I;fprintf(g->o,"  %%t%d = load i64, ptr %%t%d\n",r.id,ep);break;}}}}else if(n->sy&&n->sy->k==2){r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, %lld\n",r.id,(long long)n->sy->vl);}else{r=vcast(g,p,r.k);}}break;case N_AT:{if(si(n->at.at,Z("ADDRESS"))){V p=gex(g,n->at.p);p=vcast(g,p,VK_P);r.k=VK_I;fprintf(g->o,"  %%t%d = ptrtoint ptr %%t%d to i64\n",r.id,p.id);}else if(si(n->at.at,Z("SIZE"))){Ty*t=n->at.p?tcc(n->at.p->ty):0;int64_t sz=8;if(t)sz=t->sz*8;r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, %lld\n",r.id,(long long)sz);}else if(si(n->at.at,Z("FIRST"))||si(n->at.at,Z("LAST"))||si(n->at.at,Z("LENGTH"))){Ty*t=n->at.p?tcc(n->at.p->ty):0;int64_t lo=0,hi=-1;if(t&&t->k==TY_A){lo=t->lo;hi=t->hi;}else if(t&&(t->k==TY_I||t->k==TY_UI||t->k==TY_E)){lo=t->lo;hi=t->hi;}int64_t v=0;if(si(n->at.at,Z("FIRST")))v=lo;else if(si(n->at.at,Z("LAST")))v=hi;else v=hi>=lo?(hi-lo+1):0;r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, %lld\n",r.id,(long long)v);}else if(si(n->at.at,Z("COUNT"))||si(n->at.at,Z("CALLABLE"))||si(n->at.at,Z("TERMINATED"))){r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, 0\n",r.id);}else if(si(n->at.at,Z("ACCESS"))){V p=gex(g,n->at.p);r.k=VK_P;fprintf(g->o,"  %%t%d = bitcast ptr %%t%d to ptr\n",r.id,p.id);}else{r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, 8\n",r.id);}break;}break;case N_QL:{V q=gex(g,n->ql.ag);r=vcast(g,q,r.k);}break;case N_CL:{if(n->cl.fn->k==N_ID){Sy*s=syfa(g->sm,n->cl.fn->s,n->cl.ar.n,n->ty);if(s){if(si(s->nm,Z("CREATE"))||si(s->nm,Z("OPEN"))){r.k=VK_P;int md=n->cl.ar.n>1?gex(g,n->cl.ar.d[1]).id:0;fprintf(g->o,"  %%t%d = call ptr @__text_io_%s(i64 %d, ptr %%t%d)\n",r.id,si(s->nm,Z("CREATE"))?"create":"open",md,n->cl.ar.n>2?gex(g,n->cl.ar.d[2]).id:0);break;}if(si(s->nm,Z("CLOSE"))||si(s->nm,Z("DELETE"))){if(n->cl.ar.n>0){V f=gex(g,n->cl.ar.d[0]);fprintf(g->o,"  call void @__text_io_%s(ptr %%t%d)\n",si(s->nm,Z("CLOSE"))?"close":"delete",f.id);}break;}if(si(s->nm,Z("GET"))||si(s->nm,Z("GET_LINE"))){if(n->cl.ar.n>1){V f=gex(g,n->cl.ar.d[0]);r.k=VK_I;fprintf(g->o,"  %%t%d = call i64 @__text_io_get(ptr %%t%d)\n",r.id,f.id);}else{r.k=VK_I;fprintf(g->o,"  %%t%d = call i64 @__text_io_get(ptr @stdin)\n",r.id);}break;}if(si(s->nm,Z("PUT"))||si(s->nm,Z("PUT_LINE"))){if(n->cl.ar.n>1){V f=gex(g,n->cl.ar.d[0]);V v=gex(g,n->cl.ar.d[1]);fprintf(g->o,"  call void @__text_io_%s(ptr %%t%d, ",si(s->nm,Z("PUT"))?"put":"put_line",f.id);if(v.k==VK_I)fprintf(g->o,"i64 %%t%d)\n",v.id);else if(v.k==VK_F)fprintf(g->o,"double %%t%d)\n",v.id);else fprintf(g->o,"ptr %%t%d)\n",v.id);}else{V v=gex(g,n->cl.ar.d[0]);fprintf(g->o,"  call void @__text_io_%s(ptr @stdout, ",si(s->nm,Z("PUT"))?"put":"put_line");if(v.k==VK_I)fprintf(g->o,"i64 %%t%d)\n",v.id);else if(v.k==VK_F)fprintf(g->o,"double %%t%d)\n",v.id);else fprintf(g->o,"ptr %%t%d)\n",v.id);}break;}if(s->ty&&s->ty->k==TY_S){Vk rk=tk2v(s->ty->el);r.k=rk;No*b=sbody(s,s->el);No*sp=b?b->bd.sp:0;int arid[64];Vk ark[64];int arp[64];for(uint32_t i=0;i<n->cl.ar.n&&i<64;i++){No*pm=sp&&i<sp->sp.pmm.n?sp->sp.pmm.d[i]:0;V av=gex(g,n->cl.ar.d[i]);Vk ek=VK_I;bool rf=false;if(pm&&pm->sy&&pm->sy->ty){ek=tk2v(pm->sy->ty);if(pm->pm.md&2){rf=true;int ap=nt(g);fprintf(g->o,"  %%t%d = alloca %s\n",ap,vt(ek));fprintf(g->o,"  store %s %%t%d, ptr %%t%d\n",vt(ek),av.id,ap);av.id=ap;av.k=VK_P;ek=VK_P;}}if(!rf){V cv=vcast(g,av,ek);av=cv;}arid[i]=av.id;ark[i]=ek;arp[i]=i<sp->sp.pmm.n&&sp->sp.pmm.d[i]->pm.md&2?1:0;}fprintf(g->o,"  %%t%d = call %s @%.*s.%d(",r.id,vt(rk),(int)n->cl.fn->s.n,n->cl.fn->s.s,s->el);for(uint32_t i=0;i<n->cl.ar.n;i++){if(i)fprintf(g->o,", ");fprintf(g->o,"%s %%t%d",vt(ark[i]),arid[i]);}fprintf(g->o,")\n");for(uint32_t i=0;i<n->cl.ar.n&&i<64;i++){if(arp[i]){int lv=nt(g);fprintf(g->o,"  %%t%d = load %s, ptr %%t%d\n",lv,vt(ark[i]==VK_P?VK_I:ark[i]),arid[i]);V rv={lv,ark[i]==VK_P?VK_I:ark[i]};V cv=vcast(g,rv,tk2v(n->cl.ar.d[i]->ty));No*tg=n->cl.ar.d[i];if(tg->k==N_ID){Sy*ts=syf(g->sm,tg->s);if(ts){fprintf(g->o,"  store %s %%t%d, ptr %%v.%.*s\n",vt(cv.k),cv.id,(int)tg->s.n,tg->s.s);}}}}break;}else{r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, 0\n",r.id);}}else{r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, 0\n",r.id);}}else{r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, 0\n",r.id);}break;}break;case N_AG:return gag(g,n,n->ty);case N_ALC:{r.k=VK_P;Ty*et=n->ty&&n->ty->el?tcc(n->ty->el):0;uint32_t asz=64;if(et&&et->dc.n>0)asz+=et->dc.n*8;fprintf(g->o,"  %%t%d = call ptr @malloc(i64 %u)\n",r.id,asz);if(et&&et->dc.n>0){for(uint32_t i=0;i<et->dc.n;i++){No*d=et->dc.d[i];if(d->k==N_DS&&d->pm.df){V dv=gex(g,d->pm.df);dv=vcast(g,dv,VK_I);int dp=nt(g);fprintf(g->o,"  %%t%d = getelementptr i64, ptr %%t%d, i64 %u\n",dp,r.id,i);fprintf(g->o,"  store i64 %%t%d, ptr %%t%d\n",dv.id,dp);}}}if(n->alc.in){V v=gex(g,n->alc.in);v=vcast(g,v,VK_I);int op=nt(g);fprintf(g->o,"  %%t%d = getelementptr i64, ptr %%t%d, i64 %u\n",op,r.id,et&&et->dc.n>0?(uint32_t)et->dc.n:0);fprintf(g->o,"  store i64 %%t%d, ptr %%t%d\n",v.id,op);}}break;case N_DRF:{V p=gex(g,n->drf.x);r.k=VK_I;fprintf(g->o,"  %%t%d = load i64, ptr %%t%d\n",r.id,p.id);}break;case N_CVT:{V e=gex(g,n->cvt.ex);r=vcast(g,e,r.k);}break;case N_CHK:{V e=gex(g,n->chk.ex);Ty*t=n->chk.ex->ty?tcc(n->chk.ex->ty):0;if(t&&t->k==TY_I&&(t->lo!=TY_INT->lo||t->hi!=TY_INT->hi)){int lok=nl(g),hik=nl(g),erl=nl(g),dn=nl(g);int lc=nt(g);fprintf(g->o,"  %%t%d = icmp sge i64 %%t%d, %lld\n",lc,e.id,(long long)t->lo);fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",lc,lok,erl);fprintf(g->o,"L%d:\n",lok);int hc=nt(g);fprintf(g->o,"  %%t%d = icmp sle i64 %%t%d, %lld\n",hc,e.id,(long long)t->hi);fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",hc,hik,erl);fprintf(g->o,"L%d:\n",hik);fprintf(g->o,"  br label %%L%d\n",dn);fprintf(g->o,"L%d:\n",erl);fprintf(g->o,"  call void @__ada_raise(ptr @.ex.%.*s)\n",(int)n->chk.ec.n,n->chk.ec.s);fprintf(g->o,"  unreachable\n");fprintf(g->o,"L%d:\n",dn);r=vcast(g,e,r.k);}else r=vcast(g,e,r.k);}break;case N_RN:{V lo=gex(g,n->rn.lo);r=vcast(g,lo,r.k);}break;default:r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, 0\n",r.id);}return r;}
static void gss(Gn*g,No*n){if(!n)return;switch(n->k){case N_NS:fprintf(g->o,"  ; null\n");break;case N_AS:{V v=gex(g,n->as.vl);if(n->as.tg->k==N_ID){Sy*s=n->as.tg->sy;Vk k=s&&s->ty?tk2v(s->ty):VK_I;v=vcast(g,v,k);if(s&&s->lv>=0&&s->lv<g->sm->lv)fprintf(g->o,"  store %s %%t%d, ptr %%lnk.%d.%.*s\n",vt(k),v.id,s->lv,(int)n->as.tg->s.n,n->as.tg->s.s);else fprintf(g->o,"  store %s %%t%d, ptr %%v.%.*s\n",vt(k),v.id,(int)n->as.tg->s.n,n->as.tg->s.s);}else if(n->as.tg->k==N_IX){V p=gex(g,n->as.tg->ix.p);V i0=vcast(g,gex(g,n->as.tg->ix.ix.d[0]),VK_I);int ep=nt(g);fprintf(g->o,"  %%t%d = getelementptr i64, ptr %%t%d, i64 %%t%d\n",ep,p.id,i0.id);v=vcast(g,v,VK_I);fprintf(g->o,"  store i64 %%t%d, ptr %%t%d\n",v.id,ep);}else if(n->as.tg->k==N_SEL){Ty*pt=n->as.tg->se.p->ty?tcc(n->as.tg->se.p->ty):0;V p={nt(g),VK_P};if(n->as.tg->se.p->k==N_ID){Sy*s=syf(g->sm,n->as.tg->se.p->s);if(s&&s->lv>=0&&s->lv<g->sm->lv)fprintf(g->o,"  %%t%d = bitcast ptr %%lnk.%d.%.*s to ptr\n",p.id,s->lv,(int)n->as.tg->se.p->s.n,n->as.tg->se.p->s.s);else fprintf(g->o,"  %%t%d = bitcast ptr %%v.%.*s to ptr\n",p.id,(int)n->as.tg->se.p->s.n,n->as.tg->se.p->s.s);}else{p=gex(g,n->as.tg->se.p);}if(pt&&pt->k==TY_R){if(pt->pk){for(uint32_t i=0;i<pt->cm.n;i++){No*c=pt->cm.d[i];if(c->k==N_CM&&si(c->cm.nm,n->as.tg->se.se)){v=vcast(g,v,VK_I);int bp=nt(g);fprintf(g->o,"  %%t%d = ptrtoint ptr %%t%d to i64\n",bp,p.id);int bo=nt(g);fprintf(g->o,"  %%t%d = add i64 %%t%d, %u\n",bo,bp,c->cm.of/8);int pp=nt(g);fprintf(g->o,"  %%t%d = inttoptr i64 %%t%d to ptr\n",pp,bo);int ov=nt(g);fprintf(g->o,"  %%t%d = load i64, ptr %%t%d\n",ov,pp);uint64_t mk=(1ULL<<c->cm.bt)-1;int sh=nt(g);fprintf(g->o,"  %%t%d = shl i64 %%t%d, %u\n",sh,v.id,c->cm.of%8);int ms=nt(g);fprintf(g->o,"  %%t%d = and i64 %%t%d, %llu\n",ms,sh,(unsigned long long)(mk<<(c->cm.of%8)));uint64_t cmk=~(mk<<(c->cm.of%8));int cl=nt(g);fprintf(g->o,"  %%t%d = and i64 %%t%d, %llu\n",cl,ov,(unsigned long long)cmk);int nv_=nt(g);fprintf(g->o,"  %%t%d = or i64 %%t%d, %%t%d\n",nv_,cl,ms);fprintf(g->o,"  store i64 %%t%d, ptr %%t%d\n",nv_,pp);break;}}}else{for(uint32_t i=0;i<pt->cm.n;i++){No*c=pt->cm.d[i];if(c->k==N_CM&&si(c->cm.nm,n->as.tg->se.se)){int ep=nt(g);fprintf(g->o,"  %%t%d = getelementptr i64, ptr %%t%d, i64 %u\n",ep,p.id,c->cm.of);v=vcast(g,v,VK_I);fprintf(g->o,"  store i64 %%t%d, ptr %%t%d\n",v.id,ep);break;}}}}}else{v=vcast(g,v,VK_I);fprintf(g->o,"  ; store to complex lvalue\n");}}break;case N_IF:{V c=vbool(g,gex(g,n->if_.cd));int ct=nt(g);fprintf(g->o,"  %%t%d = icmp ne i64 %%t%d, 0\n",ct,c.id);int lt=nl(g),lf=nl(g),ld=nl(g);fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",ct,lt,lf);fprintf(g->o,"L%d:\n",lt);for(uint32_t i=0;i<n->if_.th.n;i++)gss(g,n->if_.th.d[i]);fprintf(g->o,"  br label %%L%d\n",ld);fprintf(g->o,"L%d:\n",lf);if(n->if_.ei.n>0){for(uint32_t i=0;i<n->if_.ei.n;i++){No*e=n->if_.ei.d[i];V ec=vbool(g,gex(g,e->if_.cd));int ect=nt(g);fprintf(g->o,"  %%t%d = icmp ne i64 %%t%d, 0\n",ect,ec.id);int let=nl(g),lef=nl(g);fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",ect,let,lef);fprintf(g->o,"L%d:\n",let);for(uint32_t j=0;j<e->if_.th.n;j++)gss(g,e->if_.th.d[j]);fprintf(g->o,"  br label %%L%d\n",ld);fprintf(g->o,"L%d:\n",lef);}}if(n->if_.el.n>0){for(uint32_t i=0;i<n->if_.el.n;i++)gss(g,n->if_.el.d[i]);}fprintf(g->o,"  br label %%L%d\n",ld);fprintf(g->o,"L%d:\n",ld);}break;case N_CS:{V ex=gex(g,n->cs.ex);int ld=nl(g);NV lb={0};for(uint32_t i=0;i<n->cs.al.n;i++){No*a=n->cs.al.d[i];int la=nl(g);nv(&lb,ND(INT,n->l));lb.d[i]->i=la;}for(uint32_t i=0;i<n->cs.al.n;i++){No*a=n->cs.al.d[i];int la=lb.d[i]->i;for(uint32_t j=0;j<a->ch.it.n;j++){No*ch=a->ch.it.d[j];if(ch->k==N_ID&&si(ch->s,Z("others"))){fprintf(g->o,"  br label %%L%d\n",la);goto cs_sw_done;}V cv=gex(g,ch);cv=vcast(g,cv,ex.k);if(ch->k==N_RN){V lo=gex(g,ch->rn.lo);lo=vcast(g,lo,ex.k);V hi=gex(g,ch->rn.hi);hi=vcast(g,hi,ex.k);int cge=nt(g);fprintf(g->o,"  %%t%d = icmp sge i64 %%t%d, %%t%d\n",cge,ex.id,lo.id);int cle=nt(g);fprintf(g->o,"  %%t%d = icmp sle i64 %%t%d, %%t%d\n",cle,ex.id,hi.id);int ca=nt(g);fprintf(g->o,"  %%t%d = and i1 %%t%d, %%t%d\n",ca,cge,cle);int lnx=i+1<n->cs.al.n?lb.d[i+1]->i:ld;fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",ca,la,lnx);}else{int ceq=nt(g);fprintf(g->o,"  %%t%d = icmp eq i64 %%t%d, %%t%d\n",ceq,ex.id,cv.id);int lnx=i+1<n->cs.al.n?lb.d[i+1]->i:ld;fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",ceq,la,lnx);}}}cs_sw_done:;for(uint32_t i=0;i<n->cs.al.n;i++){No*a=n->cs.al.d[i];int la=lb.d[i]->i;fprintf(g->o,"L%d:\n",la);for(uint32_t j=0;j<a->hnd.stz.n;j++)gss(g,a->hnd.stz.d[j]);fprintf(g->o,"  br label %%L%d\n",ld);}fprintf(g->o,"L%d:\n",ld);}break;case N_LP:{int lb=nl(g),lc=nl(g),le=nl(g);if(g->ls<64)g->ll[g->ls++]=le;if(n->lp.lb.s){slv(&g->lbs,n->lp.lb);nv(&n->lp.lk,ND(INT,n->l));n->lp.lk.d[n->lp.lk.n-1]->i=le;}fprintf(g->o,"  br label %%L%d\n",lb);fprintf(g->o,"L%d:\n",lb);if(n->lp.it){V c=vbool(g,gex(g,n->lp.it));int ct=nt(g);fprintf(g->o,"  %%t%d = icmp ne i64 %%t%d, 0\n",ct,c.id);fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",ct,lc,le);}else fprintf(g->o,"  br label %%L%d\n",lc);fprintf(g->o,"L%d:\n",lc);for(uint32_t i=0;i<n->lp.st.n;i++)gss(g,n->lp.st.d[i]);fprintf(g->o,"  br label %%L%d\n",lb);fprintf(g->o,"L%d:\n",le);if(g->ls>0)g->ls--;}break;case N_EX:{if(n->ex.lb.s){int li=flbl(g,n->ex.lb);if(li>=0){int le=g->ll[li];if(n->ex.cd){V c=vbool(g,gex(g,n->ex.cd));int ct=nt(g);fprintf(g->o,"  %%t%d = icmp ne i64 %%t%d, 0\n",ct,c.id);int lc=nl(g);fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",ct,le,lc);fprintf(g->o,"L%d:\n",lc);}else fprintf(g->o,"  br label %%L%d\n",le);}else{if(n->ex.cd){V c=vbool(g,gex(g,n->ex.cd));int ct=nt(g);fprintf(g->o,"  %%t%d = icmp ne i64 %%t%d, 0\n",ct,c.id);int le=g->ls>0?g->ll[g->ls-1]:nl(g),lc=nl(g);fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",ct,le,lc);fprintf(g->o,"L%d:\n",lc);}else{int le=g->ls>0?g->ll[g->ls-1]:nl(g);fprintf(g->o,"  br label %%L%d\n",le);}}}else{if(n->ex.cd){V c=vbool(g,gex(g,n->ex.cd));int ct=nt(g);fprintf(g->o,"  %%t%d = icmp ne i64 %%t%d, 0\n",ct,c.id);int le=g->ls>0?g->ll[g->ls-1]:nl(g),lc=nl(g);fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",ct,le,lc);fprintf(g->o,"L%d:\n",lc);}else{int le=g->ls>0?g->ll[g->ls-1]:nl(g);fprintf(g->o,"  br label %%L%d\n",le);}}}break;case N_GT:{int li=flbl(g,n->go.lb);if(li>=0){fprintf(g->o,"  br label %%lbl.%.*s\n",(int)n->go.lb.n,n->go.lb.s);}else fprintf(g->o,"  br label %%lbl.%.*s\n",(int)n->go.lb.n,n->go.lb.s);}break;case N_RT:{if(n->rt.vl){V v=gex(g,n->rt.vl);fprintf(g->o,"  ret %s %%t%d\n",vt(v.k),v.id);}else fprintf(g->o,"  ret void\n");}break;case N_RS:{S ec=n->rs.ec&&n->rs.ec->k==N_ID?n->rs.ec->s:Z("PROGRAM_ERROR");fprintf(g->o,"  %%__exh = load ptr, ptr %%ej\n");fprintf(g->o,"  store ptr @.ex.%.*s, ptr @__ex_cur\n",(int)ec.n,ec.s);fprintf(g->o,"  call void @longjmp(ptr %%__exh, i32 1)\n");fprintf(g->o,"  unreachable\n");}break;case N_CLT:{if(n->ct.nm->k==N_ID){Sy*s=syfa(g->sm,n->ct.nm->s,n->ct.arr.n,0);if(s){if(si(s->nm,Z("PUT"))||si(s->nm,Z("PUT_LINE"))){if(n->ct.arr.n>0){V v=gex(g,n->ct.arr.d[0]);if(v.k==VK_I)fprintf(g->o,"  call void @__text_io_put_i64(i64 %%t%d)\n",v.id);else if(v.k==VK_F)fprintf(g->o,"  call void @__text_io_put_f64(double %%t%d)\n",v.id);else fprintf(g->o,"  call void @__text_io_put_str(ptr %%t%d)\n",v.id);if(si(s->nm,Z("PUT_LINE")))fprintf(g->o,"  call void @__text_io_newline()\n");}break;}if(si(s->nm,Z("NEW_LINE"))){fprintf(g->o,"  call void @__text_io_newline()\n");break;}No*b=sbody(s,s->el);if(b){int arid[64];Vk ark[64];int arp[64];No*sp=b->bd.sp;for(uint32_t i=0;i<n->ct.arr.n&&i<64;i++){No*pm=sp&&i<sp->sp.pmm.n?sp->sp.pmm.d[i]:0;V av=gex(g,n->ct.arr.d[i]);Vk ek=VK_I;bool rf=false;if(pm&&pm->sy&&pm->sy->ty){ek=tk2v(pm->sy->ty);if(pm->pm.md&2){rf=true;int ap=nt(g);fprintf(g->o,"  %%t%d = alloca %s\n",ap,vt(ek));fprintf(g->o,"  store %s %%t%d, ptr %%t%d\n",vt(ek),av.id,ap);av.id=ap;av.k=VK_P;ek=VK_P;}}if(!rf){V cv=vcast(g,av,ek);av=cv;}arid[i]=av.id;ark[i]=ek;arp[i]=rf?1:0;}fprintf(g->o,"  call void @%.*s.%d(",(int)n->ct.nm->s.n,n->ct.nm->s.s,s->el);for(uint32_t i=0;i<n->ct.arr.n;i++){if(i)fprintf(g->o,", ");fprintf(g->o,"%s %%t%d",vt(ark[i]),arid[i]);}fprintf(g->o,")\n");for(uint32_t i=0;i<n->ct.arr.n&&i<64;i++){if(arp[i]){int lv=nt(g);fprintf(g->o,"  %%t%d = load %s, ptr %%t%d\n",lv,vt(ark[i]==VK_P?VK_I:ark[i]),arid[i]);V rv={lv,ark[i]==VK_P?VK_I:ark[i]};V cv=vcast(g,rv,tk2v(n->ct.arr.d[i]->ty));No*tg=n->ct.arr.d[i];if(tg->k==N_ID){Sy*ts=syf(g->sm,tg->s);if(ts){fprintf(g->o,"  store %s %%t%d, ptr %%v.%.*s\n",vt(cv.k),cv.id,(int)tg->s.n,tg->s.s);}}}}}}}break;case N_BL:{int sj=nt(g);fprintf(g->o,"  %%t%d = call ptr @__ada_setjmp()\n",sj);fprintf(g->o,"  %%ej = alloca ptr\n  store ptr %%t%d, ptr %%ej\n",sj);fprintf(g->o,"  store ptr %%t%d, ptr @__eh_cur\n",sj);int sv=nt(g);fprintf(g->o,"  %%t%d = call i32 @setjmp(ptr %%t%d)\n",sv,sj);int ze=nt(g);fprintf(g->o,"  %%t%d = icmp eq i32 %%t%d, 0\n",ze,sv);int ln=nl(g),lh=nl(g);fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",ze,ln,lh);fprintf(g->o,"L%d:\n",ln);for(uint32_t i=0;i<n->bk.dc.n;i++)gdl(g,n->bk.dc.d[i]);for(uint32_t i=0;i<n->bk.st.n;i++)gss(g,n->bk.st.d[i]);int ld=nl(g);fprintf(g->o,"  br label %%L%d\n",ld);fprintf(g->o,"L%d:\n",lh);if(n->bk.hd.n>0){for(uint32_t i=0;i<n->bk.hd.n;i++){No*h=n->bk.hd.d[i];int lhm=nl(g),lhn=nl(g);for(uint32_t j=0;j<h->hnd.ec.n;j++){No*e=h->hnd.ec.d[j];if(e->k==N_ID&&si(e->s,Z("others"))){fprintf(g->o,"  br label %%L%d\n",lhm);break;}int ec=nt(g);fprintf(g->o,"  %%t%d = load ptr, ptr @__ex_cur\n",ec);int cm=nt(g);fprintf(g->o,"  %%t%d = call i32 @strcmp(ptr %%t%d, ptr @.ex.%.*s)\n",cm,ec,(int)e->s.n,e->s.s);int eq=nt(g);fprintf(g->o,"  %%t%d = icmp eq i32 %%t%d, 0\n",eq,cm);fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",eq,lhm,lhn);fprintf(g->o,"L%d:\n",lhn);}fprintf(g->o,"  br label %%L%d\n",ld);fprintf(g->o,"L%d:\n",lhm);for(uint32_t j=0;j<h->hnd.stz.n;j++)gss(g,h->hnd.stz.d[j]);fprintf(g->o,"  br label %%L%d\n",ld);}}else{fprintf(g->o,"  %%__exc = load ptr, ptr @__ex_cur\n");fprintf(g->o,"  call void @__ada_raise(ptr %%__exc)\n  unreachable\n");}fprintf(g->o,"L%d:\n",ld);}break;case N_DL:{V d=gex(g,n->ex.cd);d=vcast(g,d,VK_I);fprintf(g->o,"  call void @__ada_delay(i64 %%t%d)\n",d.id);}break;case N_SA:{if(n->sa.kn==1||n->sa.kn==3){V gd=gex(g,n->sa.gd);int ld=nl(g);fprintf(g->o,"  call void @__ada_delay(i64 %%t%d)\n",gd.id);if(n->sa.kn==3)fprintf(g->o,"  call void @__ada_raise(ptr @.ex.TASKING_ERROR)\n  unreachable\n");for(uint32_t i=0;i<n->sa.sts.n;i++)gss(g,n->sa.sts.d[i]);fprintf(g->o,"  br label %%L%d\n",ld);fprintf(g->o,"L%d:\n",ld);}else{int ld=nl(g);for(uint32_t i=0;i<n->sa.sts.n;i++){No*st=n->sa.sts.d[i];if(st->k==N_ACC){for(uint32_t j=0;j<st->acc.stx.n;j++)gss(g,st->acc.stx.d[j]);}else if(st->k==N_DL){V d=gex(g,st->ex.cd);fprintf(g->o,"  call void @__ada_delay(i64 %%t%d)\n",d.id);for(uint32_t j=0;j<st->hnd.stz.n;j++)gss(g,st->hnd.stz.d[j]);}}if(n->ss.el.n>0)for(uint32_t i=0;i<n->ss.el.n;i++)gss(g,n->ss.el.d[i]);fprintf(g->o,"  br label %%L%d\n",ld);fprintf(g->o,"L%d:\n",ld);}}break;default:break;}}}
static void gdl(Gn*g,No*n){if(!n)return;switch(n->k){case N_OD:for(uint32_t i=0;i<n->od.id.n;i++){No*id=n->od.id.d[i];Vk k=n->od.ty?tk2v(rst(g->sm,n->od.ty)):VK_I;Sy*s=id->sy;if(s&&s->lv>=0&&s->lv<g->sm->lv)fprintf(g->o,"  %%lnk.%d.%.*s = alloca %s\n",s->lv,(int)id->s.n,id->s.s,vt(k));else fprintf(g->o,"  %%v.%.*s = alloca %s\n",(int)id->s.n,id->s.s,vt(k));if(n->od.in){V v=gex(g,n->od.in);v=vcast(g,v,k);if(s&&s->lv>=0&&s->lv<g->sm->lv)fprintf(g->o,"  store %s %%t%d, ptr %%lnk.%d.%.*s\n",vt(k),v.id,s->lv,(int)id->s.n,id->s.s);else fprintf(g->o,"  store %s %%t%d, ptr %%v.%.*s\n",vt(k),v.id,(int)id->s.n,id->s.s);}}break;case N_PB:{for(uint32_t i=0;i<n->bd.dc.n;i++){No*d=n->bd.dc.d[i];if(d&&(d->k==N_PB||d->k==N_FB))gdl(g,d);}No*sp=n->bd.sp;fprintf(g->o,"define void @%.*s.%d(",(int)sp->sp.nm.n,sp->sp.nm.s,n->bd.el);int np=sp->sp.pmm.n;if(n->bd.pr&&n->bd.pr->lv>=0)np++;for(int i=0;i<np;i++){if(i)fprintf(g->o,", ");if(i<(int)sp->sp.pmm.n){No*p=sp->sp.pmm.d[i];Vk k=p->pm.ty?tk2v(rst(g->sm,p->pm.ty)):VK_I;if(p->pm.md&2)fprintf(g->o,"ptr %%p.%.*s",(int)p->pm.nm.n,p->pm.nm.s);else fprintf(g->o,"%s %%p.%.*s",vt(k),(int)p->pm.nm.n,p->pm.nm.s);}else fprintf(g->o,"ptr %%__slnk");}fprintf(g->o,") {\n");for(uint32_t i=0;i<sp->sp.pmm.n;i++){No*p=sp->sp.pmm.d[i];Vk k=p->pm.ty?tk2v(rst(g->sm,p->pm.ty)):VK_I;Sy*ps=p->sy;if(ps&&ps->lv>=0&&ps->lv<g->sm->lv)fprintf(g->o,"  %%lnk.%d.%.*s = alloca %s\n",ps->lv,(int)p->pm.nm.n,p->pm.nm.s,vt(k));else fprintf(g->o,"  %%v.%.*s = alloca %s\n",(int)p->pm.nm.n,p->pm.nm.s,vt(k));if(p->pm.md&2){int lv=nt(g);fprintf(g->o,"  %%t%d = load %s, ptr %%p.%.*s\n",lv,vt(k),(int)p->pm.nm.n,p->pm.nm.s);if(ps&&ps->lv>=0&&ps->lv<g->sm->lv)fprintf(g->o,"  store %s %%t%d, ptr %%lnk.%d.%.*s\n",vt(k),lv,ps->lv,(int)p->pm.nm.n,p->pm.nm.s);else fprintf(g->o,"  store %s %%t%d, ptr %%v.%.*s\n",vt(k),lv,(int)p->pm.nm.n,p->pm.nm.s);}else{if(ps&&ps->lv>=0&&ps->lv<g->sm->lv)fprintf(g->o,"  store %s %%p.%.*s, ptr %%lnk.%d.%.*s\n",vt(k),(int)p->pm.nm.n,p->pm.nm.s,ps->lv,(int)p->pm.nm.n,p->pm.nm.s);else fprintf(g->o,"  store %s %%p.%.*s, ptr %%v.%.*s\n",vt(k),(int)p->pm.nm.n,p->pm.nm.s,(int)p->pm.nm.n,p->pm.nm.s);}}for(uint32_t i=0;i<n->bd.dc.n;i++){No*d=n->bd.dc.d[i];if(d&&d->k!=N_PB&&d->k!=N_FB)gdl(g,d);}for(uint32_t i=0;i<n->bd.st.n;i++)gss(g,n->bd.st.d[i]);fprintf(g->o,"  ret void\n}\n");}break;case N_FB:{for(uint32_t i=0;i<n->bd.dc.n;i++){No*d=n->bd.dc.d[i];if(d&&(d->k==N_PB||d->k==N_FB))gdl(g,d);}No*sp=n->bd.sp;Vk rk=sp->sp.rt?tk2v(rst(g->sm,sp->sp.rt)):VK_I;fprintf(g->o,"define %s @%.*s.%d(",vt(rk),(int)sp->sp.nm.n,sp->sp.nm.s,n->bd.el);int np=sp->sp.pmm.n;if(n->bd.pr&&n->bd.pr->lv>=0)np++;for(int i=0;i<np;i++){if(i)fprintf(g->o,", ");if(i<(int)sp->sp.pmm.n){No*p=sp->sp.pmm.d[i];Vk k=p->pm.ty?tk2v(rst(g->sm,p->pm.ty)):VK_I;if(p->pm.md&2)fprintf(g->o,"ptr %%p.%.*s",(int)p->pm.nm.n,p->pm.nm.s);else fprintf(g->o,"%s %%p.%.*s",vt(k),(int)p->pm.nm.n,p->pm.nm.s);}else fprintf(g->o,"ptr %%__slnk");}fprintf(g->o,") {\n");for(uint32_t i=0;i<sp->sp.pmm.n;i++){No*p=sp->sp.pmm.d[i];Vk k=p->pm.ty?tk2v(rst(g->sm,p->pm.ty)):VK_I;Sy*ps=p->sy;if(ps&&ps->lv>=0&&ps->lv<g->sm->lv)fprintf(g->o,"  %%lnk.%d.%.*s = alloca %s\n",ps->lv,(int)p->pm.nm.n,p->pm.nm.s,vt(k));else fprintf(g->o,"  %%v.%.*s = alloca %s\n",(int)p->pm.nm.n,p->pm.nm.s,vt(k));if(p->pm.md&2){int lv=nt(g);fprintf(g->o,"  %%t%d = load %s, ptr %%p.%.*s\n",lv,vt(k),(int)p->pm.nm.n,p->pm.nm.s);if(ps&&ps->lv>=0&&ps->lv<g->sm->lv)fprintf(g->o,"  store %s %%t%d, ptr %%lnk.%d.%.*s\n",vt(k),lv,ps->lv,(int)p->pm.nm.n,p->pm.nm.s);else fprintf(g->o,"  store %s %%t%d, ptr %%v.%.*s\n",vt(k),lv,(int)p->pm.nm.n,p->pm.nm.s);}else{if(ps&&ps->lv>=0&&ps->lv<g->sm->lv)fprintf(g->o,"  store %s %%p.%.*s, ptr %%lnk.%d.%.*s\n",vt(k),(int)p->pm.nm.n,p->pm.nm.s,ps->lv,(int)p->pm.nm.n,p->pm.nm.s);else fprintf(g->o,"  store %s %%p.%.*s, ptr %%v.%.*s\n",vt(k),(int)p->pm.nm.n,p->pm.nm.s,(int)p->pm.nm.n,p->pm.nm.s);}}for(uint32_t i=0;i<n->bd.dc.n;i++){No*d=n->bd.dc.d[i];if(d&&d->k!=N_PB&&d->k!=N_FB)gdl(g,d);}for(uint32_t i=0;i<n->bd.st.n;i++)gss(g,n->bd.st.d[i]);fprintf(g->o,"  ret %s 0\n}\n",vt(rk));}break;case N_PKB:for(uint32_t i=0;i<n->pb.dc.n;i++)gdl(g,n->pb.dc.d[i]);break;default:break;}}
static void gel(Gn*g,No*n){if(n&&n->k==N_PKB)for(uint32_t i=0;i<n->pb.st.n;i++)gss(g,n->pb.st.d[i]);}
static void grt(Gn*g){fprintf(g->o,"declare i32 @setjmp(ptr)\ndeclare void @longjmp(ptr,i32)\ndeclare i32 @pthread_create(ptr,ptr,ptr,ptr)\ndeclare i32 @pthread_join(i64,ptr)\ndeclare i32 @pthread_mutex_init(ptr,ptr)\ndeclare i32 @pthread_mutex_lock(ptr)\ndeclare i32 @pthread_mutex_unlock(ptr)\ndeclare i32 @usleep(i32)\ndeclare ptr @malloc(i64)\ndeclare void @free(ptr)\ndeclare i32 @printf(ptr,...)\ndeclare i32 @puts(ptr)\ndeclare i32 @strcmp(ptr,ptr)\ndeclare double @pow(double,double)\ndeclare void @llvm.memcpy.p0.p0.i64(ptr,ptr,i64,i1)\n");fprintf(g->o,"@__eh_cur = external global ptr\n@__ex_cur = external global ptr\n");fprintf(g->o,"@.ex.CONSTRAINT_ERROR = linkonce_odr constant [17 x i8] c\"CONSTRAINT_ERROR\\00\"\n");fprintf(g->o,"@.ex.PROGRAM_ERROR = linkonce_odr constant [14 x i8] c\"PROGRAM_ERROR\\00\"\n");fprintf(g->o,"@.ex.STORAGE_ERROR = linkonce_odr constant [14 x i8] c\"STORAGE_ERROR\\00\"\n");fprintf(g->o,"@.ex.TASKING_ERROR = linkonce_odr constant [14 x i8] c\"TASKING_ERROR\\00\"\n");fprintf(g->o,"@stdin = external global ptr\n@stdout = external global ptr\n@stderr = external global ptr\n");fprintf(g->o,"declare ptr @__ada_setjmp()\n");fprintf(g->o,"declare void @__ada_raise(ptr)\n");fprintf(g->o,"declare i64 @__ada_powi(i64,i64)\n");fprintf(g->o,"declare void @__ada_delay(i64)\n");fprintf(g->o,"declare void @__text_io_put_i64(i64)\n");fprintf(g->o,"declare void @__text_io_put_f64(double)\n");fprintf(g->o,"declare void @__text_io_put_str(ptr)\n");fprintf(g->o,"declare void @__text_io_newline()\n");fprintf(g->o,"declare ptr @__text_io_create(i64,ptr)\n");fprintf(g->o,"declare ptr @__text_io_open(i64,ptr)\n");fprintf(g->o,"declare void @__text_io_close(ptr)\n");fprintf(g->o,"declare void @__text_io_delete(ptr)\n");fprintf(g->o,"declare i64 @__text_io_get(ptr)\n");fprintf(g->o,"declare void @__text_io_put(ptr,i64)\n");fprintf(g->o,"declare void @__text_io_put_line(ptr,ptr)\n");fprintf(g->o,"@.fmt_i64 = linkonce_odr constant [5 x i8] c\"%%lld\\00\"\n");fprintf(g->o,"@.fmt_f64 = linkonce_odr constant [3 x i8] c\"%%g\\00\"\n");fprintf(g->o,"@.str_empty = linkonce_odr constant [1 x i8] c\"\\00\"\n");}
static char*rf(const char*p){FILE*f=fopen(p,"rb");if(!f)return 0;fseek(f,0,SEEK_END);long z=ftell(f);fseek(f,0,SEEK_SET);char*b=malloc(z+1);fread(b,1,z,f);b[z]=0;fclose(f);return b;}
static void wf(const char*p,const char*d){FILE*f=fopen(p,"wb");if(!f)return;fputs(d,f);fclose(f);}
static LU*lfnd(Sm*SM,S nm){for(uint32_t i=0;i<SM->lu.n;i++){LU*l=SM->lu.d[i];if(si(l->nm,nm))return l;}return 0;}
static uint64_t fts(const char*p){struct stat s;if(stat(p,&s))return 0;return s.st_mtime;}
static bool lcmp(Sm*SM,S nm,S pth){LU*ex=lfnd(SM,nm);if(ex&&ex->cmpl)return true;char fp[512];snprintf(fp,512,"%.*s.adb",(int)pth.n,pth.s);char*src=rf(fp);if(!src){snprintf(fp,512,"%.*s.ads",(int)pth.n,pth.s);src=rf(fp);}if(!src)return false;Ps p=pnw(src,strlen(src),fp);No*cu=pcu(&p);if(!cu)return false;Sm sm;smi(&sm);sm.lu=SM->lu;sm.gt=SM->gt;smu(&sm,cu);char op[512];snprintf(op,512,"%.*s.ll",(int)pth.n,pth.s);FILE*o=fopen(op,"w");Gn g={o,0,0,&sm,{0},0,{0},0,{0},0,{0},0,{0}};grt(&g);for(uint32_t i=0;i<sm.eo;i++){for(uint32_t j=0;j<4096;j++){for(Sy*s=sm.sy[j];s;s=s->nx){if(s->el==i){for(uint32_t k=0;k<s->ol.n;k++)gdl(&g,s->ol.d[k]);}}}}if(cu->cu.un){if(cu->cu.un->k==N_PKB)gel(&g,cu->cu.un);}fclose(o);LU*l=lu(cu->cu.un?cu->cu.un->k:0,nm,pth);l->cmpl=true;l->ts=fts(fp);lv(&SM->lu,l);return true;}
int main(int ac,char**av){if(ac>1&&!strcmp(av[1],"--test")){printf("\n  ADA83 COMPILER (15 tests)\n\n\n");char*T[]={"procedure T001 is\nbegin\n  null;\nend T001;","procedure T002 is\n  X: Integer := 42;\nbegin\n  X := X + 1;\nend T002;","procedure T003 is\n  function Add(A,B: Integer) return Integer is\n  begin\n    return A + B;\n  end Add;\n  R: Integer;\nbegin\n  R := Add(10, 20);\nend T003;","procedure T004 is\nbegin\n  begin\n    raise Constraint_Error;\n  exception\n    when Constraint_Error =>\n      null;\n  end;\nend T004;","procedure T005 is\n  task T is\n    entry Start;\n  end T;\n  task body T is\n  begin\n    accept Start;\n  end T;\nbegin\n  T.Start;\nend T005;","procedure T006 is\n  type Color is (Red, Green, Blue);\n  C: Color := Red;\nbegin\n  null;\nend T006;","procedure T007 is\n  type Arr is array(1..10) of Integer;\n  A: Arr;\nbegin\n  A(5) := 100;\nend T007;","procedure T008 is\n  type Rec is record\n    X: Integer;\n    Y: Integer;\n  end record;\n  R: Rec;\nbegin\n  R.X := 1;\n  R.Y := 2;\nend T008;","generic\n  type T is private;\npackage T009 is\n  procedure Set(V: T);\n  function Get return T;\nend T009;","procedure T010 is\n  package Integer_Box is new T009(Integer);\nbegin\n  Integer_Box.Set(42);\nend T010;","procedure T011 is\n  X: Integer;\nbegin\n  X := 2 ** 10;\nend T011;","procedure T012 is\n  type Status is (Ready, Waiting, Done);\n  S: Status := Ready;\nbegin\n  case S is\n    when Ready => null;\n    when Waiting => null;\n    when Done => null;\n  end case;\nend T012;","procedure T013 is\n  A: array(1..5) of Integer := (1,2,3,4,5);\n  B: array(1..3) of Integer;\nbegin\n  B := A(2..4);\nend T013;","procedure T014 is\n  procedure P(X: in out Integer) is\n  begin\n    X := X + 1;\n  end P;\n  Y: Integer := 5;\nbegin\n  P(Y);\nend T014;","procedure T015 is\n  X: Integer;\nbegin\n  loop\n    X := X + 1;\n    exit when X > 10;\n  end loop;\nend T015;"};for(int i=0;i<15;i++){printf("T%03d         ",i+1);fflush(stdout);Ps p=pnw(T[i],strlen(T[i]),"test");No*cu=pcu(&p);if(p.er||!cu){printf("\033[31mFAIL\033[0m\n");continue;}Sm sm;smi(&sm);smu(&sm,cu);char fn[64];snprintf(fn,64,"T%03d.ll",i+1);FILE*o=fopen(fn,"w");Gn g={o,0,0,&sm,{0},0,{0},0,{0},0,{0},0,{0}};grt(&g);for(uint32_t j=0;j<sm.eo;j++){for(uint32_t k=0;k<4096;k++){for(Sy*s=sm.sy[k];s;s=s->nx){if(s->el==j){for(uint32_t m=0;m<s->ol.n;m++)gdl(&g,s->ol.d[m]);}}}}if(cu->cu.un){if(cu->cu.un->k==N_PKB)gel(&g,cu->cu.un);}fclose(o);printf("\033[32mPASS\033[0m\n");}printf("\n");return 0;}if(ac<2){fprintf(stderr,"Usage: %s [--test | <file.adb> -o <output.ll>]\n",av[0]);return 1;}const char*inf=av[1];const char*ouf=ac>3?av[3]:"out.ll";char*src=rf(inf);if(!src){fprintf(stderr,"Error: cannot read %s\n",inf);return 1;}Ps p=pnw(src,strlen(src),inf);No*cu=pcu(&p);if(p.er||!cu){fprintf(stderr,"Parse error\n");return 1;}Sm sm;smi(&sm);smu(&sm,cu);FILE*o=fopen(ouf,"w");if(!o){fprintf(stderr,"Error: cannot write %s\n",ouf);return 1;}Gn g={o,0,0,&sm,{0},0,{0},0,{0},0,{0},0,{0}};grt(&g);for(uint32_t i=0;i<sm.eo;i++){for(uint32_t j=0;j<4096;j++){for(Sy*s=sm.sy[j];s;s=s->nx){if(s->el==i){for(uint32_t k=0;k<s->ol.n;k++)gdl(&g,s->ol.d[k]);}}}}if(cu->cu.un){if(cu->cu.un->k==N_PKB)gel(&g,cu->cu.un);else if(cu->cu.un->k==N_PB){No*sp=cu->cu.un->bd.sp;fprintf(o,"define i32 @main(){\n  call void @%.*s.%d(ptr null)\n  ret i32 0\n}\n",(int)sp->sp.nm.n,sp->sp.nm.s,cu->cu.un->bd.el);}}fclose(o);printf("Compiled %s -> %s\n",inf,ouf);return 0;}