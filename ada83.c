#define _POSIX_C_SOURCE 200809L
#include<stdio.h>
#include<stdlib.h>
#include<string.h>
#include<ctype.h>
#include<stdint.h>
#include<stdbool.h>
#include<stdarg.h>
#include<setjmp.h>
#include<pthread.h>
#include<sys/stat.h>
#include<fcntl.h>
#include<unistd.h>
#include<math.h>
#include<limits.h>
#include<errno.h>
typedef struct{uint64_t*d;uint32_t n,c;bool s;}U;typedef struct{U*n,*d;}R;
static U*un(uint32_t c){U*u=malloc(sizeof(U));u->d=calloc(c,8);u->n=0;u->c=c;u->s=0;return u;}
static void uf(U*u){if(u){free(u->d);free(u);}}
static void ug(U*u,uint32_t c){if(c>u->c){u->d=realloc(u->d,c*8);memset(u->d+u->c,0,(c-u->c)*8);u->c=c;}}
static void uz(U*u){while(u->n>0&&!u->d[u->n-1])u->n--;if(!u->n)u->s=0;}
static int uca(const U*a,const U*b){if(a->n!=b->n)return a->n>b->n?1:-1;for(int i=a->n-1;i>=0;i--)if(a->d[i]!=b->d[i])return a->d[i]>b->d[i]?1:-1;return 0;}
static int uc(const U*a,const U*b){if(a->s!=b->s)return a->s?-1:1;int c=uca(a,b);return a->s?-c:c;}
static inline uint64_t adc(uint64_t a,uint64_t b,uint64_t c,uint64_t*r){__uint128_t s=(__uint128_t)a+b+c;*r=s;return s>>64;}
static inline uint64_t sbb(uint64_t a,uint64_t b,uint64_t c,uint64_t*r){__uint128_t d=(__uint128_t)a-b-c;*r=d;return-(d>>64);}
static void uaa(U*r,const U*a,const U*b){uint32_t m=(a->n>b->n?a->n:b->n)+1;ug(r,m);uint64_t c=0;uint32_t i;for(i=0;i<a->n||i<b->n||c;i++){uint64_t ai=i<a->n?a->d[i]:0,bi=i<b->n?b->d[i]:0;c=adc(ai,bi,c,&r->d[i]);}r->n=i;uz(r);}
static void usa(U*r,const U*a,const U*b){ug(r,a->n);uint64_t c=0;for(uint32_t i=0;i<a->n;i++){uint64_t ai=a->d[i],bi=i<b->n?b->d[i]:0;c=sbb(ai,bi,c,&r->d[i]);}r->n=a->n;uz(r);}
static void ua(U*r,const U*a,const U*b){if(a->s==b->s){uaa(r,a,b);r->s=a->s;}else{int c=uca(a,b);if(c>=0){usa(r,a,b);r->s=a->s;}else{usa(r,b,a);r->s=b->s;}}}
static void us(U*r,const U*a,const U*b){U t=*b;t.s=!b->s;ua(r,a,&t);}
static void umb(U*r,const U*a,const U*b){ug(r,a->n+b->n);memset(r->d,0,(a->n+b->n)*8);for(uint32_t i=0;i<a->n;i++){uint64_t c=0;for(uint32_t j=0;j<b->n;j++){__uint128_t p=(__uint128_t)a->d[i]*b->d[j]+r->d[i+j]+c;r->d[i+j]=p;c=p>>64;}r->d[i+b->n]=c;}r->n=a->n+b->n;r->s=a->s!=b->s;uz(r);}
static void umk(U*r,const U*a,const U*b){uint32_t n=a->n>b->n?a->n:b->n;if(n<20){umb(r,a,b);return;}uint32_t m=n/2;U a0={a->d,a->n>m?m:a->n,a->c,0},a1={a->n>m?a->d+m:0,a->n>m?a->n-m:0,0,0};U b0={b->d,b->n>m?m:b->n,b->c,0},b1={b->n>m?b->d+m:0,b->n>m?b->n-m:0,0,0};U*z0=un(a0.n+b0.n),*z2=un(a1.n+b1.n),*z1=un(n*2);umk(z0,&a0,&b0);umk(z2,&a1,&b1);U*as=un(m+1),*bs=un(m+1);ua(as,&a0,&a1);ua(bs,&b0,&b1);umk(z1,as,bs);us(z1,z1,z0);us(z1,z1,z2);ug(r,2*n);memset(r->d,0,2*n*8);for(uint32_t i=0;i<z0->n;i++)r->d[i]=z0->d[i];uint64_t c=0;for(uint32_t i=0;i<z1->n||c;i++){uint64_t v=r->d[m+i]+(i<z1->n?z1->d[i]:0)+c;r->d[m+i]=v;c=v<r->d[m+i];}c=0;for(uint32_t i=0;i<z2->n||c;i++){uint64_t v=r->d[2*m+i]+(i<z2->n?z2->d[i]:0)+c;r->d[2*m+i]=v;c=v<r->d[2*m+i];}r->n=2*n;r->s=a->s!=b->s;uz(r);uf(z0);uf(z1);uf(z2);uf(as);uf(bs);}
static void um(U*r,const U*a,const U*b){umk(r,a,b);}
static void udm(U*q,U*r,const U*a,const U*b){int c=uca(a,b);if(c<0){if(q){q->n=0;q->s=0;}if(r){memcpy(r->d,a->d,a->n*8);r->n=a->n;r->s=a->s;}return;}if(b->n==1){uint64_t dv=b->d[0];if(q)ug(q,a->n);uint64_t rm=0;for(int i=a->n-1;i>=0;i--){__uint128_t dd=((__uint128_t)rm<<64)|a->d[i];if(q)q->d[i]=dd/dv;rm=dd%dv;}if(q){q->n=a->n;q->s=a->s!=b->s;uz(q);}if(r){r->d[0]=rm;r->n=rm?1:0;r->s=a->s&&rm;}return;}U*dv=un(a->n);memcpy(dv->d,a->d,a->n*8);dv->n=a->n;if(q){ug(q,a->n);memset(q->d,0,a->n*8);q->n=0;}U*o=un(1);o->d[0]=1;o->n=1;while(uca(dv,b)>=0){usa(dv,dv,b);if(q)ua(q,q,o);}if(q)q->s=a->s!=b->s;if(r){memcpy(r->d,dv->d,dv->n*8);r->n=dv->n;r->s=a->s&&dv->n;}uf(dv);uf(o);}
static void ush(U*r,const U*a,uint32_t b){ug(r,a->n+(b+63)/64);uint32_t wsh=b/64,bsh=b%64;if(!bsh){for(uint32_t i=0;i<wsh;i++)r->d[i]=0;for(uint32_t i=0;i<a->n;i++)r->d[i+wsh]=a->d[i];}else{r->d[0]=0;for(uint32_t i=0;i<a->n;i++){r->d[i+wsh]|=a->d[i]<<bsh;r->d[i+wsh+1]=a->d[i]>>(64-bsh);}if(!r->d[a->n+wsh])r->n=a->n+wsh;else r->n=a->n+wsh+1;}r->s=a->s;uz(r);}
static void upw(U*r,const U*a,uint64_t e){if(!e){r->d[0]=1;r->n=1;r->s=0;return;}U*t=un(8),*p=un(8);memcpy(p->d,a->d,a->n*8);p->n=a->n;p->s=a->s;t->d[0]=1;t->n=1;while(e){if(e&1){U*m=un(t->n+p->n);um(m,t,p);uf(t);t=m;}if(e>1){U*sq=un(p->n*2);um(sq,p,p);uf(p);p=sq;}e>>=1;}memcpy(r->d,t->d,t->n*8);r->n=t->n;r->s=t->s;uf(t);uf(p);}
static U*ufd(const char*s){U*r=un(4),*ten=un(1);ten->d[0]=10;ten->n=1;bool neg=*s=='-';if(neg||*s=='+')s++;while(*s){if(*s>='0'&&*s<='9'){U*d=un(1);d->d[0]=*s-'0';d->n=1;U*t=un(r->n*2);um(t,r,ten);uf(r);r=t;t=un(r->n+1);ua(t,r,d);uf(r);uf(d);r=t;}s++;}r->s=neg;uf(ten);return r;}
static char*utd(const U*u){if(!u->n){char*s=malloc(2);strcpy(s,"0");return s;}char*res=malloc(u->n*20+2);int p=0;U*t=un(u->n);memcpy(t->d,u->d,u->n*8);t->n=u->n;U*ten=un(1);ten->d[0]=10;ten->n=1;U*rm=un(1);while(t->n){udm(t,rm,t,ten);res[p++]='0'+(rm->n?rm->d[0]:0);}if(u->s)res[p++]='-';res[p]=0;for(int i=0;i<p/2;i++){char c=res[i];res[i]=res[p-1-i];res[p-1-i]=c;}uf(t);uf(ten);uf(rm);return res;}
static void ugcd(U*r,const U*a,const U*b){U*x=un(a->n>b->n?a->n:b->n),*y=un(a->n>b->n?a->n:b->n);memcpy(x->d,a->d,a->n*8);x->n=a->n;x->s=0;memcpy(y->d,b->d,b->n*8);y->n=b->n;y->s=0;uint32_t sh=0;while(x->n&&y->n&&!(x->d[0]&1)&&!(y->d[0]&1)){for(uint32_t i=0;i<x->n-1;i++)x->d[i]=(x->d[i]>>1)|(x->d[i+1]<<63);x->d[x->n-1]>>=1;uz(x);for(uint32_t i=0;i<y->n-1;i++)y->d[i]=(y->d[i]>>1)|(y->d[i+1]<<63);y->d[y->n-1]>>=1;uz(y);sh++;}while(x->n){while(x->n&&!(x->d[0]&1)){for(uint32_t i=0;i<x->n-1;i++)x->d[i]=(x->d[i]>>1)|(x->d[i+1]<<63);x->d[x->n-1]>>=1;uz(x);}while(y->n&&!(y->d[0]&1)){for(uint32_t i=0;i<y->n-1;i++)y->d[i]=(y->d[i]>>1)|(y->d[i+1]<<63);y->d[y->n-1]>>=1;uz(y);}if(uca(x,y)>=0)usa(x,x,y);else usa(y,y,x);}memcpy(r->d,y->d,y->n*8);r->n=y->n;r->s=0;U*t=un(r->n+sh/64+1);ush(t,r,sh);memcpy(r->d,t->d,t->n*8);r->n=t->n;uf(x);uf(y);uf(t);}
static void rn(R*r){U*g=un(8);ugcd(g,r->n,r->d);if(g->n&&!(g->n==1&&g->d[0]==1)){U*nn=un(r->n->n),*nd=un(r->d->n);udm(nn,0,r->n,g);udm(nd,0,r->d,g);uf(r->n);uf(r->d);r->n=nn;r->d=nd;}if(r->d->s){r->n->s=!r->n->s;r->d->s=0;}uf(g);}
static void ra(R*r,const R*a,const R*b){U*ad=un(16),*bd=un(16),*nn=un(16),*nd=un(16);um(ad,a->n,b->d);um(bd,b->n,a->d);ua(nn,ad,bd);um(nd,a->d,b->d);r->n=nn;r->d=nd;rn(r);uf(ad);uf(bd);}
static void rm(R*r,const R*a,const R*b){r->n=un(a->n->n+b->n->n);r->d=un(a->d->n+b->d->n);um(r->n,a->n,b->n);um(r->d,a->d,b->d);rn(r);}
static double rtd(const R*u){char*ns=utd(u->n),*ds=utd(u->d);double n=strtod(ns,0),d=strtod(ds,0);free(ns);free(ds);return n/d;}
typedef struct{char*b,*p,*e;}A;typedef struct{const char*s;uint32_t n;}S;typedef struct{uint32_t l,c;const char*f;}L;
#define Z(x)((S){x,sizeof(x)-1})
#define N ((S){0,0})
static A M={0};static int E=0;
static void*al(size_t n){n=(n+7)&~7;if(!M.b||M.p+n>M.e){size_t z=1<<24;M.b=M.p=malloc(z);M.e=M.b+z;}void*r=M.p;M.p+=n;return memset(r,0,n);}
static void ar(){if(M.b)M.p=M.b;}
static S sd(S s){char*p=al(s.n+1);memcpy(p,s.s,s.n);return(S){p,s.n};}
static bool se(S a,S b){return a.n==b.n&&!memcmp(a.s,b.s,a.n);}
static bool si(S a,S b){if(a.n!=b.n)return 0;for(uint32_t i=0;i<a.n;i++)if(tolower(a.s[i])!=tolower(b.s[i]))return 0;return 1;}
static char*LC(S s){static char b[8][256];static int i;char*p=b[i++&7];uint32_t n=s.n<255?s.n:255;for(uint32_t j=0;j<n;j++)p[j]=tolower(s.s[j]);p[n]=0;return p;}
static uint64_t sh(S s){uint64_t h=14695981039346656037ULL;for(uint32_t i=0;i<s.n;i++)h=(h^(uint8_t)tolower(s.s[i]))*1099511628211ULL;return h;}
static _Noreturn void die(L l,const char*f,...){va_list v;va_start(v,f);fprintf(stderr,"%s:%u:%u: ",l.f,l.l,l.c);vfprintf(stderr,f,v);fputc('\n',stderr);va_end(v);E++;exit(1);}
typedef enum{T_EOF=0,T_ERR,T_ID,T_INT,T_REAL,T_CHAR,T_STR,T_LP,T_RP,T_LB,T_RB,T_CM,T_DT,T_SC,T_CL,T_TK,T_AS,T_AR,T_DD,T_LL,T_GG,T_BX,T_BR,T_EQ,T_NE,T_LT,T_LE,T_GT,T_GE,T_PL,T_MN,T_ST,T_SL,T_AM,T_EX,T_AB,T_ABS,T_ACC,T_ACCS,T_ALITK,T_ALL,T_AND,T_ATHN,T_ARR,T_AT,T_BEG,T_BOD,T_CSE,T_CONST,T_DEC,T_DEL,T_DELTA,T_DIG,T_DO,T_ELSE,T_ELSIF,T_END,T_ENT,T_EXCP,T_EXIT,T_FOR,T_FUN,T_GEN,T_GOTO,T_IF,T_IN,T_IS,T_LIM,T_LOOP,T_MOD,T_NEW,T_NOT,T_NULL,T_OF,T_OR,T_OREL,T_OTH,T_OUT,T_PKG,T_PGM,T_PRV,T_PROC,T_RAS,T_RNG,T_REC,T_REM,T_REN,T_RET,T_REV,T_SEL,T_SEP,T_SUB,T_TSK,T_TER,T_THEN,T_TYP,T_USE,T_WHN,T_WHI,T_WITH,T_XOR,T_CNT}Tk;
enum{CHK_OVF=1,CHK_RNG=2,CHK_IDX=4,CHK_DSC=8,CHK_LEN=16,CHK_DIV=32,CHK_ELB=64,CHK_ACC=128,CHK_STG=256};
static const char*TN[T_CNT]={[T_EOF]="eof",[T_ERR]="ERR",[T_ID]="id",[T_INT]="int",[T_REAL]="real",[T_CHAR]="char",[T_STR]="str",[T_LP]="(",[T_RP]=")",[T_LB]="[",[T_RB]="]",[T_CM]=",",[T_DT]=".",[T_SC]=";",[T_CL]=":",[T_TK]="'",[T_AS]=":=",[T_AR]="=>",[T_DD]="..",[T_LL]="<<",[T_GG]=">>",[T_BX]="<>",[T_BR]="|",[T_EQ]="=",[T_NE]="/=",[T_LT]="<",[T_LE]="<=",[T_GT]=">",[T_GE]=">=",[T_PL]="+",[T_MN]="-",[T_ST]="*",[T_SL]="/",[T_AM]="&",[T_EX]="**",[T_AB]="ABORT",[T_ABS]="ABS",[T_ACC]="ACCEPT",[T_ACCS]="ACCESS",[T_ALITK]="ALIASED",[T_ALL]="ALL",[T_AND]="AND",[T_ATHN]="AND THEN",[T_ARR]="ARRAY",[T_AT]="AT",[T_BEG]="BEGIN",[T_BOD]="BODY",[T_CSE]="CASE",[T_CONST]="CONSTANT",[T_DEC]="DECLARE",[T_DEL]="DELAY",[T_DELTA]="DELTA",[T_DIG]="DIGITS",[T_DO]="DO",[T_ELSE]="ELSE",[T_ELSIF]="ELSIF",[T_END]="END",[T_ENT]="ENTRY",[T_EXCP]="EXCEPTION",[T_EXIT]="EXIT",[T_FOR]="FOR",[T_FUN]="FUNCTION",[T_GEN]="GENERIC",[T_GOTO]="GOTO",[T_IF]="IF",[T_IN]="IN",[T_IS]="IS",[T_LIM]="LIMITED",[T_LOOP]="LOOP",[T_MOD]="MOD",[T_NEW]="NEW",[T_NOT]="NOT",[T_NULL]="NULL",[T_OF]="OF",[T_OR]="OR",[T_OREL]="OR ELSE",[T_OTH]="OTHERS",[T_OUT]="OUT",[T_PKG]="PACKAGE",[T_PGM]="PRAGMA",[T_PRV]="PRIVATE",[T_PROC]="PROCEDURE",[T_RAS]="RAISE",[T_RNG]="RANGE",[T_REC]="RECORD",[T_REM]="REM",[T_REN]="RENAMES",[T_RET]="RETURN",[T_REV]="REVERSE",[T_SEL]="SELECT",[T_SEP]="SEPARATE",[T_SUB]="SUBTYPE",[T_TSK]="TASK",[T_TER]="TERMINATE",[T_THEN]="THEN",[T_TYP]="TYPE",[T_USE]="USE",[T_WHN]="WHEN",[T_WHI]="WHILE",[T_WITH]="WITH",[T_XOR]="XOR"};
typedef struct{Tk t;L l;S lit;int64_t iv;double fv;U*ui;R*ur;}Tn;typedef struct{const char*s,*c,*e;uint32_t ln,cl;const char*f;Tk pt;}Lx;
static struct{S k;Tk t;}KW[]={{Z("abort"),T_AB},{Z("abs"),T_ABS},{Z("accept"),T_ACC},{Z("access"),T_ACCS},{Z("all"),T_ALL},{Z("and"),T_AND},{Z("array"),T_ARR},{Z("at"),T_AT},{Z("begin"),T_BEG},{Z("body"),T_BOD},{Z("case"),T_CSE},{Z("constant"),T_CONST},{Z("declare"),T_DEC},{Z("delay"),T_DEL},{Z("delta"),T_DELTA},{Z("digits"),T_DIG},{Z("do"),T_DO},{Z("else"),T_ELSE},{Z("elsif"),T_ELSIF},{Z("end"),T_END},{Z("entry"),T_ENT},{Z("exception"),T_EXCP},{Z("exit"),T_EXIT},{Z("for"),T_FOR},{Z("function"),T_FUN},{Z("generic"),T_GEN},{Z("goto"),T_GOTO},{Z("if"),T_IF},{Z("in"),T_IN},{Z("is"),T_IS},{Z("limited"),T_LIM},{Z("loop"),T_LOOP},{Z("mod"),T_MOD},{Z("new"),T_NEW},{Z("not"),T_NOT},{Z("null"),T_NULL},{Z("of"),T_OF},{Z("or"),T_OR},{Z("others"),T_OTH},{Z("out"),T_OUT},{Z("package"),T_PKG},{Z("pragma"),T_PGM},{Z("private"),T_PRV},{Z("procedure"),T_PROC},{Z("raise"),T_RAS},{Z("range"),T_RNG},{Z("record"),T_REC},{Z("rem"),T_REM},{Z("renames"),T_REN},{Z("return"),T_RET},{Z("reverse"),T_REV},{Z("select"),T_SEL},{Z("separate"),T_SEP},{Z("subtype"),T_SUB},{Z("task"),T_TSK},{Z("terminate"),T_TER},{Z("then"),T_THEN},{Z("type"),T_TYP},{Z("use"),T_USE},{Z("when"),T_WHN},{Z("while"),T_WHI},{Z("with"),T_WITH},{Z("xor"),T_XOR},{N,T_EOF}};
static Tk kl(S s){for(int i=0;KW[i].k.s;i++)if(si(s,KW[i].k))return KW[i].t;return T_ID;}
static Lx ln(const char*s,size_t z,const char*f){return(Lx){s,s,s+z,1,1,f,T_EOF};}
static char pk(Lx*l){return l->c<l->e?*l->c:0;}
static char p2(Lx*l){return l->c+1<l->e?l->c[1]:0;}
static char p3(Lx*l){return l->c+2<l->e?l->c[2]:0;}
static char av(Lx*l){if(l->c>=l->e)return 0;char c=*l->c++;if(c=='\n'){l->ln++;l->cl=1;}else l->cl++;return c;}
static void sw(Lx*l){for(;;){while(l->c<l->e&&(*l->c==' '||*l->c=='\t'||*l->c=='\n'||*l->c=='\r'||*l->c=='\v'||*l->c=='\f'))av(l);if(l->c+1<l->e&&l->c[0]=='-'&&l->c[1]=='-'){while(l->c<l->e&&*l->c!='\n')av(l);}else break;}}
static Tn mt(Tk t,L lc,S lt){return(Tn){t,lc,lt,0,0.0};}
static Tn si_(Lx*l){L lc={l->ln,l->cl,l->f};const char*s=l->c;while(isalnum(pk(l))||pk(l)=='_')av(l);S lt={s,l->c-s};Tk t=kl(lt);if(t!=T_ID&&l->c<l->e&&(isalnum(*l->c)||*l->c=='_'))return mt(T_ERR,lc,Z("kw+x"));return mt(t,lc,lt);}
static Tn sn(Lx*l){L lc={l->ln,l->cl,l->f};const char*s=l->c;const char*ms=0,*me=0,*es=0;int b=10;bool ir=false,bx=false;char bd=0;while(isdigit(pk(l))||pk(l)=='_')av(l);if(pk(l)=='#'||(pk(l)==':'&&isxdigit(p2(l)))){bd=pk(l);const char*be=l->c;av(l);char*bp=al(32);int bi=0;for(const char*p=s;p<be;p++)if(*p!='_')bp[bi++]=*p;bp[bi]=0;b=atoi(bp);ms=l->c;while(isxdigit(pk(l))||pk(l)=='_')av(l);if(pk(l)=='.'){ir=true;av(l);while(isxdigit(pk(l))||pk(l)=='_')av(l);}if(pk(l)==bd){me=l->c;av(l);}if(tolower(pk(l))=='e'){bx=true;av(l);if(pk(l)=='+'||pk(l)=='-')av(l);es=l->c;while(isdigit(pk(l))||pk(l)=='_')av(l);}}else{if(pk(l)=='.'){if(p2(l)!='.'&&!isalpha(p2(l))){ir=true;av(l);while(isdigit(pk(l))||pk(l)=='_')av(l);}}if(tolower(pk(l))=='e'){ir=true;av(l);if(pk(l)=='+'||pk(l)=='-')av(l);while(isdigit(pk(l))||pk(l)=='_')av(l);}}if(isalpha(pk(l)))return mt(T_ERR,lc,Z("num+alpha"));Tn tk=mt(bx?(ir?T_REAL:T_INT):(ir?T_REAL:T_INT),lc,(S){s,l->c-s});if(bx&&es){char*mp=al(512);char*ep=al(512);int mi=0,ei=0;for(const char*p=ms;p<me;p++)if(*p!='_'&&*p!=bd)mp[mi++]=*p;mp[mi]=0;for(const char*p=es;p<l->c;p++)if(*p!='_')ep[ei++]=*p;ep[ei]=0;double m=0;int dp=-1;for(int i=0;i<mi;i++){if(mp[i]=='.'){dp=i;break;}}int fp=0;for(int i=0;i<mi;i++){if(mp[i]=='.')continue;int dv=mp[i]>='A'&&mp[i]<='F'?mp[i]-'A'+10:mp[i]>='a'&&mp[i]<='f'?mp[i]-'a'+10:mp[i]-'0';if(dp<0||i<dp)m=m*b+dv;else{fp++;m+=dv/pow(b,fp);}}int ex=atoi(ep);double rv=m*pow(b,ex);if(ir)tk.fv=rv;else{if(rv>LLONG_MAX||rv<LLONG_MIN){fprintf(stderr,"Error %d:%d: based integer constant out of range: %.*s\n",lc.l,lc.c,(int)(l->c-s),s);exit(1);}tk.iv=(int64_t)rv;}}else{char*tp=al(512);int j=0;const char*start=(bd&&ms)?ms:s;const char*end=(bd&&me)?me:l->c;for(const char*p=start;p<end;p++)if(*p!='_'&&*p!='#'&&*p!=':')tp[j++]=*p;tp[j]=0;if(bd&&!ir){int64_t v=0;for(int i=0;i<j;i++){int dv=tp[i]>='A'&&tp[i]<='F'?tp[i]-'A'+10:tp[i]>='a'&&tp[i]<='f'?tp[i]-'a'+10:tp[i]-'0';v=v*b+dv;}tk.iv=v;}else if(bd&&ir){double m=0;int dp=-1;for(int i=0;i<j;i++){if(tp[i]=='.'){dp=i;break;}}int fp=0;for(int i=0;i<j;i++){if(tp[i]=='.')continue;int dv=tp[i]>='A'&&tp[i]<='F'?tp[i]-'A'+10:tp[i]>='a'&&tp[i]<='f'?tp[i]-'a'+10:tp[i]-'0';if(dp<0||i<dp)m=m*b+dv;else{fp++;m+=dv/pow(b,fp);}}tk.fv=m;}else{if(ir)errno=0;tk.fv=strtod(tp,0);if(errno==ERANGE&&(tk.fv==HUGE_VAL||tk.fv==-HUGE_VAL)){fprintf(stderr,"Warning %d:%d: float constant overflow to infinity: %s\n",lc.l,lc.c,tp);}else tk.ui=ufd(tp);tk.iv=(tk.ui->n==1)?tk.ui->d[0]:0;if(tk.ui&&tk.ui->n>1&&!ir){fprintf(stderr,"Error %d:%d: integer constant too large for i64: %s\n",lc.l,lc.c,tp);}}}return tk;}
static Tn sc(Lx*l){L lc={l->ln,l->cl,l->f};av(l);if(!pk(l))return mt(T_ERR,lc,Z("uc"));char c=pk(l);av(l);if(pk(l)!='\'')return mt(T_ERR,lc,Z("uc"));av(l);Tn tk=mt(T_CHAR,lc,(S){&c,1});tk.iv=c;return tk;}
static Tn ss(Lx*l){L lc={l->ln,l->cl,l->f};char d=pk(l);av(l);const char*s=l->c;char*b=al(256),*p=b;int n=0;while(pk(l)){if(pk(l)==d){if(p2(l)==d){av(l);av(l);if(n<255)*p++=d;n++;}else break;}else{if(n<255)*p++=pk(l);n++;av(l);}}if(pk(l)==d)av(l);else return mt(T_ERR,lc,Z("us"));*p=0;S lt={b,n};return mt(T_STR,lc,lt);}
static Tn lnx(Lx*l){const char*pb=l->c;sw(l);bool ws=l->c!=pb;L lc={l->ln,l->cl,l->f};char c=pk(l);if(!c){l->pt=T_EOF;return mt(T_EOF,lc,N);}if(isalpha(c)){Tn tk=si_(l);l->pt=tk.t;return tk;}if(isdigit(c)){Tn tk=sn(l);l->pt=tk.t;return tk;}if(c=='\''){char c2=p2(l);char pc=l->c>l->s?l->c[-1]:0;bool id_attr=l->pt==T_ID&&!ws&&isalnum(pc);if(c2&&p3(l)=='\''&&(l->c+3>=l->e||l->c[3]!='\'')&&!id_attr){l->pt=T_CHAR;return sc(l);}av(l);l->pt=T_TK;return mt(T_TK,lc,Z("'"));}if(c=='"'||c=='%'){Tn tk=ss(l);l->pt=tk.t;return tk;}av(l);Tk tt;switch(c){case'(':tt=T_LP;break;case')':tt=T_RP;break;case'[':tt=T_LB;break;case']':tt=T_RB;break;case',':tt=T_CM;break;case';':tt=T_SC;break;case'&':tt=T_AM;break;case'|':case'!':tt=T_BR;break;case'+':tt=T_PL;break;case'-':tt=T_MN;break;case'/':if(pk(l)=='='){av(l);tt=T_NE;}else tt=T_SL;break;case'*':if(pk(l)=='*'){av(l);tt=T_EX;}else tt=T_ST;break;case'=':if(pk(l)=='>'){av(l);tt=T_AR;}else tt=T_EQ;break;case':':if(pk(l)=='='){av(l);tt=T_AS;}else tt=T_CL;break;case'.':if(pk(l)=='.'){av(l);tt=T_DD;}else tt=T_DT;break;case'<':if(pk(l)=='='){av(l);tt=T_LE;}else if(pk(l)=='<'){av(l);tt=T_LL;}else if(pk(l)=='>'){av(l);tt=T_BX;}else tt=T_LT;break;case'>':if(pk(l)=='='){av(l);tt=T_GE;}else if(pk(l)=='>'){av(l);tt=T_GG;}else tt=T_GT;break;default:tt=T_ERR;break;}l->pt=tt;return mt(tt,lc,tt==T_ERR?Z("ux"):N);}
typedef enum{N_ERR=0,N_ID,N_INT,N_REAL,N_CHAR,N_STR,N_NULL,N_AG,N_BIN,N_UN,N_AT,N_QL,N_CL,N_IX,N_SL,N_SEL,N_ALC,N_TI,N_TE,N_TF,N_TX,N_TA,N_TR,N_TAC,N_TP,N_ST,N_RN,N_CN,N_CM,N_VR,N_VP,N_DS,N_PM,N_PS,N_FS,N_PB,N_FB,N_PD,N_FD,N_PKS,N_PKB,N_PKD,N_OD,N_ND,N_TD,N_SD,N_ED,N_RE,N_AS,N_IF,N_CS,N_LP,N_BL,N_EX,N_RT,N_GT,N_RS,N_NS,N_CLT,N_EC,N_DL,N_AB,N_CD,N_ACC,N_SLS,N_SA,N_TKS,N_TKB,N_TKD,N_ENT,N_EI,N_HD,N_CH,N_ASC,N_WH,N_EL,N_WI,N_US,N_PG,N_RP,N_GD,N_GI,N_GF,N_CU,N_CX,N_LST,N_DRF,N_CVT,N_CHK,N_RRC,N_ERC,N_LNC,N_ADC,N_ALC2,N_DRV,N_LBL,N_OPID,N_GTP,N_GVL,N_GSP,N_GEN,N_GINST,N_TRM,N_CNT}Nk;
typedef struct Ty Ty;typedef struct No No;typedef struct Sy Sy;typedef struct RC RC;typedef struct LU LU;typedef struct GT GT;typedef struct{No**d;uint32_t n,c;}NV;typedef struct{Sy**d;uint32_t n,c;}SV;typedef struct{RC**d;uint32_t n,c;}RV;typedef struct{LU**d;uint32_t n,c;}LV;typedef struct{GT**d;uint32_t n,c;}GV;typedef struct{FILE**d;uint32_t n,c;}FV;typedef struct{S*d;uint32_t n,c;}SLV;
static void nv(NV*v,No*n){if(v->n>=v->c){v->c=v->c?v->c<<1:8;v->d=realloc(v->d,v->c*sizeof(No*));}v->d[v->n++]=n;}
static void sv(SV*v,Sy*s){if(v->n>=v->c){v->c=v->c?v->c<<1:8;v->d=realloc(v->d,v->c*sizeof(Sy*));}v->d[v->n++]=s;}
static void rv(RV*v,RC*r){if(v->n>=v->c){v->c=v->c?v->c<<1:8;v->d=realloc(v->d,v->c*sizeof(RC*));}v->d[v->n++]=r;}
static void lv(LV*v,LU*l){if(v->n>=v->c){v->c=v->c?v->c<<1:8;v->d=realloc(v->d,v->c*sizeof(LU*));}v->d[v->n++]=l;}
static void gv(GV*v,GT*g){if(v->n>=v->c){v->c=v->c?v->c<<1:8;v->d=realloc(v->d,v->c*sizeof(GT*));}v->d[v->n++]=g;}
static void fv(FV*v,FILE*f){if(v->n>=v->c){v->c=v->c?v->c<<1:8;v->d=realloc(v->d,v->c*sizeof(FILE*));}v->d[v->n++]=f;}
static void slv(SLV*v,S s){if(v->n>=v->c){v->c=v->c?v->c<<1:8;v->d=realloc(v->d,v->c*sizeof(S));}v->d[v->n++]=s;}
struct No{Nk k;L l;Ty*ty;Sy*sy;union{S s;int64_t i;double f;struct{Tk op;No*l,*r;}bn;struct{Tk op;No*x;}un;struct{No*p;S at;NV ar;}at;struct{No*nm,*ag;}ql;struct{No*fn;NV ar;}cl;struct{No*p;NV ix;}ix;struct{No*p;No*lo,*hi;}sl;struct{No*p;S se;}se;struct{No*st;No*in;}alc;struct{No*lo,*hi;}rn;struct{No*rn;NV cs;}cn;struct{S nm;No*ty;No*in;bool al;uint32_t of,bt;No*dc;No*dsc;}cm;struct{NV ch;NV cmm;}vr;struct{No*ds;NV vrr;uint32_t sz;}vp;struct{S nm;No*ty;No*df;uint8_t md;}pm;struct{S nm;NV pmm;No*rt;S op;}sp;struct{No*sp;NV dc;NV st;NV hdd;int el;Sy*pr;NV lk;}bd;struct{S nm;NV dc;NV pr;int el;}ps;struct{S nm;NV dc;NV st;NV hddd;int el;}pb;struct{NV id;No*ty;No*in;bool co;}od;struct{S nm;No*df;No*ds;bool nw;bool drv;No*prt;NV dsc;}td;struct{S nm;No*in;No*cn;No*rn;}sd;struct{NV id;}ed;struct{S nm;No*rn;}re;struct{No*tg;No*vl;}as;struct{No*cd;NV th;NV ei;NV el;}if_;struct{No*ex;NV al;}cs;struct{S lb;No*it;bool rv;NV st;NV lk;}lp;struct{S lb;NV dc;NV st;NV hd;}bk;struct{S lb;No*cd;}ex;struct{No*vl;}rt;struct{S lb;}go;struct{No*ec;}rs;struct{No*nm;NV arr;}ct;struct{S nm;NV ixx;NV pmx;NV stx;NV hdx;No*gd;}acc;struct{NV al;NV el;}ss;struct{uint8_t kn;No*gd;NV sts;}sa;struct{S nm;NV en;bool it;}ts;struct{S nm;NV dc;NV st;NV hdz;}tb;struct{S nm;NV ixy;NV pmy;No*gd;}ent;struct{NV ec;NV stz;}hnd;struct{NV it;}ch;struct{NV ch;No*vl;}asc;struct{NV it;}lst;struct{NV wt;NV us;}cx;struct{S nm;}wt;struct{No*nm;}us;struct{S nm;NV ar;}pg;struct{No*cx;NV un;}cu;struct{No*x;}drf;struct{No*ty,*ex;}cvt;struct{No*ex;S ec;}chk;struct{No*bs;NV ops;}drv;struct{NV fp;NV dc;No*un;}gen;struct{S nm;S gn;NV ap;}gi;struct{NV it;No*lo,*hi;uint8_t dim;}ag;};};
struct RC{uint8_t k;Ty*ty;union{struct{S nm;uint32_t po;}er;struct{S nm;uint64_t ad;}ad;struct{S nm;NV cp;}rr;struct{S lang;S nm;S ext;}im;};};
struct LU{uint8_t k;S nm;S pth;No*sp;No*bd;LV wth;LV elb;uint64_t ts;bool cmpl;};
struct GT{S nm;NV fp;NV dc;No*un;No*bd;};
static No*nd(Nk k,L l){No*n=al(sizeof(No));n->k=k;n->l=l;return n;}
static RC*rc(uint8_t k,Ty*t){RC*r=al(sizeof(RC));r->k=k;r->ty=t;return r;}
static LU*lu(uint8_t k,S nm,S pth){LU*l=al(sizeof(LU));l->k=k;l->nm=nm;l->pth=pth;return l;}
static GT*gt(S nm){GT*g=al(sizeof(GT));g->nm=nm;return g;}
#define ND(k,l)nd(N_##k,l)
typedef struct{Lx lx;Tn cr,pk;int er;SLV lb;}Ps;
static void pn(Ps*p){p->cr=p->pk;p->pk=lnx(&p->lx);if(p->cr.t==T_AND&&p->pk.t==T_THEN){p->cr.t=T_ATHN;p->pk=lnx(&p->lx);}if(p->cr.t==T_OR&&p->pk.t==T_ELSE){p->cr.t=T_OREL;p->pk=lnx(&p->lx);}}
static bool pa(Ps*p,Tk t){return p->cr.t==t;}
static bool pm(Ps*p,Tk t){if(pa(p,t)){pn(p);return 1;}return 0;}
static void pe(Ps*p,Tk t){if(!pm(p,t))die(p->cr.l,"exp '%s' got '%s'",TN[t],TN[p->cr.t]);}
static L pl(Ps*p){return p->cr.l;}
static S pi(Ps*p){S s=p->cr.lit;pe(p,T_ID);return s;}
static S pat(Ps*p){S s;if(pa(p,T_ID))s=pi(p);else if(pa(p,T_RNG)){s=Z("RANGE");pn(p);}else if(pa(p,T_ACCS)){s=Z("ACCESS");pn(p);}else if(pa(p,T_DIG)){s=Z("DIGITS");pn(p);}else if(pa(p,T_DELTA)){s=Z("DELTA");pn(p);}else if(pa(p,T_MOD)){s=Z("MOD");pn(p);}else if(pa(p,T_REM)){s=Z("REM");pn(p);}else if(pa(p,T_ABS)){s=Z("ABS");pn(p);}else if(pa(p,T_NOT)){s=Z("NOT");pn(p);}else if(pa(p,T_AND)){s=Z("AND");pn(p);}else if(pa(p,T_OR)){s=Z("OR");pn(p);}else if(pa(p,T_XOR)){s=Z("XOR");pn(p);}else if(pa(p,T_PL)){s=Z("+");pn(p);}else if(pa(p,T_MN)){s=Z("-");pn(p);}else if(pa(p,T_ST)){s=Z("*");pn(p);}else if(pa(p,T_SL)){s=Z("/");pn(p);}else if(pa(p,T_EQ)){s=Z("=");pn(p);}else if(pa(p,T_NE)){s=Z("/=");pn(p);}else if(pa(p,T_LT)){s=Z("<");pn(p);}else if(pa(p,T_LE)){s=Z("<=");pn(p);}else if(pa(p,T_GT)){s=Z(">");pn(p);}else if(pa(p,T_GE)){s=Z(">=");pn(p);}else if(pa(p,T_AM)){s=Z("&");pn(p);}else if(pa(p,T_EX)){s=Z("**");pn(p);}else die(pl(p),"exp attr");return s;}
static No*pnm(Ps*p);static No*pex(Ps*p);static No*ppr(Ps*p);static No*prn(Ps*p);static NV pst(Ps*p);static NV pdc(Ps*p);static NV phd(Ps*p);static No*ps(Ps*p);static No*pgf(Ps*p);static RC*prc(Ps*p);
static No*ppr(Ps*p){L lc=pl(p);if(pm(p,T_LP)){NV v={0};do{NV ch={0};No*e=pex(p);nv(&ch,e);while(pm(p,T_BR))nv(&ch,pex(p));if(pa(p,T_AR)){pn(p);No*vl=pex(p);for(uint32_t i=0;i<ch.n;i++){No*a=ND(ASC,lc);nv(&a->asc.ch,ch.d[i]);a->asc.vl=vl;nv(&v,a);}}else if(ch.n==1&&ch.d[0]->k==N_ID&&pm(p,T_RNG)){No*rng=prn(p);pe(p,T_AR);No*vl=pex(p);No*si=ND(ST,lc);No*cn=ND(CN,lc);cn->cn.rn=rng;si->sd.in=ch.d[0];si->sd.cn=cn;No*a=ND(ASC,lc);nv(&a->asc.ch,si);a->asc.vl=vl;nv(&v,a);}else{if(ch.n==1)nv(&v,ch.d[0]);else die(lc,"exp '=>'");}}while(pm(p,T_CM));pe(p,T_RP);if(v.n==1&&v.d[0]->k!=N_ASC)return v.d[0];No*n=ND(AG,lc);n->ag.it=v;return n;}if(pm(p,T_NEW)){No*n=ND(ALC,lc);n->alc.st=pnm(p);if(pm(p,T_TK)){pe(p,T_LP);n->alc.in=pex(p);pe(p,T_RP);}return n;}if(pm(p,T_NULL))return ND(NULL,lc);if(pm(p,T_OTH)){No*n=ND(ID,lc);n->s=Z("others");return n;}if(pa(p,T_INT)){No*n=ND(INT,lc);n->i=p->cr.iv;pn(p);return n;}if(pa(p,T_REAL)){No*n=ND(REAL,lc);n->f=p->cr.fv;pn(p);return n;}if(pa(p,T_CHAR)){No*n=ND(CHAR,lc);n->i=p->cr.iv;pn(p);return n;}if(pa(p,T_STR)){No*n=ND(STR,lc);n->s=sd(p->cr.lit);pn(p);for(;;){if(pa(p,T_LP)){pn(p);NV v={0};do{NV ch={0};No*e=pex(p);if(e->k==N_ID&&pa(p,T_AR)){pn(p);No*a=ND(ASC,lc);nv(&a->asc.ch,e);a->asc.vl=pex(p);nv(&v,a);}else{nv(&ch,e);while(pm(p,T_BR))nv(&ch,pex(p));if(pa(p,T_AR)){pn(p);No*vl=pex(p);for(uint32_t i=0;i<ch.n;i++){No*a=ND(ASC,lc);nv(&a->asc.ch,ch.d[i]);a->asc.vl=vl;nv(&v,a);}}else{if(ch.n==1)nv(&v,ch.d[0]);else die(lc,"exp '=>'");}}}while(pm(p,T_CM));pe(p,T_RP);No*m=ND(CL,lc);m->cl.fn=n;m->cl.ar=v;n=m;}else break;}return n;}if(pa(p,T_ID))return pnm(p);if(pm(p,T_NOT)){No*n=ND(UN,lc);n->un.op=T_NOT;n->un.x=ppr(p);return n;}if(pm(p,T_ABS)){No*n=ND(UN,lc);n->un.op=T_ABS;n->un.x=ppr(p);return n;}if(pm(p,T_ALL)){No*n=ND(DRF,lc);n->drf.x=ppr(p);return n;}die(lc,"exp expr");}
static No*pnm(Ps*p){L lc=pl(p);No*n=ND(ID,lc);n->s=pi(p);for(;;){if(pm(p,T_DT)){if(pm(p,T_ALL)){No*m=ND(DRF,lc);m->drf.x=n;n=m;}else{No*m=ND(SEL,lc);m->se.p=n;if(pa(p,T_STR)){m->se.se=p->cr.lit;pn(p);}else if(pa(p,T_CHAR)){char*c=al(2);c[0]=p->cr.iv;c[1]=0;m->se.se=(S){c,1};pn(p);}else m->se.se=pi(p);n=m;}}else if(pm(p,T_TK)){if(pa(p,T_LP)){pn(p);No*m=ND(QL,lc);m->ql.nm=n;NV v={0};do{NV ch={0};No*e=pex(p);nv(&ch,e);while(pm(p,T_BR))nv(&ch,pex(p));if(pa(p,T_AR)){pn(p);No*vl=pex(p);for(uint32_t i=0;i<ch.n;i++){No*a=ND(ASC,lc);nv(&a->asc.ch,ch.d[i]);a->asc.vl=vl;nv(&v,a);}}else{if(ch.n==1)nv(&v,ch.d[0]);else die(lc,"exp '=>'");}}while(pm(p,T_CM));pe(p,T_RP);if(v.n==1&&v.d[0]->k!=N_ASC)m->ql.ag=v.d[0];else{No*ag=ND(AG,lc);ag->ag.it=v;m->ql.ag=ag;}n=m;}else{S at=pat(p);No*m=ND(AT,lc);m->at.p=n;m->at.at=at;if(pm(p,T_LP)){do nv(&m->at.ar,pex(p));while(pm(p,T_CM));pe(p,T_RP);}n=m;}}else if(pa(p,T_LP)){pn(p);if(pa(p,T_RP)){pe(p,T_RP);No*m=ND(CL,lc);m->cl.fn=n;n=m;}else{NV v={0};do{NV ch={0};No*e=pex(p);if(e->k==N_ID&&pa(p,T_AR)){pn(p);No*a=ND(ASC,lc);nv(&a->asc.ch,e);a->asc.vl=pex(p);nv(&v,a);}else{nv(&ch,e);while(pm(p,T_BR))nv(&ch,pex(p));if(pa(p,T_AR)){pn(p);No*vl=pex(p);for(uint32_t i=0;i<ch.n;i++){No*a=ND(ASC,lc);nv(&a->asc.ch,ch.d[i]);a->asc.vl=vl;nv(&v,a);}}else{if(ch.n==1)nv(&v,ch.d[0]);else die(lc,"exp '=>'");}}}while(pm(p,T_CM));pe(p,T_RP);No*m=ND(CL,lc);m->cl.fn=n;m->cl.ar=v;n=m;}}else break;}return n;}
static No*ppw(Ps*p){No*n=ppr(p);if(pm(p,T_EX)){L lc=pl(p);No*m=ND(BIN,lc);m->bn.op=T_EX;m->bn.l=n;m->bn.r=ppw(p);return m;}return n;}
static No*pt(Ps*p){No*n=ppw(p);while(pa(p,T_ST)||pa(p,T_SL)||pa(p,T_MOD)||pa(p,T_REM)){Tk op=p->cr.t;pn(p);L lc=pl(p);No*m=ND(BIN,lc);m->bn.op=op;m->bn.l=n;m->bn.r=ppw(p);n=m;}return n;}
static No*psm(Ps*p){L lc=pl(p);Tk un=0;if(pm(p,T_MN))un=T_MN;else if(pm(p,T_PL))un=T_PL;No*n=pt(p);if(un){No*m=ND(UN,lc);m->un.op=un;m->un.x=n;n=m;}while(pa(p,T_PL)||pa(p,T_MN)||pa(p,T_AM)){Tk op=p->cr.t;pn(p);lc=pl(p);No*m=ND(BIN,lc);m->bn.op=op;m->bn.l=n;m->bn.r=pt(p);n=m;}return n;}
static No*prl(Ps*p){No*n=psm(p);if(pm(p,T_DD)){L lc=pl(p);No*m=ND(RN,lc);m->rn.lo=n;m->rn.hi=psm(p);return m;}if(pa(p,T_EQ)||pa(p,T_NE)||pa(p,T_LT)||pa(p,T_LE)||pa(p,T_GT)||pa(p,T_GE)||pa(p,T_IN)||pa(p,T_NOT)){Tk op=p->cr.t;pn(p);if(op==T_NOT)pe(p,T_IN);L lc=pl(p);No*m=ND(BIN,lc);m->bn.op=op;m->bn.l=n;if(op==T_IN||op==T_NOT)m->bn.r=prn(p);else m->bn.r=psm(p);return m;}return n;}
static No*pan(Ps*p){No*n=prl(p);while(pa(p,T_AND)||pa(p,T_ATHN)){Tk op=p->cr.t;pn(p);L lc=pl(p);No*m=ND(BIN,lc);m->bn.op=op;m->bn.l=n;m->bn.r=prl(p);n=m;}return n;}
static No*por(Ps*p){No*n=pan(p);while(pa(p,T_OR)||pa(p,T_OREL)||pa(p,T_XOR)){Tk op=p->cr.t;pn(p);L lc=pl(p);No*m=ND(BIN,lc);m->bn.op=op;m->bn.l=n;m->bn.r=pan(p);n=m;}return n;}
static No*pex(Ps*p){return por(p);}
static No*prn(Ps*p){L lc=pl(p);if(pm(p,T_BX)){No*n=ND(RN,lc);n->rn.lo=0;n->rn.hi=0;return n;}No*lo=psm(p);if(pm(p,T_DD)){No*m=ND(RN,lc);m->rn.lo=lo;m->rn.hi=psm(p);return m;}return lo;}
static No*psi(Ps*p){L lc=pl(p);No*n=ND(ID,lc);n->s=pi(p);for(;;){if(pm(p,T_DT)){if(pm(p,T_ALL)){No*m=ND(DRF,lc);m->drf.x=n;n=m;}else{No*m=ND(SEL,lc);m->se.p=n;m->se.se=pi(p);n=m;}}else if(pm(p,T_TK)){S at=pat(p);No*m=ND(AT,lc);m->at.p=n;m->at.at=at;if(pm(p,T_LP)){do nv(&m->at.ar,pex(p));while(pm(p,T_CM));pe(p,T_RP);}n=m;}else break;}if(pm(p,T_DELTA)){psm(p);}if(pm(p,T_DIG)){pex(p);}if(pm(p,T_RNG)){L lc=pl(p);No*c=ND(CN,lc);c->cn.rn=prn(p);No*m=ND(ST,lc);m->sd.in=n;m->sd.cn=c;return m;}if(pa(p,T_LP)){pn(p);L lc=pl(p);No*c=ND(CN,lc);do{L lc2=pl(p);NV ch={0};No*r=prn(p);nv(&ch,r);while(pm(p,T_BR))nv(&ch,prn(p));if(ch.n>0&&ch.d[0]->k==N_ID&&pm(p,T_RNG)){No*tn=ND(ID,lc2);tn->s=ch.d[0]->s;No*rng=prn(p);No*si=ND(ST,lc2);No*cn=ND(CN,lc2);cn->cn.rn=rng;si->sd.in=tn;si->sd.cn=cn;nv(&c->cn.cs,si);}else if(ch.n>0&&ch.d[0]->k==N_ID&&pm(p,T_AR)){No*vl=pex(p);for(uint32_t i=0;i<ch.n;i++){No*a=ND(ASC,lc2);nv(&a->asc.ch,ch.d[i]);a->asc.vl=vl;nv(&c->cn.cs,a);}}else{if(ch.n>0)nv(&c->cn.cs,ch.d[0]);}}while(pm(p,T_CM));pe(p,T_RP);No*m=ND(ST,lc);m->sd.in=n;m->sd.cn=c;return m;}return n;}
static NV ppm(Ps*p){NV v={0};if(!pm(p,T_LP))return v;do{L lc=pl(p);NV id={0};do{S nm=pi(p);No*i=ND(ID,lc);i->s=nm;nv(&id,i);}while(pm(p,T_CM));pe(p,T_CL);uint8_t md=0;if(pm(p,T_IN))md|=1;if(pm(p,T_OUT))md|=2;if(!md)md=1;No*ty=pnm(p);No*df=0;if(pm(p,T_AS))df=pex(p);for(uint32_t i=0;i<id.n;i++){No*n=ND(PM,lc);n->pm.nm=id.d[i]->s;n->pm.ty=ty;n->pm.df=df;n->pm.md=md;nv(&v,n);}}while(pm(p,T_SC));pe(p,T_RP);return v;}
static No*pps_(Ps*p){L lc=pl(p);pe(p,T_PROC);No*n=ND(PS,lc);if(pa(p,T_STR)){n->sp.nm=p->cr.lit;pn(p);}else n->sp.nm=pi(p);n->sp.pmm=ppm(p);return n;}
static No*pfs(Ps*p){L lc=pl(p);pe(p,T_FUN);No*n=ND(FS,lc);if(pa(p,T_STR)){n->sp.nm=p->cr.lit;pn(p);}else n->sp.nm=pi(p);n->sp.pmm=ppm(p);pe(p,T_RET);n->sp.rt=pnm(p);return n;}
static No*ptd(Ps*p);
static NV pgfp(Ps*p){NV v={0};while(!pa(p,T_PROC)&&!pa(p,T_FUN)&&!pa(p,T_PKG)){if(pm(p,T_TYP)){L lc=pl(p);S nm=pi(p);bool isp=false;if(pm(p,T_LP)){while(!pa(p,T_RP))pn(p);pe(p,T_RP);}if(pm(p,T_IS)){if(pm(p,T_DIG)||pm(p,T_DELTA)||pm(p,T_RNG)){pe(p,T_BX);}else if(pm(p,T_LP)){pe(p,T_BX);pe(p,T_RP);isp=true;}else if(pm(p,T_LIM)||pa(p,T_ARR)||pa(p,T_REC)||pa(p,T_ACCS)||pa(p,T_PRV)){ptd(p);}else pex(p);}No*n=ND(GTP,lc);n->td.nm=nm;nv(&v,n);pe(p,T_SC);}else if(pm(p,T_WITH)){if(pa(p,T_PROC)){No*sp=pps_(p);sp->k=N_GSP;if(pm(p,T_IS)){if(!pm(p,T_BX)){while(!pa(p,T_SC))pn(p);}}nv(&v,sp);}else if(pa(p,T_FUN)){No*sp=pfs(p);sp->k=N_GSP;if(pm(p,T_IS)){if(!pm(p,T_BX)){while(!pa(p,T_SC))pn(p);}}nv(&v,sp);}else{L lc=pl(p);NV id={0};do{S nm=pi(p);No*i=ND(ID,lc);i->s=nm;nv(&id,i);}while(pm(p,T_CM));pe(p,T_CL);uint8_t md=0;if(pm(p,T_IN))md|=1;if(pm(p,T_OUT))md|=2;if(!md)md=1;No*ty=pnm(p);pm(p,T_AS);if(!pa(p,T_SC))pex(p);No*n=ND(GVL,lc);n->od.id=id;n->od.ty=ty;nv(&v,n);}pe(p,T_SC);}else{L lc=pl(p);NV id={0};do{S nm=pi(p);No*i=ND(ID,lc);i->s=nm;nv(&id,i);}while(pm(p,T_CM));pe(p,T_CL);uint8_t md=0;if(pm(p,T_IN))md|=1;if(pm(p,T_OUT))md|=2;if(!md)md=1;No*ty=pnm(p);pm(p,T_AS);if(!pa(p,T_SC))pex(p);No*n=ND(GVL,lc);n->od.id=id;n->od.ty=ty;nv(&v,n);pe(p,T_SC);}}return v;}
static No*pgf(Ps*p){L lc=pl(p);pe(p,T_GEN);No*n=ND(GEN,lc);n->gen.fp=pgfp(p);if(pa(p,T_PROC)){No*sp=pps_(p);pe(p,T_SC);n->gen.un=ND(PD,lc);n->gen.un->bd.sp=sp;return n;}if(pa(p,T_FUN)){No*sp=pfs(p);pe(p,T_SC);n->gen.un=ND(FD,lc);n->gen.un->bd.sp=sp;return n;}if(pm(p,T_PKG)){S nm=pi(p);pe(p,T_IS);NV dc=pdc(p);if(pm(p,T_PRV)){NV pr=pdc(p);for(uint32_t i=0;i<pr.n;i++)nv(&dc,pr.d[i]);}n->gen.dc=dc;pe(p,T_END);if(pa(p,T_ID))pn(p);pe(p,T_SC);No*pk=ND(PKS,lc);pk->ps.nm=nm;pk->ps.dc=n->gen.dc;n->gen.un=pk;return n;}return n;}
static No*pif(Ps*p){L lc=pl(p);pe(p,T_IF);No*n=ND(IF,lc);n->if_.cd=pex(p);pe(p,T_THEN);while(!pa(p,T_ELSIF)&&!pa(p,T_ELSE)&&!pa(p,T_END))nv(&n->if_.th,ps(p));while(pm(p,T_ELSIF)){No*e=ND(EL,lc);e->if_.cd=pex(p);pe(p,T_THEN);while(!pa(p,T_ELSIF)&&!pa(p,T_ELSE)&&!pa(p,T_END))nv(&e->if_.th,ps(p));nv(&n->if_.ei,e);}if(pm(p,T_ELSE))while(!pa(p,T_END))nv(&n->if_.el,ps(p));pe(p,T_END);pe(p,T_IF);pe(p,T_SC);return n;}
static No*pcs(Ps*p){L lc=pl(p);pe(p,T_CSE);No*n=ND(CS,lc);n->cs.ex=pex(p);pe(p,T_IS);while(pa(p,T_PGM))prc(p);while(pm(p,T_WHN)){No*a=ND(WH,lc);do{No*e=pex(p);if(e->k==N_ID&&pm(p,T_RNG)){No*r=prn(p);nv(&a->ch.it,r);}else if(pm(p,T_DD)){No*r=ND(RN,lc);r->rn.lo=e;r->rn.hi=pex(p);nv(&a->ch.it,r);}else nv(&a->ch.it,e);}while(pm(p,T_BR));pe(p,T_AR);while(!pa(p,T_WHN)&&!pa(p,T_END))nv(&a->hnd.stz,ps(p));nv(&n->cs.al,a);}pe(p,T_END);pe(p,T_CSE);pe(p,T_SC);return n;}
static No*plp(Ps*p,S lb){L lc=pl(p);No*n=ND(LP,lc);n->lp.lb=lb;if(pm(p,T_WHI))n->lp.it=pex(p);else if(pm(p,T_FOR)){S vr=pi(p);pe(p,T_IN);n->lp.rv=pm(p,T_REV);No*rng=prn(p);if(pm(p,T_RNG)){No*r=ND(RN,lc);r->rn.lo=psm(p);pe(p,T_DD);r->rn.hi=psm(p);rng=r;}No*it=ND(BIN,lc);it->bn.op=T_IN;it->bn.l=ND(ID,lc);it->bn.l->s=vr;it->bn.r=rng;n->lp.it=it;}pe(p,T_LOOP);while(!pa(p,T_END))nv(&n->lp.st,ps(p));pe(p,T_END);pe(p,T_LOOP);if(pa(p,T_ID))pn(p);pe(p,T_SC);return n;}
static No*pbk(Ps*p,S lb){L lc=pl(p);No*n=ND(BL,lc);n->bk.lb=lb;if(pm(p,T_DEC))n->bk.dc=pdc(p);pe(p,T_BEG);while(!pa(p,T_EXCP)&&!pa(p,T_END))nv(&n->bk.st,ps(p));if(pm(p,T_EXCP))n->bk.hd=phd(p);pe(p,T_END);if(pa(p,T_ID))pn(p);pe(p,T_SC);return n;}
static No*psl(Ps*p){L lc=pl(p);pe(p,T_SEL);No*n=ND(SA,lc);n->sa.kn=0;if(pm(p,T_DEL)){n->sa.kn=1;n->sa.gd=pex(p);pe(p,T_THEN);if(pm(p,T_AB))n->sa.kn=3;while(!pa(p,T_OR)&&!pa(p,T_ELSE)&&!pa(p,T_END))nv(&n->sa.sts,ps(p));}else if(pa(p,T_WHN)){while(pm(p,T_WHN)){No*g=ND(WH,lc);do nv(&g->ch.it,pex(p));while(pm(p,T_BR));pe(p,T_AR);if(pm(p,T_ACC)){g->k=N_ACC;g->acc.nm=pi(p);if(pa(p,T_LP)){if(p->pk.t==T_ID){Tn scr=p->cr,spk=p->pk;Lx slx=p->lx;pn(p);pn(p);if(p->cr.t==T_CM||p->cr.t==T_CL){p->cr=scr;p->pk=spk;p->lx=slx;g->acc.pmx=ppm(p);}else{p->cr=scr;p->pk=spk;p->lx=slx;pe(p,T_LP);do nv(&g->acc.ixx,pex(p));while(pm(p,T_CM));pe(p,T_RP);g->acc.pmx=ppm(p);}}else{pe(p,T_LP);do nv(&g->acc.ixx,pex(p));while(pm(p,T_CM));pe(p,T_RP);g->acc.pmx=ppm(p);}}else{g->acc.pmx=ppm(p);}if(pm(p,T_DO)){while(!pa(p,T_END)&&!pa(p,T_OR)&&!pa(p,T_ELSE))nv(&g->acc.stx,ps(p));pe(p,T_END);if(pa(p,T_ID))pn(p);}}else if(pm(p,T_TER)){g->k=N_TRM;}else if(pm(p,T_DEL)){g->k=N_DL;g->ex.cd=pex(p);pe(p,T_THEN);while(!pa(p,T_OR)&&!pa(p,T_ELSE)&&!pa(p,T_END))nv(&g->hnd.stz,ps(p));}nv(&n->sa.sts,g);}}else{do{No*g=ND(WH,lc);if(pm(p,T_ACC)){g->k=N_ACC;g->acc.nm=pi(p);if(pa(p,T_LP)){if(p->pk.t==T_ID){Tn scr=p->cr,spk=p->pk;Lx slx=p->lx;pn(p);pn(p);if(p->cr.t==T_CM||p->cr.t==T_CL){p->cr=scr;p->pk=spk;p->lx=slx;g->acc.pmx=ppm(p);}else{p->cr=scr;p->pk=spk;p->lx=slx;pe(p,T_LP);do nv(&g->acc.ixx,pex(p));while(pm(p,T_CM));pe(p,T_RP);g->acc.pmx=ppm(p);}}else{pe(p,T_LP);do nv(&g->acc.ixx,pex(p));while(pm(p,T_CM));pe(p,T_RP);g->acc.pmx=ppm(p);}}else{g->acc.pmx=ppm(p);}if(pm(p,T_DO)){while(!pa(p,T_END)&&!pa(p,T_OR)&&!pa(p,T_ELSE))nv(&g->acc.stx,ps(p));pe(p,T_END);if(pa(p,T_ID))pn(p);}pe(p,T_SC);}else if(pm(p,T_DEL)){g->k=N_DL;g->ex.cd=pex(p);pe(p,T_SC);}else if(pm(p,T_TER)){g->k=N_TRM;pe(p,T_SC);}else{while(!pa(p,T_OR)&&!pa(p,T_ELSE)&&!pa(p,T_END))nv(&g->hnd.stz,ps(p));}nv(&n->sa.sts,g);}while(pm(p,T_OR));}if(pm(p,T_ELSE))while(!pa(p,T_END))nv(&n->ss.el,ps(p));pe(p,T_END);pe(p,T_SEL);pe(p,T_SC);return n;}
static No*ps(Ps*p){L lc=pl(p);S lb=N;while(pa(p,T_LL)){pn(p);lb=pi(p);pe(p,T_GG);slv(&p->lb,lb);}if(!lb.s&&pa(p,T_ID)&&p->pk.t==T_CL){lb=pi(p);pe(p,T_CL);slv(&p->lb,lb);}if(pa(p,T_IF))return pif(p);if(pa(p,T_CSE))return pcs(p);if(pa(p,T_SEL))return psl(p);if(pa(p,T_LOOP)||pa(p,T_WHI)||pa(p,T_FOR))return plp(p,lb);if(pa(p,T_DEC)||pa(p,T_BEG))return pbk(p,lb);if(pm(p,T_ACC)){No*n=ND(ACC,lc);n->acc.nm=pi(p);if(pa(p,T_LP)){if(p->pk.t==T_ID){Tn scr=p->cr,spk=p->pk;Lx slx=p->lx;pn(p);pn(p);if(p->cr.t==T_CM||p->cr.t==T_CL){p->cr=scr;p->pk=spk;p->lx=slx;n->acc.pmx=ppm(p);}else{p->cr=scr;p->pk=spk;p->lx=slx;pe(p,T_LP);do nv(&n->acc.ixx,pex(p));while(pm(p,T_CM));pe(p,T_RP);n->acc.pmx=ppm(p);}}else{pe(p,T_LP);do nv(&n->acc.ixx,pex(p));while(pm(p,T_CM));pe(p,T_RP);n->acc.pmx=ppm(p);}}else{n->acc.pmx=ppm(p);}if(pm(p,T_DO)){while(!pa(p,T_END))nv(&n->acc.stx,ps(p));pe(p,T_END);if(pa(p,T_ID))pn(p);}pe(p,T_SC);return n;}if(pm(p,T_DEL)){No*n=ND(DL,lc);n->ex.cd=pex(p);pe(p,T_SC);return n;}if(pm(p,T_AB)){No*n=ND(AB,lc);if(!pa(p,T_SC))n->rs.ec=pnm(p);pe(p,T_SC);return n;}if(pm(p,T_RET)){No*n=ND(RT,lc);if(!pa(p,T_SC))n->rt.vl=pex(p);pe(p,T_SC);return n;}if(pm(p,T_EXIT)){No*n=ND(EX,lc);if(pa(p,T_ID))n->ex.lb=pi(p);if(pm(p,T_WHN))n->ex.cd=pex(p);pe(p,T_SC);return n;}if(pm(p,T_GOTO)){No*n=ND(GT,lc);n->go.lb=pi(p);pe(p,T_SC);return n;}if(pm(p,T_RAS)){No*n=ND(RS,lc);if(!pa(p,T_SC))n->rs.ec=pnm(p);pe(p,T_SC);return n;}if(pm(p,T_NULL)){pe(p,T_SC);return ND(NS,lc);}if(pm(p,T_PGM)){No*n=ND(PG,lc);n->pg.nm=pi(p);if(pm(p,T_LP)){do nv(&n->pg.ar,pex(p));while(pm(p,T_CM));pe(p,T_RP);}pe(p,T_SC);return n;}No*e=pnm(p);if(pm(p,T_AS)){No*n=ND(AS,lc);if(e&&e->k==N_CL){No*fn=e->cl.fn;NV ar=e->cl.ar;e->k=N_IX;e->ix.p=fn;e->ix.ix=ar;}n->as.tg=e;n->as.vl=pex(p);pe(p,T_SC);return n;}No*n=ND(CLT,lc);if(e->k==N_IX){n->ct.nm=e->ix.p;n->ct.arr=e->ix.ix;}else if(e->k==N_CL){n->ct.nm=e->cl.fn;n->ct.arr=e->cl.ar;}else n->ct.nm=e;pe(p,T_SC);return n;}
static NV pst(Ps*p){NV v={0};while(!pa(p,T_END)&&!pa(p,T_EXCP)&&!pa(p,T_ELSIF)&&!pa(p,T_ELSE)&&!pa(p,T_WHN)&&!pa(p,T_OR))nv(&v,ps(p));return v;}
static NV phd(Ps*p){NV v={0};while(pm(p,T_WHN)){L lc=pl(p);No*h=ND(HD,lc);do{if(pm(p,T_OTH)){No*n=ND(ID,lc);n->s=Z("others");nv(&h->hnd.ec,n);}else nv(&h->hnd.ec,pnm(p));}while(pm(p,T_BR));pe(p,T_AR);while(!pa(p,T_WHN)&&!pa(p,T_END))nv(&h->hnd.stz,ps(p));nv(&v,h);}return v;}
static No*ptd(Ps*p){L lc=pl(p);if(pm(p,T_LP)){No*n=ND(TE,lc);do{if(pa(p,T_CHAR)){No*c=ND(CHAR,lc);c->i=p->cr.iv;pn(p);nv(&n->lst.it,c);}else{S nm=pi(p);No*i=ND(ID,lc);i->s=nm;nv(&n->lst.it,i);}}while(pm(p,T_CM));pe(p,T_RP);return n;}if(pm(p,T_RNG)){No*n=ND(TI,lc);if(pm(p,T_BX)){n->rn.lo=0;n->rn.hi=0;}else{n->rn.lo=psm(p);pe(p,T_DD);n->rn.hi=psm(p);}return n;}if(pm(p,T_MOD)){No*n=ND(TI,lc);n->un.op=T_MOD;n->un.x=pex(p);return n;}if(pm(p,T_DIG)){No*n=ND(TF,lc);if(pm(p,T_BX))n->un.x=0;else n->un.x=pex(p);if(pm(p,T_RNG)){n->rn.lo=psm(p);pe(p,T_DD);n->rn.hi=psm(p);}return n;}if(pm(p,T_DELTA)){No*n=ND(TX,lc);if(pm(p,T_BX)){n->rn.lo=0;n->rn.hi=0;n->bn.r=0;}else{n->rn.lo=pex(p);pe(p,T_RNG);n->rn.hi=psm(p);pe(p,T_DD);n->bn.r=psm(p);}return n;}if(pm(p,T_ARR)){pe(p,T_LP);No*n=ND(TA,lc);do{No*ix=prn(p);if(ix->k==N_ID&&pm(p,T_RNG)){No*st=ND(ST,lc);st->sd.in=ix;No*cn=ND(CN,lc);cn->cn.rn=prn(p);st->sd.cn=cn;nv(&n->ix.ix,st);}else nv(&n->ix.ix,ix);}while(pm(p,T_CM));pe(p,T_RP);pe(p,T_OF);n->ix.p=psi(p);return n;}if(pm(p,T_REC)){No*n=ND(TR,lc);uint32_t of=0;NV dc={0};if(pm(p,T_LP)){do{S dn=pi(p);pe(p,T_CL);No*dt=pnm(p);No*dd=0;if(pm(p,T_AS))dd=pex(p);No*dp=ND(DS,lc);dp->pm.nm=dn;dp->pm.ty=dt;dp->pm.df=dd;nv(&dc,dp);}while(pm(p,T_SC));pe(p,T_RP);if(!pa(p,T_IS))pe(p,T_SC);}if(pm(p,T_IS)){pe(p,T_REC);}while(!pa(p,T_END)&&!pa(p,T_CSE)&&!pa(p,T_NULL)){NV id={0};do{S nm=pi(p);No*i=ND(ID,lc);i->s=nm;nv(&id,i);}while(pm(p,T_CM));pe(p,T_CL);No*ty=psi(p);No*in=0;if(pm(p,T_AS))in=pex(p);pe(p,T_SC);for(uint32_t i=0;i<id.n;i++){No*c=ND(CM,lc);c->cm.nm=id.d[i]->s;c->cm.ty=ty;c->cm.in=in;c->cm.of=of++;c->cm.dc=0;c->cm.dsc=0;if(dc.n>0){c->cm.dc=ND(LST,lc);c->cm.dc->lst.it=dc;}nv(&n->lst.it,c);}}if(pm(p,T_NULL)){pe(p,T_SC);}if(pm(p,T_CSE)){No*vp=ND(VP,lc);vp->vp.ds=pnm(p);pe(p,T_IS);while(pm(p,T_WHN)){No*v=ND(VR,lc);do{No*e=pex(p);if(pm(p,T_DD)){No*r=ND(RN,lc);r->rn.lo=e;r->rn.hi=pex(p);e=r;}nv(&v->vr.ch,e);}while(pm(p,T_BR));pe(p,T_AR);while(!pa(p,T_WHN)&&!pa(p,T_END)&&!pa(p,T_NULL)){NV id={0};do{S nm=pi(p);No*i=ND(ID,lc);i->s=nm;nv(&id,i);}while(pm(p,T_CM));pe(p,T_CL);No*ty=psi(p);No*in=0;if(pm(p,T_AS))in=pex(p);pe(p,T_SC);for(uint32_t i=0;i<id.n;i++){No*c=ND(CM,lc);c->cm.nm=id.d[i]->s;c->cm.ty=ty;c->cm.in=in;c->cm.of=of++;c->cm.dc=0;c->cm.dsc=0;if(dc.n>0){c->cm.dc=ND(LST,lc);c->cm.dc->lst.it=dc;}nv(&v->vr.cmm,c);}}if(pm(p,T_NULL))pe(p,T_SC);nv(&vp->vp.vrr,v);}vp->vp.sz=of;if(pm(p,T_NULL)){pe(p,T_REC);}pe(p,T_END);pe(p,T_CSE);pe(p,T_SC);nv(&n->lst.it,vp);}pe(p,T_END);pe(p,T_REC);return n;}if(pm(p,T_ACCS)){No*n=ND(TAC,lc);n->un.x=psi(p);return n;}if(pm(p,T_PRV))return ND(TP,lc);if(pm(p,T_LIM)){pm(p,T_PRV);return ND(TP,lc);}return psi(p);}
static RC*prc(Ps*p){L lc=pl(p);if(pm(p,T_FOR)){pnm(p);pe(p,T_USE);if(pm(p,T_AT)){RC*r=rc(2,0);pex(p);pe(p,T_SC);return r;}if(pm(p,T_REC)){while(!pa(p,T_END)){pi(p);pe(p,T_AT);pex(p);pe(p,T_RNG);prn(p);pe(p,T_SC);}pe(p,T_END);pe(p,T_REC);pe(p,T_SC);return 0;}pex(p);pe(p,T_SC);return 0;}if(pm(p,T_PGM)){S nm=pi(p);RC*r=0;if(si(nm,Z("SUPPRESS"))){if(pa(p,T_LP)){pe(p,T_LP);S ck=pi(p);uint16_t cm=si(ck,Z("OVERFLOW_CHECK"))?CHK_OVF:si(ck,Z("RANGE_CHECK"))?CHK_RNG:si(ck,Z("INDEX_CHECK"))?CHK_IDX:si(ck,Z("DISCRIMINANT_CHECK"))?CHK_DSC:si(ck,Z("LENGTH_CHECK"))?CHK_LEN:si(ck,Z("DIVISION_CHECK"))?CHK_DIV:si(ck,Z("ELABORATION_CHECK"))?CHK_ELB:si(ck,Z("ACCESS_CHECK"))?CHK_ACC:si(ck,Z("STORAGE_CHECK"))?CHK_STG:0;if(cm){r=rc(4,0);r->ad.nm=pm(p,T_CM)?pi(p):N;while(pm(p,T_CM))pi(p);r->ad.ad=cm;}else{while(pm(p,T_CM))pi(p);}pe(p,T_RP);}pe(p,T_SC);return r;}else if(si(nm,Z("PACK"))){if(pa(p,T_LP)){pe(p,T_LP);No*tn=pnm(p);while(pm(p,T_CM))pnm(p);pe(p,T_RP);r=rc(5,0);r->er.nm=tn&&tn->k==N_ID?tn->s:N;}pe(p,T_SC);return r;}else if(si(nm,Z("INLINE"))){if(pa(p,T_LP)){pe(p,T_LP);r=rc(6,0);r->er.nm=pi(p);while(pm(p,T_CM))pi(p);pe(p,T_RP);}pe(p,T_SC);return r;}else if(si(nm,Z("CONTROLLED"))){if(pa(p,T_LP)){pe(p,T_LP);r=rc(7,0);r->er.nm=pi(p);while(pm(p,T_CM))pi(p);pe(p,T_RP);}pe(p,T_SC);return r;}else if(si(nm,Z("INTERFACE"))||si(nm,Z("IMPORT"))){if(pa(p,T_LP)){pe(p,T_LP);r=rc(8,0);r->im.lang=pi(p);if(pm(p,T_CM)){r->im.nm=pi(p);if(pm(p,T_CM)){if(pa(p,T_STR)){r->im.ext=p->cr.lit;pn(p);}else r->im.ext=pi(p);}else r->im.ext=r->im.nm;}pe(p,T_RP);}pe(p,T_SC);return r;}else if(si(nm,Z("OPTIMIZE"))||si(nm,Z("PRIORITY"))||si(nm,Z("STORAGE_SIZE"))||si(nm,Z("SHARED"))||si(nm,Z("LIST"))||si(nm,Z("PAGE"))){if(pm(p,T_LP)){do pex(p);while(pm(p,T_CM));pe(p,T_RP);}pe(p,T_SC);return 0;}else{if(si(nm,Z("ELABORATE"))||si(nm,Z("ELABORATE_ALL"))){pe(p,T_LP);do pi(p);while(pm(p,T_CM));pe(p,T_RP);}else if(pm(p,T_LP)){do pi(p);while(pm(p,T_CM));pe(p,T_RP);}pe(p,T_SC);}}return 0;}
static No*pdl(Ps*p){L lc=pl(p);if(pa(p,T_GEN))return pgf(p);if(pm(p,T_TYP)){S nm=pi(p);No*n=ND(TD,lc);n->td.nm=nm;if(pm(p,T_LP)){No*ds=ND(LST,lc);do{NV dn={0};do{S dnm=pi(p);No*di=ND(ID,lc);di->s=dnm;nv(&dn,di);}while(pm(p,T_CM));pe(p,T_CL);No*dt=pnm(p);No*dd=0;if(pm(p,T_AS))dd=pex(p);for(uint32_t i=0;i<dn.n;i++){No*dp=ND(DS,lc);dp->pm.nm=dn.d[i]->s;dp->pm.ty=dt;dp->pm.df=dd;nv(&ds->lst.it,dp);}}while(pm(p,T_SC));pe(p,T_RP);n->td.dsc=ds->lst.it;}if(pm(p,T_IS)){n->td.nw=pm(p,T_NEW);n->td.drv=n->td.nw;if(n->td.drv){n->td.prt=pnm(p);n->td.df=n->td.prt;if(pm(p,T_DIG)){pex(p);if(pm(p,T_RNG)){psm(p);pe(p,T_DD);psm(p);}}else if(pm(p,T_DELTA)){pex(p);pe(p,T_RNG);psm(p);pe(p,T_DD);psm(p);}else if(pm(p,T_RNG)){No*rn=ND(RN,lc);rn->rn.lo=psm(p);pe(p,T_DD);rn->rn.hi=psm(p);n->td.df=rn;}}else n->td.df=ptd(p);}pe(p,T_SC);return n;}if(pm(p,T_SUB)){S nm=pi(p);pe(p,T_IS);No*n=ND(SD,lc);n->sd.nm=nm;n->sd.in=psi(p);if(n->sd.in->k==N_ST)n->sd.rn=n->sd.in->sd.cn->cn.rn;pe(p,T_SC);return n;}if(pa(p,T_PROC)){No*sp=pps_(p);if(pm(p,T_REN)){pex(p);pe(p,T_SC);No*n=ND(PD,lc);n->bd.sp=sp;return n;}if(pm(p,T_IS)){if(pm(p,T_SEP)){pe(p,T_SC);No*n=ND(PD,lc);n->bd.sp=sp;return n;}if(pm(p,T_NEW)){S gn=pi(p);NV ap={0};if(pm(p,T_LP)){do{No*e=pex(p);if(e->k==N_ID&&pa(p,T_AR)){pn(p);No*a=ND(ASC,lc);nv(&a->asc.ch,e);a->asc.vl=pex(p);nv(&ap,a);}else{nv(&ap,e);}}while(pm(p,T_CM));pe(p,T_RP);}pe(p,T_SC);No*n=ND(GINST,lc);n->gi.nm=sp->sp.nm;n->gi.gn=gn;n->gi.ap=ap;return n;}No*n=ND(PB,lc);n->bd.sp=sp;n->bd.dc=pdc(p);pe(p,T_BEG);n->bd.st=pst(p);if(pm(p,T_EXCP))n->bd.hdd=phd(p);pe(p,T_END);if(pa(p,T_ID)||pa(p,T_STR))pn(p);pe(p,T_SC);return n;}pe(p,T_SC);No*n=ND(PD,lc);n->bd.sp=sp;return n;}if(pm(p,T_FUN)){S nm;if(pa(p,T_STR)){nm=p->cr.lit;pn(p);}else nm=pi(p);if(pm(p,T_IS)&&pm(p,T_NEW)){S gn=pi(p);NV ap={0};if(pm(p,T_LP)){do{No*e=pex(p);if(e->k==N_ID&&pa(p,T_AR)){pn(p);No*a=ND(ASC,lc);nv(&a->asc.ch,e);a->asc.vl=pex(p);nv(&ap,a);}else{nv(&ap,e);}}while(pm(p,T_CM));pe(p,T_RP);}pe(p,T_SC);No*n=ND(GINST,lc);n->gi.nm=nm;n->gi.gn=gn;n->gi.ap=ap;return n;}No*sp=ND(FS,lc);sp->sp.nm=nm;sp->sp.pmm=ppm(p);pe(p,T_RET);sp->sp.rt=pnm(p);if(pm(p,T_REN)){pex(p);pe(p,T_SC);No*n=ND(FD,lc);n->bd.sp=sp;return n;}if(pm(p,T_IS)){if(pm(p,T_SEP)){pe(p,T_SC);No*n=ND(FD,lc);n->bd.sp=sp;return n;}No*n=ND(FB,lc);n->bd.sp=sp;n->bd.dc=pdc(p);pe(p,T_BEG);n->bd.st=pst(p);if(pm(p,T_EXCP))n->bd.hdd=phd(p);pe(p,T_END);if(pa(p,T_ID)||pa(p,T_STR))pn(p);pe(p,T_SC);return n;}pe(p,T_SC);No*n=ND(FD,lc);n->bd.sp=sp;return n;}if(pm(p,T_PKG)){if(pm(p,T_BOD)){S nm=pi(p);pe(p,T_IS);if(pm(p,T_SEP)){pe(p,T_SC);No*n=ND(PKB,lc);n->pb.nm=nm;return n;}No*n=ND(PKB,lc);n->pb.nm=nm;n->pb.dc=pdc(p);if(pm(p,T_BEG)){n->pb.st=pst(p);if(pm(p,T_EXCP))n->pb.hddd=phd(p);}pe(p,T_END);if(pa(p,T_ID))pn(p);pe(p,T_SC);return n;}S nm=pi(p);pe(p,T_IS);if(pm(p,T_NEW)){S gn=pi(p);NV ap={0};if(pm(p,T_LP)){do{No*e=pex(p);if(e->k==N_ID&&pa(p,T_AR)){pn(p);No*a=ND(ASC,lc);nv(&a->asc.ch,e);a->asc.vl=pex(p);nv(&ap,a);}else{nv(&ap,e);}}while(pm(p,T_CM));pe(p,T_RP);}pe(p,T_SC);No*n=ND(GINST,lc);n->gi.nm=nm;n->gi.gn=gn;n->gi.ap=ap;return n;}No*n=ND(PKS,lc);n->ps.nm=nm;n->ps.dc=pdc(p);if(pm(p,T_PRV))n->ps.pr=pdc(p);pe(p,T_END);if(pa(p,T_ID))pn(p);pe(p,T_SC);return n;}if(pm(p,T_TSK)){if(pm(p,T_BOD)){S nm=pi(p);pe(p,T_IS);if(pm(p,T_SEP)){pe(p,T_SC);No*n=ND(TKB,lc);n->tb.nm=nm;return n;}No*n=ND(TKB,lc);n->tb.nm=nm;n->tb.dc=pdc(p);pe(p,T_BEG);n->tb.st=pst(p);if(pm(p,T_EXCP))n->tb.hdz=phd(p);pe(p,T_END);if(pa(p,T_ID))pn(p);pe(p,T_SC);return n;}bool it=pm(p,T_TYP);S nm=pi(p);No*n=ND(TKS,lc);n->ts.nm=nm;n->ts.it=it;if(pm(p,T_IS)){while(!pa(p,T_END)){if(pm(p,T_ENT)){No*e=ND(ENT,lc);e->ent.nm=pi(p);if(pa(p,T_LP)){if(p->pk.t==T_ID||p->pk.t==T_INT||p->pk.t==T_CHAR){Tn scr=p->cr,spk=p->pk;Lx slx=p->lx;pn(p);pn(p);if(p->cr.t==T_CM||p->cr.t==T_CL){p->cr=scr;p->pk=spk;p->lx=slx;e->ent.pmy=ppm(p);}else{p->cr=scr;p->pk=spk;p->lx=slx;pe(p,T_LP);No*ix=prn(p);if(ix->k!=N_RN&&pm(p,T_RNG)){No*rng=prn(p);No*si=ND(ST,lc);No*cn=ND(CN,lc);cn->cn.rn=rng;si->sd.in=ix;si->sd.cn=cn;nv(&e->ent.ixy,si);}else{nv(&e->ent.ixy,ix);}pe(p,T_RP);e->ent.pmy=ppm(p);}}else{pe(p,T_LP);No*ix=prn(p);if(ix->k!=N_RN&&pm(p,T_RNG)){No*rng=prn(p);No*si=ND(ST,lc);No*cn=ND(CN,lc);cn->cn.rn=rng;si->sd.in=ix;si->sd.cn=cn;nv(&e->ent.ixy,si);}else{nv(&e->ent.ixy,ix);}pe(p,T_RP);e->ent.pmy=ppm(p);}}else{e->ent.pmy=ppm(p);}pe(p,T_SC);nv(&n->ts.en,e);}else if(pm(p,T_PGM)){pi(p);if(pm(p,T_LP)){do pex(p);while(pm(p,T_CM));pe(p,T_RP);}pe(p,T_SC);}}pe(p,T_END);if(pa(p,T_ID))pn(p);}pe(p,T_SC);return n;}if(pm(p,T_USE)){NV nms={0};do nv(&nms,pnm(p));while(pm(p,T_CM));pe(p,T_SC);if(nms.n==1){No*n=ND(US,lc);n->us.nm=nms.d[0];return n;}No*lst=ND(LST,lc);for(uint32_t i=0;i<nms.n;i++){No*u=ND(US,lc);u->us.nm=nms.d[i];nv(&lst->lst.it,u);}return lst;}if(pm(p,T_PGM)){No*n=ND(PG,lc);n->pg.nm=pi(p);if(pm(p,T_LP)){do nv(&n->pg.ar,pex(p));while(pm(p,T_CM));pe(p,T_RP);}pe(p,T_SC);return n;}{NV id={0};do{S nm=pi(p);No*i=ND(ID,lc);i->s=nm;nv(&id,i);}while(pm(p,T_CM));pe(p,T_CL);bool co=pm(p,T_CONST);if(pm(p,T_EXCP)){No*n=ND(ED,lc);n->ed.id=id;pe(p,T_SC);return n;}No*ty=0;if(!pa(p,T_AS)){if(pa(p,T_ARR)||pa(p,T_ACCS))ty=ptd(p);else ty=psi(p);}No*in=0;if(pm(p,T_REN))in=pex(p);else if(pm(p,T_AS))in=pex(p);pe(p,T_SC);No*n=ND(OD,lc);n->od.id=id;n->od.ty=ty;n->od.in=in;n->od.co=co;return n;}}
static NV pdc(Ps*p){NV v={0};while(!pa(p,T_BEG)&&!pa(p,T_END)&&!pa(p,T_PRV)&&!pa(p,T_EOF)&&!pa(p,T_ENT)){if(pa(p,T_FOR)){RC*r=prc(p);if(r){No*n=ND(RRC,pl(p));memcpy(&n->ag.it.d,&r,sizeof(RC*));nv(&v,n);}continue;}if(pa(p,T_PGM)){RC*r=prc(p);if(r){No*n=ND(RRC,pl(p));memcpy(&n->ag.it.d,&r,sizeof(RC*));nv(&v,n);}continue;}nv(&v,pdl(p));}return v;}
static No*pcx(Ps*p){L lc=pl(p);No*cx=ND(CX,lc);while(pa(p,T_WITH)||pa(p,T_USE)||pa(p,T_PGM)){if(pm(p,T_WITH)){do{No*w=ND(WI,lc);w->wt.nm=pi(p);nv(&cx->cx.wt,w);}while(pm(p,T_CM));pe(p,T_SC);}else if(pm(p,T_USE)){do{No*u=ND(US,lc);u->us.nm=pnm(p);nv(&cx->cx.us,u);}while(pm(p,T_CM));pe(p,T_SC);}else{No*pg=pdl(p);if(pg)nv(&cx->cx.us,pg);}}return cx;}
static No*pcu(Ps*p){L lc=pl(p);No*n=ND(CU,lc);n->cu.cx=pcx(p);while(pa(p,T_WITH)||pa(p,T_USE)||pa(p,T_PROC)||pa(p,T_FUN)||pa(p,T_PKG)||pa(p,T_GEN)||pa(p,T_PGM)){if(pa(p,T_WITH)||pa(p,T_USE)||pa(p,T_PGM)){No*cx=pcx(p);for(uint32_t i=0;i<cx->cx.wt.n;i++)nv(&n->cu.cx->cx.wt,cx->cx.wt.d[i]);for(uint32_t i=0;i<cx->cx.us.n;i++)nv(&n->cu.cx->cx.us,cx->cx.us.d[i]);}else nv(&n->cu.un,pdl(p));}return n;}
static Ps pnw(const char*s,size_t z,const char*f){Ps p={ln(s,z,f)};pn(&p);pn(&p);return p;}
typedef enum{TY_V=0,TY_I,TY_B,TY_C,TY_F,TY_E,TY_A,TY_R,TY_AC,TY_T,TY_S,TY_P,TY_UI,TY_UF,TY_D,TY_PT,TY_FT,TY_FX}Tk_;
struct Ty{Tk_ k;S nm;Ty*bs,*el,*prt;int64_t lo,hi;NV cm,dc;uint32_t sz,al;SV ev;RV rc;uint64_t ad;bool pk;NV ops;int64_t sm,lg;uint16_t sup;bool ctrl;uint8_t frz;No*fzn;};
struct Sy{S nm;uint8_t k;Ty*ty;No*df;Sy*nx,*pv;int sc;int ss;int64_t vl;uint32_t of;NV ol;SV us;int el;GT*gt;Sy*pr;int lv;bool inl;bool shrd;bool ext;S ext_nm;S ext_lang;uint8_t frz;No*fzn;uint8_t vis;Sy*hm;};
typedef struct{Sy*sy[4096];int sc;int ss;No*ds;No*pk;SV uv;int eo;LV lu;GV gt;jmp_buf*eb[16];int ed;S ce[16];FV io;int fn;SLV lb;int lv;NV ib;Sy*sst[256];int ssd;SV dps[256];int dpn;SV ex;uint64_t uv_vis[64];SLV eh;}Sm;
static uint32_t syh(S s){return sh(s)&4095;}
static Sy*syn(S nm,uint8_t k,Ty*ty,No*df){Sy*s=al(sizeof(Sy));s->nm=nm;s->k=k;s->ty=ty;s->df=df;s->el=-1;s->lv=-1;return s;}
static Sy*sya(Sm*SM,Sy*s){uint32_t h=syh(s->nm);s->hm=SM->sy[h];s->nx=SM->sy[h];s->sc=SM->sc;s->ss=SM->ss;s->el=SM->eo++;s->lv=SM->lv;s->vis=1;SM->sy[h]=s;if(SM->ssd<256)SM->sst[SM->ssd++]=s;return s;}
static Sy*syf(Sm*SM,S nm){Sy*imm=0,*pot=0;uint32_t h=syh(nm);for(Sy*s=SM->sy[h];s;s=s->nx)if(si(s->nm,nm)){if(s->vis&1&&(!imm||s->sc>imm->sc))imm=s;if(s->vis&2&&(!pot||s->sc>pot->sc))pot=s;}for(uint32_t i=0;i<SM->uv.n;i++)for(Sy*u=SM->uv.d[i];u;u=u->nx)if(si(u->nm,nm)&&(u->vis&2)&&(!pot||u->sc>pot->sc))pot=u;if(imm)return imm;for(Sy*s=SM->sy[h];s;s=s->nx)if(si(s->nm,nm)&&(!imm||s->sc>imm->sc))imm=s;if(!imm)for(uint32_t i=0;i<SM->uv.n;i++)for(Sy*u=SM->uv.d[i];u;u=u->nx)if(si(u->nm,nm)&&(!imm||u->sc>imm->sc))imm=u;return imm?:pot;}
static void sfu(Sm*SM,Sy*s,S nm){uint32_t h=syh(nm)&63,b=1ULL<<(syh(nm)&63);if(SM->uv_vis[h]&b)return;SM->uv_vis[h]|=b;for(Sy*p=s;p;p=p->nx)if(si(p->nm,nm)&&p->k==6&&p->df&&p->df->k==N_PKS){No*pk=p->df;for(uint32_t i=0;i<pk->ps.dc.n;i++){No*d=pk->ps.dc.d[i];if(d->sy){sv(&s->us,d->sy);d->sy->vis|=2;sv(&SM->uv,d->sy);}else if(d->k==N_ED){for(uint32_t j=0;j<d->ed.id.n;j++){No*e=d->ed.id.d[j];if(e->sy){sv(&s->us,e->sy);e->sy->vis|=2;sv(&SM->uv,e->sy);sv(&SM->ex,e->sy);}}}else if(d->k==N_OD){for(uint32_t j=0;j<d->od.id.n;j++){No*oid=d->od.id.d[j];if(oid->sy){sv(&s->us,oid->sy);oid->sy->vis|=2;sv(&SM->uv,oid->sy);}}}}if(SM->dpn<256){bool f=0;for(int i=0;i<SM->dpn;i++)if(SM->dps[i].n&&si(SM->dps[i].d[0]->nm,p->nm)){f=1;break;}if(!f){sv(&SM->dps[SM->dpn],p);SM->dpn++;}}}SM->uv_vis[h]&=~b;}
static GT*gfnd(Sm*SM,S nm){for(uint32_t i=0;i<SM->gt.n;i++){GT*g=SM->gt.d[i];if(si(g->nm,nm))return g;}return 0;}
static int tysc(Ty*a,Ty*b,Ty*tx){if(!a||!b)return 0;if(a==b)return 1000;if(a->prt==b||b->prt==a)return 900;if(a->bs==b||b->bs==a)return 800;if((a->k==TY_I||a->k==TY_UI)&&(b->k==TY_I||b->k==TY_UI))return 700;if((a->k==TY_F||a->k==TY_UF)&&(b->k==TY_F||b->k==TY_UF))return 700;if(a->k==TY_AC&&b->k==TY_AC&&a->el&&b->el)return 500+tysc(a->el,b->el,0);if(tx&&a->el&&b==tx)return 400;return 0;}
static Sy*syfa(Sm*SM,S nm,int na,Ty*tx){SV cv={0};for(Sy*s=SM->sy[syh(nm)];s;s=s->nx)if(si(s->nm,nm))sv(&cv,s);for(uint32_t i=0;i<SM->uv.n;i++)for(Sy*u=SM->uv.d[i];u;u=u->nx)if(si(u->nm,nm))sv(&cv,u);if(!cv.n)return 0;if(cv.n==1)return cv.d[0];Sy*br=0;int bs=-1;for(uint32_t i=0;i<cv.n;i++){Sy*c=cv.d[i];int sc=0;if((c->k==4||c->k==5)&&na>=0){if(c->ol.n>0){for(uint32_t j=0;j<c->ol.n;j++){No*b=c->ol.d[j];if(b->k==N_PB||b->k==N_FB){int np=b->bd.sp->sp.pmm.n;if(np==na){sc+=1000;if(tx&&c->ty&&c->ty->el){int ts=tysc(c->ty->el,tx,0);sc+=ts;}for(uint32_t k=0;k<b->bd.sp->sp.pmm.n&&k<(uint32_t)na;k++){No*p=b->bd.sp->sp.pmm.d[k];if(p->sy&&p->sy->ty&&tx){int ps=tysc(p->sy->ty,tx,0);sc+=ps;}}if(sc>bs){bs=sc;br=c;}}}}}else if(c->k==1){if(na==1){sc=500;if(tx){int ts=tysc(c->ty,tx,0);sc+=ts;}if(sc>bs){bs=sc;br=c;}}}}else if(c->k==1&&na<0){sc=100;if(sc>bs){bs=sc;br=c;}}}return br?:cv.d[0];}
static Ty*tyn(Tk_ k,S nm){Ty*t=al(sizeof(Ty));t->k=k;t->nm=nm;t->sz=8;t->al=8;return t;}
static Ty*TY_INT,*TY_BOOL,*TY_CHAR,*TY_STR,*TY_FLT,*TY_UINT,*TY_UFLT,*TY_FILE,*TY_NAT,*TY_POS;
static void smi(Sm*SM){memset(SM,0,sizeof(*SM));TY_INT=tyn(TY_I,Z("INTEGER"));TY_INT->lo=-2147483648LL;TY_INT->hi=2147483647LL;TY_NAT=tyn(TY_I,Z("NATURAL"));TY_NAT->lo=0;TY_NAT->hi=2147483647LL;TY_POS=tyn(TY_I,Z("POSITIVE"));TY_POS->lo=1;TY_POS->hi=2147483647LL;TY_BOOL=tyn(TY_B,Z("BOOLEAN"));TY_CHAR=tyn(TY_C,Z("CHARACTER"));TY_CHAR->sz=1;TY_STR=tyn(TY_A,Z("STRING"));TY_STR->el=TY_CHAR;TY_FLT=tyn(TY_F,Z("FLOAT"));TY_UINT=tyn(TY_UI,Z("universal_integer"));TY_UFLT=tyn(TY_UF,Z("universal_real"));TY_FILE=tyn(TY_FT,Z("FILE_TYPE"));sya(SM,syn(Z("INTEGER"),1,TY_INT,0));sya(SM,syn(Z("NATURAL"),1,TY_NAT,0));sya(SM,syn(Z("POSITIVE"),1,TY_POS,0));sya(SM,syn(Z("BOOLEAN"),1,TY_BOOL,0));Sy*st=sya(SM,syn(Z("TRUE"),2,TY_BOOL,0));st->vl=1;sv(&TY_BOOL->ev,st);Sy*sf=sya(SM,syn(Z("FALSE"),2,TY_BOOL,0));sf->vl=0;sv(&TY_BOOL->ev,sf);sya(SM,syn(Z("CHARACTER"),1,TY_CHAR,0));sya(SM,syn(Z("STRING"),1,TY_STR,0));sya(SM,syn(Z("FLOAT"),1,TY_FLT,0));sya(SM,syn(Z("FILE_TYPE"),1,TY_FILE,0));sya(SM,syn(Z("CONSTRAINT_ERROR"),3,0,0));sya(SM,syn(Z("PROGRAM_ERROR"),3,0,0));sya(SM,syn(Z("STORAGE_ERROR"),3,0,0));sya(SM,syn(Z("TASKING_ERROR"),3,0,0));fv(&SM->io,stdin);fv(&SM->io,stdout);fv(&SM->io,stderr);SM->fn=3;}
static No*geq(Ty*t,L l){No*f=ND(FB,l);f->bd.sp=ND(FS,l);char b[256];snprintf(b,256,"Oeq%.*s",(int)t->nm.n,t->nm.s);f->bd.sp->sp.nm=(S){sd((S){b,strlen(b)}).s,strlen(b)};f->bd.sp->sp.op=Z("=");No*p1=ND(PM,l);p1->pm.nm=Z("L");p1->pm.ty=ND(ID,l);p1->pm.ty->s=t->nm;p1->pm.md=0;No*p2=ND(PM,l);p2->pm.nm=Z("R");p2->pm.ty=ND(ID,l);p2->pm.ty->s=t->nm;p2->pm.md=0;nv(&f->bd.sp->sp.pmm,p1);nv(&f->bd.sp->sp.pmm,p2);f->bd.sp->sp.rt=ND(ID,l);f->bd.sp->sp.rt->s=Z("BOOLEAN");No*s=ND(RT,l);s->rt.vl=ND(BIN,l);s->rt.vl->bn.op=T_EQ;if(t->k==TY_R){s->rt.vl->bn.l=ND(BIN,l);s->rt.vl->bn.l->bn.op=T_AND;for(uint32_t i=0;i<t->cm.n;i++){No*c=t->cm.d[i];if(c->k!=N_CM)continue;No*cmp=ND(BIN,l);cmp->bn.op=T_EQ;No*lf=ND(SEL,l);lf->se.p=ND(ID,l);lf->se.p->s=Z("L");lf->se.se=c->cm.nm;No*rf=ND(SEL,l);rf->se.p=ND(ID,l);rf->se.p->s=Z("R");rf->se.se=c->cm.nm;cmp->bn.l=lf;cmp->bn.r=rf;if(!i)s->rt.vl->bn.l=cmp;else{No*a=ND(BIN,l);a->bn.op=T_AND;a->bn.l=s->rt.vl->bn.l;a->bn.r=cmp;s->rt.vl->bn.l=a;}}}else if(t->k==TY_A){No*lp=ND(LP,l);lp->lp.it=ND(BIN,l);lp->lp.it->bn.op=T_IN;lp->lp.it->bn.l=ND(ID,l);lp->lp.it->bn.l->s=Z("I");lp->lp.it->bn.r=ND(AT,l);lp->lp.it->bn.r->at.p=ND(ID,l);lp->lp.it->bn.r->at.p->s=Z("L");lp->lp.it->bn.r->at.at=Z("RANGE");No*cmp=ND(BIN,l);cmp->bn.op=T_NE;No*li=ND(IX,l);li->ix.p=ND(ID,l);li->ix.p->s=Z("L");nv(&li->ix.ix,ND(ID,l));li->ix.ix.d[0]->s=Z("I");No*ri=ND(IX,l);ri->ix.p=ND(ID,l);ri->ix.p->s=Z("R");nv(&ri->ix.ix,ND(ID,l));ri->ix.ix.d[0]->s=Z("I");cmp->bn.l=li;cmp->bn.r=ri;No*rt=ND(RT,l);rt->rt.vl=ND(ID,l);rt->rt.vl->s=Z("FALSE");No*ifs=ND(IF,l);ifs->if_.cd=cmp;nv(&ifs->if_.th,rt);nv(&lp->lp.st,ifs);nv(&f->bd.st,lp);s->rt.vl=ND(ID,l);s->rt.vl->s=Z("TRUE");}nv(&f->bd.st,s);return f;}
static No*gas(Ty*t,L l){No*p=ND(PB,l);p->bd.sp=ND(PS,l);char b[256];snprintf(b,256,"Oas%.*s",(int)t->nm.n,t->nm.s);p->bd.sp->sp.nm=(S){sd((S){b,strlen(b)}).s,strlen(b)};p->bd.sp->sp.op=Z(":=");No*p1=ND(PM,l);p1->pm.nm=Z("T");p1->pm.ty=ND(ID,l);p1->pm.ty->s=t->nm;p1->pm.md=3;No*p2=ND(PM,l);p2->pm.nm=Z("S");p2->pm.ty=ND(ID,l);p2->pm.ty->s=t->nm;p2->pm.md=0;nv(&p->bd.sp->sp.pmm,p1);nv(&p->bd.sp->sp.pmm,p2);if(t->k==TY_R){for(uint32_t i=0;i<t->cm.n;i++){No*c=t->cm.d[i];if(c->k!=N_CM)continue;No*as=ND(AS,l);No*lt=ND(SEL,l);lt->se.p=ND(ID,l);lt->se.p->s=Z("T");lt->se.se=c->cm.nm;No*rs=ND(SEL,l);rs->se.p=ND(ID,l);rs->se.p->s=Z("S");rs->se.se=c->cm.nm;as->as.tg=lt;as->as.vl=rs;nv(&p->bd.st,as);}}else if(t->k==TY_A){No*lp=ND(LP,l);lp->lp.it=ND(BIN,l);lp->lp.it->bn.op=T_IN;lp->lp.it->bn.l=ND(ID,l);lp->lp.it->bn.l->s=Z("I");lp->lp.it->bn.r=ND(AT,l);lp->lp.it->bn.r->at.p=ND(ID,l);lp->lp.it->bn.r->at.p->s=Z("T");lp->lp.it->bn.r->at.at=Z("RANGE");No*as=ND(AS,l);No*ti=ND(IX,l);ti->ix.p=ND(ID,l);ti->ix.p->s=Z("T");nv(&ti->ix.ix,ND(ID,l));ti->ix.ix.d[0]->s=Z("I");No*si=ND(IX,l);si->ix.p=ND(ID,l);si->ix.p->s=Z("S");nv(&si->ix.ix,ND(ID,l));si->ix.ix.d[0]->s=Z("I");as->as.tg=ti;as->as.vl=si;nv(&lp->lp.st,as);nv(&p->bd.st,lp);}return p;}
static No*gin(Ty*t,L l){No*f=ND(FB,l);f->bd.sp=ND(FS,l);char b[256];snprintf(b,256,"Oin%.*s",(int)t->nm.n,t->nm.s);f->bd.sp->sp.nm=(S){sd((S){b,strlen(b)}).s,strlen(b)};f->bd.sp->sp.rt=ND(ID,l);f->bd.sp->sp.rt->s=t->nm;No*ag=ND(AG,l);if(t->k==TY_R){for(uint32_t i=0;i<t->cm.n;i++){No*c=t->cm.d[i];if(c->k!=N_CM||!c->cm.in)continue;No*a=ND(ASC,l);nv(&a->asc.ch,ND(ID,l));a->asc.ch.d[0]->s=c->cm.nm;a->asc.vl=c->cm.in;nv(&ag->ag.it,a);}}No*rt=ND(RT,l);rt->rt.vl=ag;nv(&f->bd.st,rt);return ag->ag.it.n>0?f:0;}
static void fty(Sm*SM,Ty*t,L l){
if(!t||t->frz)return;
if(t->k==TY_PT&&t->prt&&!t->prt->frz)return;
t->frz=1;
t->fzn=ND(ERR,l);
if(t->bs&&t->bs!=t&&!t->bs->frz)fty(SM,t->bs,l);
if(t->prt&&!t->prt->frz)fty(SM,t->prt,l);
if(t->el&&!t->el->frz)fty(SM,t->el,l);
if(t->k==TY_R){for(uint32_t i=0;i<t->cm.n;i++)if(t->cm.d[i]->sy&&t->cm.d[i]->sy->ty)fty(SM,t->cm.d[i]->sy->ty,l);uint32_t of=0,mx=1;for(uint32_t i=0;i<t->cm.n;i++){No*c=t->cm.d[i];if(c->k!=N_CM)continue;Ty*ct=c->cm.ty?c->cm.ty->ty:0;uint32_t ca=ct&&ct->al?ct->al:8,cs=ct&&ct->sz?ct->sz:8;if(ca>mx)mx=ca;of=(of+ca-1)&~(ca-1);c->cm.of=of;of+=cs;}t->sz=(of+mx-1)&~(mx-1);t->al=mx;}
if(t->k==TY_A&&t->el){Ty*et=t->el;uint32_t ea=et->al?et->al:8,es=et->sz?et->sz:8;int64_t n=(t->hi-t->lo+1);t->sz=n>0?n*es:0;t->al=ea;}
if((t->k==TY_R||t->k==TY_A)&&t->nm.s&&t->nm.n){No*eq=geq(t,l);if(eq)nv(&t->ops,eq);No*as=gas(t,l);if(as)nv(&t->ops,as);No*in=gin(t,l);if(in)nv(&t->ops,in);}
}
static void fsy(Sm*SM,Sy*s,L l){if(!s||s->frz)return;s->frz=1;s->fzn=ND(ERR,l);if(s->ty&&!s->ty->frz)fty(SM,s->ty,l);}
static void fal(Sm*SM,L l){for(int i=0;i<4096;i++)for(Sy*s=SM->sy[i];s;s=s->nx)if(s->sc==SM->sc&&!s->frz){if(s->ty&&s->ty->k==TY_PT&&s->ty->prt&&!s->ty->prt->frz)continue;if(s->ty)fty(SM,s->ty,l);fsy(SM,s,l);}}
static void scp(Sm*SM){SM->sc++;SM->ss++;if(SM->ssd<256){int m=SM->ssd;SM->ssd++;SM->sst[m]=0;}}
static void sco(Sm*SM){fal(SM,(L){0,0,""});for(int i=0;i<4096;i++){Sy**p=&SM->sy[i];while(*p){Sy*s=*p;if(s->sc==SM->sc&&s->ss==SM->ss){if(s->k==6){s->vis=2;p=&s->nx;}else if(s->k==0&&!s->pr)*p=s->nx;else if((s->k==2||s->k==0)&&s->pr){p=&s->nx;}else{s->vis&=~1;p=&s->nx;}}else p=&s->nx;}}if(SM->ssd>0)SM->ssd--;SM->sc--;}
static Ty*rst(Sm*SM,No*n);static void rex(Sm*SM,No*n,Ty*tx);static void rss(Sm*SM,No*n);static void rdl(Sm*SM,No*n);static void rrc_(Sm*SM,RC*r);static No*gcl(Sm*SM,No*n);
static Ty*tcc(Ty*t){if(!t)return TY_INT;if(t->k==TY_UI)return TY_INT;if(t->k==TY_UF)return TY_FLT;if(t->k==TY_FX)return TY_INT;if(t->k==TY_D&&t->prt)return tcc(t->prt);return t;}
static bool tco(Ty*a,Ty*b){if(!a||!b)return false;if(a==b)return true;if(a->prt==b||b->prt==a)return true;if(a->bs==b||b->bs==a)return true;if((a->k==TY_I||a->k==TY_UI)&&(b->k==TY_I||b->k==TY_UI))return true;if((a->k==TY_F||a->k==TY_UF)&&(b->k==TY_F||b->k==TY_UF))return true;if(a->k==TY_AC&&b->k==TY_AC)return tco(a->el,b->el);if(a->k==TY_D)return tco(a->prt,b);if(b->k==TY_D)return tco(a,b->prt);return false;}
static Ty*rst(Sm*SM,No*n){if(!n)return TY_INT;if(n->k==N_ID){Sy*s=syf(SM,n->s);if(s&&s->ty)return s->ty;return TY_INT;}if(n->k==N_SEL){No*p=n->se.p;if(p->k==N_ID){Sy*ps=syf(SM,p->s);if(ps&&ps->k==6&&ps->df&&ps->df->k==N_PKS){No*pk=ps->df;for(uint32_t i=0;i<pk->ps.dc.n;i++){No*d=pk->ps.dc.d[i];if(d->k==N_TD&&si(d->td.nm,n->se.se))return rst(SM,d->td.df);if(d->sy&&si(d->sy->nm,n->se.se)&&d->sy->ty)return d->sy->ty;}}return rst(SM,p);}return TY_INT;}if(n->k==N_ST)return rst(SM,n->sd.in);if(n->k==N_TI){rex(SM,n->rn.lo,0);rex(SM,n->rn.hi,0);Ty*t=tyn(TY_I,N);if(n->rn.lo&&n->rn.lo->k==N_INT)t->lo=n->rn.lo->i;else if(n->rn.lo&&n->rn.lo->k==N_UN&&n->rn.lo->un.op==T_MN&&n->rn.lo->un.x->k==N_INT)t->lo=-n->rn.lo->un.x->i;if(n->rn.hi&&n->rn.hi->k==N_INT)t->hi=n->rn.hi->i;else if(n->rn.hi&&n->rn.hi->k==N_UN&&n->rn.hi->un.op==T_MN&&n->rn.hi->un.x->k==N_INT)t->hi=-n->rn.hi->un.x->i;return t;}if(n->k==N_TX){Ty*t=tyn(TY_FX,N);double d=1.0;if(n->rn.lo&&n->rn.lo->k==N_REAL)d=n->rn.lo->f;else if(n->rn.lo&&n->rn.lo->k==N_INT)d=n->rn.lo->i;t->sm=(int64_t)(1.0/d);if(n->rn.hi&&n->rn.hi->k==N_INT)t->lo=n->rn.hi->i;if(n->bn.r&&n->bn.r->k==N_INT)t->hi=n->bn.r->i;return t;}if(n->k==N_TE)return tyn(TY_I,N);if(n->k==N_TF){Ty*t=tyn(TY_F,N);if(n->un.x){rex(SM,n->un.x,0);if(n->un.x->k==N_INT)t->sm=n->un.x->i;}return t;}if(n->k==N_TA){Ty*t=tyn(TY_A,N);t->el=rst(SM,n->ix.p);if(n->ix.ix.n==1){No*r=n->ix.ix.d[0];if(r&&r->k==N_RN&&r->rn.lo&&r->rn.hi&&r->rn.lo->k==N_INT&&r->rn.hi->k==N_INT){t->lo=r->rn.lo->i;t->hi=r->rn.hi->i;}}return t;}if(n->k==N_TR||n->k==N_TP)return tyn(TY_R,N);if(n->k==N_TAC){Ty*t=tyn(TY_AC,N);t->el=rst(SM,n->un.x);return t;}if(n->k==N_RN){rex(SM,n->rn.lo,0);rex(SM,n->rn.hi,0);Ty*t=tyn(TY_I,N);if(n->rn.lo&&n->rn.lo->k==N_INT)t->lo=n->rn.lo->i;else if(n->rn.lo&&n->rn.lo->k==N_UN&&n->rn.lo->un.op==T_MN&&n->rn.lo->un.x->k==N_INT)t->lo=-n->rn.lo->un.x->i;if(n->rn.hi&&n->rn.hi->k==N_INT)t->hi=n->rn.hi->i;else if(n->rn.hi&&n->rn.hi->k==N_UN&&n->rn.hi->un.op==T_MN&&n->rn.hi->un.x->k==N_INT)t->hi=-n->rn.hi->un.x->i;return t;}return TY_INT;}
static Sy*scl(Sm*SM,char c,Ty*tx){if(tx&&tx->k==TY_E){for(uint32_t i=0;i<tx->ev.n;i++){Sy*e=tx->ev.d[i];if(e->nm.n==1&&tolower(e->nm.s[0])==tolower(c))return e;}}if(tx&&tx->k==TY_D&&tx->prt)return scl(SM,c,tx->prt);for(Sy*s=SM->sy[syh((S){&c,1})];s;s=s->nx)if(s->nm.n==1&&tolower(s->nm.s[0])==tolower(c)&&s->k==2&&s->ty&&(s->ty->k==TY_E||(s->ty->k==TY_D&&s->ty->prt&&s->ty->prt->k==TY_E)))return s;return 0;}
static No*chk(Sm*SM,No*n,L l){if(!n||!n->ty)return n;Ty*t=tcc(n->ty);if(t->k==TY_I&&(t->lo!=TY_INT->lo||t->hi!=TY_INT->hi)&&!(t->sup&CHK_RNG)){No*c=ND(CHK,l);c->chk.ex=n;c->chk.ec=Z("CONSTRAINT_ERROR");c->ty=n->ty;return c;}return n;}
static void icv(Ty*t,No*n){if(!t||!n||n->k!=N_CL)return;for(uint32_t i=0;i<n->cl.ar.n;i++)rex(0,n->cl.ar.d[i],0);}
static bool hrs(NV*v){for(uint32_t i=0;i<v->n;i++)if(v->d[i]->k!=N_PG)return 1;return 0;}
static void rex(Sm*SM,No*n,Ty*tx){if(!n)return;switch(n->k){case N_ID:{Sy*s=syf(SM,n->s);if(s){n->ty=s->ty;n->sy=s;if(s->k==2&&s->df){if(s->df->k==N_INT){n->k=N_INT;n->i=s->df->i;n->ty=TY_UINT;}else if(s->df->k==N_REAL){n->k=N_REAL;n->f=s->df->f;n->ty=TY_UFLT;}}}else{if(tx&&tx->k==TY_E){for(uint32_t i=0;i<tx->ev.n;i++){Sy*e=tx->ev.d[i];if(si(e->nm,n->s)){n->ty=tx;n->sy=e;return;}}}if(E<99&&!si(n->s,Z("others")))die(n->l,"undef '%.*s'",(int)n->s.n,n->s.s);n->ty=TY_INT;}}break;case N_INT:n->ty=TY_UINT;break;case N_REAL:n->ty=TY_UFLT;break;case N_CHAR:{Sy*s=scl(SM,n->i,tx);if(s){n->ty=s->ty;n->sy=s;n->k=N_ID;n->s=s->nm;}else n->ty=TY_CHAR;}break;case N_STR:n->ty=TY_STR;break;case N_NULL:n->ty=tx&&tx->k==TY_AC?tx:TY_INT;break;case N_BIN:rex(SM,n->bn.l,tx);rex(SM,n->bn.r,tx);if(n->bn.op==T_ATHN||n->bn.op==T_OREL){n->ty=TY_BOOL;break;}if(n->bn.op==T_AND||n->bn.op==T_OR||n->bn.op==T_XOR){n->bn.l=chk(SM,n->bn.l,n->l);n->bn.r=chk(SM,n->bn.r,n->l);n->ty=TY_BOOL;break;}if(n->bn.op==T_IN){n->bn.l=chk(SM,n->bn.l,n->l);n->bn.r=chk(SM,n->bn.r,n->l);n->ty=TY_BOOL;break;}if(n->bn.l->k==N_INT&&n->bn.r->k==N_INT&&(n->bn.op==T_PL||n->bn.op==T_MN||n->bn.op==T_ST||n->bn.op==T_SL||n->bn.op==T_MOD||n->bn.op==T_REM)){int64_t a=n->bn.l->i,b=n->bn.r->i,r=0;if(n->bn.op==T_PL)r=a+b;else if(n->bn.op==T_MN)r=a-b;else if(n->bn.op==T_ST)r=a*b;else if(n->bn.op==T_SL&&b!=0)r=a/b;else if((n->bn.op==T_MOD||n->bn.op==T_REM)&&b!=0)r=a%b;n->k=N_INT;n->i=r;n->ty=TY_UINT;}else if((n->bn.l->k==N_REAL||n->bn.r->k==N_REAL)&&(n->bn.op==T_PL||n->bn.op==T_MN||n->bn.op==T_ST||n->bn.op==T_SL||n->bn.op==T_EX)){double a=n->bn.l->k==N_INT?(double)n->bn.l->i:n->bn.l->f,b=n->bn.r->k==N_INT?(double)n->bn.r->i:n->bn.r->f,r=0;if(n->bn.op==T_PL)r=a+b;else if(n->bn.op==T_MN)r=a-b;else if(n->bn.op==T_ST)r=a*b;else if(n->bn.op==T_SL&&b!=0)r=a/b;else if(n->bn.op==T_EX)r=pow(a,b);n->k=N_REAL;n->f=r;n->ty=TY_UFLT;}else{n->ty=tcc(n->bn.l->ty);}if(n->bn.op>=T_EQ&&n->bn.op<=T_GE)n->ty=TY_BOOL;break;case N_UN:rex(SM,n->un.x,tx);if(n->un.op==T_MN&&n->un.x->k==N_INT){n->k=N_INT;n->i=-n->un.x->i;n->ty=TY_UINT;}else if(n->un.op==T_MN&&n->un.x->k==N_REAL){n->k=N_REAL;n->f=-n->un.x->f;n->ty=TY_UFLT;}else if(n->un.op==T_PL&&(n->un.x->k==N_INT||n->un.x->k==N_REAL)){n->k=n->un.x->k;if(n->k==N_INT){n->i=n->un.x->i;n->ty=TY_UINT;}else{n->f=n->un.x->f;n->ty=TY_UFLT;}}else{n->ty=tcc(n->un.x->ty);}if(n->un.op==T_NOT)n->ty=TY_BOOL;break;case N_IX:rex(SM,n->ix.p,0);for(uint32_t i=0;i<n->ix.ix.n;i++){rex(SM,n->ix.ix.d[i],0);n->ix.ix.d[i]=chk(SM,n->ix.ix.d[i],n->l);}if(n->ix.p->ty&&n->ix.p->ty->k==TY_A)n->ty=n->ix.p->ty->el;else n->ty=TY_INT;break;case N_SL:rex(SM,n->sl.p,0);rex(SM,n->sl.lo,0);rex(SM,n->sl.hi,0);if(n->sl.p->ty&&n->sl.p->ty->k==TY_A)n->ty=n->sl.p->ty;else n->ty=TY_INT;break;case N_SEL:{rex(SM,n->se.p,0);No*p=n->se.p;if(p->k==N_ID){Sy*ps=syf(SM,p->s);if(ps&&ps->k==6&&ps->df&&ps->df->k==N_PKS){No*pk=ps->df;for(uint32_t i=0;i<pk->ps.dc.n;i++){No*d=pk->ps.dc.d[i];if(d->sy&&si(d->sy->nm,n->se.se)){n->ty=d->sy->ty?d->sy->ty:TY_INT;n->sy=d->sy;return;}if(d->k==N_ED){for(uint32_t j=0;j<d->ed.id.n;j++){No*eid=d->ed.id.d[j];if(eid->sy&&si(eid->sy->nm,n->se.se)){n->ty=eid->sy->ty?eid->sy->ty:TY_INT;n->sy=eid->sy;return;}}}if(d->k==N_OD){for(uint32_t j=0;j<d->od.id.n;j++){No*oid=d->od.id.d[j];if(oid->sy&&si(oid->sy->nm,n->se.se)){n->ty=oid->sy->ty?oid->sy->ty:TY_INT;n->sy=oid->sy;return;}}}}for(uint32_t i=0;i<pk->ps.dc.n;i++){No*d=pk->ps.dc.d[i];if(d->k==N_TD&&d->sy&&d->sy->ty){Ty*et=d->sy->ty;if(et->k==TY_E){for(uint32_t j=0;j<et->ev.n;j++){Sy*e=et->ev.d[j];if(si(e->nm,n->se.se)){n->ty=et;n->sy=e;return;}}}}if(d->sy&&si(d->sy->nm,n->se.se)){n->ty=d->sy->ty;n->sy=d->sy;return;}}for(int h=0;h<4096;h++)for(Sy*s=SM->sy[h];s;s=s->nx)if(s->pr==ps&&si(s->nm,n->se.se)){n->ty=s->ty;n->sy=s;return;}if(E<99)die(n->l,"?'%.*s' in pkg",(int)n->se.se.n,n->se.se.s);}}if(p->ty){Ty*pt=tcc(p->ty);if(pt->k==TY_R){for(uint32_t i=0;i<pt->cm.n;i++){No*c=pt->cm.d[i];if(c->k==N_CM&&si(c->cm.nm,n->se.se)){n->ty=rst(SM,c->cm.ty);return;}}for(uint32_t i=0;i<pt->dc.n;i++){No*d=pt->dc.d[i];if(d->k==N_DS&&si(d->pm.nm,n->se.se)){n->ty=rst(SM,d->pm.ty);return;}}for(uint32_t i=0;i<pt->cm.n;i++){No*c=pt->cm.d[i];if(c->k==N_VP){for(uint32_t j=0;j<c->vp.vrr.n;j++){No*v=c->vp.vrr.d[j];for(uint32_t k=0;k<v->vr.cmm.n;k++){No*vc=v->vr.cmm.d[k];if(si(vc->cm.nm,n->se.se)){n->ty=rst(SM,vc->cm.ty);return;}}}}}if(E<99)die(n->l,"?fld '%.*s'",(int)n->se.se.n,n->se.se.s);}}n->ty=TY_INT;}break;case N_AT:rex(SM,n->at.p,0);for(uint32_t i=0;i<n->at.ar.n;i++)rex(SM,n->at.ar.d[i],0);{Ty*pt=n->at.p?tcc(n->at.p->ty):0;S a=n->at.at;if(si(a,Z("FIRST"))||si(a,Z("LAST")))n->ty=pt&&pt->el?pt->el:(pt&&(pt->k==TY_I||pt->k==TY_E))?pt:TY_INT;else if(si(a,Z("LENGTH"))||si(a,Z("SIZE"))||si(a,Z("POS"))||si(a,Z("COUNT"))||si(a,Z("ADDRESS"))||si(a,Z("STORAGE_SIZE"))||si(a,Z("POSITION"))||si(a,Z("FIRST_BIT"))||si(a,Z("LAST_BIT"))||si(a,Z("AFT"))||si(a,Z("FORE"))||si(a,Z("WIDTH"))||si(a,Z("DIGITS"))||si(a,Z("MANTISSA"))||si(a,Z("MACHINE_EMAX"))||si(a,Z("MACHINE_EMIN"))||si(a,Z("MACHINE_MANTISSA"))||si(a,Z("MACHINE_RADIX"))||si(a,Z("SAFE_EMAX"))||si(a,Z("EMAX")))n->ty=TY_INT;else if(si(a,Z("DELTA"))||si(a,Z("EPSILON"))||si(a,Z("SMALL"))||si(a,Z("LARGE"))||si(a,Z("SAFE_LARGE"))||si(a,Z("SAFE_SMALL")))n->ty=TY_FLT;else if(si(a,Z("CALLABLE"))||si(a,Z("TERMINATED"))||si(a,Z("CONSTRAINED"))||si(a,Z("MACHINE_OVERFLOWS"))||si(a,Z("MACHINE_ROUNDS")))n->ty=TY_BOOL;else if(si(a,Z("ACCESS")))n->ty=tyn(TY_AC,N);else if(si(a,Z("IMAGE")))n->ty=TY_STR;else if(si(a,Z("VALUE"))||si(a,Z("SUCC"))||si(a,Z("PRED"))||si(a,Z("VAL")))n->ty=pt?:TY_INT;else if(si(a,Z("RANGE")))n->ty=TY_INT;else if(si(a,Z("BASE")))n->ty=pt&&pt->bs?pt->bs:pt;else n->ty=TY_INT;if(si(a,Z("POS"))&&n->at.ar.n>0&&n->at.ar.d[0]->k==N_INT){Ty*pt2=n->at.p?tcc(n->at.p->ty):0;if(pt2&&(pt2->k==TY_I||pt2->k==TY_UI||pt2->k==TY_D)){n->k=N_INT;n->i=n->at.ar.d[0]->i;n->ty=TY_UINT;}}}break;case N_QL:{Ty*qt=rst(SM,n->ql.nm);rex(SM,n->ql.ag,qt);n->ty=qt;if(n->ql.ag->ty&&qt){icv(qt,n->ql.ag);n->ql.ag->ty=qt;}}break;case N_CL:{rex(SM,n->cl.fn,0);for(uint32_t i=0;i<n->cl.ar.n;i++)rex(SM,n->cl.ar.d[i],0);Ty*ft=n->cl.fn?n->cl.fn->ty:0;if(ft&&ft->k==TY_A){No*fn=n->cl.fn;NV ar=n->cl.ar;n->k=N_IX;n->ix.p=fn;n->ix.ix=ar;rex(SM,n,tx);break;}if(n->cl.fn->k==N_ID){Sy*s=syfa(SM,n->cl.fn->s,n->cl.ar.n,tx);if(s){if(s->ty&&s->ty->k==TY_S&&s->ty->el){n->ty=s->ty->el;n->sy=s;}else if(s->k==1){No*cv=ND(CVT,n->l);cv->cvt.ty=n->cl.fn;cv->cvt.ex=n->cl.ar.n>0?n->cl.ar.d[0]:0;n->k=N_CVT;n->cvt=cv->cvt;n->ty=s->ty?s->ty:TY_INT;}else n->ty=TY_INT;}else n->ty=TY_INT;}else n->ty=TY_INT;}break;case N_AG:for(uint32_t i=0;i<n->ag.it.n;i++)rex(SM,n->ag.it.d[i],tx);n->ty=tx?:TY_INT;icv(tx,n);break;case N_ALC:n->ty=tyn(TY_AC,N);n->ty->el=rst(SM,n->alc.st);if(n->alc.in){Ty*et=n->ty->el?tcc(n->ty->el):0;if(et&&et->k==TY_R&&et->dc.n>0){for(uint32_t i=0;i<et->dc.n;i++){No*d=et->dc.d[i];if(d->k==N_DS&&d->pm.df){rex(SM,d->pm.df,rst(SM,d->pm.ty));}}}rex(SM,n->alc.in,n->ty->el);}break;case N_RN:rex(SM,n->rn.lo,tx);rex(SM,n->rn.hi,tx);n->rn.lo=chk(SM,n->rn.lo,n->l);n->rn.hi=chk(SM,n->rn.hi,n->l);n->ty=tcc(n->rn.lo->ty);break;case N_ASC:if(n->asc.vl)rex(SM,n->asc.vl,tx);break;case N_DRF:rex(SM,n->drf.x,0);{Ty*dty=n->drf.x->ty?tcc(n->drf.x->ty):0;if(dty&&dty->k==TY_AC)n->ty=dty->el;else{if(E<99&&n->drf.x->ty)die(n->l,".all non-ac");n->ty=TY_INT;}}break;case N_CVT:rex(SM,n->cvt.ex,0);n->ty=rst(SM,n->cvt.ty);break;case N_CHK:rex(SM,n->chk.ex,tx);n->ty=n->chk.ex->ty;break;default:break;}}
static void rss(Sm*SM,No*n){if(!n)return;switch(n->k){case N_AS:rex(SM,n->as.tg,0);rex(SM,n->as.vl,n->as.tg->ty);break;case N_IF:rex(SM,n->if_.cd,TY_BOOL);if(n->if_.th.n>0&&!hrs(&n->if_.th))die(n->l,"seq needs stmt");for(uint32_t i=0;i<n->if_.th.n;i++)rss(SM,n->if_.th.d[i]);for(uint32_t i=0;i<n->if_.ei.n;i++){No*e=n->if_.ei.d[i];rex(SM,e->if_.cd,TY_BOOL);if(e->if_.th.n>0&&!hrs(&e->if_.th))die(e->l,"seq needs stmt");for(uint32_t j=0;j<e->if_.th.n;j++)rss(SM,e->if_.th.d[j]);}if(n->if_.el.n>0&&!hrs(&n->if_.el))die(n->l,"seq needs stmt");for(uint32_t i=0;i<n->if_.el.n;i++)rss(SM,n->if_.el.d[i]);break;case N_CS:rex(SM,n->cs.ex,0);for(uint32_t i=0;i<n->cs.al.n;i++){No*a=n->cs.al.d[i];for(uint32_t j=0;j<a->ch.it.n;j++)rex(SM,a->ch.it.d[j],n->cs.ex->ty);if(a->hnd.stz.n>0&&!hrs(&a->hnd.stz))die(a->l,"seq needs stmt");for(uint32_t j=0;j<a->hnd.stz.n;j++)rss(SM,a->hnd.stz.d[j]);}break;case N_LP:if(n->lp.it){if(n->lp.it->k==N_BIN&&n->lp.it->bn.op==T_IN){No*v=n->lp.it->bn.l;if(v->k==N_ID){Ty*rt=n->lp.it->bn.r->ty;Sy*lvs=syn(v->s,0,rt?:TY_INT,0);sya(SM,lvs);lvs->lv=-1;v->sy=lvs;}}rex(SM,n->lp.it,TY_BOOL);}if(n->lp.st.n>0&&!hrs(&n->lp.st))die(n->l,"seq needs stmt");for(uint32_t i=0;i<n->lp.st.n;i++)rss(SM,n->lp.st.d[i]);break;case N_BL:scp(SM);for(uint32_t i=0;i<n->bk.dc.n;i++)rdl(SM,n->bk.dc.d[i]);for(uint32_t i=0;i<n->bk.st.n;i++)rss(SM,n->bk.st.d[i]);if(n->bk.hd.n>0){for(uint32_t i=0;i<n->bk.hd.n;i++){No*h=n->bk.hd.d[i];for(uint32_t j=0;j<h->hnd.ec.n;j++){No*e=h->hnd.ec.d[j];if(e->k==N_ID&&!si(e->s,Z("others")))slv(&SM->eh,e->s);}for(uint32_t j=0;j<h->hnd.stz.n;j++)rss(SM,h->hnd.stz.d[j]);}}sco(SM);break;case N_RT:if(n->rt.vl)rex(SM,n->rt.vl,0);break;case N_EX:if(n->ex.cd)rex(SM,n->ex.cd,TY_BOOL);break;case N_RS:if(n->rs.ec&&n->rs.ec->k==N_ID)slv(&SM->eh,n->rs.ec->s);else slv(&SM->eh,Z("PROGRAM_ERROR"));if(n->rs.ec)rex(SM,n->rs.ec,0);break;case N_CLT:rex(SM,n->ct.nm,0);for(uint32_t i=0;i<n->ct.arr.n;i++)rex(SM,n->ct.arr.d[i],0);break;case N_ACC:for(uint32_t i=0;i<n->acc.pmx.n;i++){No*p=n->acc.pmx.d[i];rex(SM,p,0);}if(n->acc.stx.n>0&&!hrs(&n->acc.stx))die(n->l,"seq needs stmt");for(uint32_t i=0;i<n->acc.stx.n;i++)rss(SM,n->acc.stx.d[i]);break;case N_SA:if(n->sa.gd)rex(SM,n->sa.gd,0);for(uint32_t i=0;i<n->sa.sts.n;i++){No*s=n->sa.sts.d[i];if(s->k==N_ACC){for(uint32_t j=0;j<s->acc.pmx.n;j++)rex(SM,s->acc.pmx.d[j],0);if(s->acc.stx.n>0&&!hrs(&s->acc.stx))die(s->l,"seq needs stmt");for(uint32_t j=0;j<s->acc.stx.n;j++)rss(SM,s->acc.stx.d[j]);}else if(s->k==N_DL)rex(SM,s->ex.cd,0);}break;case N_DL:rex(SM,n->ex.cd,0);break;case N_AB:if(n->rs.ec&&n->rs.ec->k==N_ID)slv(&SM->eh,n->rs.ec->s);else slv(&SM->eh,Z("TASKING_ERROR"));if(n->rs.ec)rex(SM,n->rs.ec,0);break;case N_US:if(n->us.nm->k==N_ID){Sy*s=syf(SM,n->us.nm->s);if(s)sfu(SM,s,n->us.nm->s);}break;default:break;}}
static void rrc_(Sm*SM,RC*r){if(!r)return;switch(r->k){case 1:{Sy*ts=syf(SM,r->er.nm);if(ts&&ts->ty){Ty*t=tcc(ts->ty);for(uint32_t i=0;i<r->rr.cp.n;i++){No*e=r->rr.cp.d[i];for(uint32_t j=0;j<t->ev.n;j++){Sy*ev=t->ev.d[j];if(si(ev->nm,e->s)){ev->vl=e->i;break;}}}}}break;case 2:{Sy*s=syf(SM,r->ad.nm);if(s&&s->ty){Ty*t=tcc(s->ty);t->ad=r->ad.ad;}}break;case 3:{Sy*s=syf(SM,r->rr.nm);if(s&&s->ty){Ty*t=tcc(s->ty);uint32_t bt=0;for(uint32_t i=0;i<r->rr.cp.n;i++){No*cp=r->rr.cp.d[i];for(uint32_t j=0;j<t->cm.n;j++){No*c=t->cm.d[j];if(c->k==N_CM&&si(c->cm.nm,cp->cm.nm)){c->cm.of=cp->cm.of;c->cm.bt=cp->cm.bt;bt+=cp->cm.bt;break;}}}t->sz=(bt+7)/8;t->pk=true;}}break;case 4:{Sy*s=r->ad.nm.n>0?syf(SM,r->ad.nm):0;if(s&&s->ty){Ty*t=tcc(s->ty);t->sup|=r->ad.ad;}}break;case 5:{Sy*s=syf(SM,r->er.nm);if(s&&s->ty){Ty*t=tcc(s->ty);t->pk=true;}}break;case 6:{Sy*s=syf(SM,r->er.nm);if(s)s->inl=true;}break;case 7:{Sy*s=syf(SM,r->er.nm);if(s&&s->ty){Ty*t=tcc(s->ty);t->ctrl=true;}}break;case 8:{Sy*s=syf(SM,r->im.nm);if(s){s->ext=true;s->ext_nm=r->im.ext.n>0?r->im.ext:r->im.nm;s->ext_lang=r->im.lang;}}break;}}
static void ihop(Ty*dt,Ty*pt){if(!dt||!pt)return;for(uint32_t i=0;i<pt->ops.n;i++){No*op=pt->ops.d[i];if(op->k==N_FB||op->k==N_PB){No*nop=nd(op->k,op->l);nop->bd=op->bd;No*nsp=nd(N_FS,op->l);nsp->sp=op->bd.sp->sp;nsp->sp.nm=op->bd.sp->sp.nm;nsp->sp.pmm=op->bd.sp->sp.pmm;if(op->k==N_FB)nsp->sp.rt=op->bd.sp->sp.rt;nop->bd.sp=nsp;nop->bd.el=-1;nv(&dt->ops,nop);}}}
static int ncp_depth=0;
#define MAX_NCP_DEPTH 100
static bool mfp(No*f,S nm);
static No*ncs(No*n,NV*fp,NV*ap);

static void ncsv(NV*d,NV*s,NV*fp,NV*ap){d->n=0;d->c=0;d->d=0;for(uint32_t i=0;i<s->n;i++)nv(d,ncs(s->d[i],fp,ap));}
static No*ncs(No*n,NV*fp,NV*ap){if(!n)return 0;if(fp&&n->k==N_ID){for(uint32_t i=0;i<fp->n;i++)if(mfp(fp->d[i],n->s)){if(i<ap->n){No*a=ap->d[i];return a->k==N_ASC&&a->asc.vl?ncs(a->asc.vl,0,0):ncs(a,0,0);}return ncs(n,0,0);}}if(ncp_depth++>MAX_NCP_DEPTH){ncp_depth--;return n;}No*c=nd(n->k,n->l);*c=*n;c->sy=0;switch(n->k){case N_BIN:c->bn.l=ncs(n->bn.l,fp,ap);c->bn.r=ncs(n->bn.r,fp,ap);break;case N_UN:c->un.x=ncs(n->un.x,fp,ap);break;case N_AT:c->at.p=ncs(n->at.p,fp,ap);ncsv(&c->at.ar,&n->at.ar,fp,ap);break;case N_QL:c->ql.nm=ncs(n->ql.nm,fp,ap);c->ql.ag=ncs(n->ql.ag,fp,ap);break;case N_CL:c->cl.fn=ncs(n->cl.fn,fp,ap);ncsv(&c->cl.ar,&n->cl.ar,fp,ap);break;case N_IX:c->ix.p=ncs(n->ix.p,fp,ap);ncsv(&c->ix.ix,&n->ix.ix,fp,ap);break;case N_SL:c->sl.p=ncs(n->sl.p,fp,ap);c->sl.lo=ncs(n->sl.lo,fp,ap);c->sl.hi=ncs(n->sl.hi,fp,ap);break;case N_SEL:c->se.p=ncs(n->se.p,fp,ap);break;case N_ALC:c->alc.st=ncs(n->alc.st,fp,ap);c->alc.in=ncs(n->alc.in,fp,ap);break;case N_RN:c->rn.lo=ncs(n->rn.lo,fp,ap);c->rn.hi=ncs(n->rn.hi,fp,ap);break;case N_CN:c->cn.rn=ncs(n->cn.rn,fp,ap);ncsv(&c->cn.cs,&n->cn.cs,fp,ap);break;case N_CM:c->cm.ty=ncs(n->cm.ty,fp,ap);c->cm.in=ncs(n->cm.in,fp,ap);c->cm.dc=ncs(n->cm.dc,fp,ap);c->cm.dsc=ncs(n->cm.dsc,fp,ap);break;case N_VR:ncsv(&c->vr.ch,&n->vr.ch,fp,ap);ncsv(&c->vr.cmm,&n->vr.cmm,fp,ap);break;case N_VP:c->vp.ds=ncs(n->vp.ds,fp,ap);ncsv(&c->vp.vrr,&n->vp.vrr,fp,ap);break;case N_PM:c->pm.ty=ncs(n->pm.ty,fp,ap);c->pm.df=ncs(n->pm.df,fp,ap);break;case N_PS:case N_FS:case N_GSP:ncsv(&c->sp.pmm,&n->sp.pmm,fp,ap);c->sp.rt=ncs(n->sp.rt,fp,ap);break;case N_PD:case N_PB:case N_FD:case N_FB:c->bd.sp=ncs(n->bd.sp,fp,ap);ncsv(&c->bd.dc,&n->bd.dc,fp,ap);ncsv(&c->bd.st,&n->bd.st,fp,ap);ncsv(&c->bd.hdd,&n->bd.hdd,fp,ap);break;case N_PKS:ncsv(&c->ps.dc,&n->ps.dc,fp,ap);ncsv(&c->ps.pr,&n->ps.pr,fp,ap);break;case N_PKB:ncsv(&c->pb.dc,&n->pb.dc,fp,ap);ncsv(&c->pb.st,&n->pb.st,fp,ap);ncsv(&c->pb.hddd,&n->pb.hddd,fp,ap);break;case N_OD:case N_GVL:ncsv(&c->od.id,&n->od.id,fp,ap);c->od.ty=ncs(n->od.ty,fp,ap);c->od.in=ncs(n->od.in,fp,ap);break;case N_TD:case N_GTP:c->td.df=ncs(n->td.df,fp,ap);c->td.ds=ncs(n->td.ds,fp,ap);c->td.prt=ncs(n->td.prt,fp,ap);ncsv(&c->td.dsc,&n->td.dsc,fp,ap);break;case N_SD:c->sd.in=ncs(n->sd.in,fp,ap);c->sd.cn=ncs(n->sd.cn,fp,ap);c->sd.rn=ncs(n->sd.rn,fp,ap);break;case N_ED:ncsv(&c->ed.id,&n->ed.id,fp,ap);break;case N_RE:c->re.rn=ncs(n->re.rn,fp,ap);break;case N_AS:c->as.tg=ncs(n->as.tg,fp,ap);c->as.vl=ncs(n->as.vl,fp,ap);break;case N_IF:case N_EL:c->if_.cd=ncs(n->if_.cd,fp,ap);ncsv(&c->if_.th,&n->if_.th,fp,ap);ncsv(&c->if_.ei,&n->if_.ei,fp,ap);ncsv(&c->if_.el,&n->if_.el,fp,ap);break;case N_CS:c->cs.ex=ncs(n->cs.ex,fp,ap);ncsv(&c->cs.al,&n->cs.al,fp,ap);break;case N_LP:c->lp.it=ncs(n->lp.it,fp,ap);ncsv(&c->lp.st,&n->lp.st,fp,ap);ncsv(&c->lp.lk,&n->lp.lk,fp,ap);break;case N_BL:ncsv(&c->bk.dc,&n->bk.dc,fp,ap);ncsv(&c->bk.st,&n->bk.st,fp,ap);ncsv(&c->bk.hd,&n->bk.hd,fp,ap);break;case N_EX:c->ex.cd=ncs(n->ex.cd,fp,ap);break;case N_RT:c->rt.vl=ncs(n->rt.vl,fp,ap);break;case N_RS:c->rs.ec=ncs(n->rs.ec,fp,ap);break;case N_CLT:c->ct.nm=ncs(n->ct.nm,fp,ap);ncsv(&c->ct.arr,&n->ct.arr,fp,ap);break;case N_ACC:ncsv(&c->acc.ixx,&n->acc.ixx,fp,ap);ncsv(&c->acc.pmx,&n->acc.pmx,fp,ap);ncsv(&c->acc.stx,&n->acc.stx,fp,ap);ncsv(&c->acc.hdx,&n->acc.hdx,fp,ap);c->acc.gd=ncs(n->acc.gd,fp,ap);break;case N_SLS:ncsv(&c->ss.al,&n->ss.al,fp,ap);ncsv(&c->ss.el,&n->ss.el,fp,ap);break;case N_SA:c->sa.gd=ncs(n->sa.gd,fp,ap);ncsv(&c->sa.sts,&n->sa.sts,fp,ap);break;case N_TKS:ncsv(&c->ts.en,&n->ts.en,fp,ap);break;case N_TKB:ncsv(&c->tb.dc,&n->tb.dc,fp,ap);ncsv(&c->tb.st,&n->tb.st,fp,ap);ncsv(&c->tb.hdz,&n->tb.hdz,fp,ap);break;case N_ENT:ncsv(&c->ent.ixy,&n->ent.ixy,fp,ap);ncsv(&c->ent.pmy,&n->ent.pmy,fp,ap);c->ent.gd=ncs(n->ent.gd,fp,ap);break;case N_HD:case N_WH:ncsv(&c->hnd.ec,&n->hnd.ec,fp,ap);ncsv(&c->hnd.stz,&n->hnd.stz,fp,ap);break;case N_CH:ncsv(&c->ch.it,&n->ch.it,fp,ap);break;case N_ASC:ncsv(&c->asc.ch,&n->asc.ch,fp,ap);c->asc.vl=ncs(n->asc.vl,fp,ap);break;case N_CX:ncsv(&c->cx.wt,&n->cx.wt,fp,ap);ncsv(&c->cx.us,&n->cx.us,fp,ap);break;case N_US:c->us.nm=ncs(n->us.nm,fp,ap);break;case N_PG:ncsv(&c->pg.ar,&n->pg.ar,fp,ap);break;case N_CU:c->cu.cx=ncs(n->cu.cx,fp,ap);ncsv(&c->cu.un,&n->cu.un,fp,ap);break;case N_DRF:c->drf.x=ncs(n->drf.x,fp,ap);break;case N_CVT:c->cvt.ty=ncs(n->cvt.ty,fp,ap);c->cvt.ex=ncs(n->cvt.ex,fp,ap);break;case N_CHK:c->chk.ex=ncs(n->chk.ex,fp,ap);break;case N_DRV:c->drv.bs=ncs(n->drv.bs,fp,ap);ncsv(&c->drv.ops,&n->drv.ops,fp,ap);break;case N_GEN:ncsv(&c->gen.fp,&n->gen.fp,fp,ap);ncsv(&c->gen.dc,&n->gen.dc,fp,ap);c->gen.un=ncs(n->gen.un,fp,ap);break;case N_GINST:ncsv(&c->gi.ap,&n->gi.ap,fp,ap);break;case N_AG:ncsv(&c->ag.it,&n->ag.it,fp,ap);c->ag.lo=ncs(n->ag.lo,fp,ap);c->ag.hi=ncs(n->ag.hi,fp,ap);break;case N_TA:case N_TI:case N_TE:case N_TF:case N_TX:case N_TR:case N_TAC:case N_TP:case N_ST:case N_LST:ncsv(&c->lst.it,&n->lst.it,fp,ap);break;default:break;}ncp_depth--;return c;}
static bool mfp(No*f,S nm){if(f->k==N_GTP)return si(f->td.nm,nm);if(f->k==N_GSP)return si(f->sp.nm,nm);if(f->k==N_GVL)for(uint32_t j=0;j<f->od.id.n;j++)if(si(f->od.id.d[j]->s,nm))return 1;return 0;}
static No*gcl(Sm*SM,No*n){if(!n)return 0;if(n->k==N_GEN){S nm=n->gen.un?(n->gen.un->k==N_PKS?n->gen.un->ps.nm:n->gen.un->bd.sp?n->gen.un->bd.sp->sp.nm:N):N;GT*g=gfnd(SM,nm);if(!g){g=gt(nm);g->fp=n->gen.fp;g->dc=n->gen.dc;g->un=n->gen.un;gv(&SM->gt,g);if(g->nm.s&&g->nm.n){Sy*gs=syn(g->nm,11,0,n);gs->gt=g;if(g->un&&g->un->k==N_PKS)gs->df=g->un;sya(SM,gs);}}}else if(n->k==N_GINST){GT*g=gfnd(SM,n->gi.gn);if(g){No*inst=ncs(g->un,&g->fp,&n->gi.ap);if(inst->k==N_PB||inst->k==N_FB||inst->k==N_PD||inst->k==N_FD){inst->bd.sp->sp.nm=n->gi.nm;}else if(inst->k==N_PKS){inst->ps.nm=n->gi.nm;}return inst;}}return 0;}
static void rdl(Sm*SM,No*n){if(!n)return;switch(n->k){case N_GINST:{No*inst=gcl(SM,n);if(inst){rdl(SM,inst);if(inst->k==N_PKS){GT*g=gfnd(SM,n->gi.gn);if(g&&g->bd){No*bd=ncs(g->bd,&g->fp,&n->gi.ap);if(bd){bd->pb.nm=n->gi.nm;rdl(SM,bd);nv(&SM->ib,bd);}}}}}break;case N_RRC:{RC*r=*(RC**)&n->ag.it.d;rrc_(SM,r);}break;case N_GVL:case N_OD:{Ty*t=rst(SM,n->od.ty);for(uint32_t i=0;i<n->od.id.n;i++){No*id=n->od.id.d[i];Sy*x=syf(SM,id->s);Sy*s=0;if(x&&x->sc==SM->sc&&x->ss==SM->ss&&x->k!=11){if(x->k==2&&x->df&&x->df->k==N_OD&&!((No*)x->df)->od.in&&n->od.co&&n->od.in){s=x;}else if(E<99)die(n->l,"dup '%.*s'",(int)id->s.n,id->s.s);}if(!s){s=sya(SM,syn(id->s,n->od.co?2:0,t,n));s->pr=SM->pk?SM->pk->sy:0;}id->sy=s;if(n->od.in){rex(SM,n->od.in,t);s->df=n->od.in;if(n->od.co&&n->od.in->k==N_INT)s->vl=n->od.in->i;else if(n->od.co&&n->od.in->k==N_ID&&n->od.in->sy&&n->od.in->sy->k==2)s->vl=n->od.in->sy->vl;else if(n->od.co&&n->od.in->k==N_AT){Ty*pt=n->od.in->at.p?tcc(n->od.in->at.p->ty):0;S a=n->od.in->at.at;if(pt&&si(a,Z("FIRST")))s->vl=pt->lo;else if(pt&&si(a,Z("LAST")))s->vl=pt->hi;}else if(n->od.co&&n->od.in->k==N_QL&&n->od.in->ql.ag){No*ag=n->od.in->ql.ag;if(ag->k==N_ID&&ag->sy&&ag->sy->k==2)s->vl=ag->sy->vl;else if(ag->k==N_INT)s->vl=ag->i;}}}}break;case N_GTP:case N_TD:{uint32_t of=0;Ty*t=0;if(n->td.drv&&n->td.prt){Ty*pt=rst(SM,n->td.prt);if(n->td.prt->k==N_TAC&&E<99)die(n->l,"der acc ty");t=tyn(TY_D,n->td.nm);t->prt=pt;if(pt){t->lo=pt->lo;t->hi=pt->hi;t->el=pt->el;t->dc=pt->dc;t->sz=pt->sz;t->al=pt->al;t->ev=pt->ev;ihop(t,pt);}if(n->td.df&&n->td.df->k==N_RN){rex(SM,n->td.df->rn.lo,0);rex(SM,n->td.df->rn.hi,0);t->lo=n->td.df->rn.lo->i;t->hi=n->td.df->rn.hi->i;}}else{Sy*px=syf(SM,n->td.nm);if(px&&px->k==1&&px->ty&&px->ty->k==TY_I&&n->td.df){t=px->ty;}else if(n->td.df){t=rst(SM,n->td.df);}else{t=tyn(TY_I,n->td.nm);if(t&&n->td.nm.s){Sy*s=sya(SM,syn(n->td.nm,1,t,n));n->sy=s;}break;}}if(t&&n->td.nm.s&&n->td.nm.n>0&&!t->nm.s)t->nm=n->td.nm;if(n->td.dsc.n>0){for(uint32_t i=0;i<n->td.dsc.n;i++){No*d=n->td.dsc.d[i];if(d->k==N_DS){Sy*ds=sya(SM,syn(d->pm.nm,8,rst(SM,d->pm.ty),d));if(d->pm.df)rex(SM,d->pm.df,ds->ty);}}t->dc=n->td.dsc;}if(n->td.nm.s&&n->td.nm.n>0){Sy*px2=syf(SM,n->td.nm);if(px2&&px2->k==1&&px2->ty==t){n->sy=px2;if(n->td.df)px2->df=n;}else{Sy*s=sya(SM,syn(n->td.nm,1,t,n));n->sy=s;}}if(n->td.df&&n->td.df->k==N_TE){t->k=TY_E;int vl=0;for(uint32_t i=0;i<n->td.df->lst.it.n;i++){No*it=n->td.df->lst.it.d[i];Sy*es=sya(SM,syn(it->k==N_CHAR?(S){(const char*)&it->i,1}:it->s,2,t,n));es->vl=vl++;sv(&t->ev,es);}t->lo=0;t->hi=vl-1;}if(n->td.df&&n->td.df->k==N_TR){t->k=TY_R;of=0;for(uint32_t i=0;i<n->td.df->lst.it.n;i++){No*c=n->td.df->lst.it.d[i];if(c->k==N_CM){c->cm.of=of++;Ty*ct=rst(SM,c->cm.ty);if(ct)c->cm.ty->ty=ct;if(c->cm.dc){for(uint32_t j=0;j<c->cm.dc->lst.it.n;j++){No*dc=c->cm.dc->lst.it.d[j];if(dc->k==N_DS&&dc->pm.df)rex(SM,dc->pm.df,rst(SM,dc->pm.ty));}}if(c->cm.dsc){for(uint32_t j=0;j<c->cm.dsc->lst.it.n;j++){No*dc=c->cm.dsc->lst.it.d[j];if(dc->k==N_DS){Sy*ds=sya(SM,syn(dc->pm.nm,8,rst(SM,dc->pm.ty),dc));if(dc->pm.df)rex(SM,dc->pm.df,ds->ty);}}c->cm.dc=c->cm.dsc;}}else if(c->k==N_VP){for(uint32_t j=0;j<c->vp.vrr.n;j++){No*v=c->vp.vrr.d[j];for(uint32_t k=0;k<v->vr.cmm.n;k++){No*vc=v->vr.cmm.d[k];vc->cm.of=of++;Ty*vct=rst(SM,vc->cm.ty);if(vct)vc->cm.ty->ty=vct;if(vc->cm.dc){for(uint32_t m=0;m<vc->cm.dc->lst.it.n;m++){No*dc=vc->cm.dc->lst.it.d[m];if(dc->k==N_DS&&dc->pm.df)rex(SM,dc->pm.df,rst(SM,dc->pm.ty));}}if(vc->cm.dsc){for(uint32_t m=0;m<vc->cm.dsc->lst.it.n;m++){No*dc=vc->cm.dsc->lst.it.d[m];if(dc->k==N_DS){Sy*ds=sya(SM,syn(dc->pm.nm,8,rst(SM,dc->pm.ty),dc));if(dc->pm.df)rex(SM,dc->pm.df,ds->ty);}}vc->cm.dc=vc->cm.dsc;}}}}}}t->cm=n->td.df->lst.it;t->sz=of*8;}break;case N_SD:{Ty*b=rst(SM,n->sd.in);Ty*t=tyn(b?b->k:TY_I,n->sd.nm);if(b){t->bs=b;t->el=b->el;t->cm=b->cm;t->dc=b->dc;t->sz=b->sz;t->al=b->al;t->ad=b->ad;t->pk=b->pk;t->lo=b->lo;t->hi=b->hi;t->prt=b->prt?b->prt:b;}if(n->sd.rn){rex(SM,n->sd.rn->rn.lo,0);rex(SM,n->sd.rn->rn.hi,0);No*lo=n->sd.rn->rn.lo;No*hi=n->sd.rn->rn.hi;int64_t lov=lo->k==N_UN&&lo->un.op==T_MN&&lo->un.x->k==N_INT?-lo->un.x->i:lo->k==N_ID&&lo->sy&&lo->sy->k==2?lo->sy->vl:lo->i;int64_t hiv=hi->k==N_UN&&hi->un.op==T_MN&&hi->un.x->k==N_INT?-hi->un.x->i:hi->k==N_ID&&hi->sy&&hi->sy->k==2?hi->sy->vl:hi->i;t->lo=lov;t->hi=hiv;}sya(SM,syn(n->sd.nm,1,t,n));}break;case N_ED:for(uint32_t i=0;i<n->ed.id.n;i++){No*id=n->ed.id.d[i];id->sy=sya(SM,syn(id->s,3,0,n));}break;case N_GSP:{Ty*ft=tyn(TY_S,n->sp.nm);if(n->sp.rt){Ty*rt=rst(SM,n->sp.rt);ft->el=rt;Sy*s=sya(SM,syn(n->sp.nm,5,ft,n));nv(&s->ol,n);n->sy=s;s->pr=SM->pk?SM->pk->sy:0;nv(&ft->ops,n);}else{Sy*s=sya(SM,syn(n->sp.nm,4,ft,n));nv(&s->ol,n);n->sy=s;s->pr=SM->pk?SM->pk->sy:0;nv(&ft->ops,n);}}break;case N_PD:case N_PB:{No*sp=n->bd.sp;Ty*ft=tyn(TY_S,sp->sp.nm);Sy*s=sya(SM,syn(sp->sp.nm,4,ft,n));nv(&s->ol,n);n->sy=s;n->bd.el=s->el;s->pr=SM->pk?SM->pk->sy:0;nv(&ft->ops,n);if(n->k==N_PB){SM->lv++;scp(SM);n->bd.pr=s;GT*gt=gfnd(SM,sp->sp.nm);if(gt)for(uint32_t i=0;i<gt->fp.n;i++)rdl(SM,gt->fp.d[i]);for(uint32_t i=0;i<sp->sp.pmm.n;i++){No*p=sp->sp.pmm.d[i];Ty*pt=rst(SM,p->pm.ty);Sy*ps=sya(SM,syn(p->pm.nm,0,pt,p));p->sy=ps;}for(uint32_t i=0;i<n->bd.dc.n;i++)rdl(SM,n->bd.dc.d[i]);for(uint32_t i=0;i<n->bd.st.n;i++)rss(SM,n->bd.st.d[i]);sco(SM);SM->lv--;}}break;case N_FB:{No*sp=n->bd.sp;Ty*rt=rst(SM,sp->sp.rt);Ty*ft=tyn(TY_S,sp->sp.nm);ft->el=rt;Sy*s=sya(SM,syn(sp->sp.nm,5,ft,n));nv(&s->ol,n);n->sy=s;n->bd.el=s->el;s->pr=SM->pk?SM->pk->sy:0;nv(&ft->ops,n);if(n->k==N_FB){SM->lv++;scp(SM);n->bd.pr=s;GT*gt=gfnd(SM,sp->sp.nm);if(gt)for(uint32_t i=0;i<gt->fp.n;i++)rdl(SM,gt->fp.d[i]);for(uint32_t i=0;i<sp->sp.pmm.n;i++){No*p=sp->sp.pmm.d[i];Ty*pt=rst(SM,p->pm.ty);Sy*ps=sya(SM,syn(p->pm.nm,0,pt,p));p->sy=ps;}for(uint32_t i=0;i<n->bd.dc.n;i++)rdl(SM,n->bd.dc.d[i]);for(uint32_t i=0;i<n->bd.st.n;i++)rss(SM,n->bd.st.d[i]);sco(SM);SM->lv--;}}break;case N_FD:{No*sp=n->bd.sp;Ty*rt=rst(SM,sp->sp.rt);Ty*ft=tyn(TY_S,sp->sp.nm);ft->el=rt;Sy*s=sya(SM,syn(sp->sp.nm,5,ft,n));nv(&s->ol,n);n->sy=s;n->bd.el=s->el;s->pr=SM->pk?SM->pk->sy:0;nv(&ft->ops,n);}break;case N_PKS:{Ty*t=tyn(TY_P,n->ps.nm);Sy*s=sya(SM,syn(n->ps.nm,6,t,n));n->sy=s;n->ps.el=s->el;SM->pk=n;scp(SM);for(uint32_t i=0;i<n->ps.dc.n;i++)rdl(SM,n->ps.dc.d[i]);for(uint32_t i=0;i<n->ps.pr.n;i++)rdl(SM,n->ps.pr.d[i]);sco(SM);SM->pk=0;}break;case N_PKB:{Sy*ps=syf(SM,n->pb.nm);GT*gt=0;if(ps&&ps->k==11){gt=ps->gt?ps->gt:gfnd(SM,n->pb.nm);}if(gt){gt->bd=n;break;}scp(SM);if(ps){sv(&SM->uv,ps);n->pb.el=ps->el;SM->pk=ps->df;if(ps->df&&ps->df->k==N_PKS){No*pk=ps->df;for(uint32_t i=0;i<pk->ps.dc.n;i++){No*d=pk->ps.dc.d[i];if(d->sy)sv(&SM->uv,d->sy);else if(d->k==N_ED){for(uint32_t j=0;j<d->ed.id.n;j++){No*eid=d->ed.id.d[j];if(eid->sy)sv(&SM->uv,eid->sy);}}else if(d->k==N_OD){for(uint32_t j=0;j<d->od.id.n;j++){No*oid=d->od.id.d[j];if(oid->sy)sv(&SM->uv,oid->sy);}}}}}for(uint32_t i=0;i<n->pb.dc.n;i++)rdl(SM,n->pb.dc.d[i]);for(uint32_t i=0;i<n->pb.st.n;i++)rss(SM,n->pb.st.d[i]);sco(SM);SM->pk=0;}break;case N_TKS:{Ty*t=tyn(TY_T,n->ts.nm);t->cm=n->ts.en;sya(SM,syn(n->ts.nm,7,t,n));}break;case N_TKB:{scp(SM);for(uint32_t i=0;i<n->tb.dc.n;i++)rdl(SM,n->tb.dc.d[i]);for(uint32_t i=0;i<n->tb.st.n;i++)rss(SM,n->tb.st.d[i]);sco(SM);}break;case N_GEN:gcl(SM,n);break;case N_US:rss(SM,n);break;default:break;}}static int elc(Sm*SM,SV*ev,No*n){if(!n)return 0;int mx=0;switch(n->k){case N_PKS:case N_PKB:case N_PD:case N_PB:case N_FD:case N_FB:{Sy*s=n->sy;if(s&&s->el<0)s->el=SM->eo;if(s){sv(ev,s);if(s->el>mx)mx=s->el;}}break;case N_OD:for(uint32_t i=0;i<n->od.id.n;i++){No*id=n->od.id.d[i];if(id->sy){sv(ev,id->sy);if(id->sy->el>mx)mx=id->sy->el;}}break;default:break;}return mx;}
static char*rdf(const char*p){FILE*f=fopen(p,"rb");if(!f)return 0;fseek(f,0,2);long z=ftell(f);fseek(f,0,0);char*b=malloc(z+1);fread(b,1,z,f);b[z]=0;fclose(f);return b;}
static void rali(Sm*SM,const char*pth){char a[512];snprintf(a,512,"%s.ali",pth);char*ali=rdf(a);if(!ali)return;L ll={0,0,pth};SLV ws={0},ds={0};for(char*l=ali;*l;){if(*l=='W'&&l[1]==' '){char*e=l+2;while(*e&&*e!=' '&&*e!='\n')e++;S wn={l+2,e-(l+2)};char*c=al(wn.n+1);memcpy(c,wn.s,wn.n);c[wn.n]=0;slv(&ws,(S){c,wn.n});}else if(*l=='D'&&l[1]==' '){char*e=l+2;while(*e&&*e!=' '&&*e!='\n')e++;S dn={l+2,e-(l+2)};char*c=al(dn.n+1);memcpy(c,dn.s,dn.n);c[dn.n]=0;slv(&ds,(S){c,dn.n});}else if(*l=='X'&&l[1]==' '){char*e=l+2;while(*e&&*e!=' '&&*e!='\n')e++;S sn={l+2,e-(l+2)};bool isp=0;int pc=0;char mn[256],*m=mn;for(uint32_t i=0;i<sn.n&&i<250;)*m++=sn.s[i++];for(char*t=e;*t&&*t!='\n';){while(*t==' ')t++;if(*t=='\n')break;char*te=t;while(*te&&*te!=' '&&*te!='\n')te++;S tn={t,te-t};if(si(tn,Z("void")))isp=1;else if(si(tn,Z("i64"))||si(tn,Z("double"))||si(tn,Z("ptr"))){if(pc++)(*m++='_',*m++='_');const char*tx=si(tn,Z("i64"))?"I64":si(tn,Z("double"))?"F64":"PTR";while(*tx)*m++=*tx++;}t=te;}*m=0;S msn={mn,m-mn};if(pc==1){Ty*vt=0;if(strstr(mn,"I64"))vt=TY_INT;else if(strstr(mn,"F64"))vt=TY_FLT;else if(strstr(mn,"PTR"))vt=TY_STR;else vt=TY_INT;No*n=nd(N_OD,ll);Sy*s=sya(SM,syn(sn,0,vt,n));s->ext=1;s->lv=0;s->ext_nm=msn;n->sy=s;}else{No*n=nd(isp?N_PD:N_FD,ll),*sp=nd(N_FS,ll);sp->sp.nm=msn;for(int i=1;i<pc;i++){No*p=nd(N_PM,ll);p->pm.nm=Z("p");nv(&sp->sp.pmm,p);}sp->sp.rt=0;n->bd.sp=sp;Sy*s=sya(SM,syn(msn,isp?4:5,tyn(TY_S,msn),n));s->el=SM->eo++;nv(&s->ol,n);n->sy=s;}}while(*l&&*l!='\n')l++;if(*l)l++;}free(ali);}
static const char*lkp(Sm*SM,S nm){static const char*pd[]={"acats/","rts/",0};char pf[256],af[512];for(const char**d=pd;*d;d++){int n=snprintf(pf,256,"%s%.*s",*d,(int)nm.n,nm.s);for(char*p=pf+strlen(*d);*p;p++)*p=tolower(*p);rali(SM,pf);snprintf(af,512,"%s.ads",pf);const char*s=rdf(af);if(s)return s;}return 0;}
static void pks(Sm*SM,S nm,const char*src){if(!src)return;char af[512];snprintf(af,512,"%.*s.ads",(int)nm.n,nm.s);Ps p=pnw(src,strlen(src),af);No*cu=pcu(&p);for(uint32_t i=0;cu&&i<cu->cu.un.n;i++)if(cu->cu.un.d[i]->k==N_PKS)rdl(SM,cu->cu.un.d[i]);}
static void smu(Sm*SM,No*n){if(n->k!=N_CU)return;for(uint32_t i=0;i<n->cu.un.n;i++)if(n->cu.un.d[i]&&n->cu.un.d[i]->k==N_PKB){const char*s=lkp(SM,n->cu.un.d[i]->pb.nm);if(s)pks(SM,n->cu.un.d[i]->pb.nm,s);else{L ll={0,0,"<pkg>"};No*d=nd(N_PKS,ll);d->ps.nm=n->cu.un.d[i]->pb.nm;Sy*ps=sya(SM,syn(d->ps.nm,6,tyn(TY_P,d->ps.nm),d));ps->el=SM->eo++;d->sy=ps;ps->df=d;}}for(uint32_t i=0;i<n->cu.cx->cx.wt.n;i++)pks(SM,n->cu.cx->cx.wt.d[i]->wt.nm,lkp(SM,n->cu.cx->cx.wt.d[i]->wt.nm));for(uint32_t i=0;i<n->cu.cx->cx.us.n;i++){No*u=n->cu.cx->cx.us.d[i];if(u&&u->k==N_US&&u->us.nm&&u->us.nm->k==N_ID){Sy*ps=syf(SM,u->us.nm->s);if(ps&&ps->k==6&&ps->df&&ps->df->k==N_PKS){No*pk=ps->df;for(uint32_t j=0;j<pk->ps.dc.n;j++){No*d=pk->ps.dc.d[j];if(d->k==N_ED)for(uint32_t k=0;k<d->ed.id.n;k++)if(d->ed.id.d[k]->sy){d->ed.id.d[k]->sy->vis|=2;sv(&SM->uv,d->ed.id.d[k]->sy);}else if(d->k==N_OD)for(uint32_t k=0;k<d->od.id.n;k++)if(d->od.id.d[k]->sy){d->od.id.d[k]->sy->vis|=2;sv(&SM->uv,d->od.id.d[k]->sy);}else if(d->sy){d->sy->vis|=2;sv(&SM->uv,d->sy);}}}}}for(uint32_t i=0;i<n->cu.un.n;i++){SV eo={0};int mx=0;if(n->cu.un.d[i]->k==N_PKS)for(uint32_t j=0;j<n->cu.un.d[i]->ps.dc.n;j++){int e=elc(SM,&eo,n->cu.un.d[i]->ps.dc.d[j]);mx=e>mx?e:mx;}else if(n->cu.un.d[i]->k==N_PKB)for(uint32_t j=0;j<n->cu.un.d[i]->pb.dc.n;j++){int e=elc(SM,&eo,n->cu.un.d[i]->pb.dc.d[j]);mx=e>mx?e:mx;}for(uint32_t j=0;j<eo.n;j++)if(eo.d[j]->k==6&&eo.d[j]->df&&eo.d[j]->df->k==N_PKS)for(uint32_t k=0;k<((No*)eo.d[j]->df)->ps.dc.n;k++)rdl(SM,((No*)eo.d[j]->df)->ps.dc.d[k]);rdl(SM,n->cu.un.d[i]);}}
typedef enum{VK_I=0,VK_F=1,VK_P=2}Vk;typedef struct{int id;Vk k;}V;typedef struct TH TH;typedef struct TK TK;typedef struct PT PT;struct TH{S ec;jmp_buf jb;TH*nx;};struct TK{pthread_t th;int id;S nm;NV en;PT*pt;bool ac,tm;};struct PT{pthread_mutex_t mx;S nm;NV en;bool lk;};typedef struct{FILE*o;int tm,lb,md;Sm*sm;int ll[64];int ls;SV el;TH*eh;TK*tk[64];int tn;PT*pt[64];int pn;SLV lbs;SLV exs;SLV dcl;uint8_t lopt[64];}Gn;
static int nt(Gn*g){return g->tm++;}
static int nl(Gn*g){return g->lb++;}
static int nm(Gn*g){return++g->md;}
static void lmd(FILE*o,int id){fprintf(o,", !llvm.loop !%d",id);}
static void emd(Gn*g){for(int i=1;i<=g->md;i++){fprintf(g->o,"!%d = distinct !{!%d",i,i);if(i<64&&(g->lopt[i]&1))fprintf(g->o,", !%d",g->md+1);if(i<64&&(g->lopt[i]&2))fprintf(g->o,", !%d",g->md+2);if(i<64&&(g->lopt[i]&4))fprintf(g->o,", !%d",g->md+3);fprintf(g->o,"}\n");}if(g->md>0){fprintf(g->o,"!%d = !{!\"llvm.loop.unroll.enable\"}\n",g->md+1);fprintf(g->o,"!%d = !{!\"llvm.loop.vectorize.enable\"}\n",g->md+2);fprintf(g->o,"!%d = !{!\"llvm.loop.distribute.enable\"}\n",g->md+3);}}
static int flbl(Gn*g,S lb){for(uint32_t i=0;i<g->lbs.n;i++)if(si(g->lbs.d[i],lb))return i;return -1;}
static void eex(Gn*g,S ex){for(uint32_t i=0;i<g->exs.n;i++)if(si(g->exs.d[i],ex))return;slv(&g->exs,ex);}
static bool adcl(Gn*g,const char*fn){S fns={fn,strlen(fn)};for(uint32_t i=0;i<g->dcl.n;i++)if(si(g->dcl.d[i],fns))return false;char*cp=malloc(fns.n+1);memcpy(cp,fn,fns.n);cp[fns.n]=0;slv(&g->dcl,(S){cp,fns.n});return true;}
static const char*vt(Vk k){return k==VK_I?"i64":k==VK_F?"double":"ptr";}
static Vk tk2v(Ty*t){if(!t)return VK_I;t=tcc(t);switch(t->k){case TY_F:case TY_UF:return VK_F;case TY_FT:case TY_A:case TY_R:case TY_S:return VK_P;case TY_AC:return VK_I;default:return VK_I;}}
static int esn(char*b,int sz,Sy*s,S nm,int pc){int n=0;if(s&&s->pr&&s->pr->nm.s){for(uint32_t i=0;i<s->pr->nm.n;i++){char c=s->pr->nm.s[i];if((c>='a'&&c<='z')||(c>='A'&&c<='Z')||(c>='0'&&c<='9'))b[n++]=toupper(c);else n+=snprintf(b+n,sz-n,"_%02X",(unsigned char)c);}b[n++]='_';b[n++]='_';for(uint32_t i=0;i<nm.n;i++){char c=nm.s[i];if((c>='a'&&c<='z')||(c>='A'&&c<='Z')||(c>='0'&&c<='9'))b[n++]=toupper(c);else n+=snprintf(b+n,sz-n,"_%02X",(unsigned char)c);}n+=snprintf(b+n,sz-n,".%d",pc);b[n]=0;return n;}for(uint32_t i=0;i<nm.n;i++){char c=nm.s[i];if((c>='a'&&c<='z')||(c>='A'&&c<='Z')||(c>='0'&&c<='9')||c=='_')b[n++]=c;else n+=snprintf(b+n,sz-n,"_%02X",(unsigned char)c);}n+=snprintf(b+n,sz-n,".%d",pc);return n;}
static V gex(Gn*g,No*n);static void gss(Gn*g,No*n);static void gbf(Gn*g){
int mx=g->sm->eo;
if(mx>0)fprintf(g->o,"  %%__frame = alloca [%d x ptr]\n",mx);
}
static void gdl(Gn*g,No*n);
static inline void lbl(Gn*g,int l){fprintf(g->o,"L%d:\n",l);}
static inline void br(Gn*g,int l){fprintf(g->o,"  br label %%L%d\n",l);}
static inline void cbr(Gn*g,int c,int lt,int lf){fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",c,lt,lf);}
static V vcast(Gn*g,V v,Vk k){if(v.k==k)return v;V r={nt(g),k};if(v.k==VK_I&&k==VK_F)fprintf(g->o,"  %%t%d = sitofp i64 %%t%d to double\n",r.id,v.id);else if(v.k==VK_F&&k==VK_I)fprintf(g->o,"  %%t%d = fptosi double %%t%d to i64\n",r.id,v.id);else if(v.k==VK_P&&k==VK_I)fprintf(g->o,"  %%t%d = ptrtoint ptr %%t%d to i64\n",r.id,v.id);else if(v.k==VK_I&&k==VK_P)fprintf(g->o,"  %%t%d = inttoptr i64 %%t%d to ptr\n",r.id,v.id);else fprintf(g->o,"  %%t%d = bitcast %s %%t%d to %s\n",r.id,vt(v.k),v.id,vt(k));return r;}
static V vbool(Gn*g,V v){if(v.k!=VK_I)v=vcast(g,v,VK_I);int t=nt(g);V c={nt(g),VK_I};fprintf(g->o,"  %%t%d = icmp ne i64 %%t%d, 0\n",t,v.id);fprintf(g->o,"  %%t%d = zext i1 %%t%d to i64\n",c.id,t);return c;}
static V vcmpi(Gn*g,const char*op,V a,V b){a=vcast(g,a,VK_I);b=vcast(g,b,VK_I);int c=nt(g);V r={nt(g),VK_I};fprintf(g->o,"  %%t%d = icmp %s i64 %%t%d, %%t%d\n",c,op,a.id,b.id);fprintf(g->o,"  %%t%d = zext i1 %%t%d to i64\n",r.id,c);return r;}
static V vcmpf(Gn*g,const char*op,V a,V b){a=vcast(g,a,VK_F);b=vcast(g,b,VK_F);int c=nt(g);V r={nt(g),VK_I};fprintf(g->o,"  %%t%d = fcmp %s double %%t%d, %%t%d\n",c,op,a.id,b.id);fprintf(g->o,"  %%t%d = zext i1 %%t%d to i64\n",r.id,c);return r;}
static V vpowi(Gn*g,V a,V b){a=vcast(g,a,VK_I);b=vcast(g,b,VK_I);V r={nt(g),VK_I};fprintf(g->o,"  %%t%d = call i64 @__ada_powi(i64 %%t%d, i64 %%t%d)\n",r.id,a.id,b.id);return r;}
static V vpows(Gn*g,V a,V b){a=vcast(g,a,VK_F);b=vcast(g,b,VK_F);V r={nt(g),VK_F};fprintf(g->o,"  %%t%d = call double @pow(double %%t%d, double %%t%d)\n",r.id,a.id,b.id);return r;}
static V gag(Gn*g,No*n,Ty*ty){FILE*o=g->o;V r={nt(g),VK_P};Ty*t=ty?tcc(ty):0;if(!t||t->k!=TY_R||t->pk){int sz=n->ag.it.n?n->ag.it.n:1;int p=nt(g);fprintf(o,"  %%t%d = alloca [%d x i64]\n",p,sz);uint32_t ix=0;for(uint32_t i=0;i<n->ag.it.n;i++){No*el=n->ag.it.d[i];if(el->k==N_ASC){if(el->asc.ch.d[0]->k==N_ID&&si(el->asc.ch.d[0]->s,Z("others"))){for(;ix<(uint32_t)sz;ix++){V v=vcast(g,gex(g,el->asc.vl),VK_I);int ep=nt(g);fprintf(o,"  %%t%d = getelementptr [%d x i64], ptr %%t%d, i64 0, i64 %u\n",ep,sz,p,ix);fprintf(o,"  store i64 %%t%d, ptr %%t%d\n",v.id,ep);}}else{V v=vcast(g,gex(g,el->asc.vl),VK_I);for(uint32_t j=0;j<el->asc.ch.n;j++){No*ch=el->asc.ch.d[j];if(ch->k==N_ID&&ch->sy&&ch->sy->k==1&&ch->sy->ty){Ty*cht=tcc(ch->sy->ty);if(cht->k==TY_E){for(uint32_t ei=0;ei<cht->ev.n;ei++){V cv={nt(g),VK_I};fprintf(o,"  %%t%d = add i64 0, %ld\n",cv.id,(long)cht->ev.d[ei]->vl);int ep=nt(g);fprintf(o,"  %%t%d = getelementptr [%d x i64], ptr %%t%d, i64 0, i64 %%t%d\n",ep,sz,p,cv.id);fprintf(o,"  store i64 %%t%d, ptr %%t%d\n",v.id,ep);}}else if((cht->lo!=0||cht->hi!=0)&&cht->k==TY_I){for(int64_t ri=cht->lo;ri<=cht->hi;ri++){V cv={nt(g),VK_I};fprintf(o,"  %%t%d = add i64 0, %ld\n",cv.id,(long)ri);int ep=nt(g);fprintf(o,"  %%t%d = getelementptr [%d x i64], ptr %%t%d, i64 0, i64 %%t%d\n",ep,sz,p,cv.id);fprintf(o,"  store i64 %%t%d, ptr %%t%d\n",v.id,ep);}}}else{V ci=vcast(g,gex(g,ch),VK_I);int ep=nt(g);fprintf(o,"  %%t%d = getelementptr [%d x i64], ptr %%t%d, i64 0, i64 %%t%d\n",ep,sz,p,ci.id);fprintf(o,"  store i64 %%t%d, ptr %%t%d\n",v.id,ep);}}ix++;}}else{V v=vcast(g,gex(g,el),VK_I);int ep=nt(g);fprintf(o,"  %%t%d = getelementptr [%d x i64], ptr %%t%d, i64 0, i64 %u\n",ep,sz,p,ix);fprintf(o,"  store i64 %%t%d, ptr %%t%d\n",v.id,ep);ix++;}}fprintf(o,"  %%t%d = getelementptr [%d x i64], ptr %%t%d, i64 0, i64 0\n",r.id,sz,p);}else{uint32_t sz=t->sz/8;int p=nt(g);fprintf(o,"  %%t%d = alloca [%u x i64]\n",p,sz);uint32_t ix=0;for(uint32_t i=0;i<n->ag.it.n;i++){No*el=n->ag.it.d[i];if(el->k==N_ASC){for(uint32_t j=0;j<el->asc.ch.n;j++){No*ch=el->asc.ch.d[j];if(ch->k==N_ID){for(uint32_t k=0;k<t->cm.n;k++){No*c=t->cm.d[k];if(c->k==N_CM&&si(c->cm.nm,ch->s)){V v=vcast(g,gex(g,el->asc.vl),VK_I);int ep=nt(g);fprintf(o,"  %%t%d = getelementptr [%u x i64], ptr %%t%d, i64 0, i64 %u\n",ep,sz,p,c->cm.of);fprintf(o,"  store i64 %%t%d, ptr %%t%d\n",v.id,ep);break;}}}}ix++;}else{V v=vcast(g,gex(g,el),VK_I);int ep=nt(g);fprintf(o,"  %%t%d = getelementptr [%u x i64], ptr %%t%d, i64 0, i64 %u\n",ep,sz,p,ix);fprintf(o,"  store i64 %%t%d, ptr %%t%d\n",v.id,ep);ix++;}}fprintf(o,"  %%t%d = getelementptr [%u x i64], ptr %%t%d, i64 0, i64 0\n",r.id,sz,p);}return r;}
static No*sbody(Sy*s,int el){if(!s||s->ol.n==0)return 0;for(uint32_t i=0;i<s->ol.n;i++){No*b=s->ol.d[i];if((b->k==N_PB||b->k==N_FB)&&b->bd.el==el)return b;}return s->ol.d[0];}
static V gex(Gn*g,No*n){FILE*o=g->o;if(!n)return(V){0,VK_I};V r={nt(g),tk2v(n->ty)};switch(n->k){case N_INT:r.k=VK_I;fprintf(o,"  %%t%d = add i64 0, %lld\n",r.id,(long long)n->i);break;case N_REAL:r.k=VK_F;fprintf(o,"  %%t%d = fadd double 0.0, %e\n",r.id,n->f);break;case N_CHAR:r.k=VK_I;fprintf(o,"  %%t%d = add i64 0, %d\n",r.id,(int)n->i);break;case N_STR:r.k=VK_P;{int p=nt(g);uint32_t sz=n->s.n+1;fprintf(o,"  %%t%d = alloca [%u x i64]\n",p,sz);fprintf(o,"  store i64 %u, ptr %%t%d\n",n->s.n,p);for(uint32_t i=0;i<n->s.n;i++){int ep=nt(g);fprintf(o,"  %%t%d = getelementptr [%u x i64], ptr %%t%d, i64 0, i64 %u\n",ep,sz,p,i+1);fprintf(o,"  store i64 %d, ptr %%t%d\n",(int)(unsigned char)n->s.s[i],ep);}fprintf(o,"  %%t%d = bitcast ptr %%t%d to ptr\n",r.id,p);}break;case N_NULL:r.k=VK_P;fprintf(o,"  %%t%d = inttoptr i64 0 to ptr\n",r.id);break;case N_ID:{Sy*s=n->sy?n->sy:syf(g->sm,n->s);if(!s&&n->sy){s=n->sy;}int gen_0p_call=0;Vk fn_ret_type=r.k;if(s&&s->k==5){Sy*s0=syfa(g->sm,n->s,0,n->ty);if(s0){s=s0;gen_0p_call=1;}}if(s&&s->k==2){if(s->df&&s->df->k==N_STR){r.k=VK_P;int p=nt(g);uint32_t sz=s->df->s.n+1;fprintf(o,"  %%t%d = alloca [%u x i64]\n",p,sz);fprintf(o,"  store i64 %u, ptr %%t%d\n",s->df->s.n,p);for(uint32_t i=0;i<s->df->s.n;i++){int ep=nt(g);fprintf(o,"  %%t%d = getelementptr [%u x i64], ptr %%t%d, i64 0, i64 %u\n",ep,sz,p,i+1);fprintf(o,"  store i64 %d, ptr %%t%d\n",(int)(unsigned char)s->df->s.s[i],ep);}fprintf(o,"  %%t%d = bitcast ptr %%t%d to ptr\n",r.id,p);}else{r.k=VK_I;fprintf(o,"  %%t%d = add i64 0, %lld\n",r.id,(long long)s->vl);}}else{Vk k=VK_I;if(s&&s->ty)k=tk2v(s->ty);r.k=k;if(s&&s->lv==0){char nb[256];if(s->ext&&s->ext_nm.s){snprintf(nb,256,"%s",s->ext_nm.s);}else if(s->pr&&s->pr->nm.s){int n=0;for(uint32_t i=0;i<s->pr->nm.n;i++)nb[n++]=toupper(s->pr->nm.s[i]);nb[n++]='_';nb[n++]='_';for(uint32_t i=0;i<s->nm.n;i++)nb[n++]=toupper(s->nm.s[i]);nb[n]=0;}else snprintf(nb,256,"%.*s",(int)s->nm.n,s->nm.s);if(s->k==5){if(gen_0p_call){char fnb[256];esn(fnb,256,s,n->s,0);fprintf(o,"  %%t%d = call %s @\"%s\"()\n",r.id,vt(fn_ret_type),fnb);r.k=fn_ret_type;}else{No*b=sbody(s,s->el);No*sp=b?b->bd.sp:0;if((sp&&sp->sp.pmm.n==0)||(!b)){char fnb[256];esn(fnb,256,s,n->s,0);fprintf(o,"  %%t%d = call %s @\"%s\"()\n",r.id,vt(fn_ret_type),fnb);r.k=fn_ret_type;}else fprintf(o,"  %%t%d = load %s, ptr @%s\n",r.id,vt(k),nb);}}else fprintf(o,"  %%t%d = load %s, ptr @%s\n",r.id,vt(k),nb);}else if(s&&s->lv>=0&&s->lv<g->sm->lv){
if(s->k==5){No*b=sbody(s,s->el);No*sp=b?b->bd.sp:0;if(sp&&sp->sp.pmm.n==0){char fnb[256];esn(fnb,256,s,n->s,0);fprintf(o,"  %%t%d = call %s @\"%s\"(ptr %%__slnk)\n",r.id,vt(k),fnb);}else{int p=nt(g);fprintf(o,"  %%t%d = getelementptr ptr, ptr %%__slnk, i64 %u\n",p,s->el);int a=nt(g);fprintf(o,"  %%t%d = load ptr, ptr %%t%d\n",a,p);fprintf(o,"  %%t%d = load %s, ptr %%t%d\n",r.id,vt(k),a);}}else{
int p=nt(g);
fprintf(o,"  %%t%d = getelementptr ptr, ptr %%__slnk, i64 %u\n",p,s->el);
int a=nt(g);
fprintf(o,"  %%t%d = load ptr, ptr %%t%d\n",a,p);
fprintf(o,"  %%t%d = load %s, ptr %%t%d\n",r.id,vt(k),a);
}}else{if(s&&s->k==5){No*b=sbody(s,s->el);No*sp=b?b->bd.sp:0;if(sp&&sp->sp.pmm.n==0){char fnb[256];esn(fnb,256,s,n->s,0);if(s->lv>=g->sm->lv)fprintf(o,"  %%t%d = call %s @\"%s\"(ptr %%__frame)\n",r.id,vt(k),fnb);else fprintf(o,"  %%t%d = call %s @\"%s\"(ptr %%__slnk)\n",r.id,vt(k),fnb);}else{Ty*vat=s&&s->ty?tcc(s->ty):0;if(vat&&vat->k==TY_A){fprintf(o,"  %%t%d = bitcast ptr %%v.%s.sc%u.%u to ptr\n",r.id,LC(n->s),s?s->sc:0,s?s->el:0);}else{fprintf(o,"  %%t%d = load %s, ptr %%v.%s.sc%u.%u\n",r.id,vt(k),LC(n->s),s?s->sc:0,s?s->el:0);}}}else{Ty*vat=s&&s->ty?tcc(s->ty):0;if(vat&&vat->k==TY_A){fprintf(o,"  %%t%d = bitcast ptr %%v.%s.sc%u.%u to ptr\n",r.id,LC(n->s),s?s->sc:0,s?s->el:0);}else{fprintf(o,"  %%t%d = load %s, ptr %%v.%s.sc%u.%u\n",r.id,vt(k),LC(n->s),s?s->sc:0,s?s->el:0);}}}}}break;case N_BIN:{Tk op=n->bn.op;if(op==T_ATHN||op==T_OREL){V lv=vbool(g,gex(g,n->bn.l));int c=nt(g);fprintf(o,"  %%t%d = icmp ne i64 %%t%d, 0\n",c,lv.id);int lt=nl(g),lf=nl(g),ld=nl(g);if(op==T_ATHN)cbr(g,c,lt,lf);else cbr(g,c,lf,lt);lbl(g,lt);V rv=vbool(g,gex(g,n->bn.r));br(g,ld);lbl(g,lf);br(g,ld);lbl(g,ld);r.k=VK_I;fprintf(o,"  %%t%d = phi i64 [%s,%%L%d],[%%t%d,%%L%d]\n",r.id,op==T_ATHN?"0":"1",lf,rv.id,lt);break;}if(op==T_AND||op==T_OR||op==T_XOR){Ty*lt=n->bn.l->ty?tcc(n->bn.l->ty):0;Ty*rt=n->bn.r->ty?tcc(n->bn.r->ty):0;if(lt&&rt&&lt->k==TY_A&&rt->k==TY_A){int sz=lt->hi>=lt->lo?lt->hi-lt->lo+1:1;int p=nt(g);fprintf(o,"  %%t%d = alloca [%d x i64]\n",p,sz);V la=gex(g,n->bn.l);V ra=gex(g,n->bn.r);for(int i=0;i<sz;i++){int ep1=nt(g);fprintf(o,"  %%t%d = getelementptr i64, ptr %%t%d, i64 %d\n",ep1,la.id,i);int lv=nt(g);fprintf(o,"  %%t%d = load i64, ptr %%t%d\n",lv,ep1);int ep2=nt(g);fprintf(o,"  %%t%d = getelementptr i64, ptr %%t%d, i64 %d\n",ep2,ra.id,i);int rv=nt(g);fprintf(o,"  %%t%d = load i64, ptr %%t%d\n",rv,ep2);int res=nt(g);fprintf(o,"  %%t%d = %s i64 %%t%d, %%t%d\n",res,op==T_AND?"and":op==T_OR?"or":"xor",lv,rv);int ep3=nt(g);fprintf(o,"  %%t%d = getelementptr [%d x i64], ptr %%t%d, i64 0, i64 %d\n",ep3,sz,p,i);fprintf(o,"  store i64 %%t%d, ptr %%t%d\n",res,ep3);}r.k=VK_P;fprintf(o,"  %%t%d = getelementptr [%d x i64], ptr %%t%d, i64 0, i64 0\n",r.id,sz,p);break;}V a=vbool(g,gex(g,n->bn.l));V b=vbool(g,gex(g,n->bn.r));r.k=VK_I;if(op==T_AND)fprintf(o,"  %%t%d = and i64 %%t%d, %%t%d\n",r.id,a.id,b.id);else if(op==T_OR)fprintf(o,"  %%t%d = or i64 %%t%d, %%t%d\n",r.id,a.id,b.id);else fprintf(o,"  %%t%d = xor i64 %%t%d, %%t%d\n",r.id,a.id,b.id);break;}if(op==T_NOT){V x=vcast(g,gex(g,n->bn.l),VK_I);No*rr=n->bn.r;while(rr&&rr->k==N_CHK)rr=rr->chk.ex;if(rr&&rr->k==N_RN){V lo=vcast(g,gex(g,rr->rn.lo),VK_I),hi=vcast(g,gex(g,rr->rn.hi),VK_I);V ge=vcmpi(g,"sge",x,lo);V le=vcmpi(g,"sle",x,hi);V b1=vbool(g,ge),b2=vbool(g,le);int c1=nt(g);fprintf(o,"  %%t%d = icmp ne i64 %%t%d, 0\n",c1,b1.id);int c2=nt(g);fprintf(o,"  %%t%d = icmp ne i64 %%t%d, 0\n",c2,b2.id);int a1=nt(g);fprintf(o,"  %%t%d = and i1 %%t%d, %%t%d\n",a1,c1,c2);int xr=nt(g);fprintf(o,"  %%t%d = zext i1 %%t%d to i64\n",xr,a1);r.k=VK_I;fprintf(o,"  %%t%d = xor i64 %%t%d, 1\n",r.id,xr);}else if(rr&&rr->k==N_ID){Sy*s=rr->sy?rr->sy:syf(g->sm,rr->s);if(s&&s->ty){Ty*t=tcc(s->ty);if(t){int tlo=nt(g);fprintf(o,"  %%t%d = add i64 0, %lld\n",tlo,(long long)t->lo);int thi=nt(g);fprintf(o,"  %%t%d = add i64 0, %lld\n",thi,(long long)t->hi);V lo={tlo,VK_I},hi={thi,VK_I};V ge=vcmpi(g,"sge",x,lo);V le=vcmpi(g,"sle",x,hi);V b1=vbool(g,ge),b2=vbool(g,le);int c1=nt(g);fprintf(o,"  %%t%d = icmp ne i64 %%t%d, 0\n",c1,b1.id);int c2=nt(g);fprintf(o,"  %%t%d = icmp ne i64 %%t%d, 0\n",c2,b2.id);int a1=nt(g);fprintf(o,"  %%t%d = and i1 %%t%d, %%t%d\n",a1,c1,c2);int xr=nt(g);fprintf(o,"  %%t%d = zext i1 %%t%d to i64\n",xr,a1);r.k=VK_I;fprintf(o,"  %%t%d = xor i64 %%t%d, 1\n",r.id,xr);}else{r.k=VK_I;fprintf(o,"  %%t%d = add i64 0, 0\n",r.id);}}else{r.k=VK_I;fprintf(o,"  %%t%d = add i64 0, 0\n",r.id);}}else{r.k=VK_I;fprintf(o,"  %%t%d = add i64 0, 1\n",r.id);}break;}if(op==T_IN){V x=vcast(g,gex(g,n->bn.l),VK_I);No*rr=n->bn.r;while(rr&&rr->k==N_CHK)rr=rr->chk.ex;if(rr&&rr->k==N_RN){V lo=vcast(g,gex(g,rr->rn.lo),VK_I),hi=vcast(g,gex(g,rr->rn.hi),VK_I);V ge=vcmpi(g,"sge",x,lo);V le=vcmpi(g,"sle",x,hi);V b1=vbool(g,ge),b2=vbool(g,le);int c1=nt(g);fprintf(o,"  %%t%d = icmp ne i64 %%t%d, 0\n",c1,b1.id);int c2=nt(g);fprintf(o,"  %%t%d = icmp ne i64 %%t%d, 0\n",c2,b2.id);int a1=nt(g);fprintf(o,"  %%t%d = and i1 %%t%d, %%t%d\n",a1,c1,c2);r.k=VK_I;fprintf(o,"  %%t%d = zext i1 %%t%d to i64\n",r.id,a1);}else if(rr&&rr->k==N_ID){Sy*s=rr->sy?rr->sy:syf(g->sm,rr->s);if(s&&s->ty){Ty*t=tcc(s->ty);if(t){int tlo=nt(g);fprintf(o,"  %%t%d = add i64 0, %lld\n",tlo,(long long)t->lo);int thi=nt(g);fprintf(o,"  %%t%d = add i64 0, %lld\n",thi,(long long)t->hi);V lo={tlo,VK_I},hi={thi,VK_I};V ge=vcmpi(g,"sge",x,lo);V le=vcmpi(g,"sle",x,hi);V b1=vbool(g,ge),b2=vbool(g,le);int c1=nt(g);fprintf(o,"  %%t%d = icmp ne i64 %%t%d, 0\n",c1,b1.id);int c2=nt(g);fprintf(o,"  %%t%d = icmp ne i64 %%t%d, 0\n",c2,b2.id);int a1=nt(g);fprintf(o,"  %%t%d = and i1 %%t%d, %%t%d\n",a1,c1,c2);r.k=VK_I;fprintf(o,"  %%t%d = zext i1 %%t%d to i64\n",r.id,a1);}else{r.k=VK_I;fprintf(o,"  %%t%d = add i64 0, 0\n",r.id);}}else{r.k=VK_I;fprintf(o,"  %%t%d = add i64 0, 0\n",r.id);}}else{r.k=VK_I;fprintf(o,"  %%t%d = add i64 0, 0\n",r.id);}break;}V a=gex(g,n->bn.l),b=gex(g,n->bn.r);if(op==T_EQ||op==T_NE){Ty*lt=n->bn.l->ty?tcc(n->bn.l->ty):0;Ty*rt=n->bn.r->ty?tcc(n->bn.r->ty):0;if(lt&&rt&&lt->k==TY_A&&rt->k==TY_A){int sz=lt->hi>=lt->lo?lt->hi-lt->lo+1:1;r.k=VK_I;int res=nt(g);fprintf(o,"  %%t%d = add i64 0, 1\n",res);for(int i=0;i<sz;i++){int ep1=nt(g);fprintf(o,"  %%t%d = getelementptr i64, ptr %%t%d, i64 %d\n",ep1,a.id,i);int lv=nt(g);fprintf(o,"  %%t%d = load i64, ptr %%t%d\n",lv,ep1);int ep2=nt(g);fprintf(o,"  %%t%d = getelementptr i64, ptr %%t%d, i64 %d\n",ep2,b.id,i);int rv=nt(g);fprintf(o,"  %%t%d = load i64, ptr %%t%d\n",rv,ep2);int cmp=nt(g);fprintf(o,"  %%t%d = icmp eq i64 %%t%d, %%t%d\n",cmp,lv,rv);int ec=nt(g);fprintf(o,"  %%t%d = zext i1 %%t%d to i64\n",ec,cmp);int nres=nt(g);fprintf(o,"  %%t%d = and i64 %%t%d, %%t%d\n",nres,res,ec);res=nres;}int cmp_tmp=nt(g);fprintf(o,"  %%t%d = %s i64 %%t%d, 1\n",cmp_tmp,op==T_EQ?"icmp eq":"icmp ne",res);fprintf(o,"  %%t%d = zext i1 %%t%d to i64\n",r.id,cmp_tmp);break;}}if(op==T_EX){if(b.k==VK_F){int bc=nt(g);fprintf(o,"  %%t%d = fptosi double %%t%d to i64\n",bc,b.id);b.id=bc;b.k=VK_I;}V bi=vcast(g,b,VK_I);int cf=nt(g);fprintf(o,"  %%t%d = icmp slt i64 %%t%d, 0\n",cf,bi.id);int lt=nl(g),lf=nl(g);cbr(g,cf,lt,lf);lbl(g,lt);fprintf(o,"  call void @__ada_raise(ptr @.ex.CONSTRAINT_ERROR)\n  unreachable\nL%d:\n",lf);if(tk2v(n->ty)==VK_F){r=vpows(g,a,b);}else{r=vpowi(g,a,bi);}break;}if(op==T_PL||op==T_MN||op==T_ST||op==T_SL){if(a.k==VK_F||b.k==VK_F){a=vcast(g,a,VK_F);b=vcast(g,b,VK_F);r.k=VK_F;fprintf(o,"  %%t%d = %s double %%t%d, %%t%d\n",r.id,op==T_PL?"fadd":op==T_MN?"fsub":op==T_ST?"fmul":"fdiv",a.id,b.id);}else{a=vcast(g,a,VK_I);b=vcast(g,b,VK_I);r.k=VK_I;fprintf(o,"  %%t%d = %s i64 %%t%d, %%t%d\n",r.id,op==T_PL?"add":op==T_MN?"sub":op==T_ST?"mul":"sdiv",a.id,b.id);}break;}if(op==T_MOD||op==T_REM){a=vcast(g,a,VK_I);b=vcast(g,b,VK_I);r.k=VK_I;fprintf(o,"  %%t%d = srem i64 %%t%d, %%t%d\n",r.id,a.id,b.id);break;}if(op==T_EQ||op==T_NE||op==T_LT||op==T_LE||op==T_GT||op==T_GE){if((op==T_EQ||op==T_NE)&&(n->bn.l->k==N_STR||n->bn.r->k==N_STR||(n->bn.l->ty&&tcc(n->bn.l->ty)->el&&tcc(n->bn.l->ty)->el->k==TY_C)||(n->bn.r->ty&&tcc(n->bn.r->ty)->el&&tcc(n->bn.r->ty)->el->k==TY_C))){V ap=a,bp=b;if(ap.k==VK_I){int p1=nt(g);fprintf(o,"  %%t%d = inttoptr i64 %%t%d to ptr\n",p1,ap.id);ap.id=p1;ap.k=VK_P;}if(bp.k==VK_I){int p2=nt(g);fprintf(o,"  %%t%d = inttoptr i64 %%t%d to ptr\n",p2,bp.id);bp.id=p2;bp.k=VK_P;}int cmp=nt(g);fprintf(o,"  %%t%d = call i32 @strcmp(ptr %%t%d, ptr %%t%d)\n",cmp,ap.id,bp.id);int eq=nt(g);fprintf(o,"  %%t%d = icmp %s i32 %%t%d, 0\n",eq,op==T_EQ?"eq":"ne",cmp);r.k=VK_I;fprintf(o,"  %%t%d = zext i1 %%t%d to i64\n",r.id,eq);break;}if(a.k==VK_F||b.k==VK_F){const char*cc=op==T_EQ?"oeq":op==T_NE?"one":op==T_LT?"olt":op==T_LE?"ole":op==T_GT?"ogt":"oge";r=vcmpf(g,cc,a,b);}else{const char*cc=op==T_EQ?"eq":op==T_NE?"ne":op==T_LT?"slt":op==T_LE?"sle":op==T_GT?"sgt":"sge";r=vcmpi(g,cc,a,b);}break;}if(op==T_AM&&(a.k==VK_P||b.k==VK_P)){a=vcast(g,a,VK_P);b=vcast(g,b,VK_P);int la=nt(g),lb=nt(g);fprintf(o,"  %%t%d = call i64 @strlen(ptr %%t%d)\n",la,a.id);fprintf(o,"  %%t%d = call i64 @strlen(ptr %%t%d)\n",lb,b.id);int sz=nt(g);fprintf(o,"  %%t%d = add i64 %%t%d, %%t%d\n",sz,la,lb);int sz1=nt(g);fprintf(o,"  %%t%d = add i64 %%t%d, 1\n",sz1,sz);int np=nt(g);fprintf(o,"  %%t%d = call ptr @malloc(i64 %%t%d)\n",np,sz1);fprintf(o,"  call void @llvm.memcpy.p0.p0.i64(ptr %%t%d, ptr %%t%d, i64 %%t%d, i1 false)\n",np,a.id,la);int dp=nt(g);fprintf(o,"  %%t%d = getelementptr i8, ptr %%t%d, i64 %%t%d\n",dp,np,la);fprintf(o,"  call void @llvm.memcpy.p0.p0.i64(ptr %%t%d, ptr %%t%d, i64 %%t%d, i1 false)\n",dp,b.id,lb);int zp=nt(g);fprintf(o,"  %%t%d = getelementptr i8, ptr %%t%d, i64 %%t%d\n",zp,np,sz);fprintf(o,"  store i8 0, ptr %%t%d\n",zp);r.k=VK_P;r.id=np;break;}r.k=VK_I;{V ai=vcast(g,a,VK_I),bi=vcast(g,b,VK_I);fprintf(o,"  %%t%d = add i64 %%t%d, %%t%d\n",r.id,ai.id,bi.id);}break;}break;case N_UN:{V x=gex(g,n->un.x);if(n->un.op==T_MN){if(x.k==VK_F){r.k=VK_F;fprintf(o,"  %%t%d = fsub double 0.0, %%t%d\n",r.id,x.id);}else{x=vcast(g,x,VK_I);r.k=VK_I;fprintf(o,"  %%t%d = sub i64 0, %%t%d\n",r.id,x.id);}break;}if(n->un.op==T_NOT){V b=vbool(g,x);r.k=VK_I;fprintf(o,"  %%t%d = xor i64 %%t%d, 1\n",r.id,b.id);break;}if(n->un.op==T_ABS){if(x.k==VK_F){V z=vcast(g,x,VK_F);int c=nt(g);fprintf(o,"  %%t%d = fcmp olt double %%t%d, 0.0\n",c,z.id);V ng={nt(g),VK_F};fprintf(o,"  %%t%d = fsub double 0.0, %%t%d\n",ng.id,z.id);r.k=VK_F;fprintf(o,"  %%t%d = select i1 %%t%d, double %%t%d, double %%t%d\n",r.id,c,ng.id,z.id);}else{V z=vcast(g,x,VK_I);int c=nt(g);fprintf(o,"  %%t%d = icmp slt i64 %%t%d, 0\n",c,z.id);V ng={nt(g),VK_I};fprintf(o,"  %%t%d = sub i64 0, %%t%d\n",ng.id,z.id);r.k=VK_I;fprintf(o,"  %%t%d = select i1 %%t%d, i64 %%t%d, i64 %%t%d\n",r.id,c,ng.id,z.id);}break;}r=vcast(g,x,r.k);break;}break;case N_IX:{V p=gex(g,n->ix.p);if(p.k==VK_I){int pp=nt(g);fprintf(o,"  %%t%d = inttoptr i64 %%t%d to ptr\n",pp,p.id);p.id=pp;p.k=VK_P;}V i0=vcast(g,gex(g,n->ix.ix.d[0]),VK_I);int ep=nt(g);fprintf(o,"  %%t%d = getelementptr i64, ptr %%t%d, i64 %%t%d\n",ep,p.id,i0.id);Ty*et=n->ty?tcc(n->ty):0;if(et&&(et->k==TY_A||et->k==TY_R)){r.k=VK_P;r.id=ep;}else{r.k=VK_I;fprintf(o,"  %%t%d = load i64, ptr %%t%d\n",r.id,ep);}}break;case N_SL:{V p=gex(g,n->sl.p);V lo=vcast(g,gex(g,n->sl.lo),VK_I);V hi=vcast(g,gex(g,n->sl.hi),VK_I);int ln=nt(g);fprintf(o,"  %%t%d = sub i64 %%t%d, %%t%d\n",ln,hi.id,lo.id);int sz=nt(g);fprintf(o,"  %%t%d = add i64 %%t%d, 1\n",sz,ln);int sl=nt(g);fprintf(o,"  %%t%d = mul i64 %%t%d, 8\n",sl,sz);int ap=nt(g);fprintf(o,"  %%t%d = alloca i8, i64 %%t%d\n",ap,sl);int sp=nt(g);fprintf(o,"  %%t%d = getelementptr i64, ptr %%t%d, i64 %%t%d\n",sp,p.id,lo.id);fprintf(o,"  call void @llvm.memcpy.p0.p0.i64(ptr %%t%d, ptr %%t%d, i64 %%t%d, i1 false)\n",ap,sp,sl);r.k=VK_P;fprintf(o,"  %%t%d = bitcast ptr %%t%d to ptr\n",r.id,ap);}break;case N_SEL:{Ty*pt=n->se.p->ty?tcc(n->se.p->ty):0;V p={nt(g),VK_P};if(n->se.p->k==N_ID){Sy*s=n->se.p->sy?n->se.p->sy:syf(g->sm,n->se.p->s);if(s&&s->lv>=0&&s->lv<g->sm->lv)fprintf(o,"  %%t%d = bitcast ptr %%lnk.%d.%.*s to ptr\n",p.id,s->lv,(int)n->se.p->s.n,n->se.p->s.s);else fprintf(o,"  %%t%d = bitcast ptr %%v.%s.sc%u.%u to ptr\n",p.id,LC(n->se.p->s),s?s->sc:0,s?s->el:0);}else{p=gex(g,n->se.p);}if(pt&&pt->k==TY_R){for(uint32_t i=0;i<pt->dc.n;i++){No*d=pt->dc.d[i];S dn=d->k==N_DS?d->pm.nm:d->cm.nm;if(si(dn,n->se.se)){int ep=nt(g);fprintf(o,"  %%t%d = getelementptr i64, ptr %%t%d, i64 %u\n",ep,p.id,i);r.k=VK_I;fprintf(o,"  %%t%d = load i64, ptr %%t%d\n",r.id,ep);goto sel_done;}}if(pt->pk){for(uint32_t i=0;i<pt->cm.n;i++){No*c=pt->cm.d[i];if(c->k==N_CM&&si(c->cm.nm,n->se.se)){int bp=nt(g);fprintf(o,"  %%t%d = ptrtoint ptr %%t%d to i64\n",bp,p.id);int bo=nt(g);fprintf(o,"  %%t%d = add i64 %%t%d, %u\n",bo,bp,c->cm.of/8);int pp=nt(g);fprintf(o,"  %%t%d = inttoptr i64 %%t%d to ptr\n",pp,bo);int vp=nt(g);fprintf(o,"  %%t%d = load i64, ptr %%t%d\n",vp,pp);int sh=nt(g);fprintf(o,"  %%t%d = lshr i64 %%t%d, %u\n",sh,vp,c->cm.of%8);int ms=nt(g);uint64_t mk=(1ULL<<c->cm.bt)-1;r.k=VK_I;fprintf(o,"  %%t%d = and i64 %%t%d, %llu\n",r.id,sh,(unsigned long long)mk);break;}}}else{for(uint32_t i=0;i<pt->cm.n;i++){No*c=pt->cm.d[i];if(c->k==N_CM&&si(c->cm.nm,n->se.se)){int ep=nt(g);fprintf(o,"  %%t%d = getelementptr i64, ptr %%t%d, i64 %u\n",ep,p.id,c->cm.of);r.k=VK_I;fprintf(o,"  %%t%d = load i64, ptr %%t%d\n",r.id,ep);break;}}}for(uint32_t i=0;i<pt->cm.n;i++){No*c=pt->cm.d[i];if(c->k==N_VP){for(uint32_t j=0;j<c->vp.vrr.n;j++){No*v=c->vp.vrr.d[j];for(uint32_t k=0;k<v->vr.cmm.n;k++){No*vc=v->vr.cmm.d[k];if(si(vc->cm.nm,n->se.se)){int ep=nt(g);fprintf(o,"  %%t%d = getelementptr i64, ptr %%t%d, i64 %u\n",ep,p.id,vc->cm.of);r.k=VK_I;fprintf(o,"  %%t%d = load i64, ptr %%t%d\n",r.id,ep);goto sel_done;}}}}}sel_done:;}else if(n->sy&&n->sy->k==2){r.k=VK_I;fprintf(o,"  %%t%d = add i64 0, %lld\n",r.id,(long long)n->sy->vl);}else{r=vcast(g,p,r.k);}}break;case N_AT:{S a=n->at.at;Ty*t=n->at.p?tcc(n->at.p->ty):0;if(si(a,Z("ADDRESS"))){V p=gex(g,n->at.p);r.k=VK_I;fprintf(o,"  %%t%d = ptrtoint ptr %%t%d to i64\n",r.id,vcast(g,p,VK_P).id);}else if(si(a,Z("SIZE"))){r.k=VK_I;fprintf(o,"  %%t%d = add i64 0, %lld\n",r.id,t?(long long)(t->sz*8):64LL);}else if(si(a,Z("FIRST"))||si(a,Z("LAST"))||si(a,Z("LENGTH"))){if(n->at.ar.n>0)gex(g,n->at.ar.d[0]);int64_t lo=0,hi=-1;if(t&&t->k==TY_A){lo=t->lo;hi=t->hi;}else if(t&&(t->k==TY_I||t->k==TY_UI||t->k==TY_E||t->k==TY_D)){lo=t->lo;hi=t->hi;}int64_t v=si(a,Z("FIRST"))?lo:si(a,Z("LAST"))?hi:(hi>=lo?hi-lo+1:0);r.k=VK_I;fprintf(o,"  %%t%d = add i64 0, %lld\n",r.id,(long long)v);}else if(si(a,Z("POS"))){V x=gex(g,n->at.ar.d[0]);if(t&&(t->k==TY_E||t->k==TY_I||t->k==TY_UI||t->k==TY_D)){r=vcast(g,x,VK_I);}else{r.k=VK_I;int tlo=nt(g);fprintf(o,"  %%t%d = add i64 0, %lld\n",tlo,t?(long long)t->lo:0LL);fprintf(o,"  %%t%d = sub i64 %%t%d, %%t%d\n",r.id,vcast(g,x,VK_I).id,tlo);}}else if(si(a,Z("VAL"))){V x=gex(g,n->at.ar.d[0]);r.k=VK_I;int tlo=nt(g);fprintf(o,"  %%t%d = add i64 0, %lld\n",tlo,t?(long long)t->lo:0LL);fprintf(o,"  %%t%d = add i64 %%t%d, %%t%d\n",r.id,vcast(g,x,VK_I).id,tlo);}else if(si(a,Z("SUCC"))||si(a,Z("PRED"))){V x=gex(g,n->at.ar.d[0]);r.k=VK_I;fprintf(o,"  %%t%d = %s i64 %%t%d, 1\n",r.id,si(a,Z("SUCC"))?"add":"sub",vcast(g,x,VK_I).id);}else if(si(a,Z("IMAGE"))){V x=gex(g,n->at.ar.d[0]);r.k=VK_P;if(t&&t->k==TY_E){fprintf(o,"  %%t%d = call ptr @__ada_image_enum(i64 %%t%d, i64 %lld, i64 %lld)\n",r.id,vcast(g,x,VK_I).id,t?(long long)t->lo:0LL,t?(long long)t->hi:127LL);}else{fprintf(o,"  %%t%d = call ptr @__ada_image_int(i64 %%t%d)\n",r.id,vcast(g,x,VK_I).id);}}else if(si(a,Z("VALUE"))){V x=gex(g,n->at.ar.d[0]);r.k=VK_I;fprintf(o,"  %%t%d = call i64 @__ada_value_int(ptr %%t%d)\n",r.id,vcast(g,x,VK_P).id);}else if(si(a,Z("DIGITS"))){r.k=VK_I;fprintf(o,"  %%t%d = add i64 0, %lld\n",r.id,t?(long long)t->sm:15LL);}else if(si(a,Z("DELTA"))){r.k=VK_F;fprintf(o,"  %%t%d = fadd double 0.0, %e\n",r.id,t?1.0/pow(2.0,(double)t->sm):0.01);}else if(si(a,Z("SMALL"))||si(a,Z("LARGE"))||si(a,Z("EPSILON"))){r.k=VK_F;double v=si(a,Z("SMALL"))?pow(2.0,-126.0):si(a,Z("LARGE"))?(t&&t->sm>0?(pow(2.0,ceil((double)t->sm*log2(10.0))+1.0)-1.0)*pow(2.0,63.0):1.0e308):pow(2.0,t?-(double)t->sm:-52.0);fprintf(o,"  %%t%d = fadd double 0.0, %e\n",r.id,v);}else if(si(a,Z("MANTISSA"))||si(a,Z("MACHINE_MANTISSA"))){r.k=VK_I;fprintf(o,"  %%t%d = add i64 0, %lld\n",r.id,t?(long long)t->sm:53LL);}else if(si(a,Z("MACHINE_RADIX"))){r.k=VK_I;fprintf(o,"  %%t%d = add i64 0, 2\n",r.id);}else if(si(a,Z("EMAX"))||si(a,Z("MACHINE_EMAX"))||si(a,Z("SAFE_EMAX"))){r.k=VK_I;fprintf(o,"  %%t%d = add i64 0, 1024\n",r.id);}else if(si(a,Z("MACHINE_EMIN"))){r.k=VK_I;fprintf(o,"  %%t%d = add i64 0, -1021\n",r.id);}else if(si(a,Z("MACHINE_OVERFLOWS"))||si(a,Z("MACHINE_ROUNDS"))){r.k=VK_I;fprintf(o,"  %%t%d = add i64 0, 1\n",r.id);}else if(si(a,Z("AFT"))){r.k=VK_I;int64_t dg=1;if(t&&t->sm>0){while(pow(10.0,(double)dg)*pow(2.0,-(double)t->sm)<1.0)dg++;}fprintf(o,"  %%t%d = add i64 0, %lld\n",r.id,(long long)dg);}else if(si(a,Z("FORE"))){r.k=VK_I;int64_t fw=2;if(t&&t->hi>0){int64_t mx=t->hi;while(mx>=10){mx/=10;fw++;}}fprintf(o,"  %%t%d = add i64 0, %lld\n",r.id,(long long)fw);}else if(si(a,Z("WIDTH"))){r.k=VK_I;int64_t wd=1;if(t){if(t->k==TY_E){for(uint32_t i=0;i<t->ev.n;i++){Sy*e=t->ev.d[i];int64_t ln=e->nm.n;if(ln>wd)wd=ln;}}else{int64_t mx=t->hi>-t->lo?t->hi:-t->lo;while(mx>=10){mx/=10;wd++;}if(t->lo<0)wd++;}}fprintf(o,"  %%t%d = add i64 0, %lld\n",r.id,(long long)wd);}else if(si(a,Z("STORAGE_SIZE"))){r.k=VK_I;fprintf(o,"  %%t%d = add i64 0, %lld\n",r.id,t?(long long)(t->sz*8):0LL);}else if(si(a,Z("POSITION"))||si(a,Z("FIRST_BIT"))||si(a,Z("LAST_BIT"))){r.k=VK_I;int64_t v=0;if(n->at.p&&n->at.p->k==N_SEL){Ty*pt=n->at.p->se.p->ty?tcc(n->at.p->se.p->ty):0;if(pt&&pt->k==TY_R){for(uint32_t i=0;i<pt->cm.n;i++){No*c=pt->cm.d[i];if(c->k==N_CM&&si(c->cm.nm,n->at.p->se.se)){if(pt->pk){if(si(a,Z("POSITION")))v=c->cm.of/8;else if(si(a,Z("FIRST_BIT")))v=c->cm.of%8;else if(si(a,Z("LAST_BIT")))v=(c->cm.of%8)+c->cm.bt-1;}else{if(si(a,Z("POSITION")))v=i*8;else if(si(a,Z("FIRST_BIT")))v=0;else if(si(a,Z("LAST_BIT")))v=63;}break;}}}}fprintf(o,"  %%t%d = add i64 0, %lld\n",r.id,(long long)v);}else if(si(a,Z("CONSTRAINED"))||si(a,Z("COUNT"))||si(a,Z("CALLABLE"))||si(a,Z("TERMINATED"))){r.k=VK_I;fprintf(o,"  %%t%d = add i64 0, 0\n",r.id);}else if(si(a,Z("ACCESS"))){V p=gex(g,n->at.p);r=vcast(g,p,VK_P);}else if(si(a,Z("SAFE_LARGE"))||si(a,Z("SAFE_SMALL"))){r.k=VK_F;double v=si(a,Z("SAFE_LARGE"))?1.0e307:1.0e-307;fprintf(o,"  %%t%d = fadd double 0.0, %e\n",r.id,v);}else{r.k=VK_I;fprintf(o,"  %%t%d = add i64 0, 0\n",r.id);}break;}break;case N_QL:{V q=gex(g,n->ql.ag);r=vcast(g,q,r.k);}break;case N_CL:{if(n->cl.fn->k==N_ID){Sy*s=syfa(g->sm,n->cl.fn->s,n->cl.ar.n,n->ty);if(s){if(si(s->nm,Z("CREATE"))||si(s->nm,Z("OPEN"))){r.k=VK_P;int md=n->cl.ar.n>1?gex(g,n->cl.ar.d[1]).id:0;fprintf(o,"  %%t%d = call ptr @__text_io_%s(i64 %d, ptr %%t%d)\n",r.id,si(s->nm,Z("CREATE"))?"create":"open",md,n->cl.ar.n>2?gex(g,n->cl.ar.d[2]).id:0);break;}if(si(s->nm,Z("CLOSE"))||si(s->nm,Z("DELETE"))){if(n->cl.ar.n>0){V f=gex(g,n->cl.ar.d[0]);fprintf(o,"  call void @__text_io_%s(ptr %%t%d)\n",si(s->nm,Z("CLOSE"))?"close":"delete",f.id);}break;}if(si(s->nm,Z("GET"))||si(s->nm,Z("GET_LINE"))){if(n->cl.ar.n>1){V f=gex(g,n->cl.ar.d[0]);r.k=VK_I;fprintf(o,"  %%t%d = call i64 @__text_io_get(ptr %%t%d)\n",r.id,f.id);}else{r.k=VK_I;fprintf(o,"  %%t%d = call i64 @__text_io_get(ptr @stdin)\n",r.id);}break;}if(si(s->nm,Z("PUT"))||si(s->nm,Z("PUT_LINE"))){if(n->cl.ar.n>1){V f=gex(g,n->cl.ar.d[0]);V v=gex(g,n->cl.ar.d[1]);fprintf(o,"  call void @__text_io_%s(ptr %%t%d, ",si(s->nm,Z("PUT"))?"put":"put_line",f.id);if(v.k==VK_I)fprintf(o,"i64 %%t%d)\n",v.id);else if(v.k==VK_F)fprintf(o,"double %%t%d)\n",v.id);else fprintf(o,"ptr %%t%d)\n",v.id);}else{V v=gex(g,n->cl.ar.d[0]);fprintf(o,"  call void @__text_io_%s(ptr @stdout, ",si(s->nm,Z("PUT"))?"put":"put_line");if(v.k==VK_I)fprintf(o,"i64 %%t%d)\n",v.id);else if(v.k==VK_F)fprintf(o,"double %%t%d)\n",v.id);else fprintf(o,"ptr %%t%d)\n",v.id);}break;}if(s->ty&&s->ty->k==TY_S){Vk rk=tk2v(s->ty->el);r.k=rk;No*b=sbody(s,s->el);No*sp=b?b->bd.sp:0;int arid[64];Vk ark[64];int arp[64];for(uint32_t i=0;i<n->cl.ar.n&&i<64;i++){No*pm=sp&&i<sp->sp.pmm.n?sp->sp.pmm.d[i]:0;No*arg=n->cl.ar.d[i];V av={0,VK_I};Vk ek=VK_I;bool rf=false;if(pm){if(pm->sy&&pm->sy->ty)ek=tk2v(pm->sy->ty);else if(pm->pm.ty){Ty*pt=rst(g->sm,pm->pm.ty);ek=tk2v(pt);}if(pm->pm.md&2&&arg->k==N_ID){rf=true;Sy*as=arg->sy?arg->sy:syf(g->sm,arg->s);if(as&&as->lv==0){char nb[256];if(as->pr&&as->pr->nm.s){int n=0;for(uint32_t j=0;j<as->pr->nm.n;j++)nb[n++]=toupper(as->pr->nm.s[j]);nb[n++]='_';nb[n++]='_';for(uint32_t j=0;j<as->nm.n;j++)nb[n++]=toupper(as->nm.s[j]);nb[n]=0;}else snprintf(nb,256,"%.*s",(int)as->nm.n,as->nm.s);av.id=nt(g);av.k=VK_P;fprintf(o,"  %%t%d = bitcast ptr @%s to ptr\n",av.id,nb);}else if(as&&as->lv>=0&&as->lv<g->sm->lv){av.id=nt(g);av.k=VK_P;fprintf(o,"  %%t%d = getelementptr ptr, ptr %%__slnk, i64 %u\n",av.id,as->el);int a2=nt(g);fprintf(o,"  %%t%d = load ptr, ptr %%t%d\n",a2,av.id);av.id=a2;}else{av.id=nt(g);av.k=VK_P;fprintf(o,"  %%t%d = bitcast ptr %%v.%s.sc%u.%u to ptr\n",av.id,LC(arg->s),as?as->sc:0,as?as->el:0);}ek=VK_P;}else if(pm->pm.md&2){rf=true;av=gex(g,arg);int ap=nt(g);fprintf(o,"  %%t%d = alloca %s\n",ap,vt(av.k));fprintf(o,"  store %s %%t%d, ptr %%t%d\n",vt(av.k),av.id,ap);av.id=ap;av.k=VK_P;ek=VK_P;}else{av=gex(g,arg);}}else{av=gex(g,arg);}if(!rf){V cv=vcast(g,av,ek);av=cv;}arid[i]=av.id;ark[i]=ek;arp[i]=i<sp->sp.pmm.n&&sp->sp.pmm.d[i]->pm.md&2?1:0;}char nb[256];esn(nb,256,s,n->cl.fn->s,n->cl.ar.n);fprintf(o,"  %%t%d = call %s @\"%s\"(",r.id,vt(rk),nb);for(uint32_t i=0;i<n->cl.ar.n;i++){if(i)fprintf(o,", ");fprintf(o,"%s %%t%d",vt(ark[i]),arid[i]);}if(s->lv>0){if(n->cl.ar.n>0)fprintf(o,", ");if(s->lv>=g->sm->lv)fprintf(o,"ptr %%__frame");else fprintf(o,"ptr %%__slnk");}fprintf(o,")\n");for(uint32_t i=0;i<n->cl.ar.n&&i<64;i++){if(arp[i]){int lv=nt(g);fprintf(o,"  %%t%d = load %s, ptr %%t%d\n",lv,vt(ark[i]==VK_P?VK_I:ark[i]),arid[i]);V rv={lv,ark[i]==VK_P?VK_I:ark[i]};V cv=vcast(g,rv,tk2v(n->cl.ar.d[i]->ty));No*tg=n->cl.ar.d[i];if(tg->k==N_ID){Sy*ts=tg->sy?tg->sy:syf(g->sm,tg->s);if(ts){if(ts->lv>=0&&ts->lv<g->sm->lv)fprintf(o,"  store %s %%t%d, ptr %%lnk.%d.%s\n",vt(cv.k),cv.id,ts->lv,LC(tg->s));else fprintf(o,"  store %s %%t%d, ptr %%v.%s.sc%u.%u\n",vt(cv.k),cv.id,LC(tg->s),ts->sc,ts->el);}}}}break;}else{r.k=VK_I;fprintf(o,"  %%t%d = add i64 0, 0\n",r.id);}}else{r.k=VK_I;fprintf(o,"  %%t%d = add i64 0, 0\n",r.id);}}else{r.k=VK_I;fprintf(o,"  %%t%d = add i64 0, 0\n",r.id);}break;}break;case N_AG:return gag(g,n,n->ty);case N_ALC:{r.k=VK_P;Ty*et=n->ty&&n->ty->el?tcc(n->ty->el):0;uint32_t asz=64;if(et&&et->dc.n>0)asz+=et->dc.n*8;fprintf(o,"  %%t%d = call ptr @malloc(i64 %u)\n",r.id,asz);if(n->alc.in){V v=gex(g,n->alc.in);v=vcast(g,v,VK_I);int op=nt(g);fprintf(o,"  %%t%d = getelementptr i64, ptr %%t%d, i64 %u\n",op,r.id,et&&et->dc.n>0?(uint32_t)et->dc.n:0);fprintf(o,"  store i64 %%t%d, ptr %%t%d\n",v.id,op);}}break;case N_DRF:{V p=gex(g,n->drf.x);if(p.k==VK_I){int pp=nt(g);fprintf(o,"  %%t%d = inttoptr i64 %%t%d to ptr\n",pp,p.id);p.id=pp;p.k=VK_P;}Ty*dt=n->drf.x->ty?tcc(n->drf.x->ty):0;dt=dt&&dt->el?tcc(dt->el):0;r.k=dt?tk2v(dt):VK_I;fprintf(o,"  %%t%d = load %s, ptr %%t%d\n",r.id,vt(r.k),p.id);}break;case N_CVT:{V e=gex(g,n->cvt.ex);r=vcast(g,e,r.k);}break;case N_CHK:{V e=gex(g,n->chk.ex);Ty*t=n->chk.ex->ty?tcc(n->chk.ex->ty):0;if(t&&t->k==TY_I&&(t->lo!=TY_INT->lo||t->hi!=TY_INT->hi)){int lok=nl(g),hik=nl(g),erl=nl(g),dn=nl(g);int lc=nt(g);fprintf(o,"  %%t%d = icmp sge i64 %%t%d, %lld\n",lc,e.id,(long long)t->lo);cbr(g,lc,lok,erl);lbl(g,lok);int hc=nt(g);fprintf(o,"  %%t%d = icmp sle i64 %%t%d, %lld\n",hc,e.id,(long long)t->hi);cbr(g,hc,hik,erl);lbl(g,hik);br(g,dn);lbl(g,erl);fprintf(o,"  call void @__ada_raise(ptr @.ex.%.*s)\n",(int)n->chk.ec.n,n->chk.ec.s);fprintf(o,"  unreachable\n");lbl(g,dn);r=vcast(g,e,r.k);}else r=vcast(g,e,r.k);}break;case N_RN:{V lo=gex(g,n->rn.lo);r=vcast(g,lo,r.k);}break;default:r.k=VK_I;fprintf(o,"  %%t%d = add i64 0, 0\n",r.id);}return r;}
static void gss(Gn*g,No*n){FILE*o=g->o;if(!n)return;switch(n->k){case N_NS:fprintf(o,"  ; null\n");break;case N_AS:{V v=gex(g,n->as.vl);if(n->as.tg->k==N_ID){Sy*s=n->as.tg->sy;Vk k=s&&s->ty?tk2v(s->ty):VK_I;v=vcast(g,v,k);if(s&&s->lv==0){char nb[256];if(s->pr&&s->pr->nm.s){int n=0;for(uint32_t i=0;i<s->pr->nm.n;i++)nb[n++]=toupper(s->pr->nm.s[i]);nb[n++]='_';nb[n++]='_';for(uint32_t i=0;i<s->nm.n;i++)nb[n++]=toupper(s->nm.s[i]);nb[n]=0;}else snprintf(nb,256,"%.*s",(int)s->nm.n,s->nm.s);fprintf(o,"  store %s %%t%d, ptr @%s\n",vt(k),v.id,nb);}else if(s&&s->lv>=0&&s->lv<g->sm->lv){
int p=nt(g);
fprintf(o,"  %%t%d = getelementptr ptr, ptr %%__slnk, i64 %u\n",p,s->el);
int a=nt(g);
fprintf(o,"  %%t%d = load ptr, ptr %%t%d\n",a,p);
fprintf(o,"  store %s %%t%d, ptr %%t%d\n",vt(k),v.id,a);
}else fprintf(o,"  store %s %%t%d, ptr %%v.%s.sc%u.%u\n",vt(k),v.id,LC(n->as.tg->s),s?s->sc:0,s?s->el:0);}else if(n->as.tg->k==N_IX){V p=gex(g,n->as.tg->ix.p);if(p.k==VK_I){int pp=nt(g);fprintf(o,"  %%t%d = inttoptr i64 %%t%d to ptr\n",pp,p.id);p.id=pp;p.k=VK_P;}V i0=vcast(g,gex(g,n->as.tg->ix.ix.d[0]),VK_I);int ep=nt(g);fprintf(o,"  %%t%d = getelementptr i64, ptr %%t%d, i64 %%t%d\n",ep,p.id,i0.id);v=vcast(g,v,VK_I);fprintf(o,"  store i64 %%t%d, ptr %%t%d\n",v.id,ep);}else if(n->as.tg->k==N_SEL){Ty*pt=n->as.tg->se.p->ty?tcc(n->as.tg->se.p->ty):0;V p={nt(g),VK_P};if(n->as.tg->se.p->k==N_ID){Sy*s=n->as.tg->se.p->sy?n->as.tg->se.p->sy:syf(g->sm,n->as.tg->se.p->s);if(s&&s->lv>=0&&s->lv<g->sm->lv)fprintf(o,"  %%t%d = bitcast ptr %%lnk.%d.%.*s to ptr\n",p.id,s->lv,(int)n->as.tg->se.p->s.n,n->as.tg->se.p->s.s);else fprintf(o,"  %%t%d = bitcast ptr %%v.%s.sc%u.%u to ptr\n",p.id,LC(n->as.tg->se.p->s),s?s->sc:0,s?s->el:0);}else{p=gex(g,n->as.tg->se.p);}if(pt&&pt->k==TY_R){if(pt->pk){for(uint32_t i=0;i<pt->cm.n;i++){No*c=pt->cm.d[i];if(c->k==N_CM&&si(c->cm.nm,n->as.tg->se.se)){v=vcast(g,v,VK_I);int bp=nt(g);fprintf(o,"  %%t%d = ptrtoint ptr %%t%d to i64\n",bp,p.id);int bo=nt(g);fprintf(o,"  %%t%d = add i64 %%t%d, %u\n",bo,bp,c->cm.of/8);int pp=nt(g);fprintf(o,"  %%t%d = inttoptr i64 %%t%d to ptr\n",pp,bo);int ov=nt(g);fprintf(o,"  %%t%d = load i64, ptr %%t%d\n",ov,pp);uint64_t mk=(1ULL<<c->cm.bt)-1;int sh=nt(g);fprintf(o,"  %%t%d = shl i64 %%t%d, %u\n",sh,v.id,c->cm.of%8);int ms=nt(g);fprintf(o,"  %%t%d = and i64 %%t%d, %llu\n",ms,sh,(unsigned long long)(mk<<(c->cm.of%8)));uint64_t cmk=~(mk<<(c->cm.of%8));int cl=nt(g);fprintf(o,"  %%t%d = and i64 %%t%d, %llu\n",cl,ov,(unsigned long long)cmk);int nv_=nt(g);fprintf(o,"  %%t%d = or i64 %%t%d, %%t%d\n",nv_,cl,ms);fprintf(o,"  store i64 %%t%d, ptr %%t%d\n",nv_,pp);break;}}}else{for(uint32_t i=0;i<pt->cm.n;i++){No*c=pt->cm.d[i];if(c->k==N_CM&&si(c->cm.nm,n->as.tg->se.se)){int ep=nt(g);fprintf(o,"  %%t%d = getelementptr i64, ptr %%t%d, i64 %u\n",ep,p.id,c->cm.of);v=vcast(g,v,VK_I);fprintf(o,"  store i64 %%t%d, ptr %%t%d\n",v.id,ep);break;}}}}}else{v=vcast(g,v,VK_I);fprintf(o,"  ; store to complex lvalue\n");}}break;case N_IF:{V c=vbool(g,gex(g,n->if_.cd));int ct=nt(g);fprintf(o,"  %%t%d = icmp ne i64 %%t%d, 0\n",ct,c.id);int lt=nl(g),lf=nl(g),ld=nl(g);cbr(g,ct,lt,lf);lbl(g,lt);for(uint32_t i=0;i<n->if_.th.n;i++)gss(g,n->if_.th.d[i]);br(g,ld);lbl(g,lf);if(n->if_.ei.n>0){for(uint32_t i=0;i<n->if_.ei.n;i++){No*e=n->if_.ei.d[i];V ec=vbool(g,gex(g,e->if_.cd));int ect=nt(g);fprintf(o,"  %%t%d = icmp ne i64 %%t%d, 0\n",ect,ec.id);int let=nl(g),lef=nl(g);cbr(g,ect,let,lef);lbl(g,let);for(uint32_t j=0;j<e->if_.th.n;j++)gss(g,e->if_.th.d[j]);br(g,ld);lbl(g,lef);}}if(n->if_.el.n>0){for(uint32_t i=0;i<n->if_.el.n;i++)gss(g,n->if_.el.d[i]);}br(g,ld);lbl(g,ld);}break;case N_CS:{V ex=gex(g,n->cs.ex);int ld=nl(g);NV lb={0};for(uint32_t i=0;i<n->cs.al.n;i++){No*a=n->cs.al.d[i];int la=nl(g);nv(&lb,ND(INT,n->l));lb.d[i]->i=la;}for(uint32_t i=0;i<n->cs.al.n;i++){No*a=n->cs.al.d[i];int la=lb.d[i]->i;for(uint32_t j=0;j<a->ch.it.n;j++){No*ch=a->ch.it.d[j];if(ch->k==N_ID&&si(ch->s,Z("others"))){br(g,la);goto cs_sw_done;}Ty*cht=ch->ty?tcc(ch->ty):0;if(ch->k==N_ID&&cht&&(cht->lo!=0||cht->hi!=0)){int lo_id=nt(g);fprintf(o,"  %%t%d = add i64 0, %lld\n",lo_id,(long long)cht->lo);int hi_id=nt(g);fprintf(o,"  %%t%d = add i64 0, %lld\n",hi_id,(long long)cht->hi);int cge=nt(g);fprintf(o,"  %%t%d = icmp sge i64 %%t%d, %%t%d\n",cge,ex.id,lo_id);int cle=nt(g);fprintf(o,"  %%t%d = icmp sle i64 %%t%d, %%t%d\n",cle,ex.id,hi_id);int ca=nt(g);fprintf(o,"  %%t%d = and i1 %%t%d, %%t%d\n",ca,cge,cle);int lnx=i+1<n->cs.al.n?lb.d[i+1]->i:ld;cbr(g,ca,la,lnx);continue;}V cv=gex(g,ch);cv=vcast(g,cv,ex.k);if(ch->k==N_RN){V lo=gex(g,ch->rn.lo);lo=vcast(g,lo,ex.k);V hi=gex(g,ch->rn.hi);hi=vcast(g,hi,ex.k);int cge=nt(g);fprintf(o,"  %%t%d = icmp sge i64 %%t%d, %%t%d\n",cge,ex.id,lo.id);int cle=nt(g);fprintf(o,"  %%t%d = icmp sle i64 %%t%d, %%t%d\n",cle,ex.id,hi.id);int ca=nt(g);fprintf(o,"  %%t%d = and i1 %%t%d, %%t%d\n",ca,cge,cle);int lnx=i+1<n->cs.al.n?lb.d[i+1]->i:ld;cbr(g,ca,la,lnx);}else{int ceq=nt(g);fprintf(o,"  %%t%d = icmp eq i64 %%t%d, %%t%d\n",ceq,ex.id,cv.id);int lnx=i+1<n->cs.al.n?lb.d[i+1]->i:ld;cbr(g,ceq,la,lnx);}}}cs_sw_done:;for(uint32_t i=0;i<n->cs.al.n;i++){No*a=n->cs.al.d[i];int la=lb.d[i]->i;lbl(g,la);for(uint32_t j=0;j<a->hnd.stz.n;j++)gss(g,a->hnd.stz.d[j]);br(g,ld);}lbl(g,ld);}break;case N_LP:{int lb=nl(g),lc=nl(g),le=nl(g);if(g->ls<64)g->ll[g->ls++]=le;if(n->lp.lb.s){slv(&g->lbs,n->lp.lb);nv(&n->lp.lk,ND(INT,n->l));n->lp.lk.d[n->lp.lk.n-1]->i=le;}No*fv=0;Ty*ft=0;int hi_var=-1;if(n->lp.it&&n->lp.it->k==N_BIN&&n->lp.it->bn.op==T_IN&&n->lp.it->bn.l->k==N_ID){fv=n->lp.it->bn.l;ft=n->lp.it->bn.r->ty?tcc(n->lp.it->bn.r->ty):0;if(ft){Sy*vs=fv->sy;if(vs){fprintf(o,"  %%v.%s.sc%u.%u = alloca i64\n",LC(fv->s),vs->sc,vs->el);No*rng=n->lp.it->bn.r;hi_var=nt(g);fprintf(o,"  %%v.__for_hi_%d = alloca i64\n",hi_var);int ti=nt(g);if(rng&&rng->k==N_RN){V lo=vcast(g,gex(g,rng->rn.lo),VK_I);fprintf(o,"  %%t%d = add i64 %%t%d, 0\n",ti,lo.id);V hi=vcast(g,gex(g,rng->rn.hi),VK_I);fprintf(o,"  store i64 %%t%d, ptr %%v.__for_hi_%d\n",hi.id,hi_var);}else if(rng&&rng->k==N_AT&&si(rng->at.at,Z("RANGE"))){Ty*at=rng->at.p?tcc(rng->at.p->ty):0;if(at&&at->k==TY_A){fprintf(o,"  %%t%d = add i64 0, %lld\n",ti,(long long)at->lo);int hi_t=nt(g);fprintf(o,"  %%t%d = add i64 0, %lld\n",hi_t,(long long)at->hi);fprintf(o,"  store i64 %%t%d, ptr %%v.__for_hi_%d\n",hi_t,hi_var);}else{fprintf(o,"  %%t%d = add i64 0, %lld\n",ti,(long long)ft->lo);int hi_t=nt(g);fprintf(o,"  %%t%d = add i64 0, %lld\n",hi_t,(long long)ft->hi);fprintf(o,"  store i64 %%t%d, ptr %%v.__for_hi_%d\n",hi_t,hi_var);}}else{fprintf(o,"  %%t%d = add i64 0, %lld\n",ti,(long long)ft->lo);int hi_t=nt(g);fprintf(o,"  %%t%d = add i64 0, %lld\n",hi_t,(long long)ft->hi);fprintf(o,"  store i64 %%t%d, ptr %%v.__for_hi_%d\n",hi_t,hi_var);}if(vs->lv==0){char nb[256];if(vs->pr&&vs->pr->nm.s){int n=0;for(uint32_t i=0;i<vs->pr->nm.n;i++)nb[n++]=toupper(vs->pr->nm.s[i]);nb[n++]='_';nb[n++]='_';for(uint32_t i=0;i<vs->nm.n;i++)nb[n++]=toupper(vs->nm.s[i]);nb[n]=0;}else snprintf(nb,256,"%.*s",(int)vs->nm.n,vs->nm.s);fprintf(o,"  store i64 %%t%d, ptr @%s\n",ti,nb);}else fprintf(o,"  store i64 %%t%d, ptr %%v.%s.sc%u.%u\n",ti,LC(fv->s),vs->sc,vs->el);}}}br(g,lb);lbl(g,lb);if(n->lp.it){if(fv&&ft&&hi_var>=0){Sy*vs=fv->sy;int cv=nt(g);if(vs->lv==0){char nb[256];if(vs->pr&&vs->pr->nm.s){int n=0;for(uint32_t i=0;i<vs->pr->nm.n;i++)nb[n++]=toupper(vs->pr->nm.s[i]);nb[n++]='_';nb[n++]='_';for(uint32_t i=0;i<vs->nm.n;i++)nb[n++]=toupper(vs->nm.s[i]);nb[n]=0;}else snprintf(nb,256,"%.*s",(int)vs->nm.n,vs->nm.s);fprintf(o,"  %%t%d = load i64, ptr @%s\n",cv,nb);}else{fprintf(o,"  %%t%d = load i64, ptr %%v.%s.sc%u.%u\n",cv,LC(fv->s),vs->sc,vs->el);}int hv=nt(g);fprintf(o,"  %%t%d = load i64, ptr %%v.__for_hi_%d\n",hv,hi_var);int cmp=nt(g);fprintf(o,"  %%t%d = icmp sle i64 %%t%d, %%t%d\n",cmp,cv,hv);cbr(g,cmp,lc,le);}else{V c=vbool(g,gex(g,n->lp.it));int ct=nt(g);fprintf(o,"  %%t%d = icmp ne i64 %%t%d, 0\n",ct,c.id);cbr(g,ct,lc,le);}}else br(g,lc);lbl(g,lc);for(uint32_t i=0;i<n->lp.st.n;i++)gss(g,n->lp.st.d[i]);if(fv&&ft){Sy*vs=fv->sy;if(vs){int cv=nt(g);if(vs->lv==0){char nb[256];if(vs->pr&&vs->pr->nm.s){int n=0;for(uint32_t i=0;i<vs->pr->nm.n;i++)nb[n++]=toupper(vs->pr->nm.s[i]);nb[n++]='_';nb[n++]='_';for(uint32_t i=0;i<vs->nm.n;i++)nb[n++]=toupper(vs->nm.s[i]);nb[n]=0;}else snprintf(nb,256,"%.*s",(int)vs->nm.n,vs->nm.s);fprintf(o,"  %%t%d = load i64, ptr @%s\n",cv,nb);int nv=nt(g);fprintf(o,"  %%t%d = add i64 %%t%d, 1\n",nv,cv);fprintf(o,"  store i64 %%t%d, ptr @%s\n",nv,nb);}else{fprintf(o,"  %%t%d = load i64, ptr %%v.%s.sc%u.%u\n",cv,LC(fv->s),vs->sc,vs->el);int nv=nt(g);fprintf(o,"  %%t%d = add i64 %%t%d, 1\n",nv,cv);fprintf(o,"  store i64 %%t%d, ptr %%v.%s.sc%u.%u\n",nv,LC(fv->s),vs->sc,vs->el);}}}int lmd_id=0;if(g->ls<=64){lmd_id=nm(g);g->lopt[lmd_id]=n->lp.rv?7:0;}if(lmd_id){fprintf(o,"  br label %%L%d",lb);lmd(o,lmd_id);fprintf(o,"\n");}else br(g,lb);lbl(g,le);if(g->ls>0)g->ls--;}break;case N_EX:{if(n->ex.lb.s){int li=flbl(g,n->ex.lb);if(li>=0){int le=g->ll[li];if(n->ex.cd){V c=vbool(g,gex(g,n->ex.cd));int ct=nt(g);fprintf(o,"  %%t%d = icmp ne i64 %%t%d, 0\n",ct,c.id);int lc=nl(g);cbr(g,ct,le,lc);lbl(g,lc);}else br(g,le);}else{if(n->ex.cd){V c=vbool(g,gex(g,n->ex.cd));int ct=nt(g);fprintf(o,"  %%t%d = icmp ne i64 %%t%d, 0\n",ct,c.id);int le=g->ls>0?g->ll[g->ls-1]:nl(g),lc=nl(g);cbr(g,ct,le,lc);lbl(g,lc);}else{int le=g->ls>0?g->ll[g->ls-1]:nl(g);br(g,le);}}}else{if(n->ex.cd){V c=vbool(g,gex(g,n->ex.cd));int ct=nt(g);fprintf(o,"  %%t%d = icmp ne i64 %%t%d, 0\n",ct,c.id);int le=g->ls>0?g->ll[g->ls-1]:nl(g),lc=nl(g);cbr(g,ct,le,lc);lbl(g,lc);}else{int le=g->ls>0?g->ll[g->ls-1]:nl(g);br(g,le);}}}break;case N_GT:{int li=flbl(g,n->go.lb);if(li>=0){fprintf(o,"  br label %%lbl.%.*s\n",(int)n->go.lb.n,n->go.lb.s);}else fprintf(o,"  br label %%lbl.%.*s\n",(int)n->go.lb.n,n->go.lb.s);}break;case N_RT:{if(n->rt.vl){V v=gex(g,n->rt.vl);fprintf(o,"  ret %s %%t%d\n",vt(v.k),v.id);}else fprintf(o,"  ret void\n");}break;case N_RS:{S ec=n->rs.ec&&n->rs.ec->k==N_ID?n->rs.ec->s:Z("PROGRAM_ERROR");eex(g,ec);int exh=nt(g);fprintf(o,"  %%t%d = load ptr, ptr %%ej\n",exh);fprintf(o,"  store ptr @.ex.%.*s, ptr @__ex_cur\n",(int)ec.n,ec.s);fprintf(o,"  call void @longjmp(ptr %%t%d, i32 1)\n",exh);fprintf(o,"  unreachable\n");}break;case N_CLT:{if(n->ct.nm->k==N_ID){Sy*s=syfa(g->sm,n->ct.nm->s,n->ct.arr.n,0);
if(s){No*b=sbody(s,s->el);if(b){int arid[64];Vk ark[64];int arp[64];No*sp=b->bd.sp;for(uint32_t i=0;i<n->ct.arr.n&&i<64;i++){No*pm=sp&&i<sp->sp.pmm.n?sp->sp.pmm.d[i]:0;No*arg=n->ct.arr.d[i];V av={0,VK_I};Vk ek=VK_I;bool rf=false;if(pm){if(pm->sy&&pm->sy->ty)ek=tk2v(pm->sy->ty);else if(pm->pm.ty){Ty*pt=rst(g->sm,pm->pm.ty);ek=tk2v(pt);}if(pm->pm.md&2&&arg->k==N_ID){rf=true;Sy*as=arg->sy?arg->sy:syf(g->sm,arg->s);if(as&&as->lv==0){char nb[256];if(as->pr&&as->pr->nm.s){int n=0;for(uint32_t j=0;j<as->pr->nm.n;j++)nb[n++]=toupper(as->pr->nm.s[j]);nb[n++]='_';nb[n++]='_';for(uint32_t j=0;j<as->nm.n;j++)nb[n++]=toupper(as->nm.s[j]);nb[n]=0;}else snprintf(nb,256,"%.*s",(int)as->nm.n,as->nm.s);av.id=nt(g);av.k=VK_P;fprintf(o,"  %%t%d = bitcast ptr @%s to ptr\n",av.id,nb);}else if(as&&as->lv>=0&&as->lv<g->sm->lv){av.id=nt(g);av.k=VK_P;fprintf(o,"  %%t%d = getelementptr ptr, ptr %%__slnk, i64 %u\n",av.id,as->el);int a2=nt(g);fprintf(o,"  %%t%d = load ptr, ptr %%t%d\n",a2,av.id);av.id=a2;}else{av.id=nt(g);av.k=VK_P;fprintf(o,"  %%t%d = bitcast ptr %%v.%s.sc%u.%u to ptr\n",av.id,LC(arg->s),as?as->sc:0,as?as->el:0);}ek=VK_P;}else if(pm->pm.md&2){rf=true;av=gex(g,arg);int ap=nt(g);fprintf(o,"  %%t%d = alloca %s\n",ap,vt(av.k));fprintf(o,"  store %s %%t%d, ptr %%t%d\n",vt(av.k),av.id,ap);av.id=ap;av.k=VK_P;ek=VK_P;}else{av=gex(g,arg);}}else{av=gex(g,arg);}if(!rf){V cv=vcast(g,av,ek);av=cv;}arid[i]=av.id;ark[i]=ek;arp[i]=rf?1:0;}char nb[256];if(s->ext)snprintf(nb,256,"%.*s",(int)s->ext_nm.n,s->ext_nm.s);else esn(nb,256,s,n->ct.nm->s,n->ct.arr.n);fprintf(o,"  call void @\"%s\"(",nb);for(uint32_t i=0;i<n->ct.arr.n;i++){if(i)fprintf(o,", ");fprintf(o,"%s %%t%d",vt(ark[i]),arid[i]);}if(s->lv>0&&!s->ext){if(n->ct.arr.n>0)fprintf(o,", ");if(s->lv>=g->sm->lv)fprintf(o,"ptr %%__frame");else fprintf(o,"ptr %%__slnk");}fprintf(o,")\n");for(uint32_t i=0;i<n->ct.arr.n&&i<64;i++){if(arp[i]){int lv=nt(g);fprintf(o,"  %%t%d = load %s, ptr %%t%d\n",lv,vt(ark[i]==VK_P?VK_I:ark[i]),arid[i]);V rv={lv,ark[i]==VK_P?VK_I:ark[i]};V cv=vcast(g,rv,tk2v(n->ct.arr.d[i]->ty));No*tg=n->ct.arr.d[i];if(tg->k==N_ID){Sy*ts=tg->sy?tg->sy:syf(g->sm,tg->s);if(ts){if(ts->lv>=0&&ts->lv<g->sm->lv)fprintf(o,"  store %s %%t%d, ptr %%lnk.%d.%s\n",vt(cv.k),cv.id,ts->lv,LC(tg->s));else fprintf(o,"  store %s %%t%d, ptr %%v.%s.sc%u.%u\n",vt(cv.k),cv.id,LC(tg->s),ts->sc,ts->el);}}}}}else if(s->k==4||s->k==5){No*sp=s->ol.n>0&&(s->ol.d[0]->k==N_PD||s->ol.d[0]->k==N_FD)?s->ol.d[0]->bd.sp:0;if(!sp&&s->ty&&s->ty->ops.n>0){sp=s->ty->ops.d[0]->bd.sp;}int arid[64];Vk ark[64];int arpt[64];for(uint32_t i=0;i<n->ct.arr.n&&i<64;i++){No*pm=sp&&i<sp->sp.pmm.n?sp->sp.pmm.d[i]:0;arpt[i]=pm&&(pm->pm.md&2)?1:0;}for(uint32_t i=0;i<n->ct.arr.n&&i<64;i++){No*arg=n->ct.arr.d[i];V av={0,VK_I};Vk ek=VK_I;if(arpt[i]&&arg->k==N_ID){ek=VK_P;Sy*as=arg->sy?arg->sy:syf(g->sm,arg->s);av.id=nt(g);av.k=VK_P;if(as&&as->lv>=0&&as->lv<g->sm->lv)fprintf(o,"  %%t%d = bitcast ptr %%lnk.%d.%s to ptr\n",av.id,as->lv,LC(arg->s));else fprintf(o,"  %%t%d = bitcast ptr %%v.%s.sc%u.%u to ptr\n",av.id,LC(arg->s),as?as->sc:0,as?as->el:0);}else{av=gex(g,arg);V cv=vcast(g,av,ek);av=cv;}arid[i]=av.id;ark[i]=ek;}char nb[256];if(s->ext)snprintf(nb,256,"%.*s",(int)s->ext_nm.n,s->ext_nm.s);else esn(nb,256,s,n->ct.nm->s,n->ct.arr.n);if(s->k==5&&sp&&sp->sp.rt){Ty*rt=rst(g->sm,sp->sp.rt);Vk rk=tk2v(rt);int rid=nt(g);fprintf(o,"  %%t%d = call %s @\"%s\"(",rid,vt(rk),nb);}else fprintf(o,"  call void @\"%s\"(",nb);for(uint32_t i=0;i<n->ct.arr.n;i++){if(i)fprintf(o,", ");fprintf(o,"%s %%t%d",vt(ark[i]),arid[i]);}fprintf(o,")\n");}}}break;case N_BL:{int sj=nt(g);fprintf(o,"  %%t%d = call ptr @__ada_setjmp()\n",sj);fprintf(o,"  store ptr %%t%d, ptr %%ej\n",sj);fprintf(o,"  store ptr %%t%d, ptr @__eh_cur\n",sj);int sv=nt(g);fprintf(o,"  %%t%d = call i32 @setjmp(ptr %%t%d)\n",sv,sj);int ze=nt(g);fprintf(o,"  %%t%d = icmp eq i32 %%t%d, 0\n",ze,sv);int ln=nl(g),lh=nl(g);cbr(g,ze,ln,lh);lbl(g,ln);for(uint32_t i=0;i<n->bk.dc.n;i++){No*d=n->bk.dc.d[i];if(d&&d->k!=N_PB&&d->k!=N_FB&&!((d->k==N_PD||d->k==N_FD)&&d->sy&&d->sy->ext))gdl(g,d);}for(uint32_t i=0;i<n->bk.dc.n;i++){No*d=n->bk.dc.d[i];if(d&&d->k==N_OD&&d->od.in){for(uint32_t j=0;j<d->od.id.n;j++){No*id=d->od.id.d[j];if(!id->sy||id->sy->k!=2){Vk k=d->od.ty?tk2v(rst(g->sm,d->od.ty)):VK_I;Sy*s=id->sy;V v=gex(g,d->od.in);v=vcast(g,v,k);if(s&&s->lv>=0&&s->lv<g->sm->lv)fprintf(o,"  store %s %%t%d, ptr %%lnk.%d.%s\n",vt(k),v.id,s->lv,LC(id->s));else fprintf(o,"  store %s %%t%d, ptr %%v.%s.sc%u.%u\n",vt(k),v.id,LC(id->s),s?s->sc:0,s?s->el:0);}}}}for(uint32_t i=0;i<n->bk.st.n;i++)gss(g,n->bk.st.d[i]);int ld=nl(g);br(g,ld);lbl(g,lh);if(n->bk.hd.n>0){for(uint32_t i=0;i<n->bk.hd.n;i++){No*h=n->bk.hd.d[i];int lhm=nl(g),lhn=nl(g);for(uint32_t j=0;j<h->hnd.ec.n;j++){No*e=h->hnd.ec.d[j];if(e->k==N_ID&&si(e->s,Z("others"))){br(g,lhm);break;}int ec=nt(g);fprintf(o,"  %%t%d = load ptr, ptr @__ex_cur\n",ec);int cm=nt(g);fprintf(o,"  %%t%d = call i32 @strcmp(ptr %%t%d, ptr @.ex.%.*s)\n",cm,ec,(int)e->s.n,e->s.s);int eq=nt(g);fprintf(o,"  %%t%d = icmp eq i32 %%t%d, 0\n",eq,cm);cbr(g,eq,lhm,lhn);lbl(g,lhn);}br(g,ld);lbl(g,lhm);for(uint32_t j=0;j<h->hnd.stz.n;j++)gss(g,h->hnd.stz.d[j]);br(g,ld);}}else{int exc=nt(g);fprintf(o,"  %%t%d = load ptr, ptr @__ex_cur\n",exc);fprintf(o,"  call void @__ada_raise(ptr %%t%d)\n  unreachable\n",exc);}lbl(g,ld);}break;case N_DL:{V d=gex(g,n->ex.cd);d=vcast(g,d,VK_I);fprintf(o,"  call void @__ada_delay(i64 %%t%d)\n",d.id);}break;case N_SA:{if(n->sa.kn==1||n->sa.kn==3){V gd=gex(g,n->sa.gd);int ld=nl(g);fprintf(o,"  call void @__ada_delay(i64 %%t%d)\n",gd.id);if(n->sa.kn==3)fprintf(o,"  call void @__ada_raise(ptr @.ex.TASKING_ERROR)\n  unreachable\n");for(uint32_t i=0;i<n->sa.sts.n;i++)gss(g,n->sa.sts.d[i]);br(g,ld);lbl(g,ld);}else{int ld=nl(g);for(uint32_t i=0;i<n->sa.sts.n;i++){No*st=n->sa.sts.d[i];if(st->k==N_ACC){for(uint32_t j=0;j<st->acc.stx.n;j++)gss(g,st->acc.stx.d[j]);}else if(st->k==N_DL){V d=gex(g,st->ex.cd);fprintf(o,"  call void @__ada_delay(i64 %%t%d)\n",d.id);for(uint32_t j=0;j<st->hnd.stz.n;j++)gss(g,st->hnd.stz.d[j]);}}if(n->ss.el.n>0)for(uint32_t i=0;i<n->ss.el.n;i++)gss(g,n->ss.el.d[i]);br(g,ld);lbl(g,ld);}}break;default:break;}}}
static bool isrt(const char*n){return !strcmp(n,"__text_io_new_line")||!strcmp(n,"__text_io_put_char")||!strcmp(n,"__text_io_put")||!strcmp(n,"__text_io_put_line")||!strcmp(n,"__text_io_get_char")||!strcmp(n,"__text_io_get_line")||!strcmp(n,"__ada_ss_init")||!strcmp(n,"__ada_ss_mark")||!strcmp(n,"__ada_ss_release")||!strcmp(n,"__ada_ss_allocate")||!strcmp(n,"__ada_setjmp")||!strcmp(n,"__ada_raise")||!strcmp(n,"__ada_delay")||!strcmp(n,"__ada_powi")||!strcmp(n,"__ada_finalize")||!strcmp(n,"__ada_finalize_all")||!strcmp(n,"__ada_image_enum")||!strcmp(n,"__ada_value_int")||!strcmp(n,"__ada_image_int");}
static void gdl(Gn*g,No*n){FILE*o=g->o;if(!n)return;switch(n->k){case N_OD:{for(uint32_t j=0;j<n->od.id.n;j++){No*id=n->od.id.d[j];Sy*s=id->sy;if(s){if(s->k==0||s->k==2){Vk k=n->od.ty?tk2v(rst(g->sm,n->od.ty)):VK_I;Ty*at=n->od.ty?rst(g->sm,n->od.ty):0;if(s->k==0){if(at&&at->k==TY_A&&at->hi>=at->lo){int asz=(int)(at->hi-at->lo+1);fprintf(o,"  %%v.%s.sc%u.%u = alloca [%d x i64]\n",LC(id->s),s->sc,s->el,asz);}else{fprintf(o,"  %%v.%s.sc%u.%u = alloca %s\n",LC(id->s),s->sc,s->el,vt(k));}}}}}break;}case N_PD:{No*sp=n->bd.sp;char nb[256];if(n->sy&&n->sy->ext)snprintf(nb,256,"%.*s",(int)n->sy->ext_nm.n,n->sy->ext_nm.s);else esn(nb,256,n->sy,sp->sp.nm,sp->sp.pmm.n);if(!adcl(g,nb))break;if(isrt(nb))break;fprintf(o,"declare void @\"%s\"(",nb);for(uint32_t i=0;i<sp->sp.pmm.n;i++){if(i)fprintf(o,",");No*p=sp->sp.pmm.d[i];Ty*pt=p->pm.ty?rst(g->sm,p->pm.ty):0;Vk k=VK_I;if(pt){Ty*ptc=tcc(pt);if(n->sy&&n->sy->ext&&ptc&&ptc->k==TY_A&&!(p->pm.md&2))k=VK_I;else k=tk2v(pt);}if(p->pm.md&2)fprintf(o,"ptr");else fprintf(o,"%s",vt(k));}fprintf(o,")\n");}break;case N_FD:{No*sp=n->bd.sp;char nb[256];if(n->sy&&n->sy->ext)snprintf(nb,256,"%.*s",(int)n->sy->ext_nm.n,n->sy->ext_nm.s);else esn(nb,256,n->sy,sp->sp.nm,sp->sp.pmm.n);if(!adcl(g,nb))break;if(isrt(nb))break;bool has_body=false;if(n->sy)for(uint32_t i=0;i<n->sy->ol.n;i++)if(n->sy->ol.d[i]->k==N_FB){has_body=true;break;}if(has_body)break;Vk rk=sp->sp.rt?tk2v(rst(g->sm,sp->sp.rt)):VK_I;fprintf(o,"declare %s @\"%s\"(",vt(rk),nb);for(uint32_t i=0;i<sp->sp.pmm.n;i++){if(i)fprintf(o,",");No*p=sp->sp.pmm.d[i];Ty*pt=p->pm.ty?rst(g->sm,p->pm.ty):0;Vk k=VK_I;if(pt){Ty*ptc=tcc(pt);if(n->sy&&n->sy->ext&&ptc&&ptc->k==TY_A&&!(p->pm.md&2))k=VK_I;else k=tk2v(pt);}if(p->pm.md&2)fprintf(o,"ptr");else fprintf(o,"%s",vt(k));}fprintf(o,")\n");}break;case N_BL:for(uint32_t i=0;i<n->bk.dc.n;i++){No*d=n->bk.dc.d[i];if(d&&d->k!=N_PB&&d->k!=N_FB&&!((d->k==N_PD||d->k==N_FD)&&d->sy&&d->sy->ext))gdl(g,d);}for(uint32_t i=0;i<n->bk.dc.n;i++){No*d=n->bk.dc.d[i];if(d&&(d->k==N_PB||d->k==N_FB))gdl(g,d);}break;case N_PB:{for(uint32_t i=0;i<n->bd.dc.n;i++){No*d=n->bd.dc.d[i];if(d&&d->k==N_PKB)gdl(g,d);}for(uint32_t i=0;i<n->bd.dc.n;i++){No*d=n->bd.dc.d[i];if(d&&(d->k==N_PB||d->k==N_FB||((d->k==N_PD||d->k==N_FD)&&d->sy&&d->sy->ext)))gdl(g,d);}No*sp=n->bd.sp;char nb[256];esn(nb,256,n->sy,sp->sp.nm,sp->sp.pmm.n);adcl(g,nb);fprintf(o,"define void @\"%s\"(",nb);int np=sp->sp.pmm.n;if(n->sy&&n->sy->lv>0)np++;for(int i=0;i<np;i++){if(i)fprintf(o,", ");if(i<(int)sp->sp.pmm.n){No*p=sp->sp.pmm.d[i];Vk k=p->pm.ty?tk2v(rst(g->sm,p->pm.ty)):VK_I;if(p->pm.md&2)fprintf(o,"ptr %%p.%s",LC(p->pm.nm));else fprintf(o,"%s %%p.%s",vt(k),LC(p->pm.nm));}else fprintf(o,"ptr %%__slnk");}fprintf(o,")%s{\n",n->sy&&n->sy->inl?" alwaysinline ":" ");fprintf(o,"  %%ej = alloca ptr\n");int sv=g->sm->lv;g->sm->lv=n->sy?n->sy->lv+1:0;gbf(g);for(uint32_t i=0;i<sp->sp.pmm.n;i++){No*p=sp->sp.pmm.d[i];Vk k=p->pm.ty?tk2v(rst(g->sm,p->pm.ty)):VK_I;Sy*ps=p->sy;if(ps&&ps->lv>=0&&ps->lv<g->sm->lv)fprintf(o,"  %%lnk.%d.%s = alloca %s\n",ps->lv,LC(p->pm.nm),vt(k));else fprintf(o,"  %%v.%s.sc%u.%u = alloca %s\n",LC(p->pm.nm),ps?ps->sc:0,ps?ps->el:0,vt(k));if(p->pm.md&2){int lv=nt(g);fprintf(o,"  %%t%d = load %s, ptr %%p.%s\n",lv,vt(k),LC(p->pm.nm));if(ps&&ps->lv>=0&&ps->lv<g->sm->lv)fprintf(o,"  store %s %%t%d, ptr %%lnk.%d.%s\n",vt(k),lv,ps->lv,LC(p->pm.nm));else fprintf(o,"  store %s %%t%d, ptr %%v.%s.sc%u.%u\n",vt(k),lv,LC(p->pm.nm),ps?ps->sc:0,ps?ps->el:0);}else{if(ps&&ps->lv>=0&&ps->lv<g->sm->lv)fprintf(o,"  store %s %%p.%s, ptr %%lnk.%d.%s\n",vt(k),LC(p->pm.nm),ps->lv,LC(p->pm.nm));else fprintf(o,"  store %s %%p.%s, ptr %%v.%s.sc%u.%u\n",vt(k),LC(p->pm.nm),LC(p->pm.nm),ps?ps->sc:0,ps?ps->el:0);}}if(n->sy&&n->sy->lv>0){for(int h=0;h<4096;h++){for(Sy*s=g->sm->sy[h];s;s=s->nx){if(s->k==0&&s->lv>=0&&s->lv<g->sm->lv){Vk k=s->ty?tk2v(s->ty):VK_I;Ty*at=s->ty?tcc(s->ty):0;if(at&&at->k==TY_A&&at->hi>=at->lo){int asz=(int)(at->hi-at->lo+1);fprintf(o,"  %%v.%s.sc%u.%u = alloca [%d x i64]\n",LC(s->nm),s->sc,s->el,asz);}else{fprintf(o,"  %%v.%s.sc%u.%u = alloca %s\n",LC(s->nm),s->sc,s->el,vt(k));}int p=nt(g);fprintf(o,"  %%t%d = getelementptr i64, ptr %%__slnk, i64 %u\n",p,s->el);int v=nt(g);fprintf(o,"  %%t%d = load %s, ptr %%t%d\n",v,vt(k),p);fprintf(o,"  store %s %%t%d, ptr %%v.%s.sc%u.%u\n",vt(k),v,LC(s->nm),s->sc,s->el);}}}}for(uint32_t i=0;i<n->bd.dc.n;i++){No*d=n->bd.dc.d[i];if(d&&d->k!=N_PB&&d->k!=N_FB&&!((d->k==N_PD||d->k==N_FD)&&d->sy&&d->sy->ext))gdl(g,d);}if(0)for(int h=0;h<4096;h++){for(Sy*s=g->sm->sy[h];s;s=s->nx){if(s->k==0&&s->el>=0&&n->sy&&s->lv==n->sy->lv&&s->sc==n->sy->sc){bool is_pm=false;for(uint32_t pi=0;pi<sp->sp.pmm.n;pi++){if(sp->sp.pmm.d[pi]->sy==s){is_pm=true;break;}}if(!is_pm){Vk k=s->ty?tk2v(s->ty):VK_I;int fp=nt(g);int mx=g->sm->eo;fprintf(o,"  %%t%d = getelementptr [%d x ptr], ptr %%__frame, i64 0, i64 %u\n",fp,mx,s->el);fprintf(o,"  store ptr %%v.%s.sc%u.%u, ptr %%t%d\n",LC(s->nm),s->sc,s->el,fp);}}}}for(uint32_t i=0;i<n->bd.dc.n;i++){No*d=n->bd.dc.d[i];if(d&&d->k==N_OD&&d->od.in){for(uint32_t j=0;j<d->od.id.n;j++){No*id=d->od.id.d[j];if(!id->sy||id->sy->k!=2){Vk k=d->od.ty?tk2v(rst(g->sm,d->od.ty)):VK_I;Sy*s=id->sy;V v=gex(g,d->od.in);v=vcast(g,v,k);if(s&&s->lv>=0&&s->lv<g->sm->lv)fprintf(o,"  store %s %%t%d, ptr %%lnk.%d.%s\n",vt(k),v.id,s->lv,LC(id->s));else fprintf(o,"  store %s %%t%d, ptr %%v.%s.sc%u.%u\n",vt(k),v.id,LC(id->s),s?s->sc:0,s?s->el:0);}}}}for(uint32_t i=0;i<n->bd.st.n;i++)gss(g,n->bd.st.d[i]);g->sm->lv=sv;fprintf(o,"  ret void\n}\n");}break;case N_FB:{for(uint32_t i=0;i<n->bd.dc.n;i++){No*d=n->bd.dc.d[i];if(d&&d->k==N_PKB)gdl(g,d);}for(uint32_t i=0;i<n->bd.dc.n;i++){No*d=n->bd.dc.d[i];if(d&&(d->k==N_PB||d->k==N_FB||((d->k==N_PD||d->k==N_FD)&&d->sy&&d->sy->ext)))gdl(g,d);}No*sp=n->bd.sp;Vk rk=sp->sp.rt?tk2v(rst(g->sm,sp->sp.rt)):VK_I;char nb[256];esn(nb,256,n->sy,sp->sp.nm,sp->sp.pmm.n);adcl(g,nb);fprintf(o,"define %s @\"%s\"(",vt(rk),nb);int np=sp->sp.pmm.n;if(n->sy&&n->sy->lv>0)np++;for(int i=0;i<np;i++){if(i)fprintf(o,", ");if(i<(int)sp->sp.pmm.n){No*p=sp->sp.pmm.d[i];Vk k=p->pm.ty?tk2v(rst(g->sm,p->pm.ty)):VK_I;if(p->pm.md&2)fprintf(o,"ptr %%p.%s",LC(p->pm.nm));else fprintf(o,"%s %%p.%s",vt(k),LC(p->pm.nm));}else fprintf(o,"ptr %%__slnk");}fprintf(o,")%s{\n",n->sy&&n->sy->inl?" alwaysinline ":" ");fprintf(o,"  %%ej = alloca ptr\n");int sv=g->sm->lv;g->sm->lv=n->sy?n->sy->lv+1:0;gbf(g);for(uint32_t i=0;i<sp->sp.pmm.n;i++){No*p=sp->sp.pmm.d[i];Vk k=p->pm.ty?tk2v(rst(g->sm,p->pm.ty)):VK_I;Sy*ps=p->sy;if(ps&&ps->lv>=0&&ps->lv<g->sm->lv)fprintf(o,"  %%lnk.%d.%s = alloca %s\n",ps->lv,LC(p->pm.nm),vt(k));else fprintf(o,"  %%v.%s.sc%u.%u = alloca %s\n",LC(p->pm.nm),ps?ps->sc:0,ps?ps->el:0,vt(k));if(p->pm.md&2){int lv=nt(g);fprintf(o,"  %%t%d = load %s, ptr %%p.%s\n",lv,vt(k),LC(p->pm.nm));if(ps&&ps->lv>=0&&ps->lv<g->sm->lv)fprintf(o,"  store %s %%t%d, ptr %%lnk.%d.%s\n",vt(k),lv,ps->lv,LC(p->pm.nm));else fprintf(o,"  store %s %%t%d, ptr %%v.%s.sc%u.%u\n",vt(k),lv,LC(p->pm.nm),ps?ps->sc:0,ps?ps->el:0);}else{if(ps&&ps->lv>=0&&ps->lv<g->sm->lv)fprintf(o,"  store %s %%p.%s, ptr %%lnk.%d.%s\n",vt(k),LC(p->pm.nm),ps->lv,LC(p->pm.nm));else fprintf(o,"  store %s %%p.%s, ptr %%v.%s.sc%u.%u\n",vt(k),LC(p->pm.nm),LC(p->pm.nm),ps?ps->sc:0,ps?ps->el:0);}}for(uint32_t i=0;i<n->bd.dc.n;i++){No*d=n->bd.dc.d[i];if(d&&d->k!=N_PB&&d->k!=N_FB&&!((d->k==N_PD||d->k==N_FD)&&d->sy&&d->sy->ext))gdl(g,d);}if(0)for(int h=0;h<4096;h++){for(Sy*s=g->sm->sy[h];s;s=s->nx){if(s->k==0&&s->lv>=0&&n->sy&&s->lv==n->sy->lv&&s->sc==n->sy->sc&&s->el>=0){bool is_pm=false;for(uint32_t pi=0;pi<sp->sp.pmm.n;pi++){if(sp->sp.pmm.d[pi]->sy==s){is_pm=true;break;}}if(!is_pm){int fp=nt(g);int mx=g->sm->eo;fprintf(o,"  %%t%d = getelementptr [%d x ptr], ptr %%__frame, i64 0, i64 %u\n",fp,mx,s->el);fprintf(o,"  store ptr %%v.%s.sc%u.%u, ptr %%t%d\n",LC(s->nm),s->sc,s->el,fp);}}}}for(uint32_t i=0;i<n->bd.dc.n;i++){No*d=n->bd.dc.d[i];if(d&&d->k==N_OD&&d->od.in){for(uint32_t j=0;j<d->od.id.n;j++){No*id=d->od.id.d[j];if(!id->sy||id->sy->k!=2){Vk k=d->od.ty?tk2v(rst(g->sm,d->od.ty)):VK_I;Sy*s=id->sy;V v=gex(g,d->od.in);v=vcast(g,v,k);if(s&&s->lv>=0&&s->lv<g->sm->lv)fprintf(o,"  store %s %%t%d, ptr %%lnk.%d.%s\n",vt(k),v.id,s->lv,LC(id->s));else fprintf(o,"  store %s %%t%d, ptr %%v.%s.sc%u.%u\n",vt(k),v.id,LC(id->s),s?s->sc:0,s?s->el:0);}}}}for(uint32_t i=0;i<n->bd.st.n;i++)gss(g,n->bd.st.d[i]);if(rk==VK_P){fprintf(o,"  ret ptr null\n}\n");}else{fprintf(o,"  ret %s 0\n}\n",vt(rk));}}break;case N_PKB:break;default:break;}}
static void gel(Gn*g,No*n){if(n&&n->k==N_PKB&&n->pb.st.n>0){Sy*ps=syf(g->sm,n->pb.nm);if(ps&&ps->k==11)return;char nb[256];snprintf(nb,256,"%.*s__elab",(int)n->pb.nm.n,n->pb.nm.s);fprintf(g->o,"define void @\"%s\"() {\n",nb);for(uint32_t i=0;i<n->pb.st.n;i++)gss(g,n->pb.st.d[i]);fprintf(g->o,"  ret void\n}\n");fprintf(g->o,"@llvm.global_ctors=appending global[1 x {i32,ptr,ptr}][{i32,ptr,ptr}{i32 65535,ptr @\"%s\",ptr null}]\n",nb);}}
static void grt(Gn*g){FILE*o=g->o;fprintf(o,"declare i32 @setjmp(ptr)\ndeclare void @longjmp(ptr,i32)\ndeclare i32 @pthread_create(ptr,ptr,ptr,ptr)\ndeclare i32 @pthread_join(i64,ptr)\ndeclare i32 @pthread_mutex_init(ptr,ptr)\ndeclare i32 @pthread_mutex_lock(ptr)\ndeclare i32 @pthread_mutex_unlock(ptr)\ndeclare i32 @pthread_cond_init(ptr,ptr)\ndeclare i32 @pthread_cond_wait(ptr,ptr)\ndeclare i32 @pthread_cond_signal(ptr)\ndeclare i32 @pthread_cond_broadcast(ptr)\ndeclare i32 @usleep(i32)\ndeclare ptr @malloc(i64)\ndeclare ptr @realloc(ptr,i64)\ndeclare void @free(ptr)\ndeclare i32 @printf(ptr,...)\ndeclare i32 @puts(ptr)\ndeclare i32 @sprintf(ptr,ptr,...)\ndeclare i32 @snprintf(ptr,i64,ptr,...)\ndeclare i32 @strcmp(ptr,ptr)\ndeclare ptr @strcpy(ptr,ptr)\ndeclare i64 @strlen(ptr)\ndeclare ptr @memcpy(ptr,ptr,i64)\ndeclare ptr @memset(ptr,i32,i64)\ndeclare double @pow(double,double)\ndeclare double @sqrt(double)\ndeclare double @sin(double)\ndeclare double @cos(double)\ndeclare double @exp(double)\ndeclare double @log(double)\ndeclare void @llvm.memcpy.p0.p0.i64(ptr,ptr,i64,i1)\n");fprintf(o,"@stdin=external global ptr\n@stdout=external global ptr\n@stderr=external global ptr\n@__ss_ptr=linkonce_odr global i64 0\n@__ss_base=linkonce_odr global ptr null\n@__ss_size=linkonce_odr global i64 0\n@__eh_cur=linkonce_odr global ptr null\n@__ex_cur=linkonce_odr global ptr null\n@__fin_list=linkonce_odr global ptr null\n");fprintf(o,"@.ex.CONSTRAINT_ERROR=linkonce_odr constant[17 x i8]c\"CONSTRAINT_ERROR\\00\"\n@.ex.PROGRAM_ERROR=linkonce_odr constant[14 x i8]c\"PROGRAM_ERROR\\00\"\n@.ex.STORAGE_ERROR=linkonce_odr constant[14 x i8]c\"STORAGE_ERROR\\00\"\n@.ex.TASKING_ERROR=linkonce_odr constant[14 x i8]c\"TASKING_ERROR\\00\"\n@.ex.USE_ERROR=linkonce_odr constant[10 x i8]c\"USE_ERROR\\00\"\n@.ex.NAME_ERROR=linkonce_odr constant[11 x i8]c\"NAME_ERROR\\00\"\n@.ex.STATUS_ERROR=linkonce_odr constant[13 x i8]c\"STATUS_ERROR\\00\"\n@.ex.MODE_ERROR=linkonce_odr constant[11 x i8]c\"MODE_ERROR\\00\"\n@.ex.END_ERROR=linkonce_odr constant[10 x i8]c\"END_ERROR\\00\"\n@.ex.DATA_ERROR=linkonce_odr constant[11 x i8]c\"DATA_ERROR\\00\"\n@.ex.DEVICE_ERROR=linkonce_odr constant[13 x i8]c\"DEVICE_ERROR\\00\"\n@.ex.LAYOUT_ERROR=linkonce_odr constant[13 x i8]c\"LAYOUT_ERROR\\00\"\n");fprintf(o,"define linkonce_odr void @__ada_ss_init(){%%p=call ptr @malloc(i64 1048576)\nstore ptr %%p,ptr @__ss_base\nstore i64 1048576,ptr @__ss_size\nstore i64 0,ptr @__ss_ptr\nret void}\n");fprintf(o,"define linkonce_odr i64 @__ada_ss_mark(){%%m=load i64,ptr @__ss_ptr\nret i64 %%m}\n");fprintf(o,"define linkonce_odr void @__ada_ss_release(i64 %%m){store i64 %%m,ptr @__ss_ptr\nret void}\n");fprintf(o,"define linkonce_odr ptr @__ada_ss_allocate(i64 %%sz){%%1=load ptr,ptr @__ss_base\n%%2=icmp eq ptr %%1,null\nbr i1 %%2,label %%init,label %%alloc\ninit:\ncall void @__ada_ss_init()\n%%3=load ptr,ptr @__ss_base\nbr label %%alloc\nalloc:\n%%p=phi ptr[%%1,%%0],[%%3,%%init]\n%%4=load i64,ptr @__ss_ptr\n%%5=add i64 %%sz,7\n%%6=and i64 %%5,-8\n%%7=add i64 %%4,%%6\n%%8=load i64,ptr @__ss_size\n%%9=icmp ult i64 %%7,%%8\nbr i1 %%9,label %%ok,label %%grow\ngrow:\n%%10=mul i64 %%8,2\nstore i64 %%10,ptr @__ss_size\n%%11=call ptr @realloc(ptr %%p,i64 %%10)\nstore ptr %%11,ptr @__ss_base\nbr label %%ok\nok:\n%%12=phi ptr[%%p,%%alloc],[%%11,%%grow]\n%%13=getelementptr i8,ptr %%12,i64 %%4\nstore i64 %%7,ptr @__ss_ptr\nret ptr %%13}\n");fprintf(o,"define linkonce_odr ptr @__ada_setjmp(){%%p=call ptr @malloc(i64 200)\nret ptr %%p}\n");fprintf(o,"define linkonce_odr void @__ada_raise(ptr %%msg){store ptr %%msg,ptr @__ex_cur\ncall void @longjmp(ptr @__eh_cur,i32 1)\nret void}\n");fprintf(o,"define linkonce_odr void @__ada_delay(i64 %%us){%%t=trunc i64 %%us to i32\n%%r=call i32 @usleep(i32 %%t)\nret void}\n");fprintf(o,"define linkonce_odr i64 @__ada_powi(i64 %%base,i64 %%exp){entry:\n%%result=alloca i64\nstore i64 1,ptr %%result\n%%e=alloca i64\nstore i64 %%exp,ptr %%e\nbr label %%loop\nloop:\n%%ev=load i64,ptr %%e\n%%cmp=icmp sgt i64 %%ev,0\nbr i1 %%cmp,label %%body,label %%done\nbody:\n%%rv=load i64,ptr %%result\n%%nv=mul i64 %%rv,%%base\nstore i64 %%nv,ptr %%result\n%%ev2=load i64,ptr %%e\n%%ev3=sub i64 %%ev2,1\nstore i64 %%ev3,ptr %%e\nbr label %%loop\ndone:\n%%final=load i64,ptr %%result\nret i64 %%final}\n");fprintf(o,"define linkonce_odr void @__ada_finalize(ptr %%obj,ptr %%fn){%%1=call ptr @malloc(i64 16)\n%%2=getelementptr ptr,ptr %%1,i64 0\nstore ptr %%obj,ptr %%2\n%%3=getelementptr ptr,ptr %%1,i64 1\nstore ptr %%fn,ptr %%3\n%%4=load ptr,ptr @__fin_list\n%%5=getelementptr ptr,ptr %%1,i64 2\nstore ptr %%4,ptr %%5\nstore ptr %%1,ptr @__fin_list\nret void}\n");fprintf(o,"define linkonce_odr void @__ada_finalize_all(){entry:\n%%1=load ptr,ptr @__fin_list\nbr label %%loop\nloop:\n%%p=phi ptr[%%1,%%entry],[%%9,%%fin]\n%%2=icmp eq ptr %%p,null\nbr i1 %%2,label %%done,label %%fin\nfin:\n%%3=getelementptr ptr,ptr %%p,i64 0\n%%4=load ptr,ptr %%3\n%%5=getelementptr ptr,ptr %%p,i64 1\n%%6=load ptr,ptr %%5\n%%7=bitcast ptr %%6 to ptr\ncall void %%7(ptr %%4)\n%%8=getelementptr ptr,ptr %%p,i64 2\n%%9=load ptr,ptr %%8\ncall void @free(ptr %%p)\nbr label %%loop\ndone:\nret void}\n");fprintf(o,"@.fmt_d=linkonce_odr constant[5 x i8]c\"%%lld\\00\"\n@.fmt_s=linkonce_odr constant[3 x i8]c\"%%s\\00\"\n");fprintf(o,"define linkonce_odr void @__text_io_new_line(){call i32 @putchar(i32 10)\nret void}\n");fprintf(o,"define linkonce_odr void @__text_io_put_char(i64 %%c){%%1=trunc i64 %%c to i32\ncall i32 @putchar(i32 %%1)\nret void}\n");fprintf(o,"define linkonce_odr void @__text_io_put(ptr %%s){entry:\n%%len=call i64 @strlen(ptr %%s)\nbr label %%loop\nloop:\n%%i=phi i64[0,%%entry],[%%next,%%body]\n%%cmp=icmp slt i64 %%i,%%len\nbr i1 %%cmp,label %%body,label %%done\nbody:\n%%charptr=getelementptr i8,ptr %%s,i64 %%i\n%%ch8=load i8,ptr %%charptr\n%%ch=sext i8 %%ch8 to i32\ncall i32 @putchar(i32 %%ch)\n%%next=add i64 %%i,1\nbr label %%loop\ndone:\nret void}\n");fprintf(o,"define linkonce_odr void @__text_io_put_line(ptr %%s){call void @__text_io_put(ptr %%s)\ncall void @__text_io_new_line()\nret void}\n");fprintf(o,"define linkonce_odr void @__text_io_get_char(ptr %%p){%%1=call i32 @getchar()\n%%2=icmp eq i32 %%1,-1\n%%3=sext i32 %%1 to i64\n%%4=select i1 %%2,i64 0,i64 %%3\nstore i64 %%4,ptr %%p\nret void}\n");fprintf(o,"define linkonce_odr void @__text_io_get_line(ptr %%b,ptr %%n){store i64 0,ptr %%n\nret void}\n");fprintf(o,"declare i32 @putchar(i32)\ndeclare i32 @getchar()\n");fprintf(o,"define linkonce_odr ptr @__ada_image_enum(i64 %%v,i64 %%f,i64 %%l){%%p=sub i64 %%v,%%f\n%%fmt=getelementptr[5 x i8],ptr @.fmt_d,i64 0,i64 0\n%%buf=alloca[32 x i8]\n%%1=getelementptr[32 x i8],ptr %%buf,i64 0,i64 0\n%%add=add i64 %%p,1\n%%2=call i32(ptr,ptr,...)@sprintf(ptr %%1,ptr %%fmt,i64 %%add)\n%%n=sext i32 %%2 to i64\n%%sz=add i64 %%n,1\n%%rsz=mul i64 %%sz,8\n%%r=call ptr @malloc(i64 %%rsz)\nstore i64 %%n,ptr %%r\nbr label %%loop\nloop:\n%%i=phi i64[0,%%0],[%%9,%%body]\n%%3=icmp slt i64 %%i,%%n\nbr i1 %%3,label %%body,label %%done\nbody:\n%%4=getelementptr[32 x i8],ptr %%buf,i64 0,i64 %%i\n%%5=load i8,ptr %%4\n%%6=sext i8 %%5 to i64\n%%7=add i64 %%i,1\n%%8=getelementptr i64,ptr %%r,i64 %%7\nstore i64 %%6,ptr %%8\n%%9=add i64 %%i,1\nbr label %%loop\ndone:\nret ptr %%r}\n");fprintf(o,"define linkonce_odr i64 @__ada_value_int(ptr %%s){%%pn=load i64,ptr %%s\n%%buf=call ptr @malloc(i64 %%pn)\nbr label %%copy\ncopy:\n%%ci=phi i64[0,%%0],[%%next,%%cbody]\n%%1=icmp slt i64 %%ci,%%pn\nbr i1 %%1,label %%cbody,label %%parse\ncbody:\n%%idx=add i64 %%ci,1\n%%sptr=getelementptr i64,ptr %%s,i64 %%idx\n%%charval=load i64,ptr %%sptr\n%%ch=trunc i64 %%charval to i8\n%%bptr=getelementptr i8,ptr %%buf,i64 %%ci\nstore i8 %%ch,ptr %%bptr\n%%next=add i64 %%ci,1\nbr label %%copy\nparse:\n%%null=getelementptr i8,ptr %%buf,i64 %%pn\nstore i8 0,ptr %%null\n%%result=call i64(ptr,ptr,i32,...)@strtoll(ptr %%buf,ptr null,i32 10)\ncall void @free(ptr %%buf)\nret i64 %%result}\ndeclare i64 @strtoll(ptr,ptr,i32,...)\n");fprintf(o,"define linkonce_odr ptr @__ada_image_int(i64 %%v){%%buf=alloca[32 x i8]\n%%1=getelementptr[32 x i8],ptr %%buf,i64 0,i64 0\n%%fmt=getelementptr[5 x i8],ptr @.fmt_d,i64 0,i64 0\n%%2=call i32(ptr,ptr,...)@sprintf(ptr %%1,ptr %%fmt,i64 %%v)\n%%n=sext i32 %%2 to i64\n%%sz=add i64 %%n,1\n%%rsz=mul i64 %%sz,8\n%%r=call ptr @malloc(i64 %%rsz)\nstore i64 %%n,ptr %%r\nbr label %%loop\nloop:\n%%i=phi i64[0,%%0],[%%8,%%body]\n%%3=icmp slt i64 %%i,%%n\nbr i1 %%3,label %%body,label %%done\nbody:\n%%4=getelementptr[32 x i8],ptr %%buf,i64 0,i64 %%i\n%%5=load i8,ptr %%4\n%%6=sext i8 %%5 to i64\n%%7=add i64 %%i,1\n%%idx=getelementptr i64,ptr %%r,i64 %%7\nstore i64 %%6,ptr %%idx\n%%8=add i64 %%i,1\nbr label %%loop\ndone:\nret ptr %%r}\n");}
static char*rf(const char*p){FILE*f=fopen(p,"rb");if(!f)return 0;fseek(f,0,SEEK_END);long z=ftell(f);fseek(f,0,SEEK_SET);char*b=malloc(z+1);size_t _=fread(b,1,z,f);(void)_;b[z]=0;fclose(f);return b;}
static void wf(const char*p,const char*d){FILE*f=fopen(p,"wb");if(!f)return;fputs(d,f);fclose(f);}
static void prf(Gn*g,Sm*sm){for(int h=0;h<4096;h++)for(Sy*s=sm->sy[h];s;s=s->nx)if(s->lv==0&&!s->ext)for(uint32_t k=0;k<s->ol.n;k++){No*n=s->ol.d[k];if(n&&(n->k==N_PB||n->k==N_FB)){No*sp=n->bd.sp;char nb[256];esn(nb,256,n->sy,sp->sp.nm,sp->sp.pmm.n);adcl(g,nb);}}}
static LU*lfnd(Sm*SM,S nm){for(uint32_t i=0;i<SM->lu.n;i++){LU*l=SM->lu.d[i];if(si(l->nm,nm))return l;}return 0;}
static uint64_t fts(const char*p){struct stat s;if(stat(p,&s))return 0;return s.st_mtime;}
static void wali(Sm*SM,const char*fn,No*cu){if(!cu||cu->cu.un.n==0)return;char alp[520];snprintf(alp,520,"%s.ali",fn);FILE*f=fopen(alp,"w");if(!f)return;fprintf(f,"V 1.0\n");No*u0=cu->cu.un.d[0];S nm=u0->k==N_PKS?u0->ps.nm:u0->k==N_PKB?u0->pb.nm:N;fprintf(f,"U %.*s\n",(int)nm.n,nm.s);if(cu->cu.cx)for(uint32_t i=0;i<cu->cu.cx->cx.wt.n;i++){No*w=cu->cu.cx->cx.wt.d[i];char pf[256];int n=snprintf(pf,256,"%.*s",(int)w->wt.nm.n,w->wt.nm.s);for(int j=0;j<n;j++)pf[j]=tolower(pf[j]);uint64_t ts=fts(pf);fprintf(f,"W %.*s %lu\n",(int)w->wt.nm.n,w->wt.nm.s,(unsigned long)ts);}for(int i=0;i<SM->dpn;i++)if(SM->dps[i].n&&SM->dps[i].d[0])fprintf(f,"D %.*s\n",(int)SM->dps[i].d[0]->nm.n,SM->dps[i].d[0]->nm.s);for(int h=0;h<4096;h++){for(Sy*s=SM->sy[h];s;s=s->nx){if((s->k==4||s->k==5)&&s->pr&&si(s->pr->nm,nm)){No*sp=s->ol.n>0&&s->ol.d[0]->bd.sp?s->ol.d[0]->bd.sp:0;char nb[256];esn(nb,256,s,s->nm,sp?sp->sp.pmm.n:0);fprintf(f,"X %s",nb);if(s->k==4){fprintf(f," void");if(sp)for(uint32_t i=0;i<sp->sp.pmm.n;i++){No*p=sp->sp.pmm.d[i];Vk k=p->pm.ty?tk2v(rst(SM,p->pm.ty)):VK_I;fprintf(f," %s",vt(k));}}else{Ty*rt=sp&&sp->sp.rt?rst(SM,sp->sp.rt):0;Vk rk=tk2v(rt);fprintf(f," %s",vt(rk));if(sp)for(uint32_t i=0;i<sp->sp.pmm.n;i++){No*p=sp->sp.pmm.d[i];Vk k=p->pm.ty?tk2v(rst(SM,p->pm.ty)):VK_I;fprintf(f," %s",vt(k));}}fprintf(f,"\n");}else if((s->k==0||s->k==2)&&s->lv==0&&s->pr&&si(s->pr->nm,nm)){char nb[256];if(s->pr&&s->pr->nm.s){int n=0;for(uint32_t j=0;j<s->pr->nm.n;j++)nb[n++]=toupper(s->pr->nm.s[j]);nb[n++]='_';nb[n++]='_';for(uint32_t j=0;j<s->nm.n;j++)nb[n++]=toupper(s->nm.s[j]);nb[n]=0;}else snprintf(nb,256,"%.*s",(int)s->nm.n,s->nm.s);Vk k=s->ty?tk2v(s->ty):VK_I;fprintf(f,"X %s %s\n",nb,vt(k));}}}for(uint32_t i=0;i<SM->eh.n;i++){bool f2=0;for(uint32_t j=0;j<i;j++)if(si(SM->eh.d[j],SM->eh.d[i])){f2=1;break;}if(!f2)fprintf(f,"H %.*s\n",(int)SM->eh.d[i].n,SM->eh.d[i].s);}if(SM->eo>0)fprintf(f,"E %d\n",SM->eo);fclose(f);}
static bool lcmp(Sm*SM,S nm,S pth){LU*ex=lfnd(SM,nm);if(ex&&ex->cmpl)return true;char fp[512];snprintf(fp,512,"%.*s.adb",(int)pth.n,pth.s);char*src=rf(fp);if(!src){snprintf(fp,512,"%.*s.ads",(int)pth.n,pth.s);src=rf(fp);}if(!src)return false;Ps p=pnw(src,strlen(src),fp);No*cu=pcu(&p);if(!cu)return false;Sm sm;smi(&sm);sm.lu=SM->lu;sm.gt=SM->gt;smu(&sm,cu);char op[512];snprintf(op,512,"%.*s.ll",(int)pth.n,pth.s);FILE*o=fopen(op,"w");Gn g={o,0,0,0,&sm,{0},0,{0},0,{0},0,{0},0,{0},{0},{0}};grt(&g);prf(&g,&sm);for(int h=0;h<4096;h++)for(Sy*s=sm.sy[h];s;s=s->nx)if((s->k==0||s->k==2)&&s->lv==0&&s->pr&&!s->ext){Vk k=s->ty?tk2v(s->ty):VK_I;char nb[256];int n=0;for(uint32_t j=0;j<s->pr->nm.n;j++)nb[n++]=toupper(s->pr->nm.s[j]);nb[n++]='_';nb[n++]='_';for(uint32_t j=0;j<s->nm.n;j++)nb[n++]=toupper(s->nm.s[j]);nb[n]=0;if(s->k==2&&s->df&&s->df->k==N_STR){uint32_t len=s->df->s.n;fprintf(o,"@%s=constant [%u x i8]c\"",nb,len+1);for(uint32_t i=0;i<len;i++){char c=s->df->s.s[i];if(c=='"')fprintf(o,"\\22");else if(c=='\\')fprintf(o,"\\5C");else if(c<32||c>126)fprintf(o,"\\%02X",(unsigned char)c);else fprintf(o,"%c",c);}fprintf(o,"\\00\"\n");}else{char iv[64];if(k==VK_I&&s->df&&s->df->k==N_INT){snprintf(iv,64,"%ld",s->df->i);}else if(k==VK_I&&s->vl!=0){snprintf(iv,64,"%ld",s->vl);}else{snprintf(iv,64,"%s",k==VK_P?"null":"0");}fprintf(o,"@%s=%s %s %s\n",nb,s->k==2?"constant":"global",vt(k),iv);}}for(uint32_t i=0;i<sm.eo;i++){for(uint32_t j=0;j<4096;j++){for(Sy*s=sm.sy[j];s;s=s->nx){if(s->el==i){for(uint32_t k=0;k<s->ol.n;k++)gdl(&g,s->ol.d[k]);}}}}for(uint32_t ui=0;ui<cu->cu.un.n;ui++){No*u=cu->cu.un.d[ui];if(u->k==N_PKB)gel(&g,u);}for(uint32_t i=0;i<sm.ib.n;i++)gel(&g,sm.ib.d[i]);emd(&g);fclose(o);LU*l=lu(cu->cu.un.n>0?cu->cu.un.d[0]->k:0,nm,pth);l->cmpl=true;l->ts=fts(fp);lv(&SM->lu,l);return true;}
int main(int ac,char**av){if(ac<2){fprintf(stderr,"u: %s f.adb\n",av[0]);return 1;}const char*inf=av[1];char*src=rf(inf);if(!src){fprintf(stderr,"e: %s\n",inf);return 1;}Ps p=pnw(src,strlen(src),inf);No*cu=pcu(&p);if(p.er||!cu)return 1;Sm sm;smi(&sm);char sd[520]={0};const char*sl=strrchr(inf,'/');if(sl){size_t dl=sl-inf+1;if(dl<519){memcpy(sd,inf,dl);sd[dl]=0;}}if(cu->cu.cx)for(uint32_t i=0;i<cu->cu.cx->cx.wt.n;i++){No*w=cu->cu.cx->cx.wt.d[i];char pb[520];char*ln=LC(w->wt.nm);bool ld=0;if(sd[0]){snprintf(pb,520,"%s%s",sd,ln);if(lcmp(&sm,w->wt.nm,(S){pb,strlen(pb)}))ld=1;}if(!ld){snprintf(pb,520,"acats/%s",ln);if(lcmp(&sm,w->wt.nm,(S){pb,strlen(pb)}))ld=1;}if(!ld){snprintf(pb,520,"rts/%s",ln);lcmp(&sm,w->wt.nm,(S){pb,strlen(pb)});}}smu(&sm,cu);char of[520];strncpy(of,inf,512);char*dt=strrchr(of,'.');if(dt)*dt=0;snprintf(of+strlen(of),520-strlen(of),".ll");FILE*o=stdout;Gn g={o,0,0,0,&sm,{0},0,{0},0,{0},0,{0},13,{0},{0},{0}};grt(&g);for(int h=0;h<4096;h++)for(Sy*s=sm.sy[h];s;s=s->nx)if((s->k==0||s->k==2)&&(s->lv==0||s->pr)&&!(s->pr&&lfnd(&sm,s->pr->nm))){Vk k=s->ty?tk2v(s->ty):VK_I;char nb[256];if(s->pr&&s->pr->nm.s){int n=0;for(uint32_t j=0;j<s->pr->nm.n;j++)nb[n++]=toupper(s->pr->nm.s[j]);nb[n++]='_';nb[n++]='_';for(uint32_t j=0;j<s->nm.n;j++)nb[n++]=toupper(s->nm.s[j]);nb[n]=0;}else snprintf(nb,256,"%.*s",(int)s->nm.n,s->nm.s);if(s->k==2&&s->df&&s->df->k==N_STR){uint32_t len=s->df->s.n;fprintf(o,"@%s=%s[%u x i8]c\"",nb,s->pr?"constant ":"linkonce_odr constant ",len+1);for(uint32_t i=0;i<len;i++){char c=s->df->s.s[i];if(c=='"')fprintf(o,"\\22");else if(c=='\\')fprintf(o,"\\5C");else if(c<32||c>126)fprintf(o,"\\%02X",(unsigned char)c);else fprintf(o,"%c",c);}fprintf(o,"\\00\"\n");}else{char iv[64];if(k==VK_I&&s->df&&s->df->k==N_INT){snprintf(iv,64,"%ld",s->df->i);}else if(k==VK_I&&s->vl!=0){snprintf(iv,64,"%ld",s->vl);}else{snprintf(iv,64,"%s",k==VK_P?"null":"0");}fprintf(o,"@%s=%s %s %s\n",nb,s->k==2?(s->pr?"constant":"linkonce_odr constant"):"global",vt(k),iv);}}prf(&g,&sm);for(uint32_t i=0;i<sm.eo;i++)for(uint32_t j=0;j<4096;j++)for(Sy*s=sm.sy[j];s;s=s->nx)if(s->el==i&&s->lv==0)for(uint32_t k=0;k<s->ol.n;k++)gdl(&g,s->ol.d[k]);for(uint32_t ui=0;ui<cu->cu.un.n;ui++){No*u=cu->cu.un.d[ui];if(u->k==N_PKB)gel(&g,u);}for(uint32_t i=0;i<sm.ib.n;i++)gel(&g,sm.ib.d[i]);for(uint32_t ui=cu->cu.un.n;ui>0;ui--){No*u=cu->cu.un.d[ui-1];if(u->k==N_PB){No*sp=u->bd.sp;fprintf(o,"define i32 @main(){\n  call void @\"%.*s.%d\"(ptr null)\n  ret i32 0\n}\n",(int)sp->sp.nm.n,sp->sp.nm.s,sp->sp.pmm.n);break;}}emd(&g);if(o!=stdout)fclose(o);of[strlen(of)-3]=0;wali(&sm,of,cu);return 0;}
